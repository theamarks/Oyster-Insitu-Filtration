---
title: "Insitu_Filter Graphs"
author: "Althea Marks"
date: "11/12/2019"
output:
  html_document: default
  pdf_document: default
---

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(data.table)
library(magrittr)
library(lubridate)
library(ggplot2)
library(ggthemes)
library(stringr)
library(hms)

Master_analysis_table <- fread(file.path('./Data', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_density = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))

# Graph Color Palette: Color blind palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
```

Filtration Rates (L/hr/m^2) predicted by Total Particulate Matter (ug/L) of seston
```{r FR vs TPM, echo=FALSE}
# FR vs TPM (Filtration Trials only)
(FR_TPM_graph <- ggplot((Master_analysis_table %>% 
                          filter(Experiment == "Filtration")), 
                        aes(Avg_TPM, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Total Particulate Matter (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials') +
  guides(fill = FALSE))

# Fit line 
(FR_TPM_graph_best_line <- ggplot(Master_analysis_table %>% 
                                      filter(Experiment == "Filtration"), 
                                    aes(Avg_TPM, L_hr_m2)) +
  geom_point() +
  geom_smooth() +
  theme_classic() +
  labs(x = 'Total Particulate Matter (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials with best fit line') +
  guides(fill = FALSE))
```

Filtration Rates (L/hr/m^2) predicted by Organic Content of seston
```{r FR vs OC, echo=FALSE}
(FR_OC_graph <- ggplot(Master_analysis_table %>% 
                          filter(Experiment == "Filtration"), 
                        aes(Avg_OC_Ratio, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials') +
  guides(fill = FALSE))

(FR_OC_graph_bestfit <- ggplot(Master_analysis_table %>% 
                          filter(Experiment == "Filtration"), 
                        aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials with best fit line') +
  guides(fill = FALSE)) +
  geom_smooth()

# Deanza only
(FR_OC_NPD_graph <- ggplot(Master_analysis_table %>% 
                             filter(Experiment == "Filtration",
                                    Site == "Deanza"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Newport Deanza Filtration Trials with best fit line') +
  guides(fill = FALSE)) +
  geom_smooth()

# Morro Bay only
(FR_OC_MB_graph <- ggplot(Master_analysis_table %>% 
                             filter(Experiment == "Filtration",
                                    Site == "Morro Bay"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Morro Bay Filtration Trials with best fit line') +
  guides(fill = FALSE)) +
  geom_smooth()

# San Rafael only
(FR_OC_NPSM_graph <- ggplot(Master_analysis_table %>% 
                             filter(Experiment == "Filtration",
                                    Site == "San Rafael"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'San Rafael Filtration Trials with best fit line') +
  guides(fill = FALSE)) +
  geom_smooth()

# Shellmaker only
(FR_OC_NPSM_graph <- ggplot(Master_analysis_table %>% 
                             filter(Experiment == "Filtration",
                                    Site == "Shellmaker"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Shellmaker Filtration Trials with best fit line') +
  guides(fill = FALSE)) +
  geom_smooth()
```
Filtration Rate (L/hr/m^2) predicted by Temperature (Linear Model, 95% CI)
```{r FR vs Water Quality, echo=FALSE}

Filter_data <- Master_analysis_table %>% 
                     filter(Experiment == "Filtration")

(FR_Temp <- ggplot(Filter_data, aes(Temp_C_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Temprature - All Sites'))

(FR_Temp_bestfit <- ggplot(Filter_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Temprature - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_temp_lm <- lm(data = Filter_data, L_hr_m2 ~ Temp_C_Up)
summary(FR_temp_lm)
par(mfrow=c(2,2))
plot(FR_temp_lm)
```
Filtration Rate (L/hr/m^2) predicted by Salinity (Linear Model, 95% CI)
```{r}

(FR_Sal <- ggplot(Filter_data, aes(Sal_ppt_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Salinity - All Sites')) 
  
(FR_Sal_bestfit <- ggplot(Filter_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Salinity - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_Sal_lm <- lm(data = Filter_data, L_hr_m2 ~ Sal_ppt_Up)
summary(FR_Sal_lm)
par(mfrow=c(2,2))
plot(FR_Sal_lm)
```

```{r}
# Chlorophyll 
(FR_Chl <- ggplot(Filter_data, aes(Chl_ug_L_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Chlrophyll - All Sites')) 
  
(FR_Chl_bestfit <- ggplot(Filter_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Chlorophyll - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_Chl_lm <- lm(data = Filter_data, L_hr_m2 ~ Chl_ug_L_Up)
summary(FR_Chl_lm)
par(mfrow=c(2,2))
plot(FR_Chl_lm)
```

```{r}
# Turbidity
(FR_Turbidity <- ggplot(Filter_data, aes(Turbidity_NTU_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Turbidity - All Sites')) 
  
(FR_Turbidity_bestfit <- ggplot(Filter_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Tubidity Upstream (NTU)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Turbidity - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_Turb_lm <- lm(data = Filter_data, L_hr_m2 ~ Turbidity_NTU_Up)
summary(FR_Turb_lm)
par(mfrow=c(2,2))
plot(FR_Turb_lm)
```

TPM vs OC
```{r TPM vs OC, echo=FALSE}
TPM_OC_base <- ggplot(data = Avg_TPM_summary_table, aes(x = Avg_TPM, y = Avg_OC_Ratio, color = Site, label = Date))

TPM_OC_base + geom_point(size=4) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)

# Exclude low deanza value
exclude_low_deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(!(Site == "Deanza") | !(Date == "4/18/19"))), aes(x = Avg_TPM, y = Avg_OC_Ratio, color = Site, label = Date))

exclude_low_deanza + geom_point(size=4) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC", subtitle = "Excluding NPD 4/18/19") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)
```
Plot individual Sites TPM vs OC
```{r TPM vs OC - Individual Sites, echo=FALSE}
Avg_TPM_summary_table %>% 
  ggplot(aes(x = Avg_TPM, y = Avg_OC_Ratio, group = Site, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = "Total Particulate Matter",
       y = 'Average Organic Content Ratio',
       title = 'OC predicted by TPM') +
  facet_wrap(~ Site) 

############ Deanza #############
Deanza_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

Deanza_only + geom_point(size=4, color = '#F8766D') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC Deanza") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.0003, nudge_y = 0, check_overlap = T)

############ Shellmaker ##########
Shellmaker_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

Shellmaker_only + geom_point(size=4, color = '#C77CFF') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC Shellmaker") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.0002, nudge_y = 0, check_overlap = T)

############ San Rafael ##########
SR_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

SR_only + geom_point(size=4, color = '#00BFC4') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC San Rafael") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.005, nudge_y = 0, check_overlap = T)

############ Morro Bay ##########
MB_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

MB_only + geom_point(size=4, color = '#7CAE00') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC Morro Bay") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.0005, nudge_y = 0, check_overlap = T)
```
Bivalve Density Graphs
```{r eval=FALSE, include=FALSE}
# Graph Density by Species, exclude absent species

############## Newport Deanza ###################
(Graph_NPD_species_den <- ggplot(NPD_may18_species_den[which(NPD_may18_species_den$species_den_m2>0),], 
                               aes(Species, species_den_m2, fill = Species)) + 
  geom_col() + # columns
  theme_classic() + 
  labs (x = 'Bivlave Species', 
        y = 'Density (individuals / m^2)', 
        title = 'Newport Deanza Bivalve Density',
        subtitle = 'May 2018 Survey') +
  guides(fill = FALSE) + # removes color legend
  geom_text(aes(label = species_den_m2), vjust = -0.5)) # able to round values? 
                                                                      
############## Newport Shellmaker ##############
(Graph_NPSM_species_den <- ggplot(NPSM_may18_species_den[which(NPD_may18_species_den$species_den_m2>0),], 
                                 aes(Species, species_den_m2, fill = Species)) + 
  geom_col() + # columns
  theme_classic() + 
  labs (x = 'Bivlave Species', 
        y = 'Density (individuals / m^2)', 
        title = 'Newport Shellmaker Bivalve Density',
        subtitle = 'May 2018 Survey') +
  guides(fill = FALSE) + # removes color legend
  geom_text(aes(label = species_den_m2), vjust = -0.5)) # able to round values? 


# Save graph to "./0_Graph_Output/Graphs_Bivalve_Density"
# Not needed Whit Rmd Knit yet
######### May need to reformat .pdf  ###########
#ggsave(file.path(Bivlave_density_graph_directory, "NPD_may18_bivalve_species_density.pdf"), Graph_NPD_species_den )
#ggsave(file.path(Bivlave_density_graph_directory, "NPSM_may18_bivalve_species_density.pdf"), Graph_NPSM_species_den )

##### FIgure ####### -->> biomass comparison among species
```

Olympia DTW predicted by Shell Length - Newport, CA
```{r echo=FALSE}
NPD_oly <- NPD_density %>% 
  filter(species == "O. lurida") %>% 
  drop_na() %>% 
  as_tibble() %>%
  select(species, length_mm, tissue_dry_weight_g)

(Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

# Remove outlier / data error
(Oly_shell_DTW <- ggplot(NPD_oly %>% 
                           filter(!(tissue_dry_weight_g > 1)),
                         aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Removed outlier bad data') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

# log transform both axes
(Oly_shell_DTW_log <- ggplot(NPD_oly %>% 
                              filter(!(tissue_dry_weight_g > 1)),
                            aes(log10(length_mm), log10(tissue_dry_weight_g))) +
  geom_point() +
  theme_classic() +
  labs(x = 'log10 Shell Length (mm)',
       y = 'log10 Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Removed outlier') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

#log transform y axis
(Oly_shell_DTW_log <- ggplot(NPD_oly %>% 
                              filter(!(tissue_dry_weight_g > 1)),
                            aes(length_mm, log10(tissue_dry_weight_g))) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'log10 Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Removed outlier') +
  geom_smooth(method=lm, se=TRUE, level=0.95))
```
Build Simple model to predict Olympia DTW
```{r Shell height / DTW linear model, echo=FALSE}
Oly_DTW_lm <- lm(data = NPD_oly, tissue_dry_weight_g ~ length_mm)
summary(Oly_DTW_lm)
par(mfrow=c(2,2))
plot(Oly_DTW_lm)

Oly_DTW_lm_log <- lm(data = NPD_oly, log10(tissue_dry_weight_g) ~ log10(length_mm))
summary(Oly_DTW_lm_log)
par(mfrow=c(2,2))
plot(Oly_DTW_lm_log)
```

