---
title: "In situ Filtration Analysis Graphs"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    vertical_layout: scroll
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(data.table)
library(magrittr)
library(lubridate)
library(ggplot2)
library(ggthemes)
library(stringr)
library(hms)
library(viridisLite)
library(forcats)
library(gridExtra)
library(ggpmisc) # package for adding line equation and R^2 to plots
library(viridis) # Color palette for Restoration Area - Options: magma , inferno, plasma, viridis, cividis
library(scales)


Master_analysis_table <- fread(file.path('./output/4_Filtration_Calculations/Filtration_Summary', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_density = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))

# Remove San Diego filtration trial - not applicable to this analysis - different experimental set up
Master_analysis_table <- Master_analysis_table %>% 
  filter(!Site %in% c("San Diego"))

# Basic linear model formula to display on plots
x_y_formula <- y ~ x 

# Order Sites by Latitude
site_by_lat <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
# transform Site variable to factor and arange by Latitude
Master_analysis_table <- arrange(transform(Master_analysis_table, Site = factor(Site,levels = site_by_lat)), Site)
# Assign colors to each Site
viridis(4)
Site_colors <- c("San Rafael" = "#440154FF",
                 "Morro Bay" = "#31688EFF",
                 "Shellmaker" = "#35B779FF",
                 "Deanza" = "#FDE725FF")

```

Chlorphyll % Removed  - Linear Regression
=====================================
### LM - excluding San Rafael logic variable
```{r Chl_rmd_LM_No_SR output, fig.height=15, fig.width=6, cache=TRUE}

Chl_rmd_LM_No_SR <- lm(Master_analysis_table$pcnt_Chl_rmvd ~
                         # site logic variables 
                         Master_analysis_table$NPD + Master_analysis_table$NPSM + Master_analysis_table$MB + 
                         # Field notes logic variables
                         Master_analysis_table$Wind + Master_analysis_table$G_upstream + Master_analysis_table$Daylight +
                         Master_analysis_table$Sonde_fell + Master_analysis_table$Boat_wake + Master_analysis_table$Algae +
                         # Quantatative variables
                         Master_analysis_table$Temp_C_Up + Master_analysis_table$Sal_ppt_Up +
                         Master_analysis_table$Turbidity_NTU_Up + Master_analysis_table$Chl_ug_L_Up +
                         Master_analysis_table$avg_depth_cm + Master_analysis_table$d_bw_sondes_m +
                         Master_analysis_table$avg_m_hr + Master_analysis_table$Avg_POM + 
                         Master_analysis_table$Avg_PIM)

summary(Chl_rmd_LM_No_SR)
```

L/hr/m^2 X TPM (ug/L)
=====================================

### FR by site (all data)
```{r FR vs TPM, fig.height=5, fig.width=6, cache=TRUE}
Filter_data <- Master_analysis_table %>% 
                     filter(Experiment == "Filtration")

Filter_data_pos <- Master_analysis_table %>% 
                     filter(Experiment == "Filtration",
                            L_hr_m2 > 0)

FR_TPM_box <- ggplot((Filter_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = 'Filtration Rate L/hr/m^2')
plot(FR_TPM_box)
```

### FR by site (Positive values only) 
```{r FR by site positive only, cache=TRUE}
FR_TPM_box_pos <- ggplot((Filter_data_pos), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = 'Filtration Rate L/hr/m^2')
plot(FR_TPM_box_pos)
```

### FR vs TPM (Filtration Trials only)
```{r, cache=TRUE}
FR_TPM_graph <- ggplot((Filter_data), aes(Avg_TPM, L_hr_m2 )) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Total Particulate Matter (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_TPM_graph)
```

### FR TPM Linear Model
```{r, cache=TRUE}
FR_TPM_lm <- lm(data = Filter_data, L_hr_m2 ~ Avg_TPM)
summary(FR_TPM_lm)
```

### diagnostic plots
```{r, cache=TRUE}
par(mfrow=c(2,2))
plot(FR_TPM_lm)

```

L/hr/m^2 X OC 
=====================================

### FR predicted by OC
```{r FR vs OC, cache=TRUE}
FR_OC_graph <- ggplot(Filter_data, aes(Avg_OC_Ratio, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  geom_smooth(method=lm, se=T, level=0.95, color = "black")
plot(FR_OC_graph)
```

### FR by OC bestfit
```{r eval=FALSE, include=FALSE, cache=T}
FR_OC_graph_bestfit <- ggplot(Filter_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials with best fit line') +
  guides(fill = FALSE) +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(FR_OC_graph_bestfit)
```

### FR by OC Linear Model
```{r, cache =TRUE}
FR_OC_lm <- lm(data = Filter_data, L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_lm)
```

### Diagnosic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_lm)
```

### Deanza FR by OC
```{r}
FR_OC_NPD_graph <- ggplot(Filter_data %>% 
                             filter(Site == "Deanza"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Newport Deanza Filtration Trials with best fit line') +
  guides(fill = FALSE) +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(FR_OC_NPD_graph)
```

### Deanza FR by OC Linear Model
```{r}
FR_OC_NPD_lm <- lm(data = (Filter_data %>% filter(Site == "Deanza")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_NPD_lm)
```

### Diagnostic plot
```{r}
par(mfrow=c(2,2))
plot(FR_OC_NPD_lm)
```

### Morro Bay FR by OC
```{r}
FR_OC_MB_graph <- ggplot(Filter_data %>% 
                             filter(Site == "Morro Bay"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Morro Bay Filtration Trials with lm') +
  guides(fill = FALSE) +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(FR_OC_MB_graph)
```

### MB FR by OC Linear Model
```{r}
FR_OC_MB_lm <- lm(data = (Filter_data %>% filter(Site == "Morro Bay")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_MB_lm)
```

### Diagnositc plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_NPD_lm)
```

### San Rafael FR by OC
```{r}
# San Rafael only
FR_OC_SR_graph <- ggplot(Master_analysis_table %>% 
                             filter(Site == "San Rafael"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'San Rafael Filtration Trials with lm') +
  guides(fill = FALSE) +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(FR_OC_SR_graph)
```

### SR FR by OC Linear Model
```{r}
FR_OC_SR_lm <- lm(data = (Filter_data %>% filter(Site == "San Rafael")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_SR_lm)
```

### Diagnostic plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_SR_lm)
```

### Shellmaker only
```{r}
FR_OC_NPSM_graph <- ggplot(Filter_data %>% 
                             filter(Site == "Shellmaker"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Shellmaker Filtration Trials with lm') +
  guides(fill = FALSE) +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(FR_OC_NPSM_graph)
```

### Shellmaker FR by OC Linear Model
```{r}
FR_OC_NPSM_lm <- lm(data = (Filter_data %>% filter(Site == "Shellmaker")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_NPSM_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_NPSM_lm)
```

L/hr/m^2 X WQ
=====================================

### Temperature
```{r FR vs Water Quality, echo=FALSE}
FR_Temp <- ggplot(Filter_data, aes(Temp_C_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Temprature - All Sites')
plot(FR_Temp)

(FR_Temp_bestfit <- ggplot(Filter_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Temprature - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_temp_lm <- lm(data = Filter_data, L_hr_m2 ~ Temp_C_Up)
summary(FR_temp_lm)
par(mfrow=c(2,2))
plot(FR_temp_lm)
```

```{r echo=FALSE}
## Salinity
(FR_Sal <- ggplot(Filter_data, aes(Sal_ppt_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Salinity - All Sites')) 
  
(FR_Sal_bestfit <- ggplot(Filter_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Salinity - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_Sal_lm <- lm(data = Filter_data, L_hr_m2 ~ Sal_ppt_Up)
summary(FR_Sal_lm)
par(mfrow=c(2,2))
plot(FR_Sal_lm)
```

```{r echo=FALSE}
## Chlorophyll 
(FR_Chl <- ggplot(Filter_data, aes(Chl_ug_L_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Chlrophyll - All Sites')) 
  
(FR_Chl_bestfit <- ggplot(Filter_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Chlorophyll - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_Chl_lm <- lm(data = Filter_data, L_hr_m2 ~ Chl_ug_L_Up)
summary(FR_Chl_lm)
par(mfrow=c(2,2))
plot(FR_Chl_lm)
```

```{r echo=FALSE}
## Turbidity
(FR_Turbidity <- ggplot(Filter_data, aes(Turbidity_NTU_Up, L_hr_m2, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Turbidity - All Sites')) 
  
(FR_Turbidity_bestfit <- ggplot(Filter_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Tubidity Upstream (NTU)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Turbidity - All Sites') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

FR_Turb_lm <- lm(data = Filter_data, L_hr_m2 ~ Turbidity_NTU_Up)
summary(FR_Turb_lm)
par(mfrow=c(2,2))
plot(FR_Turb_lm)
```

TPM & OC
=====================================
```{r TPM vs OC, echo=FALSE}
##TPM vs OC
TPM_OC_base <- ggplot(data = Avg_TPM_summary_table, aes(x = Avg_TPM, y = Avg_OC_Ratio, color = Site, label = Date))

TPM_OC_base + geom_point(size=4) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)

# Exclude low deanza value
exclude_low_deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(!(Site == "Deanza") | !(Date == "4/18/19"))), aes(x = Avg_TPM, y = Avg_OC_Ratio, color = Site, label = Date))

exclude_low_deanza + geom_point(size=4) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC", subtitle = "Excluding NPD 4/18/19") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)
```

```{r TPM vs OC - By Site, echo=FALSE}
## Plot individual Sites TPM vs OC
Avg_TPM_summary_table %>% 
  ggplot(aes(x = Avg_TPM, y = Avg_OC_Ratio, group = Site, color = Site)) +
  geom_point() +
  theme_classic() +
  labs(x = "Total Particulate Matter",
       y = 'Average Organic Content Ratio',
       title = 'OC predicted by TPM') +
  facet_wrap(~ Site) 

############ Deanza #############
Deanza_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

Deanza_only + geom_point(size=4, color = '#F8766D') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC Deanza") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.0003, nudge_y = 0, check_overlap = T)

############ Shellmaker ##########
Shellmaker_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

Shellmaker_only + geom_point(size=4, color = '#C77CFF') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC Shellmaker") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.0002, nudge_y = 0, check_overlap = T)

############ San Rafael ##########
SR_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

SR_only + geom_point(size=4, color = '#00BFC4') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC San Rafael") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.005, nudge_y = 0, check_overlap = T)

############ Morro Bay ##########
MB_only <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date))

MB_only + geom_point(size=4, color = '#7CAE00') + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC Morro Bay") + 
  theme_classic() +
  geom_text(aes(label=Date), nudge_x = 0.0005, nudge_y = 0, check_overlap = T)
```
DTW - Shell length
=====================================
```{r Oly DTW - Shell length analysis, echo=FALSE}
##Olympia DTW predicted by Shell Length - Newport, CA
NPD_oly <- NPD_density %>% 
  filter(species == "O. lurida") %>% 
  drop_na() %>% 
  as_tibble() %>%
  select(species, length_mm, tissue_dry_weight_g)

(Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

Oly_DTW_lm <- lm(data = NPD_oly, tissue_dry_weight_g ~ length_mm)
summary(Oly_DTW_lm)
par(mfrow=c(2,2))
plot(Oly_DTW_lm)

# Outlier analysis (mean -+ SD * 2.2)
find_outlier <- function(data){
  average <- mean(data)
  stdev <- sd(data)
  outlier <- ifelse((data < (average - 2.2 * stdev) | (data > (average + 2.2 * stdev))),
         TRUE, FALSE)
}
# Remove outlier from graph 
NPD_oly_outlier <- NPD_oly %>% 
  mutate(DTW_outlier = find_outlier(NPD_oly$tissue_dry_weight_g))

(Oly_shell_DTW_rm_out <- ggplot(NPD_oly_outlier %>% 
                                  filter(DTW_outlier == FALSE), 
                                aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Removed outlier') +
  geom_smooth(method=lm, se=TRUE, level=0.95))

# Linear model without outlier
Oly_DTZW_lm_rm_out <- lm(data = NPD_oly_outlier %>% 
                           filter(DTW_outlier == FALSE),
                         tissue_dry_weight_g ~ length_mm)

summary(Oly_DTZW_lm_rm_out)
par(mfrow=c(2,2))
plot(Oly_DTZW_lm_rm_out)
```

```{r eval=FALSE, include=FALSE}
## Test sbs correction - SBS corrections applied correctly
NPD_41519_Filter_plot <- fread(file.path("./output/2_Manual_Corrections_Applied", "Insitu_Filter_NPD_41519.csv"))
NPD_41519_Filter_plot <- NPD_41519_Filter_plot %>% 
  filter(Experiment == 'Filtration') 

(regular <- ggplot(NPD_41519_Filter_plot, aes(Time, Chl_ug_L, group = Position, color = Position)) + 
  geom_point())

NPD_41519_Filter_plot_sbs <- fread(file.path("./output/3_Sbs_Corrections_Applied", "Insitu_Filter_NPD_41519.csv"))
NPD_41519_Filter_plot_sbs <- NPD_41519_Filter_plot_sbs %>% 
  filter(Experiment == 'Filtration')

(adjusted <- ggplot(NPD_41519_Filter_plot_sbs, aes(Time, Chl_ug_L, group = Position, color = Position)) + 
  geom_point())

```



```{r Bar Graphs up vs down, echo=FALSE}
Bar_up_down_data <- Master_analysis_table %>%
  select(Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>%
  rename(Upstream = Chl_ug_L_Up, Downstream = Chl_ug_L_Down) %>%  
  gather(Upstream, Downstream, key = Position, value = Chl_ug_L) %>% 
  mutate(Position = fct_relevel(Position, 'Upstream', 'Downstream')) %>% 
  mutate(Site = fct_relevel(Site, 'Deanza', 'Shellmaker', 'San Rafael', 'Morro Bay')) %>% 
  mutate(Site_exp_date = paste(Site, Experiment,
                                     Date,
                                     sep = ' ')) %>% 
  mutate(Exp_Date = paste(Experiment, Date, sep = ' ')) %>% 
  arrange(Site, mdy(Date))

#Bar_up_down_data$Position <- as.factor(Bar_up_down_data$Position)

(Paired_bar_chl_graph <- ggplot(data = Bar_up_down_data, aes(x = Site_exp_date, y = Chl_ug_L, fill = Position)) +
    geom_bar(stat="identity", position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_grid(~ Site, scales = "free", space = "free") + #'free' allows axis b/w sites uneaven
    geom_bar(data = (Bar_up_down_data %>%
                       filter(!Experiment %in% c('Filtration'))),
             color = "grey22",
             stat="identity",
             position = "dodge") +
    labs(x = 'Experiment', y = 'Chlorophyl (ug/L)'))
############## Try 2 ####### make separate graphs, combine using grid.arrange()
NPD_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Deanza')

(NPD_bar_graph <- ggplot(data = NPD_bar_data, aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPD_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.x = element_blank(),
          legend.position = c(0.9, 0.8),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(y = 'Chlorophyll a (ug/L)', title = "Newport Deanza") +
    scale_x_discrete(labels = NPD_bar_data$Date) +
    ylim(0, 8))

NPSM_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Shellmaker')

(NPSM_bar_graph <- ggplot(data = NPSM_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPSM_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Newport Shellmaker") +
    scale_x_discrete(labels = NPSM_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)) 

MB_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Morro Bay')

(MB_bar_graph <- ggplot(data = MB_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (MB_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Morro Bay") +
    scale_x_discrete(labels = MB_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE))

SR_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'San Rafael')

(SR_bar_graph <- ggplot(data = SR_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (SR_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "San Rafael") +
    scale_x_discrete(labels = SR_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE))

Chl_graphs <- list(NPD_bar_graph, NPSM_bar_graph, SR_bar_graph, MB_bar_graph) 
(all_chl_graphs <- grid.arrange(grobs = Chl_graphs,
             widths = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1),
             layout_matrix = rbind(c(NA,1,1,1,1,1,1,1,1,1,1,1,1, NA),
                                   c(2,2,2,2,2,3,3,3,3,3,4,4,4,4))))
ggsave("Insitu_Filter_up_vs_down_all_sites.png", all_chl_graphs)
```

```{r Paire t tests, echo=FALSE}
#### Paired t-test all filtration trials --- Mean Upstream Chl vs Mean Downstream Chl

Master_analysis_table_FILTER <- Master_analysis_table %>%
  filter(Experiment == 'Filtration')

t.test(Master_analysis_table_FILTER$Chl_ug_L_Up,
       Master_analysis_table_FILTER$Chl_ug_L_Down,
       alternative =c("greater"),
       paired = TRUE,
       conf.level = 0.95)
## No difference between upstream and downstream Chl across all Filtraiton trails

##### Paired t-test on Positive L/hr/m^2 Filtration trails
Master_analysis_table_posFILTER <- Master_analysis_table %>% 
  filter(Experiment == 'Filtration',
         L_hr_m2 > 0)

t.test(Master_analysis_table_posFILTER$Chl_ug_L_Up,
       Master_analysis_table_posFILTER$Chl_ug_L_Down,
       alternative =c("greater"),
       paired = TRUE,
       conf.level = 0.95)
# No difference between upstream and downstream Chl across positive Filtration trials

######### Paired t-test on all trials (Filtraiton & Neg Control)
t.test(Master_analysis_table$Chl_ug_L_Up,
       Master_analysis_table$Chl_ug_L_Down,
       paried = TRUE,
       alternative =c("greater"),
       conf.level = 0.95)
## No difference between upstream and downstream Chl
```