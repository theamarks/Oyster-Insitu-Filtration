---
title: "In situ Filtration Analysis Graphs"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: yeti
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(data.table)
library(magrittr)
library(lubridate) # dealing with time and dates
library(ggplot2)
library(ggthemes) # theme_classic() for graphs
library(stringr)
library(hms)
library(viridisLite)
library(forcats)
library(gridExtra)
library(ggpmisc) # package for adding line equation and R^2 to plots
library(viridis) # Color palette for Restoration Area - Options: magma , inferno, plasma, viridis, cividis
library(scales)
library(cowplot) # for arranging multiple plots into a single figure
library(wesanderson)

# source functions 
source("functions.R")
# define output directory
output_directory = "./output"
# create output directories (same as Insitu_Filtraiton_Analysis_script.Rmd)
createOutputDirectories()

# Read in Data
Master_analysis_table <- fread(file.path('./output/4_Filtration_Calculations/Filtration_Summary', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_density = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))

# Remove San Diego filtration trial - not applicable to this analysis - different experimental set up
Master_analysis_table <- Master_analysis_table %>% 
  filter(!Site %in% c("San Diego"))

# linear model formula
x_y_formula <- y ~ x 
# Quadratic model
x2_y_formula <- y ~ x^2
# Exponential model
logy_x_formula <- log(y) ~ x 

# Order Sites by Latitude
site_by_lat <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 

# transform Site variable to factor and arange by Latitude
Master_analysis_table <- arrange(transform(Master_analysis_table, Site = factor(Site,levels = site_by_lat)), Site)

 # Filtration trials only - exclude Negative controls
Filtration_only_data <- Master_analysis_table %>% 
  filter(Experiment %in% c("Filtration"))

# Filtration trials only - exclude Negative controls & Percent Chl removed greater than 0
Filtration_pos_data <- Master_analysis_table %>% 
  filter(Experiment %in% c("Filtration") & pcnt_Chl_rmvd > 0)

# Assign colors to each Site
viridis(4)
Site_colors <- c("San Rafael" = "#440154FF",
                 "Morro Bay" = "#31688EFF",
                 "Shellmaker" = "#35B779FF",
                 "Deanza" = "#FDE725FF")

# Labels for graphs 
Hab_FR_Label <- expression('Habitat Filtration Rate (L/hr/m'^2*')')
Prt_Chl_Label <- expression(paste('Percent Chlorophyll ', alpha, ' Removed'))
Chl_ugL_Label <- expression(paste("Chlorophyll ", alpha, " (", mu, "g/L) "))
TPM_Label <- expression(paste('Total Particulate Matter (', mu,"g/L)"))

###################### Functions ####################################
# function for number of samples - display on graph
n_mean_stats <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  'mean =', round(mean(x), 1), '\n')
                )
         )
}

# function to calculate average, standard deviation, outlier data. 
find_outlier <- function(data){
  average <- mean(data)
  stdev <- sd(data)
  # Outlier data defined by outside 2.2 standard deviations from the mean 
  outlier <- ifelse((data < (average - 2.2 * stdev) | (data > (average + 2.2 * stdev))),
         TRUE, FALSE)
}
```

Chl % Removed - LM
=====================================
### LM - excluding San Rafael logic variable
```{r LM_Prct_Chl_All, fig.height=15, fig.width=6, cache=TRUE}

LM_PrctChl_All <- lm(Master_analysis_table$pcnt_Chl_rmvd ~
                        # site logic variables - SR not included - would break model
                       Master_analysis_table$NPD + Master_analysis_table$NPSM + 
                       Master_analysis_table$MB + Master_analysis_table$Filter_trial +
                       Master_analysis_table$Wind + Master_analysis_table$G_upstream + 
                       Master_analysis_table$Daylight + Master_analysis_table$Sonde_fell + 
                       Master_analysis_table$Boat_wake + Master_analysis_table$Algae +
                        # Quantatative variables
                       Master_analysis_table$Temp_C_Up + Master_analysis_table$Sal_ppt_Up +
                       Master_analysis_table$Turbidity_NTU_Up + Master_analysis_table$Chl_ug_L_Up +
                       Master_analysis_table$avg_depth_cm + Master_analysis_table$d_bw_sondes_m +
                       Master_analysis_table$avg_m_hr + Master_analysis_table$Avg_OC_Ratio ) 
                        # Bivavle density is essentially the same as site, not sure if needed. May be appropriate NPD vs NPSM  
                         #Master_analysis_table$Bivalve_den_m2)

summary(LM_PrctChl_All)
```
 
> I'm not sure if narrowing down the data to Filtration Trials only and then only significant Filtration trials helps predict. Wouldn't the model be stronger if all the data was included? How about bivalve density - the numbers are the same for each site across trials- essentially the same as Site effect?

### LM - Filtraiton Trials Only
```{r LM_PrctChl_Filter_only, fig.height=15, fig.width=6, cache=TRUE}
# Filtration Trials only - no Negative Controls
LM_PrctChl_Filter <- lm(Filtration_only_data$pcnt_Chl_rmvd ~
                         # site logic variables - SR not included - would break model to include all sites
                         Filtration_only_data$NPD + Filtration_only_data$NPSM + 
                         Filtration_only_data$MB + 
                         # Field notes logic variables
                         Filtration_only_data$Wind + Filtration_only_data$G_upstream +
                         Filtration_only_data$Daylight +
                         Filtration_only_data$Sonde_fell + Filtration_only_data$Boat_wake + 
                         Filtration_only_data$Algae +
                         # Quantatative variables
                         Filtration_only_data$Temp_C_Up + Filtration_only_data$Sal_ppt_Up +
                         Filtration_only_data$Turbidity_NTU_Up + Filtration_only_data$Chl_ug_L_Up +
                         Filtration_only_data$avg_depth_cm + Filtration_only_data$d_bw_sondes_m +
                         Filtration_only_data$avg_m_hr + Filtration_only_data$Avg_OC_Ratio)

summary(LM_PrctChl_Filter)
```

### LM - Filtration Trials w/ positive Percent Chl removal
```{r LM_PrctChl_positive, fig.height=15, fig.width=6, cache=TRUE}

# Positive Percent Chl removed trials only
LM_PrctChl_pos <- lm(Filtration_pos_data$pcnt_Chl_rmvd ~
                         # site logic variables 
                         Filtration_pos_data$NPD + Filtration_pos_data$NPSM + Filtration_pos_data$MB + 
                         # Field notes logic variables
                         Filtration_pos_data$Wind + Filtration_pos_data$G_upstream + Filtration_pos_data$Daylight +
                         Filtration_pos_data$Sonde_fell + Filtration_pos_data$Boat_wake + #Filtration_pos_data$Algae +
                         # Quantatative variables
                         Filtration_pos_data$Temp_C_Up + Filtration_pos_data$Sal_ppt_Up +
                         Filtration_pos_data$Turbidity_NTU_Up + Filtration_pos_data$Chl_ug_L_Up +
                         Filtration_pos_data$avg_depth_cm + Filtration_pos_data$d_bw_sondes_m +
                         Filtration_pos_data$avg_m_hr + Filtration_pos_data$Avg_OC_Ratio)

summary(LM_PrctChl_pos)
```

> exausted the degrees of freedom. Try addative model instead of comprehensive model. Based on literature. Temperature, Salinity, Organic Content, wind, water velocity, avg_depth 


FR X TPM
=====================================

### Filtration by site (all data)
```{r FR vs TPM, fig.height=5, fig.width=12, cache=TRUE}
# Filtration_only_data defined in setup

FR_TPM_box <- ggplot((Filtration_only_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label)

Chl_Rmd_TPM_box <- ggplot(Filtration_only_data, aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label)

grid.arrange(FR_TPM_box, Chl_Rmd_TPM_box, nrow = 1)

```

### Filtration by site (Positive values only) 
```{r FR by site positive only, fig.height=5, fig.width=12, cache=TRUE}
# Filtration_pos_data defined in setup

FR_TPM_box_pos <- ggplot((Filtration_pos_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label,
       title = 'Positive L/hr/m^2 only')

Chl_Rmd_data_pos <- Master_analysis_table %>% 
                     filter(Experiment == "Filtration" &
                            pcnt_Chl_rmvd > 0)

Chl_Rmd_box_pos <- ggplot((Chl_Rmd_data_pos), aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label,
       title = 'Positive % Chl Rmd only')

grid.arrange(FR_TPM_box_pos, Chl_Rmd_box_pos, nrow = 1)
```

### Filtration vs TPM (Filtration Trials only)
```{r, Filter by TPM filter only, fig.height=5, fig.width=12, cache=TRUE}
FR_TPM_graph <- ggplot((Filtration_only_data), aes(Avg_TPM, L_hr_m2 )) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_TPM_graph <- ggplot((Filtration_only_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_TPM_graph, Chl_Rmd_TPM_graph, nrow = 1)
```

### FR TPM Linear Model
```{r LM FR x TPM, cache=TRUE}
FR_TPM_lm <- lm(data = Filtration_only_data, L_hr_m2 ~ Avg_TPM)
summary(FR_TPM_lm)
```

### ChlRmd TPM Linear Model
```{r LM ChlRmd x TPM , cache=TRUE}
ChlRmd_TPM_lm <- lm(data = Filtration_only_data, pcnt_Chl_rmvd ~ Avg_TPM)
summary(ChlRmd_TPM_lm)
```

### Filtration vs TPM (Positive Filtration Trials only)
```{r , fig.height=5, fig.width=12, cache=TRUE}
FRPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, L_hr_m2 )) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = 'Pos Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FRPos_TPM_graph, Chl_RmdPos_TPM_graph, nrow = 1)
```

### FR Pos TPM Linear Model
```{r, cache=TRUE}
FRPos_TPM_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_TPM)
summary(FR_TPM_lm)
```

###ChlRmd Pos TPM Linear Model
```{r, cache=TRUE}
FRPos_TPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_TPM)
summary(FRPos_TPM_lm)
```

Filtration X OC 
=====================================

### Filtration vs OC
```{r FR vs OC, fig.height=5, fig.width=12, cache=TRUE}
FR_OC_graph <- ggplot(Filtration_only_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_OC_graph <- ggplot(Filtration_only_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FR_OC_graph, Chl_Rmd_OC_graph, nrow = 1)
```

### FR by OC Linear Model
```{r, cache =TRUE}
FR_OC_lm <- lm(data = Filtration_only_data, L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_lm)
```

### ChlRmd by OC Linear Model
```{r, cache =TRUE}
ChlRmd_OC_lm <- lm(data = Filtration_only_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
summary(ChlRmd_OC_lm)
```

### Filter Positive vs OC
```{r FR vs OC, fig.height=5, fig.width=12, cache=TRUE}
FRPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_RmdPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FRPos_OC_graph, Chl_RmdPos_OC_graph, nrow = 1)
```

### FR Pos by OC Linear Model
```{r, cache =TRUE}
FRPos_OC_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_OC_Ratio)
summary(FRPos_OC_lm)
```

### ChlRmd Pos by OC Linear Model
```{r, cache =TRUE}
ChlRmdPos_OC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
summary(ChlRmdPos_OC_lm)
```

> Significant Avg_OC_Ratio *

### Deanza FR by OC
```{r Deanza_Filter_OC, fig.height=5, fig.width=12}
FR_OC_NPD_graph <- ggplot(Filtration_only_data %>% filter(Site == "Deanza"),
                          aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'Newport Deanza Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_OC_NPD_graph <- ggplot(Filtration_only_data %>% filter(Site == "Deanza"),
                          aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'Newport Deanza Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FR_OC_NPD_graph, Chl_Rmd_OC_NPD_graph, nrow = 1)
```

### Deanza FR by OC Linear Model
```{r}
FR_OC_NPD_lm <- lm(data = (Filtration_only_data %>% filter(Site == "Deanza")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_NPD_lm)
```

### Deanza ChlRmd by OC Linear Model
```{r}
ChlRmd_OC_NPD_lm <- lm(data = (Filtration_only_data %>% filter(Site == "Deanza")), pcnt_Chl_rmvd ~ Avg_OC_Ratio)
summary(ChlRmd_OC_NPD_lm)
```

### Deanza FR Positive by OC
```{r Deanza_Filter_Pos_OC, fig.height=5, fig.width=12}
FRPos_OC_NPD_graph <- ggplot(Filtration_pos_data %>% filter(Site == "Deanza"),
                          aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_RmdPos_OC_NPD_graph <- ggplot(Filtration_pos_data %>% filter(Site == "Deanza"),
                          aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FRPos_OC_NPD_graph, Chl_RmdPos_OC_NPD_graph, nrow = 1)
```

### Deanza FR Positive by OC Linear Model
```{r}
FRPos_OC_NPD_lm <- lm(data = (Filtration_pos_data %>% filter(Site == "Deanza")), 
                      L_hr_m2 ~ Avg_OC_Ratio)
summary(FRPos_OC_NPD_lm)
```

### Deanza ChlRmd Positive by OC Linear Model
```{r}
ChlRmdPos_OC_NPD_lm <- lm(data = (Filtration_pos_data %>% filter(Site == "Deanza")), 
                          pcnt_Chl_rmvd ~ Avg_OC_Ratio)
summary(ChlRmdPos_OC_NPD_lm)
```

Filter X WQ
=====================================

### Temperature
```{r Filter_Temp, fig.height=10, fig.width=12, echo=FALSE}
FR_Temp <- ggplot(Filtration_only_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Hab_FR_Label,
       title = 'FR by Temp (All Filtration Trials)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_Temp <- ggplot(Filtration_only_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'ChlRmd by Temp (All Filtration Trials)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

FR_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Positive ChlRmd') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_Temp, Chl_Rmd_Temp, FR_pos_Temp, Chl_Rmd_pos_Temp, nrow = 2)
```

### FR by Temp LM (All Filter)
```{r}
FR_temp_lm <- lm(data = Filtration_only_data, L_hr_m2 ~ Temp_C_Up)
summary(FR_temp_lm)
```

### ChlRmd X Temp LM (All Filter)
```{r}
ChlRmd_temp_lm <- lm(data = Filtration_only_data, pcnt_Chl_rmvd ~ Temp_C_Up)
summary(ChlRmd_temp_lm)
```

### FR Positive X Temp LM
```{r}
FRPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
summary(FRPos_temp_lm)
```

### ChlRmd Positive X Temp LM
```{r}
ChlRmdPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
summary(ChlRmdPos_temp_lm)
```

### Salinity
```{r Filter_Salinity, fig.height=10, fig.width=12, echo=FALSE}

FR_Sal <- ggplot(Filtration_only_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_Sal <- ggplot(Filtration_only_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

FR_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'Positive FR only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Sal <- ggplot(Chl_Rmd_data_pos, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_Sal, Chl_Rmd_Sal, FR_pos_Sal, Chl_Rmd_pos_Sal, nrow = 2)
```

### FR by Salinity LM
```{r}
FR_Sal_lm <- lm(data = Filtration_only_data, L_hr_m2 ~ Sal_ppt_Up)
summary(FR_Sal_lm)
```

### ChlRmd by Salinity LM
```{r}
ChlRmd_Sal_lm <- lm(data = Filtration_only_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
summary(ChlRmd_Sal_lm)
```

### FR Pos by Salinity LM
```{r}
FRPos_Sal_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Sal_ppt_Up)
summary(FRPos_Sal_lm)
```

### ChlRmd Pos by Salinity LM
```{r}
ChlRmdPos_Sal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
summary(ChlRmdPos_Sal_lm)
```

> Salinity almost significant predictor of ChlRmd (Positive Filter)

### Chlorophyll 
```{r Filter_Chl, fig.height=10, fig.width=12, echo=FALSE}
FR_Chl <- ggplot(Filtration_only_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_Chl <- ggplot(Filtration_only_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

FR_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Chl <- ggplot(Chl_Rmd_data_pos, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_Chl, Chl_Rmd_Chl, FR_pos_Chl, Chl_Rmd_pos_Chl, nrow = 2)
```

### FR by Chl LM
```{r}
FR_Chl_lm <- lm(data = Filtration_only_data, L_hr_m2 ~ Chl_ug_L_Up)
summary(FR_Chl_lm)
```

### ChlRmd by Chl LM
```{r}
ChlRmd_Chl_lm <- lm(data = Filtration_only_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
summary(ChlRmd_Chl_lm)
```

### FR Pos by Chl LM
```{r}
FRPos_Chl_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Chl_ug_L_Up)
summary(FRPos_Chl_lm)
```

### ChlRmd Pos by Chl LM
```{r}
ChlRmdPos_Chl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
summary(ChlRmdPos_Chl_lm)
```

> Chl almost significant predictor of Chl Rmd (Pos Filter)

### Turbidity
```{r Filter_Turbidity, fig.height=10, fig.width=12, echo=FALSE}
FR_Turb <- ggplot(Filtration_only_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_Turb <- ggplot(Filtration_only_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

FR_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_Turb, Chl_Rmd_Turb, FR_pos_Turb, Chl_Rmd_pos_Turb, nrow =2)
```

### FR by Turbidity LM
```{r}
FR_Turb_lm <- lm(data = Filtration_only_data, L_hr_m2 ~ Turbidity_NTU_Up)
summary(FR_Turb_lm)
```

### ChlRmd by Turbidity LM
```{r}
ChlRmd_Turb_lm <- lm(data = Filtration_only_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
summary(ChlRmd_Turb_lm)
```

### FR Pos by Turbidity LM
```{r}
FRPos_Turb_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Turbidity_NTU_Up)
summary(FRPos_Turb_lm)
```

### ChlRmd Pos by Turbidity LM
```{r}
ChlRmdPos_Turb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
summary(ChlRmdPos_Turb_lm)
```

TPM & OC
=====================================

### TPM by OC
```{r TPM vs OC, echo=FALSE}
TPM_OC <- ggplot(data = Avg_TPM_summary_table, aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  labs(x = TPM_Label, y = "Average Organic Content Ratio", title = "All Trials") + 
  theme_classic() +
  #geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(TPM_OC)
```

> No reason to exclude that low NPD value right?

### Individual Sites TPM vs OC
```{r TPM_OC - By Site, echo=FALSE}
OC_TPM_by_Site <- Avg_TPM_summary_table %>% 
  ggplot(aes(x = Avg_TPM, y = Avg_OC_Ratio, color = Site)) +
  geom_point(aes(color = Site)) + 
  geom_smooth(method=lm, se=TRUE, level=0.95) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = TPM_Label,
       y = 'Average Organic Content Ratio',
       title = 'OC predicted by TPM (g/L)') +
  #facet_wrap(~ Site) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(OC_TPM_by_Site)
```

> Large spread of relationship among sites. Different TPM:OC signatures and relationships at different sites.

### TPM vs OC by sites
```{r TPM_OC_Sites, fig.height=10, fig.width=12,}
TPM_OC_Deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")),
                        aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Deanza") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_NPSM <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), 
                     aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Shellmaker") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_SR <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")),
                   aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "San Rafael") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_MB <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), 
                   aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Morro Bay") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(TPM_OC_Deanza, TPM_OC_NPSM, TPM_OC_SR, TPM_OC_MB, nrow = 2)
```

### San Rafael TMP by OC
```{r}
TPM_SR <- Avg_TPM_summary_table %>% filter(Site == "San Rafael")

OC_TPM_SR_LM <- lm(data = TPM_SR, Avg_OC_Ratio ~ Avg_TPM)
summary(OC_TPM_SR_LM)
```

### Morro Bay TMP by OC
```{r}
TPM_MB <- Avg_TPM_summary_table %>% filter(Site == "Morro Bay")

OC_TPM_MB_LM <- lm(data = TPM_MB, Avg_OC_Ratio ~ Avg_TPM)
summary(OC_TPM_MB_LM)
```

### Shellmaker TMP by OC
```{r}
TPM_NPSM <- Avg_TPM_summary_table %>% filter(Site == "Shellmaker")

OC_TPM_NPSM_LM <- lm(data = TPM_NPSM, Avg_OC_Ratio ~ Avg_TPM)
summary(OC_TPM_NPSM_LM)
```

### Deanza TMP by OC
```{r}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_TPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ Avg_TPM)
summary(OC_TPM_NPD_LM)
```

> almost significant 

DTW - Shell length
=====================================

### Newport Olympia Shell length vs DTW
```{r Oly_DTW_Shell_length, echo=FALSE}
#Olympia DTW predicted by Shell Length - Newport, CA
# All excavation quadrat samples processed to date aggregated 
NPD_oly <- NPD_density %>% 
  filter(species == "O. lurida") %>% 
  drop_na() %>% 
  as_tibble() 

Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method = lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top") +
  stat_quadrant_counts(quadrants = 0L, label.x = "left", 
                       aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_DTW)
```

> 1) Outlier probably sample processing error or error in data entry. 2) Negative DTW data point, doesn't make sense- remove?

### DTW Shell length Outlier analysis (mean -+ SD * 2.2)
```{r Oly_DTW_Shell_length_outier_removed}
# Remove outlier and negative DTW value
NPD_oly_outRmd <- NPD_oly %>%
  mutate(DTW_outlier = find_outlier(NPD_oly$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0)

# Graph with outliers removed
Oly_shell_DTW_rm_out <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method=lm, formula = x_y_formula, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +#aes(color = Site)) +
  #scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
 # scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Outlier removed (outside mean +- 2.2 SD)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom") +
  stat_quadrant_counts(quadrants = 0L, label.x = "left", 
                       aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_DTW_rm_out)
```

> Shell length explains 49% of Dry Tissue Weight. Compare this relationship [Gray unpublished cited in Blake & zu Ermgassen 2015] (Yaquina Bay) --> DTW = 6x10e-6 * SH^3.06

> Remove negative DTW data point. Doesn't make sense

### Linear model without outlier
```{r Linear_model_DTW_length}
Oly_DTW_lm <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ length_mm)

summary(Oly_DTW_lm)
```

### Log Transform DTW Graph
```{r}
Oly_shell_logDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, log(tissue_dry_weight_g))) +
  geom_smooth(method=lm, formula = x_y_formula, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +#aes(color = Site)) +
  #scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
 # scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = 'Shell Length (mm)',
       y = expression('Log'[n]*' Dry Tissue Weight (g)'),
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Outlier removed (outside mean +- 2.2 SD)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom") +
  stat_quadrant_counts(quadrants = 0L, label.x = "left", 
                       aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_logDTW)
```

> Is that the correct line equation?? 

### Log transform DTW
```{r}
Oly_LogDTW_lm <- lm(data = NPD_oly_outRmd,
                    log(tissue_dry_weight_g) ~ length_mm)

summary(Oly_LogDTW_lm)
```

> Explains 67% of variation. length significant predictor of log(DTW)

### Quadratic model x^2
```{r Quad_model_DTW_length_2}
#Quadratic model using length^2
length_2 <- NPD_oly_outRmd$length_mm^2

Oly_DTW_Quad <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ length_mm + length_2)
summary(Oly_DTW_Quad)
```

> Not sure if this is the correct way to build this model. summary shows no significance in either variable. DTW = -1.468e-02 + https://www.theanalysisfactor.com/r-tutorial-4/

### Quadratic model Graph
```{r Quad_model_DTW_graph}
NPD_oly_outRmd %<>% 
  mutate(Quad_model = unname(predict(Oly_DTW_Quad)))
  # Could use predict(Oly_DTW_Quad, interval = 'confidence') to create confidence intervals columns
  # column1 = fit, column2 = lwr, column3 = upr 
  # use cbind instead of mutate 
  # cars.predict <- cbind(cars, predict(cars.model, interval = 'confidence'))

Oly_DTW_Quad_graph <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  geom_line(aes(length_mm, Quad_model)) +
  theme_classic() +
  labs(title = 'Olympia Oyster DTW predicted by (Shell Length)^2 - Newport, CA') +
  # label graph with R^2 adj value. won't work with quadratic equation
  stat_poly_eq(aes(label = ..adj.rr.label..), formula = x2_y_formula, 
               parse = TRUE) 
plot(Oly_DTW_Quad_graph)
```

### Quadratic model x^3
```{r Quad_model_DTW_length_3}
#Quadratic model using length^2
length_3 <- NPD_oly_outRmd$length_mm^3

Oly_DTW_Quad <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ length_mm + length_3)
summary(Oly_DTW_Quad)
```

> doesn't fit better

### Total Wet Weight vs Dry Tissue Weight
```{r}
Oly_TWW_DTW<- ggplot(NPD_oly, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
   geom_point() +
 # scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = 'Total wet weight (g)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Total Wet Weight - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")
plot(Oly_TWW_DTW)
```

### TWW vs DTW (remove outlier)
```{r}
# use DTW outlier data to plot graph
Oly_TWW_DTW_rm_out <- ggplot(NPD_oly_outRmd, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = 'Total wet weight (g)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Total Wet Weight - Newport, CA') +

  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(Oly_TWW_DTW_rm_out)
```

> Gray and Langdon (2017): "Unless explicitly mentioned, DTW of experimental oysters was estimated using the species-specific allometric relationship between DTW and total wet weight (TWW), which were determined in preliminary analysis (O. lurida: DTW = 0.0044TWW − 0.043, R2 =0.93, F1,32 =78.80, p value <0.0001; C. gigas: DTW = 0.039TWW − 0.06, R2 =0.89, F1,29 = 225.97, p value <0.0001).

### Linear model without outlier
```{r}
Oly_TWW_DTW_lm_rm_out <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ total_wet_weight_g)

summary(Oly_TWW_DTW_lm_rm_out)
```

### Log(TWW) vs DTW 
```{r}
# use DTW outlier data to plot graph
Oly_logTWW_DTW <- ggplot(NPD_oly_outRmd, aes(log(total_wet_weight_g), log(tissue_dry_weight_g))) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = expression('Log'[n]*" Total wet weight (g)"),
       y = expression('Log'[n]*'Dry Tissue Weight (g)'),
       title = 'Olympia Oyster DTW predicted by Total Wet Weight - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(Oly_logTWW_DTW)
```

### Log DTW X  Log TWW LM
```{r}
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_outRmd %>% filter(total_wet_weight_g > 0), 
                         log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
summary(Oly_TWW_DTW_log_LM)
```

Up & Down Chl
=====================================

### Facet Plots
```{r Bar_Graphs_up_vs_down}
Bar_up_down_data <- Master_analysis_table %>%
  select(Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>%
  rename(Upstream = Chl_ug_L_Up, Downstream = Chl_ug_L_Down) %>%  
  gather(Upstream, Downstream, key = Position, value = Chl_ug_L) %>% 
  mutate(Position = fct_relevel(Position, 'Upstream', 'Downstream')) %>% 
  mutate(Site = fct_relevel(Site, 'Deanza', 'Shellmaker', 'San Rafael', 'Morro Bay')) %>% 
  mutate(Site_exp_date = paste(Site, Experiment,
                                     Date,
                                     sep = ' ')) %>% 
  mutate(Exp_Date = paste(Experiment, Date, sep = ' ')) %>% 
  arrange(Site, mdy(Date))

#Bar_up_down_data$Position <- as.factor(Bar_up_down_data$Position)

Paired_bar_chl_graph <- ggplot(data = Bar_up_down_data, aes(x = Site_exp_date, y = Chl_ug_L, fill = Position)) +
    geom_bar(stat="identity", position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_grid(~ Site, scales = "free", space = "free") + #'free' allows axis b/w sites uneaven
    geom_bar(data = (Bar_up_down_data %>%
                       filter(!Experiment %in% c('Filtration'))),
             color = "grey22",
             stat="identity",
             position = "dodge") +
    labs(x = 'Experiment', y = 'Chlorophyl (ug/L)')

plot(Paired_bar_chl_graph)
```

### Graphs using grid.arrange()
```{r Bar_Graphs_up_vs_down_grid.arrange}
############## Try 2 ####### make separate graphs, combine using grid.arrange()

##### Can't figure out how to properly label x axis. Works with Exp_Date, but can't shorten without messing up data:label pairs. Can't spend more time on this right now. come back if time -AM 2020_3_3

NPD_bar_data <- Bar_up_down_data %>% 
  filter(Site == "Deanza") %>% 
  mutate(graph_Label = ifelse(grepl("^Filtration", Exp_Date), str_replace(Exp_Date, "Filtration ", ""),
                             str_replace(Exp_Date, "^Neg Control .", "")))

NPD_bar_graph <- ggplot(data = NPD_bar_data, aes(x = Exp_Date, y = Chl_ug_L, 
                                                 fill = Position)) +
    geom_col(position = position_dodge(width = 0.9, preserve = "single")) +
    geom_col(data = (NPD_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.x = element_blank(),
          legend.position = c(0.9, 0.8),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(y = 'Chlorophyll a (ug/L)', title = "Newport Deanza") +
  # This labels the x-axis
    #scale_x_discrete(labels = Exp_Date) +
    ylim(0, 8)
NPD_bar_graph

NPSM_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Shellmaker')

NPSM_bar_graph <- ggplot(data = NPSM_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPSM_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Newport Shellmaker") +
    # scale_x_discrete(labels = NPSM_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE) 

MB_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Morro Bay')

MB_bar_graph <- ggplot(data = MB_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (MB_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Morro Bay") +
   # scale_x_discrete(labels = MB_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

SR_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'San Rafael')

SR_bar_graph <- ggplot(data = SR_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (SR_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "San Rafael") +
    #scale_x_discrete(labels = SR_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

Chl_graphs <- list(NPD_bar_graph, NPSM_bar_graph, SR_bar_graph, MB_bar_graph) 
all_chl_graphs <- grid.arrange(grobs = Chl_graphs,
             widths = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1),
             layout_matrix = rbind(c(NA,1,1,1,1,1,1,1,1,1,1,1,1, NA),
                                   c(2,2,2,2,2,3,3,3,3,3,4,4,4,4)))
plot(all_chl_graphs)
#ggsave("Insitu_Filter_up_vs_down_all_sites.png", all_chl_graphs)
```

Bivalve Density
=====================================

### Bivalve Density
```{r Bivalve_Density, fig.height=6, fig.width=8}
# read in bivalve density data from cleaned data file
Bivalve_Den_data <- fread(file.path(Bivalve_output_directory, "Bivalve_Density_summary.csv"))

# replace NAs with 0s
Bivalve_Den_data[is.na(Bivalve_Den_data)] <- 0

Bivalve_Den_data <- Bivalve_Den_data %>% 
  # move species from individual columns to a single column with new density column to contain data
  pivot_longer(c(Adula_diegensis_m2, Musculista_senhousia_m2,Mytilus_galloprovincialis_m2,
                 Ostrea_lurida_m2, Crassostrea_gigas_m2,Argopecten_ventricosa_m2, 
                 Geukensia_demissa_m2, Crassostrea_gigas_m2), 
               names_to = "Species", 
               values_to =  "individuals_m2") %>% 
  # remove "_m2" from species names in Species column
  mutate(Species = str_replace(Species, "_m2", ""))

#Reorder levels of Site factor - display North to South
order_by_site <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
Bivalve_Den_data <- arrange(transform(Bivalve_Den_data, Site = factor(Site,levels = order_by_site)), Site)

# wes_palettes # lists all current palattes 
# Color palette for Species - Royal2, Darjeeling2, Cavalcanti1, BottleRocket2, IsleofDogs1
Species_colors <- rev(wes_palette("IsleofDogs1", 7, type = c("continuous")))

# Stacked bar graph
Bivalve_Den_graph <- ggplot(Bivalve_Den_data, aes(Site)) + 
  geom_col(aes(x = Site, y = individuals_m2, fill = Species)) +
  geom_text(aes(label = round(Bivalve_den_m2,0), y = Bivalve_den_m2), 
            vjust = -0.5) +
  theme_classic() +
  scale_fill_manual(values = Species_colors) +
  scale_y_continuous(breaks = seq(0, max(Bivalve_Den_data$Bivalve_den_m2), by = 500)) +
  labs(y = expression("Individuals per m"^2))
  
Bivalve_Den_graph
```

> Data for each site is from a single survey

### Biomass estimate by Site
```{r}
##### Estimate Biomass per site here with equations
  
```
