---
title: "In situ Filtration Analysis Graphs"
output: 
  flexdashboard::flex_dashboard:
    theme: yeti
    vertical_layout: scroll
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
library(dplyr)
library(tidyr)
library(data.table)
library(magrittr)
library(lubridate)
library(ggplot2)
library(ggthemes)
library(stringr)
library(hms)
library(viridisLite)
library(forcats)
library(gridExtra)
library(ggpmisc) # package for adding line equation and R^2 to plots
library(viridis) # Color palette for Restoration Area - Options: magma , inferno, plasma, viridis, cividis
library(scales)

# Read in Data
Master_analysis_table <- fread(file.path('./output/4_Filtration_Calculations/Filtration_Summary', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_density = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))

# Remove San Diego filtration trial - not applicable to this analysis - different experimental set up
Master_analysis_table <- Master_analysis_table %>% 
  filter(!Site %in% c("San Diego"))

# Basic linear model formula to display on plots
x_y_formula <- y ~ x 

# Order Sites by Latitude
site_by_lat <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
# transform Site variable to factor and arange by Latitude
Master_analysis_table <- arrange(transform(Master_analysis_table, Site = factor(Site,levels = site_by_lat)), Site)
# Assign colors to each Site
viridis(4)
Site_colors <- c("San Rafael" = "#440154FF",
                 "Morro Bay" = "#31688EFF",
                 "Shellmaker" = "#35B779FF",
                 "Deanza" = "#FDE725FF")

```

Chl % Removed - LM
=====================================
### LM - excluding San Rafael logic variable
```{r LM_Prct_Chl_All, fig.height=15, fig.width=6, cache=TRUE}

LM_PrctChl_All <- lm(Master_analysis_table$pcnt_Chl_rmvd ~
                         # site logic variables - SR not included - would break model
                         Master_analysis_table$NPD + Master_analysis_table$NPSM + Master_analysis_table$MB + 
                         # Field notes logic variables
                         Master_analysis_table$Wind + Master_analysis_table$G_upstream + Master_analysis_table$Daylight +
                         Master_analysis_table$Sonde_fell + Master_analysis_table$Boat_wake + Master_analysis_table$Algae +
                         # Quantatative variables
                         Master_analysis_table$Temp_C_Up + Master_analysis_table$Sal_ppt_Up +
                         Master_analysis_table$Turbidity_NTU_Up + Master_analysis_table$Chl_ug_L_Up +
                         Master_analysis_table$avg_depth_cm + Master_analysis_table$d_bw_sondes_m +
                         Master_analysis_table$avg_m_hr + Master_analysis_table$Avg_POM + 
                         Master_analysis_table$Avg_PIM + 
                         # Bivavle density is essentially the same as site, not sure if needed. May be appropriate NPD vs NPSM  
                         Master_analysis_table$Bivalve_den_m2)

summary(LM_PrctChl_All)
```

### LM - Filtraiton Trials Only
```{r LM_PrctChl_Filter, fig.height=15, fig.width=6, cache=TRUE}
Filtration_only_Analysis <- Master_analysis_table %>% 
  filter(Experiment %in% c("Filtration")) # Filtration trials only - exclude Negative controls

LM_PrctChl_Filter <- lm(Filtration_only_Analysis$pcnt_Chl_rmvd ~
                         # site logic variables - SR not included - would break model to include all sites
                         Filtration_only_Analysis$NPD + Filtration_only_Analysis$NPSM + Filtration_only_Analysis$MB + 
                         # Field notes logic variables
                         Filtration_only_Analysis$Wind + Filtration_only_Analysis$G_upstream + Filtration_only_Analysis$Daylight +
                         Filtration_only_Analysis$Sonde_fell + Filtration_only_Analysis$Boat_wake + Filtration_only_Analysis$Algae +
                         # Quantatative variables
                         Filtration_only_Analysis$Temp_C_Up + Filtration_only_Analysis$Sal_ppt_Up +
                         Filtration_only_Analysis$Turbidity_NTU_Up + Filtration_only_Analysis$Chl_ug_L_Up +
                         Filtration_only_Analysis$avg_depth_cm + Filtration_only_Analysis$d_bw_sondes_m +
                         Filtration_only_Analysis$avg_m_hr + Filtration_only_Analysis$Avg_POM + 
                         Filtration_only_Analysis$Avg_PIM)

summary(LM_PrctChl_Filter)
```

### LM - Filtration Trials w/ sig Filtration
```{r LM_PrctChl_sigFilter, fig.height=15, fig.width=6, cache=TRUE}
# Filtration Trials with significant Chl_diff
FilterWithFiltration <- Master_analysis_table %>% 
  filter(p.value <= 0.05)
  
LM_PrctChl_sigFilter <- lm(Filtration_only_Analysis$pcnt_Chl_rmvd ~
                         # site logic variables 
                         Filtration_only_Analysis$NPD + Filtration_only_Analysis$NPSM + Filtration_only_Analysis$MB + 
                         # Field notes logic variables
                         Filtration_only_Analysis$Wind + Filtration_only_Analysis$G_upstream + Filtration_only_Analysis$Daylight +
                         Filtration_only_Analysis$Sonde_fell + Filtration_only_Analysis$Boat_wake + Filtration_only_Analysis$Algae +
                         # Quantatative variables
                         Filtration_only_Analysis$Temp_C_Up + Filtration_only_Analysis$Sal_ppt_Up +
                         Filtration_only_Analysis$Turbidity_NTU_Up + Filtration_only_Analysis$Chl_ug_L_Up +
                         Filtration_only_Analysis$avg_depth_cm + Filtration_only_Analysis$d_bw_sondes_m +
                         Filtration_only_Analysis$avg_m_hr + Filtration_only_Analysis$Avg_POM + 
                         Filtration_only_Analysis$Avg_PIM)

summary(LM_PrctChl_sigFilter)
```

FR X TPM
=====================================

### FR by site (all data)
```{r FR vs TPM, fig.height=5, fig.width=6, cache=TRUE}
Filter_data <- Master_analysis_table %>% 
                     filter(Experiment == "Filtration")

Filter_data_pos <- Master_analysis_table %>% 
                     filter(Experiment == "Filtration",
                            L_hr_m2 > 0)

FR_TPM_box <- ggplot((Filter_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = 'Filtration Rate L/hr/m^2')
plot(FR_TPM_box)
```

### FR by site (Positive values only) 
```{r FR by site positive only, cache=TRUE}
FR_TPM_box_pos <- ggplot((Filter_data_pos), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = 'Filtration Rate L/hr/m^2')
plot(FR_TPM_box_pos)
```

### FR vs TPM (Filtration Trials only)
```{r, cache=TRUE}
FR_TPM_graph <- ggplot((Filter_data), aes(Avg_TPM, L_hr_m2 )) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Total Particulate Matter (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_TPM_graph)
```

### FR TPM Linear Model
```{r, cache=TRUE}
FR_TPM_lm <- lm(data = Filter_data, L_hr_m2 ~ Avg_TPM)
summary(FR_TPM_lm)
```

### diagnostic plots
```{r, cache=TRUE}
par(mfrow=c(2,2))
plot(FR_TPM_lm)

```

FR X OC 
=====================================

### FR by OC
```{r FR vs OC, cache=TRUE}
FR_OC_graph <- ggplot(Filter_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_OC_graph)
```

### FR by OC Linear Model
```{r, cache =TRUE}
FR_OC_lm <- lm(data = Filter_data, L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_lm)
```

### Diagnosic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_lm)
```

### Deanza FR by OC
```{r}
FR_OC_NPD_graph <- ggplot(Filter_data %>% filter(Site == "Deanza"),
                          aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Newport Deanza Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_OC_NPD_graph)
```

### Deanza FR by OC Linear Model
```{r}
FR_OC_NPD_lm <- lm(data = (Filter_data %>% filter(Site == "Deanza")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_NPD_lm)
```

### Diagnostic plot
```{r}
par(mfrow=c(2,2))
plot(FR_OC_NPD_lm)
```

### Morro Bay FR by OC
```{r}
FR_OC_MB_graph <- ggplot(Filter_data %>%filter(Site == "Morro Bay"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Morro Bay Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_OC_MB_graph)
```

### MB FR by OC Linear Model
```{r}
FR_OC_MB_lm <- lm(data = (Filter_data %>% filter(Site == "Morro Bay")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_MB_lm)
```

### Diagnositc plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_NPD_lm)
```

### San Rafael FR by OC
```{r}
# San Rafael only
FR_OC_SR_graph <- ggplot(Master_analysis_table %>% filter(Site == "San Rafael"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'San Rafael Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

plot(FR_OC_SR_graph)
```

### SR FR by OC Linear Model
```{r}
FR_OC_SR_lm <- lm(data = (Filter_data %>% filter(Site == "San Rafael")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_SR_lm)
```

### Diagnostic plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_SR_lm)
```

### Shellmaker only
```{r}
FR_OC_NPSM_graph <- ggplot(Filter_data %>% filter(Site == "Shellmaker"),
                           aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Shellmaker Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_OC_NPSM_graph)
```

### Shellmaker FR by OC Linear Model
```{r}
FR_OC_NPSM_lm <- lm(data = (Filter_data %>% filter(Site == "Shellmaker")), L_hr_m2 ~ Avg_OC_Ratio)
summary(FR_OC_NPSM_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_OC_NPSM_lm)
```

L/hr/m^2 X WQ
=====================================

### Temperature
```{r FR vs Water Quality, echo=FALSE}
FR_Temp <- ggplot(Filter_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration by Temprature (Linear Model)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_Temp)
```

### Fr by Temp Linear Model
```{r}
FR_temp_lm <- lm(data = Filter_data, L_hr_m2 ~ Temp_C_Up)
summary(FR_temp_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_temp_lm)
```

### Salinity
```{r echo=FALSE}

FR_Sal <- ggplot(Filter_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration by Salinity (Linear Model)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_Sal)
```

### FR by Salinity Linear Model
```{r}
FR_Sal_lm <- lm(data = Filter_data, L_hr_m2 ~ Sal_ppt_Up)
summary(FR_Sal_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_Sal_lm)
```

### Chlorophyll 
```{r echo=FALSE}
FR_Chl <- ggplot(Filter_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Chlrophyll - All Sites') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_Chl)
```

### FR by Chl Linear Model
```{r}
FR_Chl_lm <- lm(data = Filter_data, L_hr_m2 ~ Chl_ug_L_Up)
summary(FR_Chl_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_Chl_lm)
```

### Turbidity
```{r echo=FALSE}
FR_Turbidity <- ggplot(Filter_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = 'Clearence Rate (L/hr/m^2)',
       title = 'Filtration predicted by Turbidity (All Sites)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FR_Turbidity)
```

### FR by Turbidity Linear Model
```{r}
FR_Turb_lm <- lm(data = Filter_data, L_hr_m2 ~ Turbidity_NTU_Up)
summary(FR_Turb_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(FR_Turb_lm)
```

TPM & OC
=====================================

### TPM by OC
```{r TPM vs OC, echo=FALSE}
TPM_OC <- ggplot(data = Avg_TPM_summary_table, aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM x OC") + 
  theme_classic() +
  #geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(TPM_OC)
```

### Exclude low deanza value
```{r}
TPM_OC_no_ND_low <- ggplot(data = (Avg_TPM_summary_table %>% filter(!(Site == "Deanza") | !(Date == "4/18/19"))),
                             aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM --> OC", 
       subtitle = "Excluding NPD 4/18/19") + 
  theme_classic() +
  #geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(TPM_OC_no_ND_low)
```

### Individual Sites TPM vs OC
```{r TPM vs OC - By Site, echo=FALSE}
OC_TPM_by_Site <- Avg_TPM_summary_table %>% 
  ggplot(aes(x = Avg_TPM, y = Avg_OC_Ratio, group = Site)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = "Total Particulate Matter",
       y = 'Average Organic Content Ratio',
       title = 'OC predicted by TPM (g/L)') +
  facet_wrap(~ Site) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(OC_TPM_by_Site)
```

### Deanza
```{r}
TPM_OC_Deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")),
                        aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM X OC (Deanza)") + 
  theme_classic()
plot(TPM_OC_Deanza)
```

### Shellmaker
```{r}
TP_OC_NPSM <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), 
                     aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM X OC (Shellmaker)") + 
  theme_classic()
plot(TP_OC_NPSM)
```

### San Rafael
```{r}
TP_OC_SR <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")),
                   aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM X OC (San Rafael)") + 
  theme_classic()
plot(TP_OC_SR)
```

### Morro Bay
```{r}
TP_OC_MB <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), 
                   aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey30') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = "Total Particulate Matter", y = "Average Organic Content Ratio", title = "TPM X OC (Morro Bay)") + 
  theme_classic()
plot(TP_OC_MB)
```

DTW - Shell length
=====================================
```{r Oly DTW - Shell length analysis, echo=FALSE}
##Olympia DTW predicted by Shell Length - Newport, CA
NPD_oly <- NPD_density %>% 
  filter(species == "O. lurida") %>% 
  drop_na() %>% 
  as_tibble() %>%
  select(species, length_mm, tissue_dry_weight_g)

Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(Oly_shell_DTW)
```

### Oly DTW Linear Model
```{r}
Oly_DTW_lm <- lm(data = NPD_oly, tissue_dry_weight_g ~ length_mm)
summary(Oly_DTW_lm)
```

### Diagnostic Plots
```{r}
par(mfrow=c(2,2))
plot(Oly_DTW_lm)
```

### Outlier analysis (mean -+ SD * 2.2)
```{r}
find_outlier <- function(data){
  average <- mean(data)
  stdev <- sd(data)
  outlier <- ifelse((data < (average - 2.2 * stdev) | (data > (average + 2.2 * stdev))),
         TRUE, FALSE)
}
# Remove outlier from graph 
NPD_oly_outlier <- NPD_oly %>% 
  mutate(DTW_outlier = find_outlier(NPD_oly$tissue_dry_weight_g))

Oly_shell_DTW_rm_out <- ggplot(NPD_oly_outlier %>% 
                                  filter(DTW_outlier == FALSE), 
                                aes(length_mm, tissue_dry_weight_g)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'Removed outlier') +
  geom_smooth(method=lm, se=TRUE, level=0.95)
plot(Oly_shell_DTW_rm_out)
```

### Linear model without outlier
```{r}
Oly_DTZW_lm_rm_out <- lm(data = NPD_oly_outlier %>% 
                           filter(DTW_outlier == FALSE),
                         tissue_dry_weight_g ~ length_mm)

summary(Oly_DTZW_lm_rm_out)
```

### Diagnostic plots
```{r}
par(mfrow=c(2,2))
plot(Oly_DTZW_lm_rm_out)
```

```{r eval=FALSE, include=FALSE}
## Test sbs correction - SBS corrections applied correctly
NPD_41519_Filter_plot <- fread(file.path("./output/2_Manual_Corrections_Applied", "Insitu_Filter_NPD_41519.csv"))
NPD_41519_Filter_plot <- NPD_41519_Filter_plot %>% 
  filter(Experiment == 'Filtration') 

(regular <- ggplot(NPD_41519_Filter_plot, aes(Time, Chl_ug_L, group = Position, color = Position)) + 
  geom_point())

NPD_41519_Filter_plot_sbs <- fread(file.path("./output/3_Sbs_Corrections_Applied", "Insitu_Filter_NPD_41519.csv"))
NPD_41519_Filter_plot_sbs <- NPD_41519_Filter_plot_sbs %>% 
  filter(Experiment == 'Filtration')

(adjusted <- ggplot(NPD_41519_Filter_plot_sbs, aes(Time, Chl_ug_L, group = Position, color = Position)) + 
  geom_point())

```

Up & Down Chl
=====================================

### Facet Plots
```{r Bar Graphs up vs down, echo=FALSE}
Bar_up_down_data <- Master_analysis_table %>%
  select(Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>%
  rename(Upstream = Chl_ug_L_Up, Downstream = Chl_ug_L_Down) %>%  
  gather(Upstream, Downstream, key = Position, value = Chl_ug_L) %>% 
  mutate(Position = fct_relevel(Position, 'Upstream', 'Downstream')) %>% 
  mutate(Site = fct_relevel(Site, 'Deanza', 'Shellmaker', 'San Rafael', 'Morro Bay')) %>% 
  mutate(Site_exp_date = paste(Site, Experiment,
                                     Date,
                                     sep = ' ')) %>% 
  mutate(Exp_Date = paste(Experiment, Date, sep = ' ')) %>% 
  arrange(Site, mdy(Date))

#Bar_up_down_data$Position <- as.factor(Bar_up_down_data$Position)

Paired_bar_chl_graph <- ggplot(data = Bar_up_down_data, aes(x = Site_exp_date, y = Chl_ug_L, fill = Position)) +
    geom_bar(stat="identity", position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_grid(~ Site, scales = "free", space = "free") + #'free' allows axis b/w sites uneaven
    geom_bar(data = (Bar_up_down_data %>%
                       filter(!Experiment %in% c('Filtration'))),
             color = "grey22",
             stat="identity",
             position = "dodge") +
    labs(x = 'Experiment', y = 'Chlorophyl (ug/L)')
plot(Paired_bar_chl_graph)
```

### Graphs using grid.arrange()
```{r}
############## Try 2 ####### make separate graphs, combine using grid.arrange()

##### Check Dates in final graph - Don't look right - AM 2020_3_22

NPD_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Deanza')

NPD_bar_graph <- ggplot(data = NPD_bar_data, aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPD_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.x = element_blank(),
          legend.position = c(0.9, 0.8),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(y = 'Chlorophyll a (ug/L)', title = "Newport Deanza") +
    scale_x_discrete(labels = NPD_bar_data$Date) +
    ylim(0, 8)

NPSM_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Shellmaker')

NPSM_bar_graph <- ggplot(data = NPSM_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPSM_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Newport Shellmaker") +
    scale_x_discrete(labels = NPSM_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE) 

MB_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Morro Bay')

MB_bar_graph <- ggplot(data = MB_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (MB_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Morro Bay") +
    scale_x_discrete(labels = MB_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

SR_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'San Rafael')

SR_bar_graph <- ggplot(data = SR_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (SR_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "San Rafael") +
    scale_x_discrete(labels = SR_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

Chl_graphs <- list(NPD_bar_graph, NPSM_bar_graph, SR_bar_graph, MB_bar_graph) 
all_chl_graphs <- grid.arrange(grobs = Chl_graphs,
             widths = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1),
             layout_matrix = rbind(c(NA,1,1,1,1,1,1,1,1,1,1,1,1, NA),
                                   c(2,2,2,2,2,3,3,3,3,3,4,4,4,4)))
plot(all_chl_graphs)
ggsave("Insitu_Filter_up_vs_down_all_sites.png", all_chl_graphs)
```

```{r Paire t tests, eval=FALSE, include=FALSE}
#### Paired t-test all filtration trials --- Mean Upstream Chl vs Mean Downstream Chl
####### Double Check this analysis - AM 2020_3_22
Master_analysis_table_FILTER <- Master_analysis_table %>%
  filter(Experiment == 'Filtration')

t.test(Master_analysis_table_FILTER$Chl_ug_L_Up,
       Master_analysis_table_FILTER$Chl_ug_L_Down,
       alternative =c("greater"),
       paired = TRUE,
       conf.level = 0.95)
## No difference between upstream and downstream Chl across all Filtraiton trails

##### Paired t-test on Positive L/hr/m^2 Filtration trails
Master_analysis_table_posFILTER <- Master_analysis_table %>% 
  filter(Experiment == 'Filtration',
         L_hr_m2 > 0)

t.test(Master_analysis_table_posFILTER$Chl_ug_L_Up,
       Master_analysis_table_posFILTER$Chl_ug_L_Down,
       alternative =c("greater"),
       paired = TRUE,
       conf.level = 0.95)
# No difference between upstream and downstream Chl across positive Filtration trials

######### Paired t-test on all trials (Filtraiton & Neg Control)
t.test(Master_analysis_table$Chl_ug_L_Up,
       Master_analysis_table$Chl_ug_L_Down,
       paried = TRUE,
       alternative =c("greater"),
       conf.level = 0.95)
## No difference between upstream and downstream Chl
```

```{r Species_Density_Graphs, echo=FALSE, cache=TRUE}
# Graph Density by Species, exclude absent species

############## Newport Deanza ###################
(Graph_NPD_species_den <-
   ggplot(NPD_may18_species_den[which(NPD_may18_species_den$species_den_m2>0),], 
                               aes(Species, species_den_m2, fill = Species)) + 
  geom_col() + # columns
  theme_classic() + 
  labs (x = 'Bivlave Species', 
        y = 'Density (individuals / m^2)', 
        title = 'Newport Deanza Bivalve Density',
        subtitle = 'May 2018 Survey') +
  guides(fill = FALSE) + # removes color legend
  geom_text(aes(label = species_den_m2), vjust = -0.5)) # able to round values? 
                                                                      
############## Newport Shellmaker ##############
(Graph_NPSM_species_den <-   ggplot(NPSM_may18_species_den[which(NPD_may18_species_den$species_den_m2>0),], 
                                 aes(Species, species_den_m2, fill = Species)) + 
  geom_col() + # columns
  theme_classic() + 
  labs (x = 'Bivlave Species', 
        y = 'Density (individuals / m^2)', 
        title = 'Newport Shellmaker Bivalve Density',
        subtitle = 'May 2018 Survey') +
  guides(fill = FALSE) + # removes color legend
  geom_text(aes(label = species_den_m2), vjust = -0.5)) # able to round values? 


# Save graph to "./0_Graph_Output/Graphs_Bivalve_Density"
# Not needed Whit Rmd Knit yet
######### May need to reformat .pdf  ###########
#ggsave(file.path(Bivlave_density_graph_directory, "NPD_may18_bivalve_species_density.pdf"), Graph_NPD_species_den )
#ggsave(file.path(Bivlave_density_graph_directory, "NPSM_may18_bivalve_species_density.pdf"), Graph_NPSM_species_den )

##### FIgure ####### -->> biomass comparison among species
```