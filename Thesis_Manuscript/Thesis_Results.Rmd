---
output: 
  pdf_document:
    fig_caption: yes
indent: true
---
possibly use template: quarterly-report.tex in YAML header. Use Fullerton_thesis.tex as template?
```{r setup, include = F, cache=FALSE}
library(knitr)
# set default code chunk settings to save figures in Figures folder, show no output, and cache 
knitr::opts_knit$set(root.dir = normalizePath('../'), # set working directory to project level
                      #fig.path = "./Thesis_Manuscript/Figures", 
                      echo = FALSE, warning = FALSE, message = FALSE, 
                     fig.asp=0.618, fig.align = "center")
```

```{r load_packages_data, include=FALSE}
################### Packages ###########################
library(dplyr)
library(tidyr)
library(magrittr)
library(data.table)
library(magrittr)
library(lubridate) # dealing with time and dates
library(ggplot2)
library(ggthemes) # theme_classic() for graphs
library(stringr)
library(hms)
library(viridisLite)
library(forcats)
library(gridExtra)
library(ggpmisc) # package for adding line equation and R^2 to plots
library(viridis) # Color palette - Options: magma , inferno, plasma, viridis, cividis
library(scales)
library(cowplot) # for arranging multiple plots into a single figure
library(wesanderson)
library(olsrr) 
library(xtable) # creates tables in LaTex
library(MASS) # collection of datasets and functions
library(ISLR) # Dataset in Intro to statistical learning

# source functions 
source("./functions.R")
# define output directory
output_directory = "./output"
# create output directories (same as Insitu_Filtraiton_Analysis_script.Rmd)
createOutputDirectories()

##################### Read in Data from  project output ##########################
Master_analysis_table <- fread(file.path('./output/4_Filtration_Calculations/Filtration_Summary', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_bivalves = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))

##################### Data #########################################
# Remove San Diego filtration trial - not applicable to this analysis - different experimental set up
Master_analysis_table <- Master_analysis_table %>% 
  filter(!Site %in% c("San Diego"))

# Order Sites by Latitude
site_by_lat <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 

# transform Site variable to factor and arange by Latitude
Master_analysis_table <- arrange(transform(Master_analysis_table, Site = factor(Site,levels = site_by_lat)), Site)

 # Filtration trials only - exclude Negative controls
Filtration_only_data <- Master_analysis_table %>% 
  filter(Experiment %in% c("Filtration"))

################# Values for Results text #####
# SR filtration trial data
SR_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("San Rafael"),
         Experiment %in% c("Filtration")) 
# SR Negative control data
SR_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("San Rafael"),
         grepl("Neg Control*", Experiment)) 

MB_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Morro Bay"),
         Experiment %in% c("Filtration"))

MB_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Morro Bay"),
         grepl("Neg Control*", Experiment)) 

NPD_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"),
         Experiment %in% c("Filtration"))

NPD_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"),
         grepl("Neg Control*", Experiment)) 

NPSM_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Shellmaker"),
         Experiment %in% c("Filtration"))

NPSM_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Shellmaker"),
         grepl("Neg Control*", Experiment)) 

# Filtration trials only - exclude Negative controls & Percent Chl removed greater than 0
### Important Note ## When Percent Chl removed is positive, so is L/hr/m^2 and vice visa. 
# Filtering by pcnt_Chl_rmvd effectively filters both values the same, so further analysis 
# withFiltration_pos_data serves both purposes. 
Filtration_pos_data <- Filtration_only_data %>% 
  filter(pcnt_Chl_rmvd > 0)

# Deanza data only - all trials
Deanza_data_all <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"))
# Deanza only - Filtraiton trials only
Deanza_Filter_data <- Deanza_data_all %>% 
  filter(Experiment %in% c("Filtration"))
# Deanza only- Positive Filtration only
Deanza_PosFilter_data <- Deanza_Filter_data %>% 
  filter(pcnt_Chl_rmvd > 0)

### Average TPM Data ######################
Avg_TPM_summary_table <- arrange(transform(Avg_TPM_summary_table, Site = factor(Site, levels = site_by_lat)), Site)

############### model formulas ###############
# linear model formula
x_y_formula <- y ~ x 
# Quadratic model
x2_y_formula <- y ~ poly(x, degree = 2)
# Exponential model
logy_x_formula <- log(y) ~ x
# logx
y_logx_fomula <- y ~ log(x)
# double log
logy_logx_formula <- log(y) ~ log(x)

############### Site Color Assignments ###############
viridis(4)
Site_colors <- c("San Rafael" = "#440154FF",
                 "Morro Bay" = "#31688EFF",
                 "Shellmaker" = "#35B779FF",
                 "Deanza" = "#FDE725FF")

############### Bivalve Species Color Assignments ###############
# wes_palettes # lists all current palattes 
# Color palette for Species - Royal2, Darjeeling2, Cavalcanti1, BottleRocket2, IsleofDogs1
density_palette <- rev(wes_palette("IsleofDogs1", 7, type = c("continuous")))
Species_colors <- c("Adula diegensis" = "#8D8680",
                    "Argopecten ventricosa" = "#CCC3C5",
                    "Crassostrea gigas" = "#6D6340",
                    "Geukensia demissa" = "#524D4F",
                    "Musculista senhousia" = "#B0915B",
                    "Mytilus galloprovincialis" = "#7E4B41",
                    "Ostrea lurida" = "#9986A5",
                    "Unknown mussel" = "black")

################# Labels for graphs  #########################
Hab_FR_Label <- expression('Habitat Filtration Rate (L/hr/m'^2*')')
Prt_Chl_Label <- expression(paste('Percent Chlorophyll ', alpha, ' Removed'))
Chl_ugL_Label <- expression(paste("Chlorophyll ", alpha, " (", mu, "g/L) "))
TPM_Label <- expression(paste('Total Particulate Matter (', mu,"g/L)"))
PIM_Label <- expression(paste('Particulate Inorganic Matter (', mu,"g/L)"))

###################### Functions ####################################
# function for number of samples - display on graph
n_mean_stats <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  'mean =', round(mean(x), 1), '\n')
                )
         )
}
# function for number of samples - 3 decimal places
n_mean_stats3 <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  'mean =', round(mean(x), 3), '\n')
                )
         )
}

# function to calculate average, standard deviation, outlier data. 
find_outlier <- function(data){
  average <- mean(data)
  stdev <- sd(data)
  # Outlier data defined by outside 2.2 standard deviations from the mean 
  outlier <- ifelse((data < (average - 2.2 * stdev) | (data > (average + 2.2 * stdev))),
         TRUE, FALSE)
}
```

# Results

### Chlorophyll drawdown

Field work was conducted from February 2018 to June 2019 and produced 28 usable trials (filtration and negative controls) across the four sites.
Filtration trials at San Rafael were conducted on the ebb and flood tides surround a low tide.
Three filtration trials conducted on flood tides (7/7/18, 7/18/18, 9/10/18), 1 ebb filtration trial (11/8/18), and 1 ebb negative control (11/7/18).
We recorded 4 filtration trials and 1 negative control at Morro Bay, all conducted on flood tides (Table 1).
At Newport Shellmaker we recorded 4 filtration and 1 negative control trial on flood tides.
Newport Deanza had the most field days with 10 filtration and 3 negative controls all conducted on ebb tides. 

### Percent chlorophyll $\alpha$ removal

Percent Chl $\alpha$ removal at the San Rafael *O. lurida* reef from `r nrow(SR_filter_sum)` field days ranged from `r round(min(SR_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(SR_filter_sum$pcnt_Chl_rmvd),1)`\% and recorded `r round(SR_NC_sum$pcnt_Chl_rmvd,1)`\% in the single negative control over bare mudflat. 
Morro Bay *C. gigas* aquaculture lines from `r nrow(MB_filter_sum)` field days ranged from `r round(min(MB_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(MB_filter_sum$pcnt_Chl_rmvd),1)`\% and over bare mud flat `r round(MB_NC_sum$pcnt_Chl_rmvd,1)`\%. 
At the Newport Bay Deanza *O. lurida* bed, Chl $\alpha$ removal ranged from `r round(min(NPD_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(NPD_filter_sum$pcnt_Chl_rmvd),1)`\% from `r nrow(NPD_filter_sum)` field days and `r format(round(min(NPD_NC_sum$pcnt_Chl_rmvd)), nsmall = 1)`\% to `r format(round(max(NPD_NC_sum$pcnt_Chl_rmvd)),nsmall = 1) `\% over `r nrow(NPD_NC_sum)` negative control trials on a single field day.
The Newport Bay Shellmaker *O. lurida* bed ranged from `r round(min(NPSM_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(NPSM_filter_sum$pcnt_Chl_rmvd),1)`\% Chl $\alpha$ removal over `r nrow(NPSM_filter_sum)` field days and `r round(NPSM_NC_sum$pcnt_Chl_rmvd,1)`\% Chl $\alpha$ removal in the single negative control. 
Table 1 summarizes water quality, field conditions, and calculations of all field days.
Reference Figure 1 Chl removal. 

### Habitat Clearance Rates 

Habitat clearance rates (HCR) adjust the percent Chl $\alpha$ by the area of habitat contributing to the Chl $\alpha$ drawdown.
HCR at Ran Rafael ranged from `r format(round(min(SR_filter_sum$L_hr_m2)), nsmall =1)` to `r round(max(SR_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^. 
Morro Bay *C. gigas* aquaculture ranged from `r format(round(min(MB_filter_sum$L_hr_m2)), nsmall =1)` to `r round(max(MB_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^.
Newport Shellmaker ranged from `r round(min(NPSM_filter_sum$L_hr_m2),1)` to `r round(max(NPSM_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^.
Newport Deanza ranged from `r round(min(NPD_filter_sum$L_hr_m2),1)` to `r round(max(NPD_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^ (Figure 1).
Negative control trials measured `r round(SR_NC_sum$L_hr_m2,1)`, `r round(MB_NC_sum$L_hr_m2,1)`, and `r round(NPSM_NC_sum$L_hr_m2,1)` Lhr^-1^m^2^ for San Rafael, Morro Bay, and Newport Shellmaker respectively.
Newport Deanza's three consecutive negative control trials ranged from `r format(round(min(NPD_NC_sum$L_hr_m2)), nsmall= 1)` to `r format(round(max(NPD_NC_sum$L_hr_m2)), nsmall= 1)` Lhr^-1^m^2^.


```{r Final_Summary_table, eval=FALSE, include=FALSE}
#results= 'asis'
library(xtable) # load xtable package 
#options(xtable.floating = FALSE)
options(xtable.timestamp = FALSE)

# Organize & clean summary table data
Final_table <- Master_analysis_table %>%
  mutate(Date = mdy(Date),
         Temp_C_Up = round(Temp_C_Up, digits = 2),
         Sal_ppt_Up = round(Sal_ppt_Up, digits = 1),
         Turbidity_NTU_Up = round(Turbidity_NTU_Up, digits = 1),
         Avg_TPM = round(Avg_TPM, digits = 4),
         Avg_OC_Ratio = round(Avg_OC_Ratio, digits = 4),
         Chl_ug_L_Up = round(Chl_ug_L_Up, digits = 1),
         Chl_ug_L_Down = round(Chl_ug_L_Down, digits = 1),
         avg_depth_m = avg_depth_cm*100,
         avg_m_hr = round(avg_m_hr, digits = 0),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1),
         L_hr_m2 = round(L_hr_m2, digits = 0)) %>%
  dplyr::select(Site, Date, Experiment, Temp_C_Up, Sal_ppt_Up, Turbidity_NTU_Up, Avg_TPM, 
          Avg_OC_Ratio, Chl_ug_L_Up, Chl_ug_L_Down, avg_depth_cm, d_bw_sondes_m, avg_m_hr, 
          pcnt_Chl_rmvd, L_hr_m2) %>% 
 dplyr::arrange(Site, Date)
# Make date formated as character to display properly
Final_table$Date <- as.character(Final_table$Date)
colnames(Final_table) <- c( "Site", "Date", "Experiment", "Temp ($\\textdegree$C)","Salinity (ppt)", "Turbidity (NTU)", "TPM ($\\mu$g/L)",
                           "OC", "Chl $\\alpha$ up ($\\mu$g/L)", "Chl $\\alpha$ down ($\\mu$g/L)", 
                           "Avg depth (m)","Distance (m)", "Avg water veolcity (m/hr)", "% Chl $\\alpha$ removal", "Clearance rate (L/hr/$m^2$)")
# create xtable
sumtable_side_LaTex <- xtable(Final_table, caption = c("Summary Table of all field days"), 
                              display= c("s","s","s","s","f","f","f","f","f","f","f","f","f","f","f","f"))

# print LaTex code for sideways table
print(sumtable_side_LaTex, type = "latex", include.rownames = FALSE)
#sanitize.colnames.function=function(x){x}
# sanitize.text.function=function(x){x}
  #sanitize.text.function = xtable::sanatize(),
  #include.rownames = FALSE
  #  floating = TRUE,
  # caption.placement = "top"
  # floating.environment = "sidewaystable"
```

```{R Summary_Table, eval=FALSE, include=FALSE}
df <- data.frame(A = c(1:10),
                 B = c(11:20),
                 C = c(21:30))

xtable(df)
df
# print LaTex code for sideways table
print.xtable(xtable(df))
sum_table2 <- xtable(df, display = c("s","f","f","f"))
sum_table2
```

```{r T_test_table, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}

T_test_Table <- Master_analysis_table %>%
  mutate(Date = mdy(Date),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1),
         Mean_Chl_diff = round(Mean_Chl_diff, digits = 2),
         StDev_Chl_diff = round(StDev_Chl_diff, digits = 2),
         StEr_Chl_diff = round(StEr_Chl_diff, digits = 2),
         statistic = round(statistic, digits = 2), # t-statistic 
         p.value = round(p.value, digits = 2),
         parameter = round(parameter, digits = 2),
         conf.low = round(conf.low, digits = 2)) %>% 
  dplyr::select(Site, Date, Experiment, pcnt_Chl_rmvd, Mean_Chl_diff, StDev_Chl_diff, StEr_Chl_diff,
                statistic, p.value, parameter, conf.low) %>% 
  group_by(Site) %>% 
  arrange(Date, .by_group = T)
# Make date formated as character to display properly
T_test_Table$Date <- as.character(T_test_Table$Date)

```


```{r FR_ChlRmd_Site_boxplot, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.show="hold", fig.asp=0.618, fig.width=4.3, out.width="50%", message= F, fig.cap="The habitat level filtration rates and percent chlorophyll removed of all filtration trials across sites. \\label{figurelabel}"}
### Filtration by site (Filtration Trials only)

FR_box <- ggplot((Filtration_only_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label)+
  ylim(-2500, 1300)
plot(FR_box) 

Chl_Rmd_box <- ggplot(Filtration_only_data, aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  #scale_y_continuous(labels = percent) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label) 
plot(Chl_Rmd_box)

#FR_Site_boxplot <- grid.arrange(FR_box, Chl_Rmd_box, nrow = 1)
#FR_Site_boxplot
#ggsave(FR_Site_boxplot, 
      # filename = "FR_Site_boxplot.pdf", 
      # path = "./Figures", 
       #fig.width = 6,
       #scale = 1 )

```

```{r FR_ChlRmd_Site_posFilter_boxplot, echo=FALSE, fig.keep = 'all', dev = 'pdf',fig.show="hold", fig.align="default", fig.asp=0.618, fig.width=4.3, out.width="50%", message= F, fig.cap="The habitat level filtration rates and percent chlorophyll removed of filtration trials (positive values only) across sites. \\label{figurelabel}"}
# Filtration_pos_data defined in setup

FR_pos_box <- ggplot((Filtration_pos_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label)

plot(FR_pos_box)

ChlRmd_pos_box <- ggplot((Filtration_pos_data), aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) +
    geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label)
plot(ChlRmd_pos_box)

#grid.arrange(FR_TPM_box_pos, Chl_Rmd_box_pos, nrow = 1)
```

```{r FR_ChlRmd_TPM_point, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.show="hold", fig.align="default", fig.asp=0.618, fig.width=4.3, out.width="50%", warning = F, fig.cap="The habitat level filtration rates and percent chlorophyll removed of positive filtration trials in response to seston total particulate matter (TPM) . \\label{figurelabel}"}
FRPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, L_hr_m2 )) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE)
  # line equation on graph
 # ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
  #             formula = x_y_formula,
   #            parse = TRUE,
     #          label.x = "right",
      #         label.y = "bottom")

plot(FRPos_TPM_graph)

Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  theme(legend.position = c(.85,.75),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) + 
  labs(x = TPM_Label,
       y = Prt_Chl_Label) 
 # guides(color = FALSE) 
  # line equation on graph
  #ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
   #            formula = x_y_formula,
    #           parse = TRUE,
     #          label.x = "right",
      #         label.y = "bottom")

plot(Chl_RmdPos_TPM_graph)

#grid.arrange(FRPos_TPM_graph, Chl_RmdPos_TPM_graph, nrow = 1)
```

```{r FRpos_TPM_LM, eval=FALSE,  include=FALSE}
FRPos_TPM_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_TPM)
#summary(FR_TPM_lm)
ols_regress(FRPos_TPM_lm)
# Not significant
```

```{r ChlRmdpos_TPM_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_TPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_TPM)
#summary(ChlRmdPos_TPM_lm)
ols_regress(ChlRmdPos_TPM_lm)
# Not significant
```

```{r ChlRmdpos_TPM_LM_diagnostics, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_TPM_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_TPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_TPM_lm)
```

```{r ChlRmd_TPM_Transform, eval=FALSE, fig.width=12, include=FALSE}
Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# log-log model predicitons
logChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_TPM))
# create range of Salinity values to predict with model
TPM_newrange <- data.frame(Avg_TPM = seq(from = 0, to = 0.04, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogTPM_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logTPM_lm, newdata = TPM_newrange)))
pred_loglog_TPM_df <- data.frame(TPM_newrange, loglogTPM_Pred)
  

logChlRmdPos_logTPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglog_TPM_df, aes(x = Avg_TPM, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'log(Y) ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons
ChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_TPM))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logTPM_lm, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

ChlRmdPos_logTPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'Y ~ log(X)') +
  guides(fill = FALSE)

# Y~x + x^2 model predicitons
ChlRmdPos_TPM2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Avg_TPM, degree = 2, raw = T))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
TPM2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_TPM2_lm, newdata = TPM_newrange))
pred_TPM2_df <- data.frame(TPM_newrange, TPM2_Pred)

ChlRmdPos_TPM2_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_line(data = pred_TPM2_df, aes(x = Avg_TPM, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'Y ~ x + x^2') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x2_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(Chl_RmdPos_TPM_graph, logChlRmdPos_logTPM_graph, 
             ChlRmdPos_logTPM_graph, ChlRmdPos_TPM2_graph, nrow = 2)
```

```{r logChlRmdPos_logTPM_lm, eval=FALSE,  include=FALSE}
logChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_TPM))
#summary(ChlRmdPos_TPM_lm)
ols_regress(logChlRmdPos_logTPM_lm)
```

```{r logChlRmdPos_logTPM_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(logChlRmdPos_logTPM_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logTPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logTPM_lm)
```

```{r ChlRmdPos_logTPM_lm, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_TPM))
#summary(ChlRmdPos_logTPM_lm)
ols_regress(ChlRmdPos_logTPM_lm)
```

```{r ChlRmdPos_TPM2_lm, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_TPM2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Avg_TPM, degree = 2, raw = T))
#summary(ChlRmdPos_TPM_lm)
ols_regress(ChlRmdPos_TPM2_lm)
```

```{r ChlRmdPos_TPM2_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_TPM2_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logTPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logTPM_lm)
```

```{r NPD_FRPos_TPM_graph, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.show="hold", fig.align="default", fig.asp=0.618, fig.width=4.3, out.width="50%", message= F, fig.cap="The positive habitat level filtration rates in response to seston total particulate matter (TPM) at the Deanza site in Newport Bay, California. \\label{figurelabel}"}
NPD_FRPos_TPM_graph <- ggplot((Deanza_PosFilter_data), aes(Avg_TPM, L_hr_m2 )) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(NPD_FRPos_TPM_graph)

NPD_ChlRmdPos_TPM_graph <- ggplot((Deanza_PosFilter_data), aes(Avg_TPM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label) +
  guides(color = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(NPD_ChlRmdPos_TPM_graph)
#grid.arrange(NPD_FRPos_TPM_graph, NPD_ChlRmdPos_TPM_graph, nrow = 1)
```

```{r NPD_FRpos_TPM_LM, eval=FALSE, cache=T, include=FALSE}
NPD_PosFR_TPM_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_TPM)
ols_regress(NPD_PosFR_TPM_lm)
```

```{r NPD_ChlRmdPos_TPM_LM, eval=FALSE, cache=T, include=FALSE}
NPD_PosChlRmd_TPM_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_TPM)
ols_regress(NPD_PosChlRmd_TPM_lm)
```

```{r NPD_PosChlRmd_TPM_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_PosChlRmd_TPM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_PosChlRmd_TPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_PosChlRmd_TPM_lm)
```

```{r FRPos_Chlpos_PIM, eval=FALSE, include=FALSE}
FRPos_PIM_graph <- ggplot(Filtration_pos_data, aes(Avg_PIM, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = PIM_Label,
       y = Hab_FR_Label,
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FRPos_PIM_graph)

Chl_RmdPos_PIM_graph <- ggplot(Filtration_pos_data, aes(Avg_PIM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = PIM_Label,
       y = Prt_Chl_Label,
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FRPos_PIM_graph)
#grid.arrange(FRPos_PIM_graph, Chl_RmdPos_PIM_graph, nrow = 1)
```

```{r FRPos_PIM_LM, eval=FALSE,  include=FALSE}
FRPos_PIM_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_PIM)
ols_regress(FRPos_PIM_lm)
```

```{r ChlRmdPos_PIM_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_PIM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_PIM)
ols_regress(ChlRmdPos_PIM_lm)
```

```{r ChlRmdPos_PIM_LM_Diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_PIM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_PIM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_PIM_lm)
```

```{r Deanza_Filter_Pos_PIM, eval=FALSE,  include=FALSE}
NPD_FRPos_PIM_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_PIM, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = PIM_Label,
       y = Hab_FR_Label,
       title = 'Deanza Positive Filtration') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_PIM_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_PIM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = PIM_Label,
       y = Prt_Chl_Label,
       title = 'Deanza Positive Filtration') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(NPD_FRPos_PIM_graph, NPD_ChlRmdPos_PIM_graph, nrow = 1)
```

```{r NPD_FRpos_PIM_LM, eval=FALSE,  include=FALSE}
NPD_FRpos_PIM_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_PIM)
ols_regress(NPD_FRpos_PIM_lm)
```

```{r NPD_ChlRmdpos_PIM_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdpos_PIM_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_PIM)
ols_regress(NPD_ChlRmdpos_PIM_lm)
```

```{r NPD_ChlRmdpos_PIM_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_ChlRmdpos_PIM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_ChlRmdpos_PIM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_ChlRmdpos_PIM_lm)
```

```{r FRPos_OC, eval=FALSE,   include=FALSE}
FRPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_RmdPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FRPos_OC_graph, Chl_RmdPos_OC_graph, nrow = 1)
```

```{r FRPos_OC_LM, eval=FALSE,  include=FALSE}
FRPos_OC_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_OC_Ratio)
ols_regress(FRPos_OC_lm)
```

```{r ChlrRmdPos_OC_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
ols_regress(ChlRmdPos_OC_lm)
```

```{r ChlRmdPos_OC_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_OC_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_OC_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_OC_lm)
```

```{r ChlRmdPos_OC_LM_Trans, eval=FALSE,  include=FALSE}
logChl_RmdPos_logOC_graph <- ggplot(Filtration_pos_data, 
                                    aes(log(Avg_OC_Ratio), log(pcnt_Chl_rmvd))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = expression(paste(log[n],' Organic Content of Seston (fraction)')),
       y = expression(paste(log[n], " Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE)

# log-log model predicitons
logChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
OC_newrange <- data.frame(Avg_OC_Ratio = seq(from = 0.6, to = 1, by = 0.025))
loglogOC_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logOC_lm, newdata = OC_newrange)))
pred_loglogOC_df <- data.frame(OC_newrange, loglogOC_Pred)

ChlRmdPos_loglogOC_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogOC_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'log(y) ~ log(x)') +
  guides(fill = FALSE)

# Y-log model predicitons
ChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
logOC_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logOC_lm, newdata = OC_newrange))
pred_logOC_df <- data.frame(OC_newrange, logOC_Pred)

ChlRmdPos_logOC_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logOC_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'y ~ log(x)') +
  guides(fill = FALSE)

# Y-x + x^2 model predicitons
ChlRmdPos_OC2_lm <- lm(data = Filtration_pos_data, 
                         pcnt_Chl_rmvd ~ poly(Avg_OC_Ratio, degree = 2, raw = T))
OC2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_OC2_lm, newdata = OC_newrange))
pred_OC2_df <- data.frame(OC_newrange, OC2_Pred)

ChlRmdPos_OC2_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_OC2_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'y ~ x + x^2') +
  guides(fill = FALSE)

grid.arrange(logChl_RmdPos_logOC_graph, ChlRmdPos_loglogOC_graph,
             ChlRmdPos_logOC_graph, ChlRmdPos_OC2_graph, nrow = 2)

```

```{r ChlRmdPos_Loglog_LM, eval=FALSE,  include=FALSE}
logChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
ols_regress(logChlRmdPos_logOC_lm)
```

```{r ChlRmdPos_OC_logLM, eval=FALSE,  include=FALSE}
ChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
ols_regress(ChlRmdPos_logOC_lm)
```

```{r ChlrRmdPos_OC_PolyLM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC2_lm <- lm(data = Filtration_pos_data, 
                       pcnt_Chl_rmvd ~ poly(Avg_OC_Ratio, degree = 2, raw = T))
ols_regress(ChlRmdPos_OC2_lm)
```

```{r Deanza_Filter_Pos_OC_graph, eval=FALSE,  include=FALSE}
FRPos_OC_NPD_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plor(FRPos_OC_NPD_graph)

Chl_RmdPos_OC_NPD_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(Chl_RmdPos_OC_NPD_graph)
#grid.arrange(FRPos_OC_NPD_graph, Chl_RmdPos_OC_NPD_graph, nrow = 1)
```

```{r NPD_FRpos_OC_LM, eval=FALSE,  include=FALSE}
FRPos_OC_NPD_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_OC_Ratio)
ols_regress(FRPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC_NPD_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
ols_regress(ChlRmdPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_OC_NPD_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_OC_NPD_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_logLM, eval=FALSE,  include=FALSE}
ChlRmdPos_logOC_NPD_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
ols_regress(ChlRmdPos_logOC_NPD_lm)
```

```{r ANOVA_ChlRmdPos_OC_NPD_LM, eval=FALSE, include=FALSE}
anova(ChlRmdPos_OC_NPD_lm, ChlRmdPos_logOC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_loglogLM, eval=FALSE,  include=FALSE}
logChlRmdPos_logOC_NPD_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
ols_regress(logChlRmdPos_logOC_NPD_lm)
```

```{r TPM_OC_graphs, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="center", fig.asp=0.618, fig.width=6, out.width = "70%", message= F, fig.cap="The relationship between seston total particulate matter (TPM) and seston organic content (OC) across all sites and all filtration and negative control trials. \\label{figurelabel}"}

TPM_OC <- ggplot(data = Avg_TPM_summary_table, aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio") + 
  theme_classic() +
  theme(legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.position = c(.9,.25)) +
  #geom_text(aes(label=Date), nudge_x = 0.007, nudge_y = 0, check_overlap = T)
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "center",
               label.y = "bottom")
plot(TPM_OC)

# I don't think a box plot is valuable to show the relationship (AM- 2020_8_24)
TPM_box <- ggplot((Avg_TPM_summary_table), aes(Site, Avg_TPM)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats3, geom = "text") + # mean isn't working 
  labs(x = 'Site',
       y = TPM_Label,
       title = "Total Particulate Matter by Site")
# I don't think a box plot is valuable to show the relationship (AM- 2020_8_24)
OC_box <- ggplot((Avg_TPM_summary_table), aes(Site, Avg_OC_Ratio)) +
  geom_boxplot(color = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats3, geom = "text") + 
  labs(x = 'Site',
       y = "Average Organic Content Ratio",
       title = "Seston Organic Content Ratio by Site")

# Y-log model
# I don't think a log transformation is valuable to show the relationship (AM- 2020_8_24)
OC_logTPM_all_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ log(Avg_TPM))
TPM_newrange <- data.frame(Avg_TPM = seq(from = 0, to = 0.075, by = 0.005))
TPMlog_Pred <- data.frame(Avg_OC_Ratio = predict(OC_logTPM_all_LM, newdata = TPM_newrange))
pred_TPMlog_df <- data.frame(TPM_newrange, TPMlog_Pred)

OC_logTPM_graph <- ggplot(Avg_TPM_summary_table, aes(Avg_TPM, Avg_OC_Ratio)) +
  geom_line(data = pred_TPMlog_df, aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = TPM_Label,
       y = "Average Organic Content Ratio",
       title = 'All trials',
       subtitle = 'y ~ log(x)')

# grid.arrange(OC_box, TPM_box, TPM_OC, OC_logTPM_graph, nrow = 2)
```

```{r TPM_OC_LM, eval=FALSE,  include=FALSE}
OC_TPM_all_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ Avg_TPM)
ols_regress(OC_TPM_all_LM)
```

```{r OC_logTPM_all_LM, eval=FALSE,  include=FALSE}
OC_logTPM_all_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ log(Avg_TPM))
ols_regress(OC_logTPM_all_LM)
```

```{r OC_logTPM_all_LM_diag, eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(OC_logTPM_all_LM)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(OC_logTPM_all_LM)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(OC_logTPM_all_LM))
```

```{r logOC_logTPM_all_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logOC_logTPM_all_LM <- lm(data = Avg_TPM_summary_table, log(Avg_OC_Ratio) ~ log(Avg_TPM))
ols_regress(logOC_logTPM_all_LM)
```

```{r TPM_OC_Sites_graphs, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="default", fig.asp=0.618, fig.width=8, message= F, fig.cap="The relationship between seston total particulate matter (TPM) and seston organic content (OC) across all sites and all trials. \\label{figurelabel}"}

TPM_OC_Deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")),
                        aes(x = Avg_TPM, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Deanza") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_NPSM <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), 
                     aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Shellmaker") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_SR <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")),
                   aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "San Rafael") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_MB <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), 
                   aes(x = Avg_TPM, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Morro Bay") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_bysite_graph <- grid.arrange(TPM_OC_Deanza, TPM_OC_NPSM, TPM_OC_SR, TPM_OC_MB, nrow = 2)
# using plot() renders plot twice. Grid.arrange must render on its own
# plot(TPM_OC_bysite_graph)
```

```{r SR_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_SR <- Avg_TPM_summary_table %>% filter(Site == "San Rafael")

OC_TPM_SR_LM <- lm(data = TPM_SR, Avg_OC_Ratio ~ Avg_TPM)
ols_regress(OC_TPM_SR_LM)
```

```{r MB_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_MB <- Avg_TPM_summary_table %>% filter(Site == "Morro Bay")

OC_TPM_MB_LM <- lm(data = TPM_MB, Avg_OC_Ratio ~ Avg_TPM)
ols_regress(OC_TPM_MB_LM)
```

```{r NPSM_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPSM <- Avg_TPM_summary_table %>% filter(Site == "Shellmaker")

OC_TPM_NPSM_LM <- lm(data = TPM_NPSM, Avg_OC_Ratio ~ Avg_TPM)
ols_regress(OC_TPM_NPSM_LM)
```

```{r NPD_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_TPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ Avg_TPM)
ols_regress(OC_TPM_NPD_LM)
```

```{r NPD_TPM_OC_LMlog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_logTPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ log(Avg_TPM))
ols_regress(OC_logTPM_NPD_LM)
```

```{r NPD_TPM_OC_LMloglog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

logOC_logTPM_NPD_LM <- lm(data = TPM_NPD, log(Avg_OC_Ratio) ~ log(Avg_TPM))
ols_regress(logOC_logTPM_NPD_LM)
```

```{r Filter_Temp, eval=FALSE, fig.height=5, fig.width=14,  include=FALSE}

FR_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Positive ChlRmd') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_pos_Temp, Chl_Rmd_pos_Temp, nrow = 1)
```

```{r FRpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(FRPos_temp_lm)
```

```{r ChlRmdpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(ChlRmdPos_temp_lm)
```

```{r ChlRmdpos_Temp_diag, eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_temp_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_temp_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_temp_lm))
```

```{r NPD_Filter_Temp, eval=FALSE, fig.height=10, fig.width=12,  include=FALSE}

NPD_Chl_RmdPos_Temp <- ggplot(Deanza_PosFilter_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Deanza Positive Filter Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Predict Y ~ log(x) model
NPD_ChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Temp_C_Up))
Temp_newrange <- data.frame(Temp_C_Up = seq(from = 18, to = 21, by = 0.25))
Templog_Pred <- data.frame(pred_ChlRmd = predict(NPD_ChlRmdPos_logtemp_lm, newdata = Temp_newrange))
pred_Templog_df <- data.frame(Temp_newrange, Templog_Pred)

NPD_ChlRmdPos_logTemp_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Templog_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'y ~ log(x)') +
  guides(fill = FALSE)

# Predict log(Y) ~ log(x) model
NPD_logChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Temp_C_Up))
Temploglog_Pred <- data.frame(pred_ChlRmd = exp(predict(NPD_logChlRmdPos_logtemp_lm, newdata = Temp_newrange)))
pred_Temploglog_df <- data.frame(Temp_newrange, Temploglog_Pred)

NPD_ChlRmdPos_loglogTemp_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Temploglog_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'log(y) ~ log(x)') +
  guides(fill = FALSE)

# Predict Y ~ x + x^2 model
NPD_ChlRmdPos_temp2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Temp_C_Up, degree = 2, raw = T))
Temp2_Pred <- data.frame(pred_ChlRmd = predict(NPD_ChlRmdPos_temp2_lm, newdata = Temp_newrange))
pred_Temp2_df <- data.frame(Temp_newrange, Temp2_Pred)

NPD_ChlRmdPos_Temp2_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Temp2_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'y ~ x + x^2') +
  guides(fill = FALSE)

grid.arrange(NPD_Chl_RmdPos_Temp, NPD_ChlRmdPos_logTemp_graph,
             NPD_ChlRmdPos_loglogTemp_graph, NPD_ChlRmdPos_Temp2_graph, nrow = 2)
```

```{r NPD_ChlRmdpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_temp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(NPD_ChlRmdPos_temp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Temp_C_Up))
ols_regress(NPD_ChlRmdPos_logtemp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_logChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Temp_C_Up))
ols_regress(NPD_logChlRmdPos_logtemp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_temp2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Temp_C_Up, degree = 2, raw = T))
ols_regress(NPD_ChlRmdPos_temp2_lm)
```

```{r Filter_Salinity, eval=FALSE, fig.height=5, fig.width=14,  include=FALSE}

FR_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'Positive FR only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_pos_Sal, Chl_Rmd_pos_Sal, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Sal_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Sal_ppt_Up)
ols_regress(FRPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
ols_regress(ChlRmdPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_Sal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_Sal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_Sal_lm))
```

```{r LogChlRmdPos_LogSalinity_graph, eval=FALSE, fig.height=12, fig.width=12,  include=FALSE}
### Graph with log-log axes
logChlRmd_pos_logSal_graph <- ggplot(Filtration_pos_data, aes(log(Sal_ppt_Up), log(pcnt_Chl_rmvd))) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = expression('log'[n]*' Salinity Upstream (ppt)'),
       y = expression(paste(log[n], " Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only') +
  stat_poly_eq(formula = x_y_formula, parse = TRUE)

# log-log model
logChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Sal_ppt_Up))
# create range of Salinity values to predict with model
Sal_newrange <- data.frame(Sal_ppt_Up = seq(from = 29, to = 38, by = 0.5))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogSal_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logSal_lm, newdata = Sal_newrange)))
pred_loglog_Sal_df <- data.frame(Sal_newrange, loglogSal_Pred)

# model coefficents 
#coef(logChlRmdPos_logSal_lm)

## Graph with regualar x & y axes, log-log model
logChlRmd_pos_logSal_graph2 <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglog_Sal_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "Log(y) ~ Log(x) pretty sure correct line")

# log X transformed model
ChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Sal_ppt_Up))
pred_ChlRmdPos_logSal_df <- data.frame(Sal_newrange,
                                       pred_ChlRmd = predict(ChlRmdPos_logSal_lm, 
                                                             newdata = Sal_newrange))

ChlRmd_pos_logSal_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_logSal_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~ log(x)")

# Polynomial ^2 transformation
ChlRmdPos_Sal2_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 2, raw = T))
# predict values with model and new Sal range values
Sal2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Sal2_lm, newdata = Sal_newrange))
pred_ChlRmdPos_Sal2_df2 <- data.frame(Sal_newrange, Sal2_Pred)

ChlRmd_pos_Sal2_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_Sal2_df2, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~  x + x^2")

# Polynomial ^3 transformation
ChlRmdPos_Sal3_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 3, raw = T))
pred_ChlRmdPos_Sal3_df <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Sal3_lm, newdata = Sal_newrange),
                                       Sal_newrange)

ChlRmd_pos_Sal3_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_Sal3_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~  x + x^3")

grid.arrange(logChlRmd_pos_logSal_graph, logChlRmd_pos_logSal_graph2, 
             ChlRmd_pos_logSal_graph, ChlRmd_pos_Sal2_graph, ChlRmd_pos_Sal3_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Sal_ppt_Up))
ols_regress(logChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(logChlRmdPos_logSal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logSal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logSal_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Sal_ppt_Up))
ols_regress(ChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_logSal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_logSal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_logSal_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
anova(ChlRmdPos_Sal_lm, ChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal2_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Sal2_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal3_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 3, raw = T))
ols_regress(ChlRmdPos_Sal2_lm)
```

```{r NPD_Filter_Salinity, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}
NPD_FRPos_Salinity <- ggplot(Deanza_PosFilter_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'NPD Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Salinity <- ggplot(Deanza_PosFilter_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'NPD Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(NPD_FRPos_Salinity, NPD_ChlRmdPos_Salinity, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Sal_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Sal_ppt_Up)
ols_regress(NPD_FRPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Sal_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
ols_regress(NPD_ChlRmdPos_Sal_lm)
```

```{r Filter_Chl, eval=FALSE, fig.height=15, fig.width=14,  include=FALSE}

FR_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Y-log model
ChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
# create range of Salinity values to predict with model
Chl_newrange <- data.frame(Chl_ug_L_Up = seq(from = 0, to = 8, by = 0.5))
logChl_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logChl_lm, newdata = Chl_newrange))
pred_logChl_df <- data.frame(Chl_newrange, logChl_Pred)

ChlRmdpos_Chllog_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logChl_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ log(x)')

# log-log model
ChlRmdPos_loglogChl_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogChl_Pred <- data.frame(pred_ChlRmd = exp(predict(ChlRmdPos_loglogChl_lm, newdata = Chl_newrange)))
pred_loglogChl_df <- data.frame(Chl_newrange, loglogChl_Pred)

ChlRmdpos_Chlloglog_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogChl_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'log(y) ~ log(x)')

# Y-x + x^2 model
ChlRmdPos_Chl2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
Chl2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Chl2_lm, newdata = Chl_newrange))
pred_Chl2_df <- data.frame(Chl_newrange, Chl2_Pred)

ChlRmdpos_Chl2_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Chl2_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ x + x^2')

grid.arrange(FR_pos_Chl, Chl_Rmd_pos_Chl, 
             ChlRmdpos_Chllog_graph, ChlRmdpos_Chlloglog_graph, 
             ChlRmdpos_Chl2_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Chl_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Chl_ug_L_Up)
ols_regress(FRPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Chl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
ols_regress(ChlRmdPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_Chl_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_Chl_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_Chl_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
ols_regress(ChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
ols_regress(logChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Chl2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Chl2_lm)
```

```{r NPD_Filter_Chl, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}

NPD_FRPos_Chl <- ggplot(Deanza_PosFilter_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = "NPD Positive Filtraiton") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Chl <- ggplot(Deanza_Filter_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = "NPD Positive Filtraiton") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(NPD_FRPos_Chl, NPD_ChlRmdPos_Chl, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Chl_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Chl_ug_L_Up)
ols_regress(NPD_FRPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Chl_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
ols_regress(NPD_ChlRmdPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_ChlRmdPos_Chl_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_ChlRmdPos_Chl_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_ChlRmdPos_Chl_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_logChl_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
ols_regress(NPD_ChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logChl_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
ols_regress(logChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Chl2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
ols_regress(NPD_ChlRmdPos_Chl2_lm)
```

```{r Filter_Turbidity, eval=FALSE, fig.height=15, fig.width=14,  include=FALSE}

FR_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Y-log model
ChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Turbidity_NTU_Up))
Turb_newrange <- data.frame(Turbidity_NTU_Up = seq(from = 2, to = 31, by = 1))
logTurb_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logTurb_lm, newdata = Turb_newrange))
pred_logTurb_df <- data.frame(Turb_newrange, logTurb_Pred)

ChlRmdpos_Turblog_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logTurb_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'y ~ log(x)')

#log-log model
logChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Turbidity_NTU_Up))
loglogTurb_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logTurb_lm, newdata = Turb_newrange)))
pred_loglogTurb_df <- data.frame(Turb_newrange, loglogTurb_Pred)

ChlRmdpos_Turbloglog_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogTurb_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'log(y) ~ log(x)')

# Y ~ x + x^2 model
ChlRmdPos_Turb2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Turbidity_NTU_Up, degree = 2, raw = T))
Turb2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Turb2_lm, newdata = Turb_newrange))
pred_Turb2_df <- data.frame(Turb_newrange, Turb2_Pred )

ChlRmdpos_Turb2_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Turb2_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ x + x^2') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(FR_pos_Turb, Chl_Rmd_pos_Turb,
             ChlRmdpos_Turblog_graph, ChlRmdpos_Turbloglog_graph,
             ChlRmdpos_Turb2_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Turb_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Turbidity_NTU_Up)
ols_regress(FRPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Turb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
ols_regress(ChlRmdPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Turbidity_NTU_Up))
ols_regress(ChlRmdPos_logTurb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Turbidity_NTU_Up))
ols_regress(logChlRmdPos_logTurb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Turb2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Turbidity_NTU_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Turb2_lm)
```

```{r NPD_Filter_Turbidity, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}

NPD_FRPos_Turb <- ggplot(Deanza_PosFilter_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Deanza - Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Turb <- ggplot(Deanza_PosFilter_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Deanza - Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")



grid.arrange(NPD_FRPos_Turb, NPD_ChlRmdPos_Turb, nrow = 1)

```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Turb_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Turbidity_NTU_Up)
ols_regress(NPD_FRPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Turb_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
ols_regress(NPD_ChlRmdPos_Turb_lm)
```

```{r Oly_DTW_Shell_length, fig.height=5, fig.width=6,  include=FALSE}
############ Olympia DTW and Shell Length #####################
# Determine what quadrat samples have missing data (NAs)
NPD_biv_bio_summary <- NPD_bivalves %>% 
  group_by(excavation_sample) %>% 
  summarize(avg_DTW = mean(tissue_dry_weight_g))

# what are the unique species in dataset
#unique(NPD_bivalves$species)

# Still contains missing data --> which quadrats to use for analyses
NPD_bivalve_data_clean <- NPD_bivalves %>% 
  filter(!excavation_sample %in% c("Q10", "Q4", "Q8")) %>% 
  mutate(species = ifelse(grepl("adula", ignore.case = T, species), "Adula diegensis",
                          ifelse(grepl("muscul.", ignore.case = T, species), "Musculista senhousia",
                                 ifelse(grepl("myt", ignore.case = T, species), "Mytilus galloprovincialis",
                                        ifelse(grepl(".lurida", ignore.case = T, species), "Ostrea lurida",
                                               ifelse(grepl("mussel", ignore.case = T, species), "Unknown mussel",
                                                      ifelse(grepl(".spinosum", ignore.case = T, species), "Crucibulum spinosum",
                                                       "Pattern Not Found"))))))) %>% 
  # Filter out unclassified/ empty species & samples less than 0g (processing error, doesn't make sense)
  filter(!species %in% c("Pattern Not Found", "Crucibulum spinosum"))


#Olympia DTW predicted by Shell Length - Newport, CA
# All excavation quadrat samples processed to date aggregated (summer 2020)
NPD_oly <- NPD_bivalve_data_clean %>% 
  filter(species == "Ostrea lurida") %>% 
  drop_na() %>% 
  as_tibble() 

Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method = lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top") +
  stat_quadrant_counts(quadrants = 0L, label.x = "left", 
                       aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_DTW)
```

```{r Oly_DTW_SH_outlier_rmd, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="center", out.width = "70%", fig.asp=0.618, fig.width=6, fig.cap="The relationship between *O. lurida* shell length and its dry tissue weight (DTW) in Newport Bay, California at the Deanza restoration site. Outlier data (outside mean +- 2.2 SD) and negative values are excluded. \\label{figurelabel}"}
# Remove outlier and negative DTW value
NPD_oly_outRmd <- NPD_oly %>%
  mutate(DTW_outlier = find_outlier(NPD_oly$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0) 

# Graph with outliers removed
Oly_shell_DTW_rm_out <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method=lm, formula = x_y_formula, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
 # scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom") 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_DTW_rm_out)
```

```{r Linear_model_DTW_length, fig.height=6, fig.width=6,  include=FALSE}
# Linear model to predict Dry Tissue weight (g) with Oly shell length (mm)
Oly_DTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ length_mm)
ols_regress(Oly_DTW_lm)

# coeficent results from linear model
Oly_DTW_SL_coef <- coef(Oly_DTW_lm)
# y-intercept in [[1]] position
Oly_DTW_SL_coef[[1]]
# creat function from model results
Oly_DTW_SL_model <- function(length_mm) {length_mm*Oly_DTW_SL_coef[[2]] + Oly_DTW_SL_coef[[1]]}

```

```{r Oly_DTW_SH_out_rmd_Trans, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="default", fig.asp=0.618, fig.width=8, fig.cap="The relationship between *O. lurida* shell length and its dry tissue weight (DTW) in Newport Bay, California at the Deanza restoration site. Possible transformations. \\label{figurelabel}"}

### y ~ log(x) model ####
Oly_LogxDTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ log(length_mm))
# range of Shell length values
SH_newrange <- data.frame(length_mm = seq(from = 0, to = 53, by = 1))
# create new dataframe with model predicted values from new data range above
pred_logxDTW_SH <- data.frame(DTW_pred = predict(Oly_LogxDTW_lm, newdata = SH_newrange), length_mm = SH_newrange)

# graph with model predicted values to draw line
Oly_SH_logxDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_logxDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "y ~ log(x)") +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### log(y) ~ x model ####
Oly_LogDTW_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ length_mm)
pred_logDTW_SH <- data.frame(DTW_pred = exp(predict(Oly_LogDTW_lm, newdata = SH_newrange)), length_mm = SH_newrange)

Oly_shell_DTW_logline <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_logDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "y ~ log(x)")+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### log(y) ~ log(x) model ###
Oly_LogDTW_logSH_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ log(length_mm))
pred_loglogDTW_SH <- data.frame(DTW_pred = exp(predict(Oly_LogDTW_logSH_lm, newdata = SH_newrange)), 
                                length_mm = SH_newrange)

Oly_shell_logDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_loglogDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "y ~ log(x)")+
  labs(x = 'Shell Length (mm)',
       y = ' Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### Y ~ x + x^2
Oly_DTW2_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ poly(length_mm, degree = 2, raw = T))
SH_newrange <- data.frame(length_mm = seq(from = 2, to = 52, by = 1))
pred_DTW2_SH_df <- data.frame(tissue_dry_weight_g = predict(Oly_DTW2_lm, newdata = SH_newrange), SH_newrange)

Oly_SH_DTW2_graph <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW2_SH_df, aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "Y ~ x + x^2")+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

OlySH_DTW_Trans_graphs <- grid.arrange(Oly_SH_logxDTW, Oly_shell_DTW_logline, 
                                        Oly_shell_logDTW, Oly_SH_DTW2_graph, nrow = 2)

#plot(OlySH_DTW_Trans_graphs)

```

```{r eval=FALSE, include=FALSE}
Oly_LogxDTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ log(length_mm))
ols_regress(Oly_LogxDTW_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_LogDTW_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ length_mm)
ols_regress(Oly_LogDTW_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_LogDTW_logSH_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ log(length_mm))
ols_regress(Oly_LogDTW_logSH_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(Oly_LogDTW_logSH_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(Oly_LogDTW_logSH_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(Oly_LogDTW_logSH_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_DTW2_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ poly(length_mm, degree = 2, raw = T))
ols_regress(Oly_DTW2_lm)
```

```{r Oly_TWW_DTW, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}
Oly_TWW_DTW<- ggplot(NPD_oly, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = 'Total Wet Weight (g)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW x TWW - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

plot(Oly_TWW_DTW)
```

```{r Oly_TWW_DTW_outRmd, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="default", fig.asp=0.618, fig.width=8, message = F, fig.cap="The relationship between *O. lurida* total wet weight (TWW) and its dry tissue weight (DTW) in Newport Bay, California at the Deanza restoration site. Blue dashed lines represent the relationship found by Gray and Langdon (2018) in Yaquina Bay, Oregon Olympia oysters (DTW = 0.0044*TWW - 0.043) \\label{figurelabel}"}

# Make sure only using positive TWW values, negative values indicate processing error
NPD_oly_TWW <- NPD_oly_outRmd %>% filter(total_wet_weight_g > 0)
# Gray & Langdon 2017 TWW ~ DTW Olympia model to add to graph
Gray17_DTW_TWW_lm <- function(x) {0.0044*x - 0.043}

# use DTW outlier data to plot graph
Oly_TWW_DTW_rm_out <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) +
  stat_function(fun = function(total_wet_weight_g) (0.0044*total_wet_weight_g) - 0.043, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  theme_classic() +
  labs(x = 'Total wet weight (g)',
       y = 'Dry Tissue Weight (g)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

### log(y) ~ x
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ total_wet_weight_g)
TWW_newrange <- data.frame(total_wet_weight_g = seq(from = 0, to = 7, by = 0.01))
pred_DTW_TWW_log_df <- data.frame(tissue_dry_weight_g = exp(predict(Oly_TWW_DTW_log_LM, newdata = TWW_newrange)),
                              TWW_newrange)

Oly_logTWW_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW_TWW_log_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  stat_function(fun = Gray17_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "log(y) ~ x") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')

### log(y) ~ log(x)
Oly_TWW_DTW_loglog_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
pred_DTW_TWW_loglog_df <- data.frame(tissue_dry_weight_g = exp(predict(Oly_TWW_DTW_loglog_LM, newdata = TWW_newrange)),
                              TWW_newrange)

Oly_loglogTWW_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW_TWW_loglog_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  stat_function(fun = Gray17_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "log(y) ~ log(x)") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')

### y ~ x + x^2
Oly_TWW2_DTW_LM <- lm(data = NPD_oly_TWW, 
                        tissue_dry_weight_g ~ poly(total_wet_weight_g, degree = 2, raw = T))
pred_DTW2_TWW_log_df <- data.frame(tissue_dry_weight_g = predict(Oly_TWW2_DTW_LM, newdata = TWW_newrange),
                              TWW_newrange)

Oly_TWW2_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW2_TWW_log_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  stat_function(fun = Gray17_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "y ~ x + x^2") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')
       
Oly_TWW_DTW_outRmd_graph <- grid.arrange(Oly_TWW_DTW_rm_out, Oly_logTWW_DTW_graph,
                                          Oly_loglogTWW_DTW_graph, Oly_TWW2_DTW_graph, nrow = 2)

#plot(Oly_TWW_DTW_outRmd_graph)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_lm_rm_out <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ total_wet_weight_g)

ols_regress(Oly_TWW_DTW_lm_rm_out)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(Oly_TWW_DTW_lm_rm_out)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(Oly_TWW_DTW_lm_rm_out)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(Oly_TWW_DTW_lm_rm_out))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ total_wet_weight_g)
ols_regress(Oly_TWW_DTW_log_LM )
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_loglog_LM <- lm(data = NPD_oly_TWW, 
                         log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
ols_regress(Oly_TWW_DTW_loglog_LM)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW2_DTW_LM <- lm(data = NPD_oly_TWW, 
                        tissue_dry_weight_g ~ poly(total_wet_weight_g, degree = 2, raw = T))
ols_regress(Oly_TWW2_DTW_LM)
```

```{r NPD_Bivalve_SH_DTW, echo=FALSE, fig.align="center", fig.asp=0.618, fig.keep='all', fig.width=8.6, dev='pdf', out.width="100%", fig.cap="The biomass of bivalves excavated from Deanza in Newport Bay \\label{figurelabel}"}
##### Estimate Biomass per site here with equations
NPD_bivalve_biomass_graph <-  NPD_bivalve_data_clean %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g, color = species)) +
  geom_point() +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  facet_wrap(~species) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = "NPD Bivalve Biomass - Raw data") +
  theme_classic() +
  theme(strip.text = element_text(face = "italic"))

plot(NPD_bivalve_biomass_graph)
```

```{r NPD_Bivalve_SH_DTW_outrmd, echo=FALSE, fig.align="center", fig.asp=0.618, fig.cap="The biomass of bivalves excavated from Deanza in Newport Bay \\label{figurelabel}", fig.keep='all', fig.width=8.6, dev='pdf', out.width="100%"}
# Remove outlier and negative DTW value
NPD_bivalve_outrmd <- NPD_bivalve_data_clean %>%
  mutate(DTW_outlier = find_outlier(NPD_bivalve_data_clean$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0) 

NPD_bivalve_outrmd_graph <- NPD_bivalve_outrmd %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g, group = species, color = species)) +
  geom_point() +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  facet_wrap(~species) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = "NPD Bivalve Biomass - Pos DTW Outlier Rmd") +
  theme_classic() +
  theme(strip.text = element_text(face = "italic"))

# NPD_bi_Biomass_graphs <- grid.arrange(NPD_bivalve_biomass_graph, NPD_bivalve_outrmd_graph, nrow = 1)
plot(NPD_bivalve_outrmd_graph)
```

```{r fig.height=5, fig.width=12,  include=FALSE}
NPD_Adula <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Adula diegensis"))

NPD_Adula_Posbiomass_graph <- NPD_Adula %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Adula diegensis")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

# Predict new values with 

NPD_Adula_Posbiomass_loggraph <- NPD_Adula %>% 
  ggplot(aes(x = log(length_mm), y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Ln Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Adula diegensis")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Adula_Posbiomass_graph, NPD_Adula_Posbiomass_loggraph, nrow = 1)
```

```{r eval=FALSE, include=FALSE}
NPD_Adula_lm <- lm(data = NPD_Adula, tissue_dry_weight_g ~ length_mm)
ols_regress(NPD_Adula_lm)

########## Model to predict Adual DTW ##############
Adula_coef <- coef(NPD_Adula_lm)
Adula_DTW_SL_model <- function(length_mm) {length_mm*Adula_coef[[2]] + Adula_coef[[1]]}

```

```{r eval=FALSE, include=FALSE}
NPD_Adula_logDTW_lm <- lm(data = NPD_Adula, log(tissue_dry_weight_g) ~ length_mm)
ols_regress(NPD_Adula_logDTW_lm)
```

```{r eval=FALSE, include=FALSE}
NPD_Adula_logDTW_logSH_lm <- lm(data = NPD_Adula, log(tissue_dry_weight_g) ~ log(length_mm))
ols_regress(NPD_Adula_logDTW_logSH_lm)
```

```{r eval=FALSE, include=FALSE}
NPD_Adula_DTW_SH2_lm <- lm(data = NPD_Adula, tissue_dry_weight_g ~ poly(length_mm, degree = 2, raw = T))
ols_regress(NPD_Adula_DTW_SH2_lm)
```

```{r NPD_Adula_ANOVA, eval=FALSE, include=FALSE}
##### Use ANOVA to compare models?? 
```


```{r fig.height=5, fig.width=12,  include=FALSE}
NPD_Musculista <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Musculista senhousia"))

NPD_Musculista_Posbiomass_graph <- NPD_Musculista %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Musculista senhousia")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Musculista_Posbiomass_loggraph <- NPD_Musculista %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Musculista senhousia")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Musculista_Posbiomass_graph, NPD_Musculista_Posbiomass_loggraph, nrow=1)
```

```{r eval=FALSE, include=FALSE}
NPD_Musculista_lm <- lm(data = NPD_Musculista, tissue_dry_weight_g ~ length_mm)
ols_regress(NPD_Musculista_lm)

Musculista_coef <- coef(NPD_Musculista_lm)
Musculista_DTW_SL_model <- function(length_mm) {length_mm*Musculista_coef[[2]] + Musculista_coef[[1]]}
```

```{r eval=FALSE, include=FALSE}
NPD_Musculista_logDTW_lm <- lm(data = NPD_Musculista, log(tissue_dry_weight_g) ~ length_mm)
ols_regress(NPD_Musculista_logDTW_lm)
```

```{r eval=FALSE, include=FALSE}
NPD_Musculista_logDTW_logSH_lm <- lm(data = NPD_Musculista, log(tissue_dry_weight_g) ~ log(length_mm))
ols_regress(NPD_Musculista_logDTW_logSH_lm)
```

```{r fig.height=5, fig.width=12,  include=FALSE}

NPD_Mytilus <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Mytilus galloprovincialis"))

NPD_Mytilus_Posbiomass_graph <- NPD_Mytilus %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Mytilus galloprovincialis")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Mytilus_Posbiomass_loggraph <- NPD_Mytilus %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Mytilus galloprovincialis")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Mytilus_Posbiomass_graph, NPD_Mytilus_Posbiomass_loggraph, nrow = 1)
```

```{r eval=FALSE, include=FALSE}
NPD_Mytilus_lm <- lm(data = NPD_Mytilus, tissue_dry_weight_g ~ length_mm)
ols_regress(NPD_Mytilus_lm)

Mytilus_coef <- coef(NPD_Mytilus_lm)
Mytilus_DTW_SL_model <- function(length_mm) {length_mm*Mytilus_coef[[2]] + Mytilus_coef[[1]]}
```

```{r eval=FALSE, include=FALSE}
NPD_Mytilus_logDTW_lm <- lm(data = NPD_Mytilus, log(tissue_dry_weight_g) ~ length_mm)
ols_regress(NPD_Mytilus_logDTW_lm)
```

```{r eval=FALSE, include=FALSE}
NPD_Mytilus_logDTW_logSH_lm <- lm(data = NPD_Mytilus, log(tissue_dry_weight_g) ~ log(length_mm))
ols_regress(NPD_Mytilus_logDTW_logSH_lm)
```

```{r eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}
NPD_Unknown <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Unknown mussel"))

NPD_Unknown_Posbiomass_graph <- NPD_Unknown %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Unknown mussel")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Unknown_Posbiomass_loggraph <- NPD_Unknown %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Unknown mussel")," - Positive Ln DTW only"))) +
  theme_classic()  +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Unknown_Posbiomass_graph, NPD_Unknown_Posbiomass_loggraph, nrow =1)

```

```{r eval=FALSE, include=FALSE}
NPD_Unknown_lm <- lm(data = NPD_Unknown, tissue_dry_weight_g ~ length_mm)
ols_regress(NPD_Unknown_lm)
```

```{r eval=FALSE, include=FALSE}
NPD_Unknown_logDTW_lm <- lm(data = NPD_Unknown, log(tissue_dry_weight_g) ~ length_mm)
ols_regress(NPD_Unknown_logDTW_lm)
```

```{r eval=FALSE, include=FALSE}
NPD_Unknown_logDTW_logSH_lm <- lm(data = NPD_Unknown, log(tissue_dry_weight_g) ~ log(length_mm))
ols_regress(NPD_Unknown_logDTW_logSH_lm)
```

```{r eval=FALSE, include=FALSE}
## Bar graph NPD Biomass / DTW by species
Bivalve_Biomass_graph <- ggplot(NPD_bivalve_outrmd, aes(Site)) + 
  geom_col(aes(x = Site, y = tissue_dry_weight_g, fill = species)) +
  theme_classic() +
  scale_fill_manual(values = Species_colors) +
  #scale_y_continuous(breaks = seq(0, max(NPD_Posbiomass_outlier$tissue_dry_weight_g), by = 500)) +
  labs(y = "Dry Tissue Weight (g)")

Bivalve_Biomass_graph
# Order species by DTW not alphabetical order

################### Biomass by species across sites ####################
# double dot in file path steps down from current folder "Thesis_Manuscript" back to project level folder
SR_Density_directory = "./Data/bivalve_density_community"
SR_Oly_Shelllength_data = fread(file.path(SR_Density_directory, "Insitu_Filter_SR_oyster_length.csv"))

######## Predict SR DTW with shell length #########

SR_Oly_Shelllength_data <- SR_Oly_Shelllength_data %>% 
  mutate(length_mm = length_cm*10, # convert cm length to mm
         DTW_g = Oly_DTW_SL_model(length_mm)) # predict Oly Dry tissue weight with length_mm

NPD_bivalve_DTW_predict <- NPD_bivalve_outrmd %>% 
  mutate(DTW)

```

```{r Bivalve_Density, echo=FALSE, fig.align="center", fig.asp=0.618, fig.width=6, fig.keep='all', dev='pdf', out.width="70%", fig.cap="The density of bivlaves at Deanza Newport, California surveyed May 2018. \\label{figurelabel}"}
# read in bivalve density data from cleaned data file
Bivalve_Den_data <- fread(file.path(Bivalve_output_directory, "Bivalve_Density_summary.csv"))

# replace NAs with 0s
Bivalve_Den_data[is.na(Bivalve_Den_data)] <- 0

Bivalve_Den_data <- Bivalve_Den_data %>% 
  # move species from individual columns to a single column with new density column to contain data
  pivot_longer(c(Adula_diegensis_m2, Musculista_senhousia_m2, Mytilus_galloprovincialis_m2,
                 Ostrea_lurida_m2, Crassostrea_gigas_m2, Argopecten_ventricosa_m2, 
                 Geukensia_demissa_m2, Crassostrea_gigas_m2), 
               names_to = "Species", 
               values_to =  "individuals_m2") %>% 
  # remove "_m2" from species names in Species column
  mutate(Species = str_replace(Species, "_m2", ""),
         Species = str_replace(Species, "_", " "))

#Reorder levels of Site factor - display North to South
order_by_site <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
Bivalve_Den_data <- arrange(transform(Bivalve_Den_data, Site = factor(Site,levels = order_by_site)), Site)


#unique(Bivalve_Den_data$Species) # list each individual bivalve species
# Assign species to specific color
Species_colors <- c("Adula diegensis" = "#8D8680",
                    "Argopecten ventricosa" = "#CCC3C5",
                    "Crassostrea gigas" = "#6D6340",
                    "Geukensia demissa" = "#524D4F",
                    "Musculista senhousia" = "#B0915B",
                    "Mytilus galloprovincialis" = "#7E4B41",
                    "Ostrea lurida" = "#9986A5",
                    "Unknown mussel" = "black")

# Stacked bar graph
Bivalve_Den_graph <- ggplot(Bivalve_Den_data, aes(Site)) + 
  geom_col(aes(x = Site, y = individuals_m2, fill = Species)) +
  geom_text(aes(label = round(Bivalve_den_m2,0), y = Bivalve_den_m2), 
            vjust = -0.5) +
  theme_classic() +
  scale_fill_manual(values = Species_colors) +
  scale_y_continuous(breaks = seq(0, max(Bivalve_Den_data$Bivalve_den_m2), by = 500)) +
  labs(y = expression("Individuals per m"^2))
  
Bivalve_Den_graph
```

```{r Bar_Graphs_up_vs_down,  include=FALSE}
Bar_up_down_data <- Master_analysis_table %>%
 # select(Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>%
  rename(Upstream = Chl_ug_L_Up, Downstream = Chl_ug_L_Down) %>%  
  gather(Upstream, Downstream, key = Position, value = Chl_ug_L) %>% 
  mutate(Position = fct_relevel(Position, 'Upstream', 'Downstream')) %>% 
  mutate(Site = fct_relevel(Site, 'Deanza', 'Shellmaker', 'San Rafael', 'Morro Bay')) %>% 
  mutate(Site_exp_date = paste(Site, Experiment, Date, sep = ' ')) %>% 
  mutate(Exp_Date = paste(Experiment, Date, sep = ' ')) %>% 
  arrange(Site, mdy(Date))

#Bar_up_down_data$Position <- as.factor(Bar_up_down_data$Position)

Paired_bar_chl_graph <- ggplot(data = Bar_up_down_data, aes(x = Site_exp_date, y = Chl_ug_L, fill = Position)) +
    geom_bar(stat="identity", position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_grid(~ Site, scales = "free", space = "free") + #'free' allows axis b/w sites uneaven
    geom_bar(data = (Bar_up_down_data %>%
                       filter(!Experiment %in% c('Filtration'))),
             color = "grey22",
             stat="identity",
             position = "dodge") +
    labs(x = 'Experiment', y = 'Chlorophyl (ug/L)')

plot(Paired_bar_chl_graph)
```

```{r Bar_Graphs_up_vs_down_grid.arrange, echo=FALSE, fig.align="default", fig.asp=0.75, fig.keep='all', fig.width=8.6, dev='pdf', out.width="100%", fig.cap="Chlorphyll concentrations measured at upstream and downstream instruments across all sites, filtration trials, and negative controls. \\label{figurelabel}"}
############## Try 2 ####### make separate graphs, combine using grid.arrange()

##### Can't figure out how to properly label x axis. Works with Exp_Date, but can't shorten without messing up data:label pairs. Can't spend more time on this right now. come back if time -AM 2020_3_3

NPD_bar_data <- Bar_up_down_data %>% 
  filter(Site == "Deanza") %>% 
  mutate(graph_Label = ifelse(grepl("^Filtration", Exp_Date), str_replace(Exp_Date, "Filtration ", ""),
                             str_replace(Exp_Date, "^Neg Control .", "")))

NPD_bar_graph <- ggplot(data = NPD_bar_data, aes(x = Exp_Date, y = Chl_ug_L, 
                                                 fill = Position)) +
    geom_col(position = position_dodge(width = 0.9, preserve = "single")) +
    geom_col(data = (NPD_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.x = element_blank(),
          legend.position = c(0.9, 0.8),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(y = 'Chlorophyll a (ug/L)', title = "Newport Deanza") +
  # This labels the x-axis
    #scale_x_discrete(labels = Exp_Date) +
    ylim(0, 8)

NPSM_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Shellmaker')

NPSM_bar_graph <- ggplot(data = NPSM_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPSM_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Newport Shellmaker") +
    # scale_x_discrete(labels = NPSM_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE) 

MB_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Morro Bay')

MB_bar_graph <- ggplot(data = MB_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (MB_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Morro Bay") +
   # scale_x_discrete(labels = MB_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

SR_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'San Rafael')

SR_bar_graph <- ggplot(data = SR_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (SR_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "San Rafael") +
    #scale_x_discrete(labels = SR_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

Chl_graphs <- list(NPD_bar_graph, NPSM_bar_graph, SR_bar_graph, MB_bar_graph) 
all_chl_graphs <- grid.arrange(grobs = Chl_graphs,
             widths = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1),
             layout_matrix = rbind(c(NA,1,1,1,1,1,1,1,1,1,1,1,1, NA),
                                   c(2,2,2,2,2,3,3,3,3,3,4,4,4,4)))
#plot(all_chl_graphs)
#ggsave("Insitu_Filter_up_vs_down_all_sites.png", all_chl_graphs)
```

```{r LM_PrctChl_pos_add, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}
# Multiple Linear Regression - Chl Rmd Filtration Forward Stepwise Selection
# Positive Percent Chl removed trials only
MLR_PrctChl_fwd <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~
                         # Field notes Qualitative variables
                         #Wind + G_upstream + Algae + #Daylight +  Sonde_fell + Boat_wake +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + #Turbidity_NTU_Up + 
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)

summary(MLR_PrctChl_fwd)
```

```{r eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}

#Positive Filtration ~ ChlRmd Multiple Regression with selected variables
LM2_PrctChl_pos_add <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ 
                          NPSM + Avg_OC_Ratio)

summary(LM2_PrctChl_pos_add)
# diagnosis of colinearity
#ols_coll_diag(LM_PrctChl_pos_add)
```

```{r eval=FALSE, fig.height=10, fig.width=6,  include=FALSE}
#Positive Filtration ~ ChlRmd Multiple Regression with selected variables
# detailed multiple regression summary - ANOVA results
ols_regress(LM2_PrctChl_pos_add)
```

```{r LM_FR_pos, eval=FALSE,  include=FALSE}
#FR - Positive Filtration Stepwise Multiple Regression
# Positive Percent Chl removed trials only
LM_FR_pos <- lm(data = Filtration_pos_data, L_hr_m2 ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + # Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)

ols_step_both_p(LM_FR_pos)
```

```{r LM_ChlRmd_NPD_PosFilter, eval=FALSE,  include=FALSE}
#Chl Rmd - Deanza - Positive Filtration
LM_ChlRmd_NPD_PosFilter <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + # Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)
# not enough degrees of freedom for full model
ols_step_both_p(LM_ChlRmd_NPD_PosFilter)
```

```{r LM_FR_NPD_Posfilter, eval=FALSE,  include=FALSE}
#FR - Deanza - Positive Filtration
LM_FR_NPD_Posfilter <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + #Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)
# not enough degrees of freedom for full model
ols_step_both_p(LM_FR_NPD_Posfilter)
```
