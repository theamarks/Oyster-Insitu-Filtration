---
bibliography: library.bib
csl: marine-ecology-progress-series.csl
header-includes: \usepackage{setspace}\doublespacing\usepackage{rotating}\usepackage{booktabs}
output: 
  pdf_document:
    fig_caption: yes
indent: true
---
```{r setup, include = F}
library(knitr)
# set default code chunk settings to save figures in Figures folder, show no output, and cache 
knitr::opts_knit$set(root.dir = normalizePath('../'), # set working directory to project level
                      #fig.path = "./Thesis_Manuscript/Figures", 
                      echo = FALSE, warning = FALSE, message = FALSE, 
                     fig.asp=0.618, fig.align = "center", fig.show = "hold")
```

```{r load_packages_data, include=FALSE}
################### Packages ###########################
library(dplyr)
library(tidyr)
library(readr) # reading in files 
library(magrittr) # pipe function %>%
library(data.table) # file read function and needed for xtable
library(lubridate) # dealing with time and dates
library(ggplot2) # graphing
library(ggthemes) # theme_classic() for graphs
library(stringr) # dealing with text strings
library(hms) # dealing with time
library(viridisLite) # color palette
library(forcats)
library(gridExtra)
library(ggpmisc) # package for adding line equation and R^2 to plots
library(viridis) # Color palette - Options: magma , inferno, plasma, viridis, cividis
library(scales) # add different number scales in graphs
library(cowplot) # for arranging multiple plots into a single figure
library(wesanderson) # color palette
library(olsrr) # regression output table
library(xtable) # creates tables in LaTex
library(MASS) # collection of datasets and functions
library(ISLR) # Dataset in Intro to statistical learning
library(knitr)
library(tinytex) # LaTeX conversion package
library(broom) # tidy() function to convert t.test to dataframe

# source functions 
source("./functions.R")
# define output directory
output_directory = "./output"
# create output directories (same as Insitu_Filtraiton_Analysis_script.Rmd)
createOutputDirectories()

##################### Read in Data from  project output ##########################
Master_analysis_table <- fread(file.path('./output/4_Filtration_Calculations/Filtration_Summary', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_bivalves = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))
Sbs_correction_data = fread(file.path('./output/6_Sbs_Corrections_Summary', "sbs_correction_summary.csv"))


##################### Data #########################################
# Remove San Diego filtration trial - not applicable to this analysis - different experimental set up
Master_analysis_table <- Master_analysis_table %>% 
  filter(!Site %in% c("San Diego"))

# Order Sites by Latitude
site_by_lat <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 

# transform Site variable to factor and arange by Latitude
Master_analysis_table <- arrange(transform(Master_analysis_table, Site = factor(Site,levels = site_by_lat)), Site)

 # Filtration trials only - exclude Negative controls
Filtration_only_data <- Master_analysis_table %>% 
  filter(Experiment %in% c("Filtration"))

# Filtration trials with Outliers removed - same syntax used by Dr. Nichols
Filter_only_outRmd_data <- Filtration_only_data %>% 
  filter(abs(pcnt_Chl_rmvd) < 50)

################# Values for Results text #####
# SR filtration trial data
SR_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("San Rafael"),
         Experiment %in% c("Filtration")) 
# SR Negative control data
SR_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("San Rafael"),
         grepl("Neg Control*", Experiment)) 

MB_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Morro Bay"),
         Experiment %in% c("Filtration"))

MB_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Morro Bay"),
         grepl("Neg Control*", Experiment)) 

NPD_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"),
         Experiment %in% c("Filtration"))

NPD_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"),
         grepl("Neg Control*", Experiment)) 

NPSM_filter_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Shellmaker"),
         Experiment %in% c("Filtration"))

NPSM_NC_sum <- Master_analysis_table %>% 
  filter(Site %in% c("Shellmaker"),
         grepl("Neg Control*", Experiment)) 

# Filtration trials only - exclude Negative controls & Percent Chl removed greater than 0
### Important Note ## When Percent Chl removed is positive, so is L/hr/m^2 and vice visa. 
# Filtering by pcnt_Chl_rmvd effectively filters both values the same, so further analysis 
# withFiltration_pos_data serves both purposes. 
Filtration_pos_data <- Filtration_only_data %>% 
  filter(pcnt_Chl_rmvd > 0)

# Deanza data only - all trials
Deanza_data_all <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"))
# Deanza only - Filtraiton trials only
Deanza_Filter_data <- Deanza_data_all %>% 
  filter(Experiment %in% c("Filtration"))
# Deanza only- Positive Filtration only
Deanza_PosFilter_data <- Deanza_Filter_data %>% 
  filter(pcnt_Chl_rmvd > 0)

### Average TPM Data ######################
Avg_TPM_summary_table <- arrange(transform(Avg_TPM_summary_table, Site = factor(Site, levels = site_by_lat)), Site)

############### model formulas ###############
# linear model formula
x_y_formula <- y ~ x 
# Quadratic model
x2_y_formula <- y ~ poly(x, degree = 2)
# Exponential model
logy_x_formula <- log(y) ~ x
# logx
y_logx_fomula <- y ~ log(x)
# double log
logy_logx_formula <- log(y) ~ log(x)

############### Site Color Assignments ###############
viridis(4)
Site_colors <- c("San Rafael" = "#440154FF",
                 "Morro Bay" = "#31688EFF",
                 "Shellmaker" = "#35B779FF",
                 "Deanza" = "#FDE725FF")

############### Bivalve Species Color Assignments ###############
# wes_palettes # lists all current palattes 
# Color palette for Species - Royal2, Darjeeling2, Cavalcanti1, BottleRocket2, IsleofDogs1
density_palette <- rev(wes_palette("IsleofDogs1", 7, type = c("continuous")))
Species_colors <- c("Adula diegensis" = "#8D8680",
                    "Argopecten ventricosa" = "#CCC3C5",
                    "Crassostrea gigas" = "#6D6340",
                    "Geukensia demissa" = "#524D4F",
                    "Musculista senhousia" = "#B0915B",
                    "Mytilus galloprovincialis" = "#7E4B41",
                    "Ostrea lurida" = "#9986A5",
                    "Unknown mussel" = "black")

################# Labels for graphs  #########################
Hab_FR_Label <- expression('Habitat Clearance Rate (L/hr/m'^2*')')
Prt_Chl_Label <- expression(paste('Percent Chlorophyll ', alpha, ' Removed'))
Chl_ugL_Label <- expression(paste("Chlorophyll ", alpha, " (", mu, "g/L) "))
TPM_Label <- c('Total Particulate Matter mg/L')
PIM_Label <- c('Particulate Inorganic Matter mg/L')

###################### Functions ####################################
# function for number of samples - display on graph
n_mean_stats <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  "mean =  ", round(mean(x), 1), '\n')
                )
         )
}
# function for number of samples - 3 decimal places
n_mean_stats3 <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  'mean =', round(mean(x), 3), '\n')
                )
         )
}

# function to calculate average, standard deviation, outlier data. 
find_outlier <- function(data){
  average <- mean(data)
  stdev <- sd(data)
  # Outlier data defined by outside 2.2 standard deviations from the mean 
  outlier <- ifelse((data < (average - 2.2 * stdev) | (data > (average + 2.2 * stdev))),
         TRUE, FALSE)
}
```


# Results

Field work was conducted from February 2018 to June 2019 and produced 28 usable trials (filtration and negative controls) across the four sites.
Filtration trials at San Rafael were conducted on the ebb and flood tides surround a low tide.
Three filtration trials conducted on flood tides (2018/7/7, 2018/7/18, 2018/9/10), 1 ebb filtration trial (2018/11/8), and 1 ebb negative control (2018/11/7).
We recorded 4 filtration trials and 1 negative control at Morro Bay, all conducted on flood tides (Table 1).
At Newport Shellmaker we recorded 4 filtration and 1 negative control trial on flood tides.
Newport Deanza had the most field days with 10 filtration and 3 negative controls all conducted on ebb tides. 

### Percent chlorophyll $\alpha$ removal

Percent Chl $\alpha$ removal at the San Rafael *O. lurida* reef from `r nrow(SR_filter_sum)` field days ranged from `r round(min(SR_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(SR_filter_sum$pcnt_Chl_rmvd),1)`\% and recorded `r round(SR_NC_sum$pcnt_Chl_rmvd,1)`\% in the single negative control over bare mudflat (Figure \ref{ChlRmd_Site_boxplot}). 
Morro Bay *C. gigas* aquaculture lines from `r nrow(MB_filter_sum)` field days ranged from `r round(min(MB_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(MB_filter_sum$pcnt_Chl_rmvd),1)`\% and over bare mud flat `r round(MB_NC_sum$pcnt_Chl_rmvd,1)`\%. 
At the Newport Bay Deanza *O. lurida* bed, Chl $\alpha$ removal ranged from `r round(min(NPD_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(NPD_filter_sum$pcnt_Chl_rmvd),1)`\% from `r nrow(NPD_filter_sum)` field days and `r format(round(min(NPD_NC_sum$pcnt_Chl_rmvd)), nsmall = 1)`\% to `r format(round(max(NPD_NC_sum$pcnt_Chl_rmvd)),nsmall = 1) `\% over `r nrow(NPD_NC_sum)` negative control trials on a single field day.
The Newport Bay Shellmaker *O. lurida* bed ranged from `r round(min(NPSM_filter_sum$pcnt_Chl_rmvd),1)`\% to `r round(max(NPSM_filter_sum$pcnt_Chl_rmvd),1)`\% Chl $\alpha$ removal over `r nrow(NPSM_filter_sum)` field days and `r round(NPSM_NC_sum$pcnt_Chl_rmvd,1)`\% Chl $\alpha$ removal in the single negative control. 

```{r ChlRmd_Site_boxplot, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align= "center", fig.show="hold", fig.asp=0.618, out.width="70%", message= F, fig.cap="The percent chlorophyll removed of all filtration trials across sites. Extreme values excluded from analysis are not shown. \\label{ChlRmd_Site_boxplot}"}

Chl_Rmd_box <- ggplot(Filter_only_outRmd_data, aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  #scale_y_continuous(labels = percent) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label) 
plot(Chl_Rmd_box)

####### Don't include - doesn't match analysis data
ChlRmd_pos_box <- ggplot((Filtration_pos_data), aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) +
    geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label)
#plot(ChlRmd_pos_box)

```


### Habitat Clearance Rates 

Habitat clearance rates (HCR) adjust the percent Chl $\alpha$ by the area of habitat contributing to the Chl $\alpha$ drawdown.
HCR at Ran Rafael ranged from `r format(round(min(SR_filter_sum$L_hr_m2)), nsmall =1)` to `r round(max(SR_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^. 
Morro Bay *C. gigas* aquaculture ranged from `r format(round(min(MB_filter_sum$L_hr_m2)), nsmall =1)` to `r round(max(MB_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^.
Newport Shellmaker ranged from `r round(min(NPSM_filter_sum$L_hr_m2),1)` to `r round(max(NPSM_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^.
Newport Deanza ranged from `r round(min(NPD_filter_sum$L_hr_m2),1)` to `r round(max(NPD_filter_sum$L_hr_m2),1)` Lhr^-1^m^2^ (Figure \ref{FR_Site_boxplot}).
Negative control trials measured `r round(SR_NC_sum$L_hr_m2,1)`, `r round(MB_NC_sum$L_hr_m2,1)`, and `r round(NPSM_NC_sum$L_hr_m2,1)` Lhr^-1^m^2^ for San Rafael, Morro Bay, and Newport Shellmaker respectively.
Newport Deanza's three consecutive negative control trials ranged from `r format(round(min(NPD_NC_sum$L_hr_m2)), nsmall= 1)` to `r format(round(max(NPD_NC_sum$L_hr_m2)), nsmall= 1)` Lhr^-1^m^2^.

```{r FR_Site_boxplot, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.show="hold", fig.align= "center", fig.asp=0.618, out.width="70%", message= F, fig.cap="The habitat clearance rate of all filtration trials across sites. Extreme values excluded from analysis are not shown. \\label{FR_Site_boxplot}"}
### Filtration by site (Filtration Trials only)
FR_box <- ggplot((Filter_only_outRmd_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label)
  #ylim(-2500, 1300)
plot(FR_box) 

######### Don't include ######
#### Doesn't make sense to exclue negative values if everything is going into model.

FR_pos_box <- ggplot((Filtration_pos_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label)

#plot(FR_pos_box)
```

```{r Final_Summary_table, include=FALSE, results='asis'}

#fig.cap="A summary table reporting every filtration and negative control trial from four sites within California. Water quality values are averages taken from the upstream instrument, with the exception of Chlorophyll $\\alpha$ from the downstream instrument. Depth, water velocity, Total Particulate Matter (TPM), and Organic Content (OC) are averages from multiple measurements or samples. Percent Chlorophyll $\\alpha$ and Clearance rate (L/hr/$m^2$) were calculated with Equations \\ref{Eq:PrctChl} and \\ref{Eq:Lhrm2} respectively. \\label{Final_Summary_table}",

#library(xtable) # load xtable package 
#options(xtable.floating = FALSE)
#options(xtable.timestamp = FALSE)

# Organize & clean summary table data
Final_table <- Master_analysis_table %>%
  mutate(Date = mdy(Date),
         Temp_C_Up = round(Temp_C_Up, digits = 2),
         Sal_ppt_Up = round(Sal_ppt_Up, digits = 1),
         Turbidity_NTU_Up = round(Turbidity_NTU_Up, digits = 1),
         Avg_TPM_mg_L = round(Avg_TPM_mg_L, digits = 4),
         Avg_OC_Ratio = round(Avg_OC_Ratio, digits = 2),
         Chl_ug_L_Up = round(Chl_ug_L_Up, digits = 1),
         Chl_ug_L_Down = round(Chl_ug_L_Down, digits = 1),
         avg_depth_m = round((avg_depth_cm/100), digits = 2),
         avg_m_sec = round(avg_m_hr/3600, 2),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1),
         L_hr_m2 = round(L_hr_m2, digits = 0)) %>%
  dplyr::select(Site, Date, Experiment, Temp_C_Up, Sal_ppt_Up, Turbidity_NTU_Up, Avg_TPM_mg_L, 
          Avg_OC_Ratio, Chl_ug_L_Up, Chl_ug_L_Down, avg_depth_m, d_bw_sondes_m, avg_m_sec, 
          pcnt_Chl_rmvd, L_hr_m2) %>% 
 dplyr::arrange(Site, Date)
# Make date formated as character to display properly
Final_table$Date <- as.character(Final_table$Date)
colnames(Final_table) <- c( "Site", "Date", "Experiment", "Temp ($\textdegree$C)",
                            "Salinity (ppt)", "Turbidity (NTU)","TPM (mg/L)", "OC", 
                            "Chl $\alpha$ up ($\\mu$g/L)", 
                            "Chl $\alpha$ down ($\\mu$g/L)", 
                           "Depth (m)","Distance (m)", "Water veolcity (m/s)", 
                           "% Chl $\alpha$ removal", "Clearance rate (L/hr/$m^2$)")
# allow column names text to wrap
#colnames(Final_table) <- paste("\\multicolumn{1}{c|}{", colnames(Final_table), "}")
colnames(Final_table) <- stringr::str_wrap(colnames(Final_table))
# create xtable
sumtable_latex <- xtable(Final_table, 
                         caption = "Every filtration and negative control trial across four California sites. Water quality values are upstream instrument averages, with the exception of Chlorophyll $\\alpha$ (reported from both instruments). Depth, water velocity, Total Particulate Matter (TPM), and Organic Content (OC) are averages from multiple measurements or samples.",
                         label = "tb:summary",
                         type = "latex",
                         align = c("p{0.25in}", rep('l',15))) # 0.5 seems to be relative number, change to much lower

#my_col_sanitize <- function(x){x}

print.xtable(sumtable_latex, 
      booktabs=TRUE, 
      caption.placement="top", 
      NA.string = T, 
      #sanitize.colnames.function = identity, # still causing errors
      floating.environment = "sidewaystable",
     comment = F,
     timestamp = NULL,
     sanitize.colnames.function = NULL) 

####### Extra syntax #########
#print(sumtable_latex, include.rownames = FALSE)
#type = "latex",
#sanitize.colnames.function=function(x){x} # <-- throwing \noalign errors & not knitting 
# sanitize.text.function=function(x){x}
  #sanitize.text.function = xtable::sanatize(),
  #include.rownames = FALSE
  #  floating = TRUE,
  # caption.placement = "top"
  # floating.environment = "sidewaystable"
```

```{r Chl_Corr_Filter_diff_graph, include=FALSE}
##### Althea's Chl correction x Filtration diff Graph ###########
## Correction data & OG Chl values
#Sbs_correction_data 
sbs_corr_NoAbs <- Sbs_correction_data %>% 
  dplyr::select(File_Name, Sonde_Up, Sonde_Down, G_Avg_Chl, H_Avg_Chl, Correction_Factor) %>% 
  mutate(correction_noabs = ifelse(Sonde_Up == "G", G_Avg_Chl - H_Avg_Chl, H_Avg_Chl - G_Avg_Chl),
         sbs_chl_up = ifelse(Sonde_Up == "G", G_Avg_Chl, H_Avg_Chl),
         sbs_chl_down = ifelse(Sonde_Down == "G", G_Avg_Chl, H_Avg_Chl)) %>% 
  dplyr::select(-c(Sonde_Up, Sonde_Down))

sbs_correction_summary <- read_csv("output/6_Sbs_Corrections_Summary/sbs_correction_summary.csv")
filtration_summary <- read_csv("output/4_Filtration_Calculations/Filtration_Summary/filtration_summary.csv")

filter_diff_tpaired <- filtration_summary %>% 
  dplyr::select(File_Name, Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>% 
  rename(filter_chl_up = Chl_ug_L_Up,
         filter_chl_down = Chl_ug_L_Down)

Corr_chl_diff_data <- full_join(filter_diff_tpaired, sbs_corr_NoAbs, by = "File_Name")
# Missing data from MB_2019_6_5 and MB_2019_6_4 - filtration trial not long enough for water to travel from upstream to downstream - not included in other analyses either

Corr_chl_diff_data %<>%
  mutate(chl_filter_up_uncorr = ifelse(sbs_chl_up > sbs_chl_down, 
                                       filter_chl_up + Correction_Factor, # reverse sbs correction 
                                       filter_chl_up - Correction_Factor),
         chl_filter_down_uncorr = ifelse(sbs_chl_down > sbs_chl_up, 
                                         filter_chl_down + Correction_Factor, 
                                         filter_chl_down - Correction_Factor),
         filter_chl_diff = chl_filter_up_uncorr - chl_filter_down_uncorr,
         graph_labels = ifelse(File_Name == "Insitu_Filter_NPD_2019_4_17.csv" | File_Name == "Insitu_Filter_NPSM_2019_5_22.csv" |File_Name == "Insitu_Filter_NPSM_2019_6_9.csv", 
                               paste(Site, "\n", Date, "\n", Experiment), NA))

Corr_chl_diff_data$dummie = 1:32

Corr_Chl_diff_graph <- ggplot(Corr_chl_diff_data, aes(correction_noabs, filter_chl_diff)) +
  geom_point() +
  theme_classic() + 
  xlim(-3,3) + # even axes
  ylim(-3,3) +
  xlab("SBS Correction Value (Not 1/2 or Abs)") +
  ylab("Chl Diff Filtration Trial (velocity paired)") +
  geom_abline(slope = 1, linetype = "dashed") + # 1-1 reference line
  #geom_text(aes(x=correction_noabs + .12,label=dummie)) 
  #geom_text(hjust = "center", vjust= "top",aes(x=correction_noabs, label=graph_labels))
  #geom_label(aes(label = graph_labels))
  ggrepel::geom_label_repel(aes(label = graph_labels), point.padding = 0.75, na.rm = T,
                            nudge_y = c(-0.5,0,0),
                            nudge_x = c(0.25,0.1,0.1))
  
Corr_Chl_diff_graph
     
Corr_chl_diff_data[c(9,21,23),] # Look at problem data points
```

```{r Random_Forest_DrNichols, include=FALSE}
##################### Estimate missing values (Imputation) ##########################
#In our data we are missing 4 out of 400ish values.  (cells)
#Because we have limited observations but a high number of variables simply
#removing incomplete observations is too costly

#For imputation we are doing a non parametric random forest imputation.  See missForest documentation for details/references.  
#Stekhoven, D.J. and Buehlmann, P. (2012), "missForest - nonparametric missing value imputation for mixed-type data', Bioinformatics, 28(1) 2012, 112-118, doi: 10.1093/bioinformatics/btr597

#install.packages('missForest')
#install.packages('rpart')
#install.packages('randomForest')
#install.packages('adabag')

library(missForest)
library(rpart)
library(randomForest)
library(adabag)

# Imputation for 4 missing values (TPM & OC)
temp1 = Final_table[,c(1,2,3)] # temporarily remove data labels for imputation
temp2 = missForest(Final_table[,-c(1,2,3)])$ximp # Imputation of missing values
test = cbind(temp1,temp2) # bing back data labels 

dim(Final_table[,-c(1,2,3)]) # dimensions of data with labels removed (data only) 28 x 12 = 336 data cells
num_NA_values <- sum(is.na(Final_table)) # 4 missing values

############### Filtration (adjusted) mud vs oyster #########################

colnames(test) <- c( "Site", "Date", "Experiment", "Temp","Salinity", "Turbidity",
                            "TPM", "OC", "Chl.up", "Chl.dn", 
                           "Depth","Distance", "Water veolcity", "Chl.removal", 
                           "Clearance")

#Shellmaker 06-09 Neg Control, Shellmaker 05-22 Filtration and Deanze 4-17 Filtration just have astronomical outlier values for clearance.
#Lets ignore them for now as they complete dominate any model useful for comparison.
## Thea Notes ###
## Shellmaker 06-09 Neg Control - floating algae mats caused me to reposition instruments after ~10 mins into Neg Control trial. Looks like sediments never settled afterward. Huge spikes in Chl afterwards that even cutting out is suspect. Avg depth and distance b/w sondes are wrong If I just use the first part of the neg control. Going to change values in Insitu_Filter_Veolcity_All_Data.csv - will reduce clearance rate b/c reduced water volume. 

#Filtration (unadjusted) mud vs oyster
test1 = test[abs(test$Chl.removal) < 50,] # remove extreme values (NPSM 2020_6_9, NPSM 2020_5_22, NPD 2020_4_17)
exp = test1[test1$Experiment=="Filtration",] # separate Filtraiton trials
control = test1[test1$Experiment!="Filtration",] # separate negative control trials
t_test <- t.test(exp$Clearance,control$Clearance,alternative="greater") # single sided t-test?
# extract t.test results from tibble format
filter_control_ttest <- broom::tidy(t.test(exp$Clearance,control$Clearance,alternative="greater"))
filter_control_ttest
# Degrees of freedom two-sample t-test
t_test_df <- (nrow(exp) - nrow(control)) - 2 
### t-test results - AM #####
# Combined filtration trials had significantly higher HCRs (habitat clearance rate) than negative controls (two sample t(`t_test_df`) = t-value = `filter_control_ttest$statistic`, p < `filter_control_ttest$p.value`).

######## Descriptive Filtration (as a function WQ) --> RANDOM FOREST MODEL- control for WQ & Site
model.rf = randomForest(Clearance~Temp+Salinity+Turbidity+TPM+OC+Site,
                        data=test1, # use data with extreme values removed 
                        ntree=100,
                        mtry=3,
                        control=rpart.control(minsplit=2,cp=.05))
model.rf
plot(model.rf)
y.hat = predict(model.rf,newdata=test1) # model predicted values
res = test1$Clearance - y.hat # residuals - difference between measured values and model predicted values 
r.sq = (var(test1$Clearance) - var(res))/var(test1$Clearance)
r.sq # r squared value for random forest model
#r.sq  is about 66.3% (yay)

### Random Forest variable importance
Var_import2 <- importance(model.rf)
Var_import2
Var_import2 <- Var_import2[order(Var_import2[,1], decreasing=TRUE),] # sort matrix highest to lowest - output names numeric
Var_import_df2 <- data.frame(as.list(Var_import2)) # convert named numeric to data.frame
Var_import_df2 %<>% 
  pivot_longer(cols = c(Turbidity, Temp, TPM, Salinity, OC, Site), names_to = "Variable", values_to = "Importance") %>% 
  arrange(desc(Importance))
Var_import_df2 # dataframe with sorted importance values - highest to lowest
## Calculate the percent relative importance for each variable
sum_import2 <- sum(Var_import_df2$Importance)
Temp_rel_import <- (Var_import_df2[[1,2]] / sum_import2) * 100
OC_rel_import <- (Var_import_df2[[2,2]] / sum_import2) * 100
Turb_rel_import <- (Var_import_df2[[3,2]] / sum_import2) *100
TPM_rel_import <- (Var_import_df2[[4,2]] / sum_import2) * 100
Sal_rel_import <- (Var_import_df2[[5,2]] / sum_import2) *100
Site_rel_import <- (Var_import_df2[[6,2]] / sum_import2) *100
###### Adjust values based on Random Forest model - compare Mud flat to Oyster habitat. 

y.adj = res + mean(test1$Clearance) # take residuals (diff between data and model - what the model doesn't account for (oysters)) and add to the mean response (same for data and model?). This gives me response with the effects of all variables accounted for. 
y.adj.experiment = y.adj[test1$Experiment=="Filtration"]
y.adj.control = y.adj[test1$Experiment!="Filtration"]
t.test(y.adj.experiment,y.adj.control,alternative="greater")
t_test_adj <- broom::tidy(t.test(y.adj.experiment,y.adj.control,alternative="greater"))
t_test_adj

### Example tree ######
#model.tree = rpart(Clearance~Temp+Salinity+Turbidity+TPM+OC+Site,method="anova",control=rpart.control(minsplit=2,cp=0.05),data=test1)
#plot(model.tree)
#text(model.tree,cex=.65)

############# WQ values effect on Filtration only #############

test2 <- test1[test1$Experiment=="Filtration",] # Filtraton trials only
model.rf.filter = randomForest(Clearance~Temp+Salinity+Turbidity+TPM+OC+Site,
                        data=test2, # use data with extreme values removed 
                        ntree=100,
                        mtry=3,
                        control=rpart.control(minsplit=2,cp=.05))
model.rf.filter
plot(model.rf.filter)
y.hat.filter = predict(model.rf.filter,newdata=test2) # model predicted values
res.filter = test2$Clearance - y.hat.filter # residuals - difference between measured values and model predicted values 
r.sq.filter = (var(test2$Clearance) - var(res))/var(test2$Clearance)
r.sq.filter # r squared value for random forest model

### Random Forest variable importance
Var_import <- importance(model.rf.filter)
Var_import <- Var_import[order(Var_import[,1], decreasing=TRUE),] # sort matrix highest to lowest - output names numeric
Var_import_df <- data.frame(as.list(Var_import)) # convert named numeric to data.frame
Var_import_df %<>% 
  pivot_longer(cols = c(Turbidity, Temp, TPM, Salinity, OC, Site), names_to = "Variable", values_to = "Importance") %>% 
  arrange(desc(Importance))
Var_import_df # dataframe with sorted importance values - highest to lowest




###################### Is this just exploritory? ################
m1 = lm(Chl.up~Chl.dn,data=test)
summary(m1)
plot(test$Chl.up,test$Chl.dn)
abline(m1,col=2,lty=2)
# Seemed like a dumb idea because we have very different sites.  What we're trying to accomplish
# is a comparison of chloroform upstream vs. downstream after controlling for other covariates (depth, temp, site, ect)
# To do this we will model choloroform up and cholorform down as a function of those covarates and then compare 
# residuals of those models.  
# The model we're choosing right now is just a linear model, we can substitude something more glamourous later if need be.

test1 = test[test$Experiment=="Filtration",]
par(mfrow=c(2,1))
plot(test$Chl.up,test$Chl.dn)
plot(test1$Chl.up,test1$Chl.dn)


upstream = test1[,-10] 
downstream = test1[,-9] 
upstream$stream = "upstream"
downstream$stream  = "downstream"
colnames(upstream)[9] = "clr"
colnames(downstream)[9] = "clr"
test2 = rbind(upstream,downstream)
colnames(test2)[12] = "Velocity"
control.model = lm(clr~Site+Temp+Salinity+Turbidity+TPM+OC+Depth+Distance+Velocity+Chl.removal+Clearance,data=test2)
test2$adjusted.clr = control.model$residuals + mean(test2$clr)

up.adj = test2$adjusted.clr[test2$stream=="upstream"]
dn.adj = test2$adjusted.clr[test2$stream=="downstream"]
up.adj = up.adj[-c(10,14)]
dn.adj = dn.adj[-c(10,14)]
#Assuming we have a good reason for dropping data point 10.

m2 = lm(up.adj~dn.adj+0)
summary(m2)
dev.off()
plot(up.adj,dn.adj)
abline(0,1,col=4,lwd=2,lty=2)
x.seq = seq(min(dn.adj),max(dn.adj),by = (max(dn.adj)-min(dn.adj))/1000)
conf.seq = predict.lm(m2,newdata=data.frame(dn.adj=x.seq),interval="confidence")
lines(x.seq,conf.seq[,1],col=2,lty=2,lwd=2)
lines(x.seq,conf.seq[,2],col=2,lty=2,lwd=1)
lines(x.seq,conf.seq[,3],col=2,lty=2,lwd=1)
text(up.adj+.08,dn.adj,(1:length(up.adj)))
slope = summary(m2)[[4]][1]
se = summary(m2)[[4]][2]
df = summary(m2)[[7]][2]

t = (slope-1)/se
p.val = 1-pt(t,df)
p.val
```

* Missing values / imputation
* Remove 3 extreme onservations

### Oyster vs mudflat t-test
* unadjusted control vs filtration t-test
* Random Forest Model
+ https://stackoverflow.com/questions/14996619/random-forest-output-interpretation
* Variable Importance - detrimental impact to model if variable removed
* adjusted control vs filtration t-test
* mean adjusted filter is practically very different than mean adjusted control HCR
* less emphasis on p-values because of small sample size

### Variables affecting HCR
* Random Forest Model
* Variable Importance

4 data values (2 TPM and 2 OC) values are missing from our dataset, representing `r round((4/336)*100, digits = 0)`% of the dataset. 
Removing these incomplete ovservations is costly for our data set where we have a limited number of observations with a larg number of variables. 
Instead we used a non parametric random forest imputation to estimate the missing values (MissForest Package;[@Stekhoven2012]).
Three extreme observations were removed from the dataset based on a correction-to-signal comparison (Shellmaker 2020/6/9, Shellmaker 2020/5/22, Deanza 2020/4/17).

### Oyster Habitat vs. Control 

The unadjusted filtration trials had significantly higher HCRs (habitat clearance rate) than negative controls (two sample t(`r t_test_df`) = `r round(filter_control_ttest$statistic, digits = 2)`, p = `r round(filter_control_ttest$p.value, digits = 2)`).
We used a fitted a Random Forest model to predict HCR from temperature, salinity, turbidity, TPM, OC, and site. Temperature had the most relative importance to the model (`r round(Temp_rel_import, 1)`%), followed by OC (`r round(OC_rel_import, 1)`%), turbidity (`r round(Turb_rel_import, 1)`%), TPM (`r round(TPM_rel_import, 1)`%), salinity (`r round(Sal_rel_import, 1)`%), and site (`r round(Site_rel_import, 1)`%) respectively.

```{r TPM_OC_models, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="default", fig.asp=0.618, fig.width=8,warning=F, message= F, fig.cap="The relationship between seston total particulate matter (TPM) and seston organic content (OC) across all sites and all trials. Two field days are missing TPM data because of filter processing errors. \\label{TPM_OC_models}"}
############ Linear Model
OC_TPM_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ Avg_TPM_mg_L)
#summary(OC_TPM_LM)
#par(mfrow=c(2,2))
#plot(OC_TPM_LM)

OC_TPM_graph <- ggplot(data = Avg_TPM_summary_table, aes(Avg_TPM_mg_L, Avg_OC_Ratio )) +
  geom_smooth(method = lm, se = F, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  ylim(0,0.5) +
  labs(x = TPM_Label,
       y = "Organic Content (ratio)") +
  guides(color = FALSE) +
  annotate("text", x = 60, y = 0.3, label = "y ~ x") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

############ Y ~ log(x)
OC_logTPM_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ log(Avg_TPM_mg_L))
#summary(OC_logTPM_LM)
#par(mfrow=c(2,2))
#plot(OC_logTPM_LM)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(OC_logTPM_all_LM)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(OC_logTPM_all_LM))

# create range of values to predict with model
TPM_newrange <- data.frame(Avg_TPM_mg_L = seq(from = 0, to = 80, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_OC = predict(OC_logTPM_LM, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

# Testing function to extract lm model
# equatiomatic::extract_eq(FR_logTPM_lm, use_coefs = T)

OC_logTPM_graph <- ggplot((Avg_TPM_summary_table), aes(Avg_TPM_mg_L, Avg_OC_Ratio)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM_mg_L, y = pred_OC)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  annotate("text", x = 60, y = 0.3, label = "y ~ log(x)") +
  guides(color = FALSE) +
  ylim(0,0.5) +
  labs(x = TPM_Label,
       y = "Organic Content (ratio)") +
  guides(fill = FALSE)

########## Log-log model 
logOC_logTPM_LM <- lm(data = Avg_TPM_summary_table, log(Avg_OC_Ratio) ~ log(Avg_TPM_mg_L))
#summary(logOC_logTPM_LM)

loglogTPM_Pred <- data.frame(pred_OC = exp(predict(logOC_logTPM_LM, newdata = TPM_newrange)))
pred_loglogTPM_df <- data.frame(TPM_newrange, loglogTPM_Pred)

logOC_logTPM_graph <- ggplot((Avg_TPM_summary_table), aes(Avg_TPM_mg_L, Avg_OC_Ratio)) +
  geom_line(data = pred_loglogTPM_df, aes(x = Avg_TPM_mg_L, y = pred_OC)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  guides(color = FALSE) +
  ylim(0,0.5) +
  annotate("text", x = 60, y = 0.3, label = "log(y) ~ log(x)") +
  labs(x = TPM_Label,
       y = "Organic Content (ratio)") +
  guides(fill = FALSE)

grid.arrange(OC_TPM_graph, OC_logTPM_graph, logOC_logTPM_graph, nrow = 2)

# compare models
#summary(OC_TPM_LM) # R2: 0.3309
#summary(OC_logTPM_LM) # R2: 0.2701
#summary(logOC_logTPM_LM) # R2: 0.3594
```

```{r FR_TPM_point, echo=FALSE, include=F, fig.keep = 'all', dev = 'pdf', fig.show="hold", fig.show = "hold", fig.align="center", fig.asp=0.618, fig.width=6, out.width="70%", warning = F, fig.cap="The habitat clearance rates and filtration trials in response to seston total particulate matter (TPM). Extreme values not included in the analysis are not shown. \\label{FR_ChlRmd_TPM_point}"}
### Doesn't make sense to include - doesn't align with Random Forest justificaiton - TPM x OC more interesting
############ All Filtration trials w/ outliers removed ##################

# Need to add relationship to graph
FR_TPM_graph <- ggplot(data = Filter_only_outRmd_data, aes(Avg_TPM_mg_L, L_hr_m2 )) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE)
  # line equation on graph
 # ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
  #             formula = x_y_formula,
   #            parse = TRUE,
     #          label.x = "right",
      #         label.y = "bottom")

plot(FR_TPM_graph)

########### Not Used - Positive Filtration trials only ########################
FRPos_TPM_graph <- ggplot(data = Filtration_pos_data, aes(Avg_TPM_mg_L, L_hr_m2 )) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE)
  # line equation on graph
 # ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
  #             formula = x_y_formula,
   #            parse = TRUE,
     #          label.x = "right",
      #         label.y = "bottom")

#plot(FRPos_TPM_graph)

############### Not USed- Chl Removed All Filtration Trials - outliers removed ########################
Chl_Rmd_TPM_graph <- ggplot(Filter_only_outRmd_data, aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  theme(legend.position = c(.85,.75),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) + 
  labs(x = TPM_Label,
       y = Prt_Chl_Label) 

### Not included Chl Removed graph - DZ meeting (2020/9/15)
# plot(Chl_Rmd_TPM_graph)

################ Not Used - Chl Removed Positive values only ################
Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  theme(legend.position = c(.85,.75),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) + 
  labs(x = TPM_Label,
       y = Prt_Chl_Label) 

#plot(Chl_RmdPos_TPM_graph)

#grid.arrange(FRPos_TPM_graph, Chl_RmdPos_TPM_graph, nrow = 1)
```

```{r FR_TPM_models, eval=FALSE, include=FALSE}

######## Don't include - Doesn't make sense to include this relationship with HCR with Random Forest analysis justification
##### TPM x OC makes more sense

FR_TPM_LM <- lm(data = Filter_only_outRmd_data, L_hr_m2 ~ Avg_TPM_mg_L)
# Extract LaTeX formula
equatiomatic::extract_eq(FR_TPM_LM, use_coefs = T)


FR_TPM_graph_lm <- ggplot(Filter_only_outRmd_data, aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_smooth(method = lm, se = F, color = "gray50") +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'Y ~ X') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# log-log model predicitons
logFR_logTPM_lm <- lm(data = Filter_only_outRmd_data, log(L_hr_m2) ~ log(Avg_TPM_mg_L))
# create range of values to predict with model
TPM_newrange <- data.frame(Avg_TPM_mg_L = seq(from = 0, to = 80, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogTPM_Pred <- data.frame(pred_FR = exp(predict(logFR_logTPM_lm, newdata = TPM_newrange)))
pred_loglog_TPM_df <- data.frame(TPM_newrange, loglogTPM_Pred)
  

logFR_logTPM_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_loglog_TPM_df, aes(x = Avg_TPM_mg_L, y = pred_FR)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'log(Y) ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons
FR_logTPM_lm <- lm(data = Filter_only_outRmd_data, L_hr_m2 ~ log(Avg_TPM_mg_L))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_FR = predict(FR_logTPM_lm, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

# Testing function to extract lm model
# equatiomatic::extract_eq(FR_logTPM_lm, use_coefs = T)

FR_logTPM_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM_mg_L, y = pred_FR)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'Y ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons --> producing complex numbers OR NaNs - Won't graph
logFR_TPM_lm <- lm(data = Filter_only_outRmd_data, log(L_hr_m2) ~ Avg_TPM_mg_L)
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logFR_Pred <- data.frame(pred_FR = exp(predict(logFR_TPM_lm, newdata = TPM_newrange)))
pred_logFR_df <- data.frame(TPM_newrange, logFR_Pred)

logFR_TPM_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_logFR_df, aes(x = Avg_TPM_mg_L, y = logFR_Pred)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'log(Y) ~ X') +
  guides(fill = FALSE)


# Y~x + x^2 model predicitons
FR_TPM2_lm <- lm(data = Filter_only_outRmd_data, L_hr_m2 ~ poly(Avg_TPM_mg_L, degree = 2, raw = T))
TPM2_Pred <- data.frame(FR_pred = predict(FR_TPM2_lm, newdata = TPM_newrange))
pred_TPM2_df <- data.frame(TPM_newrange, TPM2_Pred)

FR_TPM2_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_TPM2_df, aes(x = Avg_TPM_mg_L, y = FR_pred)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'Y ~ x + x^2') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x2_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(FR_TPM_graph_lm , logFR_logTPM_graph, FR_logTPM_graph, FR_TPM2_graph, nrow = 2)

summary(FR_TPM_LM)
summary(logFR_logTPM_lm)
summary(FR_logTPM_lm)
summary(FR_TPM2_lm)


```

```{r TPM_OC_Sites_graphs, echo=FALSE, include=F, fig.keep = 'all', dev = 'pdf', fig.align="default", fig.asp=0.618, fig.width=8, message= F, fig.cap="The relationship between seston total particulate matter (TPM) and seston organic content (OC) across all sites and all trials. \\label{TPM_OC_Sites_graphs}"}

TPM_OC_Deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")),
                        aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Newport Deanza") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_NPSM <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), 
                     aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Newport Shellmaker") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_SR <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")),
                   aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "San Rafael") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_MB <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), 
                   aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Morro Bay") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_bysite_graph <- grid.arrange(TPM_OC_SR, TPM_OC_MB, TPM_OC_NPSM, TPM_OC_Deanza, nrow = 2)
# using plot() renders plot twice. Grid.arrange must render on its own
# plot(TPM_OC_bysite_graph)
```

### Filter-feeding community

```{r Oly_DTW_Shell_length_setup, include=FALSE}
############ Olympia DTW and Shell Length #####################
# Determine what quadrat samples have missing data (NAs)
NPD_biv_bio_summary <- NPD_bivalves %>% 
  group_by(excavation_sample) %>% 
  summarize(avg_DTW = mean(tissue_dry_weight_g))

# what are the unique species in dataset
#unique(NPD_bivalves$species)

# Still contains missing data --> which quadrats to use for analyses
NPD_bivalve_data_clean <- NPD_bivalves %>% 
  filter(!excavation_sample %in% c("Q10", "Q4", "Q8")) %>% 
  mutate(species = ifelse(grepl("adula", ignore.case = T, species), "Adula diegensis",
                          ifelse(grepl("muscul.", ignore.case = T, species), "Musculista senhousia",
                                 ifelse(grepl("myt", ignore.case = T, species), "Mytilus galloprovincialis",
                                        ifelse(grepl(".lurida", ignore.case = T, species), "Ostrea lurida",
                                               ifelse(grepl("mussel", ignore.case = T, species), "Unknown mussel",
                                                      ifelse(grepl(".spinosum", ignore.case = T, species), "Crucibulum spinosum",
                                                       "Pattern Not Found"))))))) %>% 
  # Filter out unclassified/ empty species & samples less than 0g (processing error, doesn't make sense)
  filter(!species %in% c("Pattern Not Found", "Crucibulum spinosum"))


#Olympia DTW predicted by Shell Length - Newport, CA
# All excavation quadrat samples processed to date aggregated (summer 2020)
NPD_oly <- NPD_bivalve_data_clean %>% 
  filter(species == "Ostrea lurida") %>% 
  drop_na() %>% 
  as_tibble() 

Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method = lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top") +
  stat_quadrant_counts(quadrants = 0L, label.x = "left", 
                       aes(label = sprintf("%i observations", stat(count))))

#plot(Oly_shell_DTW)
```

```{r Gray_OlyDTW_SL}

Gray_Oly_Data <- fread(file.path('./Data/bivalve_density_community', "MattGray_2011_2013_Olurida_allometric_data.csv"))
colnames(Gray_Oly_Data) <- c("ID", "Date", "Species", "shell_length_mm", "shell_tissue_g", "vial_weight", "Vial_wet_oyster", "Tissue_weight_g", "vial_dry_oyster", "DTW_g")
Gray_Oly_Data %<>% 
  mutate(Species = ifelse(Species %in% "O. lurida", "Ostrea_lurida", "Pattern Not FOund"))

```

```{r Oly_DTW_SH_outlier_rmd, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="center", out.width = "70%", fig.asp=0.618, fig.width=6, fig.cap="The relationship between \\*O. lurida* shell length and its dry tissue weight (DTW) in Newport Bay, California at the Deanza restoration site. Outlier data (outside mean +- 2.2 SD) and negative values are excluded. \\label{Oly_DTW_SH_outlier_rmd}"}
# Remove outlier and negative DTW value
NPD_oly_outRmd <- NPD_oly %>%
  mutate(DTW_outlier = find_outlier(NPD_oly$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0) 

# Graph with outliers removed
Oly_shell_DTW_rm_out <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method=lm, formula = x_y_formula, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
 # scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom") 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_DTW_rm_out)
```

```{r Linear_model_DTW_length, fig.height=6, fig.width=6,  include=FALSE}
# Linear model to predict Dry Tissue weight (g) with Oly shell length (mm)
## This model doesn't not makes sense. DTW will never be negative. DTW will approach zero as length decreases. 
Oly_DTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ length_mm)
ols_regress(Oly_DTW_lm)

# coeficent results from linear model
Oly_DTW_SL_coef <- coef(Oly_DTW_lm)
# y-intercept in [[1]] position
Oly_DTW_SL_coef[[1]]
# creat function from model results
Oly_DTW_SL_model <- function(length_mm) {length_mm*Oly_DTW_SL_coef[[2]] + Oly_DTW_SL_coef[[1]]}

```


```{r Oly_DTW_SH_out_rmd_Trans, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="default", warning=F, message=F, fig.asp=0.618, fig.width=8, fig.cap="The relationship between \\*O. lurida* shell length and its dry tissue weight (DTW) in Newport Bay, California at the Deanza restoration site. Possible transformations. \\label{Oly_DTW_SH_out_rmd_Trans}"}

### y ~ log(x) model ####
Oly_LogxDTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ log(length_mm))
# range of Shell length values
SH_newrange <- data.frame(length_mm = seq(from = 0, to = 53, by = 1))
# create new dataframe with model predicted values from new data range above
pred_logxDTW_SH <- data.frame(DTW_pred = predict(Oly_LogxDTW_lm, newdata = SH_newrange), length_mm = SH_newrange)

# graph with model predicted values to draw line
Oly_SH_logxDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_logxDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "y ~ log(x)") +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### log(y) ~ x model ####
Oly_LogDTW_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ length_mm)
pred_logDTW_SH <- data.frame(DTW_pred = exp(predict(Oly_LogDTW_lm, newdata = SH_newrange)), length_mm = SH_newrange)

Oly_shell_DTW_logline <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_logDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "log(y) ~ x")+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### log(y) ~ log(x) model ###
Oly_LogDTW_logSH_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ log(length_mm))
# predict values for model based on model and new range of data. exp() converts log() values to regular values
pred_loglogDTW_SH <- data.frame(DTW_pred = exp(predict(Oly_LogDTW_logSH_lm, newdata = SH_newrange)), 
                                length_mm = SH_newrange)

Oly_shell_logDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_loglogDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "log(y) ~ log(x)")+
  labs(x = 'Shell Length (mm)',
       y = ' Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### Y ~ x + x^2
Oly_DTW2_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ poly(length_mm, degree = 2, raw = T))
SH_newrange <- data.frame(length_mm = seq(from = 2, to = 52, by = 1))
pred_DTW2_SH_df <- data.frame(tissue_dry_weight_g = predict(Oly_DTW2_lm, newdata = SH_newrange), SH_newrange)

Oly_SH_DTW2_graph <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW2_SH_df, aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "Y ~ x + x^2")+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

OlySH_DTW_Trans_graphs <- grid.arrange(Oly_SH_logxDTW, Oly_shell_DTW_logline, 
                                        Oly_shell_logDTW, Oly_SH_DTW2_graph, nrow = 2)

#plot(OlySH_DTW_Trans_graphs)

```

```{r NPD_OlyDTW_SL_ylogx eval=FALSE, include=FALSE}
### Doesn't look like a good fit
Oly_LogxDTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ log(length_mm))
summary(Oly_LogxDTW_lm)
#ols_regress(Oly_LogxDTW_lm)
```

```{r NPD_Oly_DTW_SL_logy, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
# This model makes more sense. DTW will never be negative whill length is positive 
Oly_LogDTW_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ length_mm)
#ols_regress(Oly_LogDTW_lm)
summary(Oly_LogDTW_lm) # residuals median should be close to 0? #https://boostedml.com/2019/06/linear-regression-in-r-interpreting-summarylm.html
# Q1 and Q3 should have similar magnitude
#### Boxplot of residuals
boxplot(Oly_LogDTW_lm[['residuals']],main='Boxplot: Residuals',ylab='residual value')

coef(Oly_LogDTW_lm) # The intercept tells us that when all the features are at 0
confint(Oly_LogDTW_lm) # confidence interval
residuals(Oly_LogDTW_lm) # residuals of each data point entered into model

#### I don't think this function methods works
#Oly_LogDTW_model <- function(x) {coef(Oly_LogDTW_lm)[[2]]*x + exp(coef(Oly_LogDTW_lm)[[1]])}

########## OR this ##################
# use predict() instead of creating a function? Use function inside of predict.
# Does predict() include error term inherint in lm()?

predict_DTW_logy <- function(data){
  exp(predict(Oly_LogDTW_lm, newdata = data.frame(length_mm = data$length_mm))) 
  # exp() converts log value, predict needs data.frame input
  # does predict() include error term inherently in lm()
}


```

```{r NPD_Oly_DTW_SL_loglog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
## This model has a better fit than log(y) ~ x
Oly_LogDTW_logSH_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ log(length_mm))
#ols_regress(Oly_LogDTW_logSH_lm)
summary(Oly_LogDTW_logSH_lm)
coef(Oly_LogDTW_logSH_lm)

par(mfrow=c(2,2))
plot(Oly_LogDTW_logSH_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(Oly_LogDTW_logSH_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(Oly_LogDTW_logSH_lm))

# copied code from Dr. Nichols to extract model attributes. Do I need to exp() on any of these?
DTW_slope = summary(Oly_LogDTW_logSH_lm)[[4]][1] # is this really the slope? Matches the intercept
DTW_se = summary(Oly_LogDTW_logSH_lm)[[4]][2]
DTW_df = summary(Oly_LogDTW_logSH_lm)[[7]][2]

DTW_t = (DTW_slope-1)/DTW_se
DTW_p.val = 1-pt(DTW_t,DTW_df)
DTW_p.val

# create function to predict DTW values from Shell length - Need error term in equation?? 
#Oly_loglogDTWSH_model <- function(x){coef(Oly_LogDTW_logSH_lm)[[2]]*log(x) + exp(coef(Oly_LogDTW_logSH_lm)[[1]])}

# Maybe use predict() instead of function?? 
predict_DTW_loglog <- function(data){
  exp(predict(Oly_LogDTW_logSH_lm, newata = data.frame(length_mm = data$length_mm)))
}
# show the available object attributes
str(Oly_LogDTW_logSH_lm)

```

```{r NPD_Oly_DTW_SL_poly2 eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_DTW2_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ poly(length_mm, degree = 2, raw = T))
summary(Oly_DTW2_lm)
#ols_regress(Oly_DTW2_lm)
```

```{r Oly_TWW_DTW_outRmd, echo=FALSE, fig.align="default", fig.asp=0.618, fig.cap="The relationship between \\*O. lurida* total wet weight (TWW) and its dry tissue weight (DTW) in Newport Bay, California at the Deanza restoration site. Blue dashed lines represent the relationship found by Gray and Langdon (2018) in Yaquina Bay, Oregon Olympia oysters (DTW = 0.0044*TWW - 0.043). \\label{Oly_TWW_DTW_outRmd}", fig.keep='all', fig.width=8, message=FALSE, warning=FALSE, dev='pdf'}

# Make sure only using positive TWW values, negative values indicate processing error
NPD_oly_TWW <- NPD_oly_outRmd %>% 
  filter(total_wet_weight_g > 0)
# Gray & Langdon 2017 TWW ~ DTW Olympia model to add to graph
Gray18_DTW_TWW_lm <- function(x) 0.0044*x - 0.043 
# Gray disertation 2016 - exponential 
Gray18_DTW_TWW_lm_loglog <- function(TWW) ((0.0044^(-0.043))*(TWW^(-0.043)))


# use DTW outlier data to plot graph
Oly_TWW_DTW_rm_out <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  xlim(0, 7) +
  scale_color_manual(values = Species_colors, guide=FALSE) +
  geom_function(fun = Gray18_DTW_TWW_lm, 
                colour = "blue", linetype = "dashed") + # plots function without data
  geom_function(fun = Gray18_DTW_TWW_lm_loglog, 
                colour = "red", linetype = "dashed") + # plots function without data
  theme_classic() +
  labs(x = 'Total wet weight (g)',
       y = 'Dry Tissue Weight (g)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

### log(y) ~ x
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ total_wet_weight_g)
TWW_newrange <- data.frame(total_wet_weight_g = seq(from = 0, to = 7, by = 0.01))
pred_DTW_TWW_log_df <- data.frame(tissue_dry_weight_g = exp(predict(Oly_TWW_DTW_log_LM, newdata = TWW_newrange)),
                              TWW_newrange)

Oly_logTWW_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW_TWW_log_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
 # stat_function(fun = Gray18_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  ylim(0,0.3) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "log(y) ~ x") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')

### log(y) ~ log(x)
Oly_TWW_DTW_loglog_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
pred_DTW_TWW_loglog_df <- data.frame(tissue_dry_weight_g = exp(predict(Oly_TWW_DTW_loglog_LM, newdata = TWW_newrange)),
                              TWW_newrange)

Oly_loglogTWW_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW_TWW_loglog_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  #stat_function(fun = Gray18_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  ylim(0,0.3) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "log(y) ~ log(x)") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')

### y ~ x + x^2
Oly_TWW2_DTW_LM <- lm(data = NPD_oly_TWW, 
                        tissue_dry_weight_g ~ poly(total_wet_weight_g, degree = 2, raw = T))
pred_DTW2_TWW_log_df <- data.frame(tissue_dry_weight_g = predict(Oly_TWW2_DTW_LM, newdata = TWW_newrange),
                              TWW_newrange)

Oly_TWW2_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW2_TWW_log_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
 # stat_function(fun = Gray18_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  ylim(0,0.3) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "y ~ x + x^2") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')
       
Oly_TWW_DTW_outRmd_graph <- grid.arrange(Oly_TWW_DTW_rm_out, Oly_logTWW_DTW_graph,
                                          Oly_loglogTWW_DTW_graph, Oly_TWW2_DTW_graph, nrow = 2)

#plot(Oly_TWW_DTW_outRmd_graph)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_lm_rm_out <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ total_wet_weight_g)

ols_regress(Oly_TWW_DTW_lm_rm_out)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(Oly_TWW_DTW_lm_rm_out)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(Oly_TWW_DTW_lm_rm_out)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(Oly_TWW_DTW_lm_rm_out))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ total_wet_weight_g)
ols_regress(Oly_TWW_DTW_log_LM )
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_loglog_LM <- lm(data = NPD_oly_TWW, 
                         log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
ols_regress(Oly_TWW_DTW_loglog_LM)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW2_DTW_LM <- lm(data = NPD_oly_TWW, 
                        tissue_dry_weight_g ~ poly(total_wet_weight_g, degree = 2, raw = T))
ols_regress(Oly_TWW2_DTW_LM)
```

```{r NPD_Bivalve_SH_DTW_outrmd, fig.align="center", fig.asp=0.618, fig.cap="The biomass of bivalves excavated from Deanza in Newport Bay \\label{NPD_Bivalve_SH_DTW_outrmd}", fig.keep='all', fig.width=8.6, dev='pdf', include=FALSE, out.width="100%"}
###### Not included - Need code for other graphs ######### 

# Remove outlier and negative DTW value
NPD_bivalve_outrmd <- NPD_bivalve_data_clean %>%
  mutate(DTW_outlier = find_outlier(NPD_bivalve_data_clean$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0) 

#NPD_bivalve_outrmd_graph <- NPD_bivalve_outrmd %>% 
 # ggplot(aes(x = length_mm, y = tissue_dry_weight_g, group = species, color = species)) +
  #geom_point() +
#  scale_color_manual(values = Species_colors, guide = FALSE) +
 # facet_wrap(~species) +
  #labs(x = "Shell length (mm)",
#       y = "Dry Tissue Weight (g)",
 #      title = "NPD Bivalve Biomass - Pos DTW Outlier Rmd") +
#  theme_classic() +
 # theme(strip.text = element_text(face = "italic"))

# NPD_bi_Biomass_graphs <- grid.arrange(NPD_bivalve_biomass_graph, NPD_bivalve_outrmd_graph, nrow = 1)
#plot(NPD_bivalve_outrmd_graph)
```

```{r Bivalve_Den_bargraph, echo=FALSE, fig.align="center", fig.asp=0.618, fig.width=6, warning= F, message= F, fig.keep='all', dev='pdf', out.width="70%", fig.cap="The bivlaves community density and composition for each study site. San Rafael data was collected November 2017 by the Zabin lab, Morro Bay was estimated by Morro Bay Oyster Company, and Shellmaker and Deanza were surveyed in May 2018 by the Zacherl lab.  \\label{Bivalve_Den_Biomass}"}
################### Bivalve Density by Site #########################
# read in bivalve density data from cleaned data file
Bivalve_Den_data <- fread(file.path(Bivalve_output_directory, "Bivalve_Density_summary.csv"))

# replace NAs with 0s
Bivalve_Den_data[is.na(Bivalve_Den_data)] <- 0

Bivalve_Den_data <- Bivalve_Den_data %>% 
  # move species from individual columns to a single column with new density column to contain data
  pivot_longer(c(Adula_diegensis_m2, Musculista_senhousia_m2, Mytilus_galloprovincialis_m2,
                 Ostrea_lurida_m2, Crassostrea_gigas_m2, Argopecten_ventricosa_m2, 
                 Geukensia_demissa_m2, Crassostrea_gigas_m2), 
               names_to = "Species", 
               values_to =  "individuals_m2") %>% 
  # remove "_m2" from species names in Species column
  mutate(Species = str_replace(Species, "_m2", ""),
         Species = str_replace(Species, "_", " "))

#Reorder levels of Site factor - display North to South
order_by_site <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
Bivalve_Den_data <- arrange(transform(Bivalve_Den_data, Site = factor(Site,levels = order_by_site)), Site)


#unique(Bivalve_Den_data$Species) # list each individual bivalve species
# Assign species to specific color
Species_colors <- c("Adula diegensis" = "#8D8680",
                    "Argopecten ventricosa" = "#CCC3C5",
                    "Crassostrea gigas" = "#6D6340",
                    "Geukensia demissa" = "#524D4F",
                    "Musculista senhousia" = "#B0915B",
                    "Mytilus galloprovincialis" = "#7E4B41",
                    "Ostrea lurida" = "#9986A5",
                    "Unknown mussel" = "black")

# Stacked bar graph
Bivalve_Den_graph <- ggplot(Bivalve_Den_data, aes(Site)) + 
  geom_col(aes(x = Site, y = individuals_m2, fill = Species)) +
 # geom_text(aes(label = round(Bivalve_den_m2,0), y = Bivalve_den_m2), 
          #  vjust = -0.5) +
  theme_classic() +
  theme(legend.text = element_text(face = "italic")) +
  scale_fill_manual(values = Species_colors) +
  scale_y_continuous(breaks = seq(0, max(Bivalve_Den_data$Bivalve_den_m2), by = 500)) +
  labs(y = expression("Individuals per m"^2))
Bivalve_Den_graph
```

```{r Bivalve_biomass_bargraph, echo=FALSE, fig.align="center", fig.asp=0.618, fig.width=6, warning= F, message= F, fig.keep='all', dev='pdf', out.width="70%", fig.cap="Estimated biomass of \\textit{O. lurida} habitat at Newport Deanza and San Rafael sites. Data for Deanza was collected by the Zacherl lab in May 2018, the relationship between \\*O. lurida* shell length and dry tissue weight (DTW) from the Deanza 2018 survey was used to estimate DTW at San Rafael with shell length data collected by the Zabin lab in November 2017. \\label{Bivalve_Den_Biomass}"}
######### Biomass by Site ############################
# excavation quadrat area m^2 (0.25 x 0.25m)
NP_excavation_quad_area = 0.0625
# calculate DTW / m^2 / species 
NPD_biv_DTW_m2 <- NPD_bivalve_outrmd %>% 
  group_by(excavation_sample, species) %>% 
  summarize(mean_DTW = mean(tissue_dry_weight_g)) %>% # show the average DTW for each species within each excav sample
  ungroup() %>% # undo previous grouping by excavation_sample and species
  group_by(species) %>% # new grouping by species to determine the average DTW by species across all quads
  summarize(mean_DTW_m2 = mean(mean_DTW/NP_excavation_quad_area)) %>% 
  mutate(Site = "Deanza") %>%  # add new column with site info for bar graph
  rename(Species = species) # rename column with capital case

################### Biomass by species San Rafael ####################
# double dot in file path steps down from current folder "Thesis_Manuscript" back to project level folder
SR_Density_directory = "./Data/bivalve_density_community"
SR_Oly_Shelllength_data = fread(file.path(SR_Density_directory, "Insitu_Filter_SR_oyster_length.csv"))

######## Predict SR DTW with shell length #########
####### log(y) ~ x 
predict_DTW_logy <- function(data){
  exp(predict(Oly_LogDTW_lm, newdata = data.frame(length_mm = data$length_mm))) 
  # exp() converts log value, predict needs data.frame input
  # does predict() include error term inherently in lm()
}

SR_Oly_DTW_data <- SR_Oly_Shelllength_data %>% 
  mutate(DTW_g = predict_DTW_logy(SR_Oly_Shelllength_data)) %>%  # predict Oly Dry tissue weight with length_mm
  group_by(Site, bag_number) %>% 
  summarize(DTW_bag = mean(DTW_g)) # average DTW per sample bag

Oly_italic <- expression(italic("Ostrea lurida"))

SR_Oly_DTW_data2 <- SR_Oly_DTW_data %>% 
  ungroup() %>% 
  group_by(Site) %>% # regroup by site
  summarize(DTW_bag_avg = mean(DTW_bag)) %>% # average DTW across sample bags
  mutate(mean_DTW_m2 = DTW_bag_avg * 18,
         Species = "Ostrea lurida") # sample bag is 1/3 the size of regular shell bag. There are 6 full size bags on the 
# top of the reef unit at San Rafael. The units are 1 x 1 x 1m, so the top area of the reef is 1m^2. (3 * 6 = the amount in 1m^2)

SR_Oly_DTW_data3 <- SR_Oly_DTW_data2 %>% 
  dplyr::select(-(DTW_bag_avg)) # remove DTW_bag_avg 
SR_Oly_DTW_data4 <- data.frame(SR_Oly_DTW_data3) # convert wierd mess of types into a data.frame

SR_NPD_biv_DTWm2 <- rbind(SR_Oly_DTW_data4, NPD_biv_DTW_m2)

####### Bar graph NPD Biomass / DTW by species
Bivalve_Biomass_graph <- ggplot(SR_NPD_biv_DTWm2, aes(Site)) + 
  geom_col(aes(x = Site, y = mean_DTW_m2, fill = Species)) +
  theme_classic() +
  scale_fill_manual(values = Species_colors) +
  theme(legend.text = element_text(face = "italic")) +
  #scale_y_continuous(breaks = seq(0, max(NPD_Posbiomass_outlier$tissue_dry_weight_g), by = 500)) +
  labs(y = expression("Dry Tissue Weight (g/m" ^2* ")"))
## Add total Biomass on top of bars
Bivalve_Biomass_graph
#bar_graphs <- plot_grid(Bivalve_Den_graph + theme(legend.position="none"),
 #                       Bivalve_Biomass_graph + theme(legend.position="none"),
  #                      align = 'vh',
   #                     labels = c("A", "B"),
    #                    hjust = -1,
     #                   nrow = 1)
#legend_b <- get_legend(Bivalve_Den_graph + theme(legend.box.margin = margin(0, 0, 0, 12)))
#bar_graph_1legend <- plot_grid(bar_graphs, legend_b, rel_widths = c(3, .4))
# How do I move legend inside of plot area? This method uses cowplot
#bar_graph_1legend

### Might be better to have separate graphs so size scaling & fonts stays good when knitting. Legend could takeup more room next to DTW graph, forcing columns to compact. Figure out how to display legend with more data then is present in the data.frame.
```

```{r Bar_Graphs_up_vs_down,  include=FALSE}
Bar_up_down_data <- Master_analysis_table %>%
 # select(Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>%
  rename(Upstream = Chl_ug_L_Up, Downstream = Chl_ug_L_Down) %>%  
  gather(Upstream, Downstream, key = Position, value = Chl_ug_L) %>% 
  mutate(Position = fct_relevel(Position, 'Upstream', 'Downstream')) %>% 
  mutate(Site = fct_relevel(Site, 'Deanza', 'Shellmaker', 'San Rafael', 'Morro Bay')) %>% 
  mutate(Site_exp_date = paste(Site, Experiment, Date, sep = ' ')) %>% 
  mutate(Exp_Date = paste(Experiment, Date, sep = ' ')) %>% 
  arrange(Site, mdy(Date))

#Bar_up_down_data$Position <- as.factor(Bar_up_down_data$Position)

Paired_bar_chl_graph <- ggplot(data = Bar_up_down_data, aes(x = Site_exp_date, y = Chl_ug_L, fill = Position)) +
    geom_bar(stat="identity", position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_grid(~ Site, scales = "free", space = "free") + #'free' allows axis b/w sites uneaven
    geom_bar(data = (Bar_up_down_data %>%
                       filter(!Experiment %in% c('Filtration'))),
             color = "grey22",
             stat="identity",
             position = "dodge") +
    labs(x = 'Experiment', y = 'Chlorophyl (ug/L)')

plot(Paired_bar_chl_graph)
```

```{r Bar_Graphs_up_vs_down_grid.arrange, echo=FALSE, fig.align="default", fig.asp=0.75, fig.keep='all', fig.width=8.6, dev='pdf', out.width="100%", fig.cap="Chlorphyll concentrations measured at upstream and downstream instruments across all sites, filtration trials, and negative controls. \\label{Bar_Graphs_up_vs_down_grid.arrange}"}
############## Try 2 ####### make separate graphs, combine using grid.arrange()

##### Can't figure out how to properly label x axis. Works with Exp_Date, but can't shorten without messing up data:label pairs. Can't spend more time on this right now. come back if time -AM 2020_3_3

NPD_bar_data <- Bar_up_down_data %>% 
  filter(Site == "Deanza") %>% 
  mutate(graph_Label = ifelse(grepl("^Filtration", Exp_Date), str_replace(Exp_Date, "Filtration ", ""),
                             str_replace(Exp_Date, "^Neg Control .", "")))

NPD_bar_graph <- ggplot(data = NPD_bar_data, aes(x = Exp_Date, y = Chl_ug_L, 
                                                 fill = Position)) +
    geom_col(position = position_dodge(width = 0.9, preserve = "single")) +
    geom_col(data = (NPD_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.x = element_blank(),
          legend.position = c(0.9, 0.8),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(y = 'Chlorophyll a (ug/L)', title = "Newport Deanza") +
  # This labels the x-axis
    #scale_x_discrete(labels = Exp_Date) +
    ylim(0, 8)

NPSM_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Shellmaker')

NPSM_bar_graph <- ggplot(data = NPSM_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPSM_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Newport Shellmaker") +
    # scale_x_discrete(labels = NPSM_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE) 

MB_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Morro Bay')

MB_bar_graph <- ggplot(data = MB_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (MB_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Morro Bay") +
   # scale_x_discrete(labels = MB_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

SR_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'San Rafael')

SR_bar_graph <- ggplot(data = SR_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (SR_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "San Rafael") +
    #scale_x_discrete(labels = SR_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

Chl_graphs <- list(NPD_bar_graph, NPSM_bar_graph, SR_bar_graph, MB_bar_graph) 
all_chl_graphs <- grid.arrange(grobs = Chl_graphs,
             widths = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1),
             layout_matrix = rbind(c(NA,1,1,1,1,1,1,1,1,1,1,1,1, NA),
                                   c(2,2,2,2,2,3,3,3,3,3,4,4,4,4)))
#plot(all_chl_graphs)
#ggsave("Insitu_Filter_up_vs_down_all_sites.png", all_chl_graphs)
```

```{r EXTRA ANALYSIS CODE, eval=FALSE, include=FALSE}
\/ \/ \/ THIS IS ALL EXTRA EXPLORATORY ANALYSIS NOT USED BELOW THIS POINT \/ \/ \/
```

```{r ChlRmdpos_TPM_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_TPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_TPM_mg_L)
#summary(ChlRmdPos_TPM_lm)
ols_regress(ChlRmdPos_TPM_lm)
# Not significant
```

```{r ChlRmdpos_TPM_LM_diagnostics, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_TPM_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_TPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_TPM_lm)
```

```{r ChlRmd_TPM_Transform, eval=FALSE, fig.width=12, include=FALSE}
Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# log-log model predicitons
logChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_TPM_mg_L))
# create range of Salinity values to predict with model
TPM_newrange <- data.frame(Avg_TPM_mg_L = seq(from = 0, to = 0.04, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogTPM_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logTPM_lm, newdata = TPM_newrange)))
pred_loglog_TPM_df <- data.frame(TPM_newrange, loglogTPM_Pred)
  

logChlRmdPos_logTPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglog_TPM_df, aes(x = Avg_TPM_mg_L, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'log(Y) ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons
ChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_TPM_mg_L))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logTPM_lm, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

ChlRmdPos_logTPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM_mg_L, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'Y ~ log(X)') +
  guides(fill = FALSE)

# Y~x + x^2 model predicitons
ChlRmdPos_TPM2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Avg_TPM_mg_L, degree = 2, raw = T))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
TPM2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_TPM2_lm, newdata = TPM_newrange))
pred_TPM2_df <- data.frame(TPM_newrange, TPM2_Pred)

ChlRmdPos_TPM2_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_line(data = pred_TPM2_df, aes(x = Avg_TPM_mg_L, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'Y ~ x + x^2') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x2_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(Chl_RmdPos_TPM_graph, logChlRmdPos_logTPM_graph, 
             ChlRmdPos_logTPM_graph, ChlRmdPos_TPM2_graph, nrow = 2)
```

```{r logChlRmdPos_logTPM_lm, eval=FALSE,  include=FALSE}
logChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_TPM_mg_L))
#summary(ChlRmdPos_TPM_lm)
ols_regress(logChlRmdPos_logTPM_lm)
```

```{r logChlRmdPos_logTPM_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(logChlRmdPos_logTPM_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logTPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logTPM_lm)
```

```{r ChlRmdPos_logTPM_lm, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_TPM_mg_L))
#summary(ChlRmdPos_logTPM_lm)
ols_regress(ChlRmdPos_logTPM_lm)
```

```{r ChlRmdPos_TPM2_lm, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_TPM2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Avg_TPM_mg_L, degree = 2, raw = T))
#summary(ChlRmdPos_TPM_lm)
ols_regress(ChlRmdPos_TPM2_lm)
```

```{r ChlRmdPos_TPM2_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_TPM2_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logTPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logTPM_lm)
```

```{r NPD_FRPos_TPM_graph, echo=FALSE, eval=F}
NPD_FRPos_TPM_graph <- ggplot((Deanza_PosFilter_data), aes(Avg_TPM_mg_L, L_hr_m2 )) +
  geom_smooth(method = lm, se = F, color = 'grey50') + #se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(NPD_FRPos_TPM_graph)

NPD_ChlRmdPos_TPM_graph <- ggplot((Deanza_PosFilter_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label) +
  guides(color = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(NPD_ChlRmdPos_TPM_graph)
#grid.arrange(NPD_FRPos_TPM_graph, NPD_ChlRmdPos_TPM_graph, nrow = 1)
```

```{r NPD_FRpos_TPM_LM, eval=FALSE, cache=T, include=FALSE}
NPD_PosFR_TPM_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_TPM_mg_L)
ols_regress(NPD_PosFR_TPM_lm)
```

```{r NPD_ChlRmdPos_TPM_LM, eval=FALSE, cache=T, include=FALSE}
NPD_PosChlRmd_TPM_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_TPM_mg_L)
ols_regress(NPD_PosChlRmd_TPM_lm)
```

```{r NPD_PosChlRmd_TPM_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_PosChlRmd_TPM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_PosChlRmd_TPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_PosChlRmd_TPM_lm)
```

```{r FRPos_Chlpos_PIM, eval=FALSE, include=FALSE}
FRPos_PIM_graph <- ggplot(Filtration_pos_data, aes(Avg_PIM, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = PIM_Label,
       y = Hab_FR_Label,
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FRPos_PIM_graph)

Chl_RmdPos_PIM_graph <- ggplot(Filtration_pos_data, aes(Avg_PIM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = PIM_Label,
       y = Prt_Chl_Label,
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FRPos_PIM_graph)
#grid.arrange(FRPos_PIM_graph, Chl_RmdPos_PIM_graph, nrow = 1)
```

```{r FRPos_PIM_LM, eval=FALSE,  include=FALSE}
FRPos_PIM_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_PIM)
ols_regress(FRPos_PIM_lm)
```

```{r ChlRmdPos_PIM_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_PIM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_PIM)
ols_regress(ChlRmdPos_PIM_lm)
```

```{r ChlRmdPos_PIM_LM_Diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_PIM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_PIM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_PIM_lm)
```

```{r Deanza_Filter_Pos_PIM, eval=FALSE,  include=FALSE}
NPD_FRPos_PIM_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_PIM, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = PIM_Label,
       y = Hab_FR_Label,
       title = 'Deanza Positive Filtration') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_PIM_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_PIM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = PIM_Label,
       y = Prt_Chl_Label,
       title = 'Deanza Positive Filtration') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(NPD_FRPos_PIM_graph, NPD_ChlRmdPos_PIM_graph, nrow = 1)
```

```{r NPD_FRpos_PIM_LM, eval=FALSE,  include=FALSE}
NPD_FRpos_PIM_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_PIM)
ols_regress(NPD_FRpos_PIM_lm)
```

```{r NPD_ChlRmdpos_PIM_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdpos_PIM_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_PIM)
ols_regress(NPD_ChlRmdpos_PIM_lm)
```

```{r NPD_ChlRmdpos_PIM_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_ChlRmdpos_PIM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_ChlRmdpos_PIM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_ChlRmdpos_PIM_lm)
```

```{r FRPos_OC, eval=FALSE,   include=FALSE}
FRPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_RmdPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FRPos_OC_graph, Chl_RmdPos_OC_graph, nrow = 1)
```

```{r FRPos_OC_LM, eval=FALSE,  include=FALSE}
FRPos_OC_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_OC_Ratio)
ols_regress(FRPos_OC_lm)
```

```{r ChlrRmdPos_OC_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
ols_regress(ChlRmdPos_OC_lm)
```

```{r ChlRmdPos_OC_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_OC_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_OC_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_OC_lm)
```

```{r ChlRmdPos_OC_LM_Trans, eval=FALSE,  include=FALSE}
logChl_RmdPos_logOC_graph <- ggplot(Filtration_pos_data, 
                                    aes(log(Avg_OC_Ratio), log(pcnt_Chl_rmvd))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = expression(paste(log[n],' Organic Content of Seston (fraction)')),
       y = expression(paste(log[n], " Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE)

# log-log model predicitons
logChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
OC_newrange <- data.frame(Avg_OC_Ratio = seq(from = 0.6, to = 1, by = 0.025))
loglogOC_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logOC_lm, newdata = OC_newrange)))
pred_loglogOC_df <- data.frame(OC_newrange, loglogOC_Pred)

ChlRmdPos_loglogOC_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogOC_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'log(y) ~ log(x)') +
  guides(fill = FALSE)

# Y-log model predicitons
ChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
logOC_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logOC_lm, newdata = OC_newrange))
pred_logOC_df <- data.frame(OC_newrange, logOC_Pred)

ChlRmdPos_logOC_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logOC_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'y ~ log(x)') +
  guides(fill = FALSE)

# Y-x + x^2 model predicitons
ChlRmdPos_OC2_lm <- lm(data = Filtration_pos_data, 
                         pcnt_Chl_rmvd ~ poly(Avg_OC_Ratio, degree = 2, raw = T))
OC2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_OC2_lm, newdata = OC_newrange))
pred_OC2_df <- data.frame(OC_newrange, OC2_Pred)

ChlRmdPos_OC2_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_OC2_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'y ~ x + x^2') +
  guides(fill = FALSE)

grid.arrange(logChl_RmdPos_logOC_graph, ChlRmdPos_loglogOC_graph,
             ChlRmdPos_logOC_graph, ChlRmdPos_OC2_graph, nrow = 2)

```

```{r ChlRmdPos_Loglog_LM, eval=FALSE,  include=FALSE}
logChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
ols_regress(logChlRmdPos_logOC_lm)
```

```{r ChlRmdPos_OC_logLM, eval=FALSE,  include=FALSE}
ChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
ols_regress(ChlRmdPos_logOC_lm)
```

```{r ChlrRmdPos_OC_PolyLM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC2_lm <- lm(data = Filtration_pos_data, 
                       pcnt_Chl_rmvd ~ poly(Avg_OC_Ratio, degree = 2, raw = T))
ols_regress(ChlRmdPos_OC2_lm)
```

```{r Deanza_Filter_Pos_OC_graph, eval=FALSE,  include=FALSE}
FRPos_OC_NPD_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plor(FRPos_OC_NPD_graph)

Chl_RmdPos_OC_NPD_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(Chl_RmdPos_OC_NPD_graph)
#grid.arrange(FRPos_OC_NPD_graph, Chl_RmdPos_OC_NPD_graph, nrow = 1)
```

```{r NPD_FRpos_OC_LM, eval=FALSE,  include=FALSE}
FRPos_OC_NPD_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_OC_Ratio)
ols_regress(FRPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC_NPD_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
ols_regress(ChlRmdPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_OC_NPD_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_OC_NPD_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_logLM, eval=FALSE,  include=FALSE}
ChlRmdPos_logOC_NPD_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
ols_regress(ChlRmdPos_logOC_NPD_lm)
```

```{r ANOVA_ChlRmdPos_OC_NPD_LM, eval=FALSE, include=FALSE}
anova(ChlRmdPos_OC_NPD_lm, ChlRmdPos_logOC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_loglogLM, eval=FALSE,  include=FALSE}
logChlRmdPos_logOC_NPD_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
ols_regress(logChlRmdPos_logOC_NPD_lm)
```


```{r SR_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_SR <- Avg_TPM_summary_table %>% filter(Site == "San Rafael")

OC_TPM_SR_LM <- lm(data = TPM_SR, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_SR_LM)
```

```{r MB_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_MB <- Avg_TPM_summary_table %>% filter(Site == "Morro Bay")

OC_TPM_MB_LM <- lm(data = TPM_MB, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_MB_LM)
```

```{r NPSM_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPSM <- Avg_TPM_summary_table %>% filter(Site == "Shellmaker")

OC_TPM_NPSM_LM <- lm(data = TPM_NPSM, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_NPSM_LM)
```

```{r NPD_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_TPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_NPD_LM)
```

```{r NPD_TPM_OC_LMlog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_logTPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ log(Avg_TPM_mg_L))
ols_regress(OC_logTPM_NPD_LM)
```

```{r NPD_TPM_OC_LMloglog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

logOC_logTPM_NPD_LM <- lm(data = TPM_NPD, log(Avg_OC_Ratio) ~ log(Avg_TPM_mg_L))
ols_regress(logOC_logTPM_NPD_LM)
```

```{r Filter_Temp, eval=FALSE, fig.height=5, fig.width=14,  include=FALSE}

FR_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Positive ChlRmd') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_pos_Temp, Chl_Rmd_pos_Temp, nrow = 1)
```

```{r FRpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(FRPos_temp_lm)
```

```{r ChlRmdpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(ChlRmdPos_temp_lm)
```

```{r ChlRmdpos_Temp_diag, eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_temp_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_temp_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_temp_lm))
```

```{r NPD_Filter_Temp, eval=FALSE, fig.height=10, fig.width=12,  include=FALSE}

NPD_Chl_RmdPos_Temp <- ggplot(Deanza_PosFilter_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Deanza Positive Filter Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Predict Y ~ log(x) model
NPD_ChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Temp_C_Up))
Temp_newrange <- data.frame(Temp_C_Up = seq(from = 18, to = 21, by = 0.25))
Templog_Pred <- data.frame(pred_ChlRmd = predict(NPD_ChlRmdPos_logtemp_lm, newdata = Temp_newrange))
pred_Templog_df <- data.frame(Temp_newrange, Templog_Pred)

NPD_ChlRmdPos_logTemp_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Templog_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'y ~ log(x)') +
  guides(fill = FALSE)

# Predict log(Y) ~ log(x) model
NPD_logChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Temp_C_Up))
Temploglog_Pred <- data.frame(pred_ChlRmd = exp(predict(NPD_logChlRmdPos_logtemp_lm, newdata = Temp_newrange)))
pred_Temploglog_df <- data.frame(Temp_newrange, Temploglog_Pred)

NPD_ChlRmdPos_loglogTemp_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Temploglog_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'log(y) ~ log(x)') +
  guides(fill = FALSE)

# Predict Y ~ x + x^2 model
NPD_ChlRmdPos_temp2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Temp_C_Up, degree = 2, raw = T))
Temp2_Pred <- data.frame(pred_ChlRmd = predict(NPD_ChlRmdPos_temp2_lm, newdata = Temp_newrange))
pred_Temp2_df <- data.frame(Temp_newrange, Temp2_Pred)

NPD_ChlRmdPos_Temp2_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Temp2_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'y ~ x + x^2') +
  guides(fill = FALSE)

grid.arrange(NPD_Chl_RmdPos_Temp, NPD_ChlRmdPos_logTemp_graph,
             NPD_ChlRmdPos_loglogTemp_graph, NPD_ChlRmdPos_Temp2_graph, nrow = 2)
```

```{r NPD_ChlRmdpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_temp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(NPD_ChlRmdPos_temp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Temp_C_Up))
ols_regress(NPD_ChlRmdPos_logtemp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_logChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Temp_C_Up))
ols_regress(NPD_logChlRmdPos_logtemp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_temp2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Temp_C_Up, degree = 2, raw = T))
ols_regress(NPD_ChlRmdPos_temp2_lm)
```

```{r Filter_Salinity, eval=FALSE, fig.height=5, fig.width=14,  include=FALSE}

FR_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'Positive FR only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_pos_Sal, Chl_Rmd_pos_Sal, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Sal_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Sal_ppt_Up)
ols_regress(FRPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
ols_regress(ChlRmdPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_Sal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_Sal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_Sal_lm))
```

```{r LogChlRmdPos_LogSalinity_graph, eval=FALSE, fig.height=12, fig.width=12,  include=FALSE}
### Graph with log-log axes
logChlRmd_pos_logSal_graph <- ggplot(Filtration_pos_data, aes(log(Sal_ppt_Up), log(pcnt_Chl_rmvd))) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = expression('log'[n]*' Salinity Upstream (ppt)'),
       y = expression(paste(log[n], " Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only') +
  stat_poly_eq(formula = x_y_formula, parse = TRUE)

# log-log model
logChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Sal_ppt_Up))
# create range of Salinity values to predict with model
Sal_newrange <- data.frame(Sal_ppt_Up = seq(from = 29, to = 38, by = 0.5))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogSal_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logSal_lm, newdata = Sal_newrange)))
pred_loglog_Sal_df <- data.frame(Sal_newrange, loglogSal_Pred)

# model coefficents 
#coef(logChlRmdPos_logSal_lm)

## Graph with regualar x & y axes, log-log model
logChlRmd_pos_logSal_graph2 <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglog_Sal_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "Log(y) ~ Log(x) pretty sure correct line")

# log X transformed model
ChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Sal_ppt_Up))
pred_ChlRmdPos_logSal_df <- data.frame(Sal_newrange,
                                       pred_ChlRmd = predict(ChlRmdPos_logSal_lm, 
                                                             newdata = Sal_newrange))

ChlRmd_pos_logSal_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_logSal_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~ log(x)")

# Polynomial ^2 transformation
ChlRmdPos_Sal2_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 2, raw = T))
# predict values with model and new Sal range values
Sal2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Sal2_lm, newdata = Sal_newrange))
pred_ChlRmdPos_Sal2_df2 <- data.frame(Sal_newrange, Sal2_Pred)

ChlRmd_pos_Sal2_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_Sal2_df2, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~  x + x^2")

# Polynomial ^3 transformation
ChlRmdPos_Sal3_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 3, raw = T))
pred_ChlRmdPos_Sal3_df <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Sal3_lm, newdata = Sal_newrange),
                                       Sal_newrange)

ChlRmd_pos_Sal3_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_Sal3_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~  x + x^3")

grid.arrange(logChlRmd_pos_logSal_graph, logChlRmd_pos_logSal_graph2, 
             ChlRmd_pos_logSal_graph, ChlRmd_pos_Sal2_graph, ChlRmd_pos_Sal3_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Sal_ppt_Up))
ols_regress(logChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(logChlRmdPos_logSal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logSal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logSal_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Sal_ppt_Up))
ols_regress(ChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_logSal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_logSal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_logSal_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
anova(ChlRmdPos_Sal_lm, ChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal2_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Sal2_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal3_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 3, raw = T))
ols_regress(ChlRmdPos_Sal2_lm)
```

```{r NPD_Filter_Salinity, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}
NPD_FRPos_Salinity <- ggplot(Deanza_PosFilter_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'NPD Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Salinity <- ggplot(Deanza_PosFilter_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'NPD Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(NPD_FRPos_Salinity, NPD_ChlRmdPos_Salinity, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Sal_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Sal_ppt_Up)
ols_regress(NPD_FRPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Sal_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
ols_regress(NPD_ChlRmdPos_Sal_lm)
```

```{r Filter_Chl, eval=FALSE, fig.height=15, fig.width=14,  include=FALSE}

FR_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Y-log model
ChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
# create range of Salinity values to predict with model
Chl_newrange <- data.frame(Chl_ug_L_Up = seq(from = 0, to = 8, by = 0.5))
logChl_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logChl_lm, newdata = Chl_newrange))
pred_logChl_df <- data.frame(Chl_newrange, logChl_Pred)

ChlRmdpos_Chllog_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logChl_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ log(x)')

# log-log model
ChlRmdPos_loglogChl_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogChl_Pred <- data.frame(pred_ChlRmd = exp(predict(ChlRmdPos_loglogChl_lm, newdata = Chl_newrange)))
pred_loglogChl_df <- data.frame(Chl_newrange, loglogChl_Pred)

ChlRmdpos_Chlloglog_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogChl_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'log(y) ~ log(x)')

# Y-x + x^2 model
ChlRmdPos_Chl2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
Chl2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Chl2_lm, newdata = Chl_newrange))
pred_Chl2_df <- data.frame(Chl_newrange, Chl2_Pred)

ChlRmdpos_Chl2_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Chl2_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ x + x^2')

grid.arrange(FR_pos_Chl, Chl_Rmd_pos_Chl, 
             ChlRmdpos_Chllog_graph, ChlRmdpos_Chlloglog_graph, 
             ChlRmdpos_Chl2_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Chl_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Chl_ug_L_Up)
ols_regress(FRPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Chl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
ols_regress(ChlRmdPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_Chl_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_Chl_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_Chl_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
ols_regress(ChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
ols_regress(logChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Chl2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Chl2_lm)
```

```{r NPD_Filter_Chl, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}

NPD_FRPos_Chl <- ggplot(Deanza_PosFilter_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = "NPD Positive Filtraiton") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Chl <- ggplot(Deanza_Filter_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = "NPD Positive Filtraiton") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(NPD_FRPos_Chl, NPD_ChlRmdPos_Chl, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Chl_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Chl_ug_L_Up)
ols_regress(NPD_FRPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Chl_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
ols_regress(NPD_ChlRmdPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_ChlRmdPos_Chl_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_ChlRmdPos_Chl_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_ChlRmdPos_Chl_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_logChl_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
ols_regress(NPD_ChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logChl_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
ols_regress(logChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Chl2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
ols_regress(NPD_ChlRmdPos_Chl2_lm)
```

```{r Filter_Turbidity, eval=FALSE, fig.height=15, fig.width=14,  include=FALSE}

FR_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Y-log model
ChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Turbidity_NTU_Up))
Turb_newrange <- data.frame(Turbidity_NTU_Up = seq(from = 2, to = 31, by = 1))
logTurb_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logTurb_lm, newdata = Turb_newrange))
pred_logTurb_df <- data.frame(Turb_newrange, logTurb_Pred)

ChlRmdpos_Turblog_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logTurb_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'y ~ log(x)')

#log-log model
logChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Turbidity_NTU_Up))
loglogTurb_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logTurb_lm, newdata = Turb_newrange)))
pred_loglogTurb_df <- data.frame(Turb_newrange, loglogTurb_Pred)

ChlRmdpos_Turbloglog_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogTurb_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'log(y) ~ log(x)')

# Y ~ x + x^2 model
ChlRmdPos_Turb2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Turbidity_NTU_Up, degree = 2, raw = T))
Turb2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Turb2_lm, newdata = Turb_newrange))
pred_Turb2_df <- data.frame(Turb_newrange, Turb2_Pred )

ChlRmdpos_Turb2_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Turb2_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ x + x^2') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(FR_pos_Turb, Chl_Rmd_pos_Turb,
             ChlRmdpos_Turblog_graph, ChlRmdpos_Turbloglog_graph,
             ChlRmdpos_Turb2_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Turb_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Turbidity_NTU_Up)
ols_regress(FRPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Turb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
ols_regress(ChlRmdPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Turbidity_NTU_Up))
ols_regress(ChlRmdPos_logTurb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Turbidity_NTU_Up))
ols_regress(logChlRmdPos_logTurb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Turb2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Turbidity_NTU_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Turb2_lm)
```

```{r NPD_Filter_Turbidity, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}

NPD_FRPos_Turb <- ggplot(Deanza_PosFilter_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Deanza - Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Turb <- ggplot(Deanza_PosFilter_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Deanza - Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")



grid.arrange(NPD_FRPos_Turb, NPD_ChlRmdPos_Turb, nrow = 1)

```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Turb_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Turbidity_NTU_Up)
ols_regress(NPD_FRPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Turb_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
ols_regress(NPD_ChlRmdPos_Turb_lm)
```

```{r NPD_Bivalve_SH_DTW, eval=FALSE, include=FALSE}
## Graph Newport Deanza biomass by shell length
NPD_bivalve_biomass_graph <-  NPD_bivalve_data_clean %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g, color = species)) +
  geom_point() +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  facet_wrap(~species) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = "NPD Bivalve Biomass - Raw data") +
  theme_classic() +
  theme(strip.text = element_text(face = "italic"))

plot(NPD_bivalve_biomass_graph)
```

```{r Oly_TWW_DTW, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}
Oly_TWW_DTW<- ggplot(NPD_oly, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = 'Total Wet Weight (g)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW x TWW - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

plot(Oly_TWW_DTW)
```



```{r fig.height=5, fig.width=12,  include=FALSE}
NPD_Adula <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Adula diegensis"))

NPD_Adula_Posbiomass_graph <- NPD_Adula %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Adula diegensis")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

# Predict new values with 

NPD_Adula_Posbiomass_loggraph <- NPD_Adula %>% 
  ggplot(aes(x = log(length_mm), y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Ln Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Adula diegensis")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Adula_Posbiomass_graph, NPD_Adula_Posbiomass_loggraph, nrow = 1)
```

```{r fig.height=5, fig.width=12,  include=FALSE}
NPD_Musculista <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Musculista senhousia"))

NPD_Musculista_Posbiomass_graph <- NPD_Musculista %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Musculista senhousia")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Musculista_Posbiomass_loggraph <- NPD_Musculista %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Musculista senhousia")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Musculista_Posbiomass_graph, NPD_Musculista_Posbiomass_loggraph, nrow=1)
```

```{r fig.height=5, fig.width=12,  include=FALSE}

NPD_Mytilus <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Mytilus galloprovincialis"))

NPD_Mytilus_Posbiomass_graph <- NPD_Mytilus %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Mytilus galloprovincialis")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Mytilus_Posbiomass_loggraph <- NPD_Mytilus %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Mytilus galloprovincialis")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Mytilus_Posbiomass_graph, NPD_Mytilus_Posbiomass_loggraph, nrow = 1)
```

```{r eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}
NPD_Unknown <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Unknown mussel"))

NPD_Unknown_Posbiomass_graph <- NPD_Unknown %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Unknown mussel")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Unknown_Posbiomass_loggraph <- NPD_Unknown %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Unknown mussel")," - Positive Ln DTW only"))) +
  theme_classic()  +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Unknown_Posbiomass_graph, NPD_Unknown_Posbiomass_loggraph, nrow =1)

```

```{r LM_PrctChl_pos_add, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}
# Multiple Linear Regression - Chl Rmd Filtration Stepwise Selection
# Positive Percent Chl removed trials only
MLR_PrctChl_fwd <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~
                         # Field notes Qualitative variables
                         #Wind + G_upstream + Algae + #Daylight +  Sonde_fell + Boat_wake +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + #Turbidity_NTU_Up + 
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)

summary(MLR_PrctChl_fwd)

# stepwise selection that enters and removes variables. 
step(MLR_PrctChl_fwd, direction = 'both')

```

```{r LM_PrctChl_pos_Oly, eval=FALSE, include=FALSE}
Pos_Newport_data <- Filtration_pos_data %>% 
  filter(!Site %in% c("Morro Bay", "San Rafael"))

LM_PrctChl_NP <- lm(data = Pos_Newport_data, pcnt_Chl_rmvd ~ 
                   Temp_C_Up + 
                   Sal_ppt_Up + 
                   Turbidity_NTU_Up + 
                   #avg_depth_cm + 
                   #d_bw_sondes_m + 
                   #avg_m_hr + 
                   Avg_OC_Ratio +
                   Avg_TPM_mg_L)

# stepwise selection that enters and removes variables. 
step(LM_PrctChl_NP, direction = 'both')
```

```{r eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}

#Positive Filtration ~ ChlRmd Multiple Regression with selected variables
LM2_PrctChl_pos_add <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ 
                          NPSM + Avg_OC_Ratio)

summary(LM2_PrctChl_pos_add)
# diagnosis of colinearity
#ols_coll_diag(LM_PrctChl_pos_add)
```

```{r eval=FALSE, fig.height=10, fig.width=6,  include=FALSE}
#Positive Filtration ~ ChlRmd Multiple Regression with selected variables
# detailed multiple regression summary - ANOVA results
ols_regress(LM2_PrctChl_pos_add)
```

```{r LM_FR_pos, eval=FALSE,  include=FALSE}
#FR - Positive Filtration Stepwise Multiple Regression
# Positive Percent Chl removed trials only
LM_FR_pos <- lm(data = Filtration_pos_data, L_hr_m2 ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + # Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)

ols_step_both_p(LM_FR_pos)
```

```{r LM_ChlRmd_NPD_PosFilter, eval=FALSE,  include=FALSE}
#Chl Rmd - Deanza - Positive Filtration
LM_ChlRmd_NPD_PosFilter <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + # Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)
# not enough degrees of freedom for full model
ols_step_both_p(LM_ChlRmd_NPD_PosFilter)
```

```{r LM_FR_NPD_Posfilter, eval=FALSE,  include=FALSE}
#FR - Deanza - Positive Filtration
LM_FR_NPD_Posfilter <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + #Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)
# not enough degrees of freedom for full model
ols_step_both_p(LM_FR_NPD_Posfilter)
```

```{r T_test_table, eval=FALSE, fig.height=5, fig.width=6, include=FALSE}
#### T-test is not an appropriate analysis for my data (per Dr. Kevin Nichols CSUF) The groups are not independent, violating the assumptions. 
T_test_Table <- Master_analysis_table %>%
  mutate(Date = mdy(Date),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1), # Do I need Percent Chl removed here? Presented in other table
         Mean_Chl_diff = round(Mean_Chl_diff, digits = 2),
         StDev_Chl_diff = round(StDev_Chl_diff, digits = 2),
         StEr_Chl_diff = round(StEr_Chl_diff, digits = 2),
         statistic = round(statistic, digits = 2), # t-statistic 
         p.value = round(p.value, digits = 2),
         parameter = round(parameter, digits = 2),
         conf.low = round(conf.low, digits = 2)) %>% 
  dplyr::select(Site, Date, Experiment, pcnt_Chl_rmvd, Mean_Chl_diff, StDev_Chl_diff, StEr_Chl_diff,
                statistic, p.value, parameter, conf.low) %>% 
  group_by(Site) %>% 
  arrange(Date, .by_group = T)
# Make date formated as character to display properly
T_test_Table$Date <- as.character(T_test_Table$Date)
# Make xtable to render LaTex table in pdf
Ttest_table_LaTeX <- xtable(T_test_Table, caption = "T-test results", label="tb:iris")


############ Chl diff single tailed t-test Values ################
SR_T_Table <- T_test_Table %>% 
  filter(Site %in% c("San Rafael"))

MB_T_Table <- T_test_Table %>% 
  filter(Site %in% c("Morro Bay"))

NPSM_T_Table <- T_test_Table %>% 
  filter(Site %in% c("Shellmaker"))

NPD_T_Table <- T_test_Table %>% 
  filter(Site %in% c("Deanza"))


```