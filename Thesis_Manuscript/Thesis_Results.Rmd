---
bibliography: library.bib
csl: inter-research-science-center.csl
header-includes: 
- \usepackage{setspace}
- \doublespacing
- \usepackage{rotating}
- \usepackage{booktabs}
- \usepackage{makecell}
- \usepackage{gensymb}
- \usepackage{upgreek}
- \usepackage{pdfpages}
- \usepackage{caption}
output: 
  pdf_document:
    fig_caption: yes
    latex_engine: xelatex
    keep_tex: yes
indent: true
---
```{r setup, include=FALSE}

library(knitr)
# Troubleshooting knitting to pdf
#options(tinytex.verbose = TRUE)

# set default settings to save figures in Figures folder
knitr::opts_knit$set(root.dir = normalizePath('../'), # set working directory to project level
                     fig.path = "./Thesis_Manuscript/Figures")

# Set chunk options- no warning messages, and place figures near where they are referenced.             
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      fig.width = 6,
                      fig.asp=0.618, 
                      fig.align = "center")

```

```{r load_packages_data, include=FALSE}
################### Packages ###########################
library(dplyr)
library(tidyr)
library(readr) # reading in files 
library(magrittr) # pipe function %>%
library(data.table) # file read function and needed for xtable
library(lubridate) # dealing with time and dates
library(ggplot2) # graphing
library(ggthemes) # theme_classic() for graphs
library(stringr) # dealing with text strings
library(hms) # dealing with time
library(viridisLite) # color palette
library(forcats)
library(gridExtra)
library(ggpmisc) # package for adding line equation and R^2 to plots
library(viridis) # Color palette - Options: magma , inferno, plasma, viridis, cividis
library(scales) # add different number scales in graphs
library(cowplot) # for arranging multiple plots into a single figure
library(wesanderson) # color palette
library(olsrr) # regression output table
library(xtable) # creates tables in LaTex
library(MASS) # collection of datasets and functions
library(ISLR) # Dataset in Intro to statistical learning
library(knitr)
library(tinytex) # LaTeX conversion package
library(broom) # tidy() function to convert t.test to dataframe
library(agricolae) # post-hoc Tukey test
library(multcompView) #
library(quantreg) # Quantile regression
library(grid) # makes test grobs useful for multiframe figures
library(pwr) # Power analysis

# source functions 
source("./functions.R")
# define output directory
output_directory = "./output"
# create output directories (same as Insitu_Filtraiton_Analysis_script.Rmd)
createOutputDirectories()

##################### Read in Data from  project output ##########################
All_data <- fread(file.path('./output/4_Filtration_Calculations/Filtration_Summary', "Master_Filtration_analysis_table.csv"))
Avg_TPM_summary_table <- fread(file.path('./output/5_TPM_OC_Summary', "Avg_TPM_summary_table.csv"))
Density_directory = "./Data/bivalve_density_community"
NPD_bivalves = fread(file.path(Density_directory, "Insitu_Filter_NPD_bivalve_biomass_data.csv"))
Sbs_correction_data = fread(file.path('./output/6_Sbs_Corrections_Summary', "sbs_correction_summary.csv"))


##################### Data #########################################
# Remove San Diego filtration trial - not applicable to this analysis - different experimental set up
Master_analysis_table <- All_data %>% 
  filter(!Site %in% c("San Diego"))

# Order Sites by Latitude
site_by_lat <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
site_by_lat_abv <- c("SR", "MB", "NPSM", "NPD")

# transform Site variable to factor and arange by Latitude
Master_analysis_table <- arrange(transform(Master_analysis_table, Site = factor(Site,levels = site_by_lat)), Site)

# All Trials, NPD 2019_4_17 removed - below Chl detection limit
site_data_outrmd <- Master_analysis_table %>% 
  filter(round(Chl_ug_L_Up,2) > 0.1 | round(Chl_ug_L_Up,2) < -0.1)

 # Filtration trials only - exclude Negative controls
Filtration_only_data <- Master_analysis_table %>% 
  filter(Experiment %in% c("Filtration"))

# Negative Control Trials only 
Control_only_data <- Master_analysis_table %>% 
  filter(grepl("Neg*", Master_analysis_table$Experiment))

# Filtration only - remove trials with Chl a within sensor detection limit (+- 0.1ug/L)
Filter_only_outRmd_data <- Filtration_only_data %>% 
  filter(round(Chl_ug_L_Up,2) > 0.1 | round(Chl_ug_L_Up,2) < -0.1)

################# Values for Results text #####
# SR filtration trial data
SR_filter_sum <- Filter_only_outRmd_data %>% 
  filter(Site %in% c("San Rafael"),
         Experiment %in% c("Filtration")) 
# SR Negative control data
SR_NC_sum <- Control_only_data %>% 
  filter(Site %in% c("San Rafael"))

MB_filter_sum <- Filter_only_outRmd_data %>% 
  filter(Site %in% c("Morro Bay"),
         Experiment %in% c("Filtration"))

MB_NC_sum <- Control_only_data %>% 
  filter(Site %in% c("Morro Bay"))

NPD_filter_sum <- Filter_only_outRmd_data %>% 
  filter(Site %in% c("Deanza"),
         Experiment %in% c("Filtration"))

NPD_NC_sum <- Control_only_data %>% 
  filter(Site %in% c("Deanza")) 

NPSM_filter_sum <- Filter_only_outRmd_data %>% 
  filter(Site %in% c("Shellmaker"),
         Experiment %in% c("Filtration"))

NPSM_NC_sum <- Control_only_data %>% 
  filter(Site %in% c("Shellmaker")) 

##### Single out NPD 2019_4_17 for stats reporting
NPD_2019_4_17 <- read_csv("output/4_Filtration_Calculations/Insitu_Filter_NPD_2019_4_17.csv")
NPD_2019_4_17 %<>% filter(Experiment == "Filtration") 

# Filtration trials only - exclude Negative controls & Percent Chl removed greater than 0
### Important Note ## When Percent Chl removed is positive, so is L/hr/m^2 and vice visa. 
# Filtering by pcnt_Chl_rmvd effectively filters both values the same, so further analysis 
# withFiltration_pos_data serves both purposes. 
Filtration_pos_data <- Filtration_only_data %>% 
  filter(pcnt_Chl_rmvd > 0)

# Deanza data only - all trials
Deanza_data_all <- Master_analysis_table %>% 
  filter(Site %in% c("Deanza"))
# Deanza only - Filtraiton trials only
Deanza_Filter_data <- Deanza_data_all %>% 
  filter(Experiment %in% c("Filtration"))
# Deanza only- Positive Filtration only
Deanza_PosFilter_data <- Deanza_Filter_data %>% 
  filter(pcnt_Chl_rmvd > 0)

### Average TPM Data ######################
Avg_TPM_summary_table <- arrange(transform(Avg_TPM_summary_table, Site = factor(Site, levels = site_by_lat)), Site)

############### model formulas ###############
# linear model formula
x_y_formula <- y ~ x 
# Quadratic model
x2_y_formula <- y ~ poly(x, degree = 2)
# Exponential model
logy_x_formula <- log(y) ~ x
# logx
y_logx_fomula <- y ~ log(x)
# double log
logy_logx_formula <- log(y) ~ log(x)

### Reporting Restoration vs aquaculture in Abstract
abstract_num <- Filter_only_outRmd_data %>% 
  mutate(habitat = ifelse(Site %in% c("San Rafael", "Deanza", "Shellmaker"), "Rest", "Aqcltr")) %>%
  dplyr::select(Site, L_hr_m2, habitat) %>% 
  group_by(habitat) %>% 
  summarise(mean_HCR = mean(L_hr_m2),
            SD = sd(L_hr_m2),
            st_error = SD / sqrt(length(L_hr_m2)))

############### Site Color Assignments ###############
viridis(4)
Site_colors <- c("San Rafael" = "#440154FF",
                 "Morro Bay" = "#31688EFF",
                 "Shellmaker" = "#35B779FF",
                 "Deanza" = "#FDE725FF")

############### Bivalve Species Color Assignments ###############
# wes_palettes # lists all current palattes 
# Color palette for Species - Royal2, Darjeeling2, Cavalcanti1, BottleRocket2, IsleofDogs1
density_palette <- rev(wes_palette("IsleofDogs1", 7, type = c("continuous")))
Species_colors <- c("Adula diegensis" = "#8D8680",
                    "Argopecten ventricosa" = "#CCC3C5",
                    "Crassostrea gigas" = "#6D6340",
                    "Geukensia demissa" = "#524D4F",
                    "Musculista senhousia" = "#B0915B",
                    "Mytilus galloprovincialis" = "#7E4B41",
                    "Ostrea lurida" = "#9986A5",
                    "Unknown mussel" = "black")

################# Labels for graphs  #########################
Hab_FR_Label <- expression('Habitat Clearance Rate (L hr'^-1*'m'^-2*')')
Prt_Chl_Label <- expression(paste('Percent Chlorophyll ', alpha, ' Removed'))
Chl_ugL_Label <- expression(paste("Chlorophyll ", alpha, " (", mu, "g/L) "))
TPM_Label <- c('Total Particulate Matter mg/L')
PIM_Label <- c('Particulate Inorganic Matter mg/L')

###################### Functions ####################################
# function for number of samples - display on graph
n_mean_stats <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  "mean =  ", round(mean(x), 1), '\n')
                )
         )
}
# function for number of samples - 3 decimal places
n_mean_stats3 <- function(x){
  return(tibble(y = max(x) * 0.95, 
                    label = paste("n = ",length(x), "\n",
                                  'mean =', round(mean(x), 3), '\n')
                )
         )
}

# function to calculate average, standard deviation, outlier data. 
find_outlier <- function(data){
  average <- mean(data)
  stdev <- sd(data)
  # Outlier data defined by outside 2.2 standard deviations from the mean 
  outlier <- ifelse((data < (average - 2.2 * stdev) | (data > (average + 2.2 * stdev))),
         TRUE, FALSE)
}

```

```{r Site WQ ANOVA, fig.width=7, fig.asp=1.2, fig.cap="Box plots of ambient (upstream) A) temperature, B) salinity, C) turbidity, D) total particulate matter, E) organic content, and F) chlorophyll $\\alpha$ from filtration trials. One-way ANOVAs compared the difference between water quality variables and site. Significantly different results were grouped by a post-hoc Tukey's HSD; significantly different sites do not share a common letter, and non-significant differences share letters. Trials were conducted from February 2018 to June 2019 at San Rafael, CA (restored reefs); Morro Bay, CA (Morro Bay Oyster Company, aquaculture); and Newport Bay, CA (Shellmaker and Deanza, restored beds). \\label{Site_WQ_boxplot}" }

#########################
###### Temperature 
#hist(Filter_only_outRmd_data$Temp_C_Up)
site_temp_aov <- aov(Temp_C_Up ~ Site, data = Filter_only_outRmd_data)
#summary(site_temp_aov)
temp_aov_values <- broom::tidy(site_temp_aov) # put ANOVA model into tibble to extract individual values
# Post-Hoc Tukey test
tukey_temp <- TukeyHSD(site_temp_aov)
#tukey_temp
#plot(tukey_temp)

#Honestly Significant Difference test --> Don't need if non-significant ANOVA
hds_temp <- HSD.test(site_temp_aov, trt = "Site")
#hds_temp

Temp_box <- ggplot(Filter_only_outRmd_data, aes(Site, Temp_C_Up)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = expression(paste("Temperature (",degree, "C)")),
       title = "A)")

#########################
####### Salinity
#hist(site_data_outrmd$Sal_ppt_Up)
site_sal_aov <- aov(Sal_ppt_Up ~ Site, data = Filter_only_outRmd_data)
sal_aov_values <- broom::tidy(site_sal_aov)

# Post-Hoc Tukey test
tukey_sal <- TukeyHSD(site_sal_aov)
#tukey_sal
#plot(tukey_sal)

#Honestly Significant Difference test
hds_sal <- HSD.test(site_sal_aov, trt = "Site")
#hds_sal

Sal_box <- ggplot(Filter_only_outRmd_data, aes(Site, Sal_ppt_Up)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = "Salinity (ppt)",
       title = "B)") +
  annotate("text", "San Rafael", 
           max((site_data_outrmd %>% 
                  filter(Site == "San Rafael"))$Sal_ppt_Up) + 0.75, label = "a") +
  annotate("text", "Morro Bay", 
           max((site_data_outrmd %>% 
                  filter(Site == "Morro Bay"))$Sal_ppt_Up) + 0.75, label = "b") +
  annotate("text", "Shellmaker", 
           max((site_data_outrmd %>% 
                  filter(Site == "Shellmaker"))$Sal_ppt_Up) + 0.75, label = "b") +
  annotate("text", "Deanza", 
           max((site_data_outrmd %>% 
                  filter(Site == "Deanza"))$Sal_ppt_Up) + 0.75, label = "b") 

###########################
######### Turbidity
#hist(site_data_outrmd$Turbidity_NTU_Up)
site_turb_aov <- aov(Turbidity_NTU_Up ~ Site, data = Filter_only_outRmd_data)
turb_aov_values <- broom::tidy(site_turb_aov)

# Post-Hoc Tukey test
tukey_turb <- TukeyHSD(site_turb_aov)
#tukey_turb
#plot(tukey_turb)

#Honestly Significant Difference test
hds_turb <- HSD.test(site_turb_aov, trt = "Site")
#hds_turb

Turb_box <- ggplot(Filter_only_outRmd_data, aes(Site, Turbidity_NTU_Up)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = "Turbidity (NTU)",
       title = "C)") +
  annotate("text", "San Rafael", 
           max((site_data_outrmd %>% 
                  filter(Site == "San Rafael"))$Turbidity_NTU_Up) + 2, 
           label = "a") +
  annotate("text", "Morro Bay", 
           max((site_data_outrmd %>% 
                  filter(Site == "Morro Bay"))$Turbidity_NTU_Up) + 2, 
           label = "b") +
  annotate("text", "Shellmaker", 
           max((site_data_outrmd %>% 
                  filter(Site == "Shellmaker"))$Turbidity_NTU_Up) + 2, 
           label = "c") +
  annotate("text", "Deanza", 
           max((site_data_outrmd %>% 
                  filter(Site == "Deanza"))$Turbidity_NTU_Up) + 2, 
           label = "c") 

########################
####### TPM
#hist(site_data_outrmd$Avg_TPM_mg_L)
site_TPM_aov <- aov(Avg_TPM_mg_L ~ Site, data = Filter_only_outRmd_data)
TPM_aov_values <- broom::tidy(site_TPM_aov)

# Post-Hoc Tukey test
tukey_tpm <- TukeyHSD(site_TPM_aov)
#tukey_tpm
#plot(tukey_tpm)

#Honestly Significant Difference test
hds_tpm <- HSD.test(site_TPM_aov, trt = "Site")
#hds_tpm

Tpm_box <- ggplot(Filter_only_outRmd_data, aes(Site, Avg_TPM_mg_L)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = expression(paste("Total Particulate Matter (mg/L)")),
       title = "D)") +
  annotate("text", "San Rafael", 
           max((site_data_outrmd %>% 
                  filter(Site == "San Rafael"))$Avg_TPM_mg_L) + 10, label = "a") +
  annotate("text", "Morro Bay", 
           max((site_data_outrmd %>% 
                  na.omit() %>% 
                  filter(Site == "Morro Bay"))$Avg_TPM_mg_L) + 10, label = "b") +
  annotate("text", "Shellmaker", 
           max((site_data_outrmd %>% 
                  filter(Site == "Shellmaker"))$Avg_TPM_mg_L) + 10, label = "b") +
  annotate("text", "Deanza", 
           max((site_data_outrmd %>% 
                  na.omit() %>% 
                  filter(Site == "Deanza"))$Avg_TPM_mg_L) + 10, label = "b") 

#####################
####### OC
#hist(site_data_outrmd$Avg_OC_Ratio)
site_OC_aov <- aov(Avg_OC_Ratio ~ Site, data = Filter_only_outRmd_data)
OC_aov_values <- broom::tidy(site_OC_aov)

# Post-Hoc Tukey test
tukey_oc <- TukeyHSD(site_OC_aov)
#tukey_oc
#plot(tukey_oc)
#Honestly Significant Difference test
hds_oc <- HSD.test(site_OC_aov, trt = "Site")
#hds_oc

OC_box <- ggplot(Filter_only_outRmd_data, aes(Site, Avg_OC_Ratio)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = "Organic Content (Ratio)",
       title = "E)") +
  annotate("text", "San Rafael", 
           max((site_data_outrmd %>% 
                  filter(Site == "San Rafael"))$Avg_OC_Ratio) + 0.025, label = "ab") +
  annotate("text", "Morro Bay", 
           max((site_data_outrmd %>% 
                  na.omit() %>% 
                  filter(Site == "Morro Bay"))$Avg_OC_Ratio) + 0.025, label = "a") +
  annotate("text", "Shellmaker", 
           max((site_data_outrmd %>% 
                  filter(Site == "Shellmaker"))$Avg_OC_Ratio) + 0.025, label = "ab") +
  annotate("text", "Deanza", 
           max((site_data_outrmd %>% 
                  na.omit() %>% 
                  filter(Site == "Deanza"))$Avg_OC_Ratio) + 0.025, label = "a") 

#########################
###### Chlorphyll
#hist(site_data_outrmd$Chl_ug_L_Up)
site_chl_aov <- aov(Chl_ug_L_Up ~ Site, data = Filter_only_outRmd_data)
#summary(site_chl_aov)
chl_aov_values <- broom::tidy(site_chl_aov) # put ANOVA model into tibble to extract individual values
# Post-Hoc Tukey test
tukey_chl <- TukeyHSD(site_chl_aov, ordered = FALSE, conf.level = 0.95)
#tukey_chl
#plot(tukey_chl)

#Honestly Significant Difference test
hds_chl <- HSD.test(site_chl_aov, trt = "Site")
#hds_chl

Chl_box <- ggplot(Filter_only_outRmd_data, aes(Site, Chl_ug_L_Up)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = expression(paste("Chlorophyll ",alpha, " (", mu,"g/L)")),
       title = "F)") 

grid.arrange(Temp_box, Sal_box, Turb_box, Tpm_box, OC_box, Chl_box,nrow=3)
```

# Results

Twenty-five experimental trials, across the four study sites, were included in the analyses; 21 filtration trials and four control trials.
A single filtration trial at Deanza (2019-4-17; Table 1) was removed from the analysis because the mean upstream Chl $\alpha$ (*M* = `r round(mean(NPD_2019_4_17$Chl_ug_L_Up),1)`, *SD* = `r round(sd(NPD_2019_4_17$Chl_ug_L_Up),2)`) was within the detection limit of the sensor (± 0.1 $\mu$g/L). 
Filtration trials across sites were not distributed equally (Table 1), Deanza had more than twice the amount filtration trials (*N* = 9) as San Rafael (*N* = 4), Morro Bay (*N* = 4), and Shellmaker (*N* = 4), while each site had a single control.
Ambient water quality during filtration trials varied within and among sites (Figure \ref{Site_WQ_boxplot}). 
Chl $\alpha$ was significantly different between sites as determined by one-way ANOVA at a *p* < 0.05 (*F*(`r chl_aov_values[[1,2]]`, `r chl_aov_values[[2,2]]`) = `r round(chl_aov_values[[1,5]],2)`, *p* = `r round(chl_aov_values[[1,6]],2)`), along with salinity (*F*(`r sal_aov_values[[1,2]]`, `r sal_aov_values[[2,2]]`) = `r round(sal_aov_values[[1,5]],2)`, *p* < 0.001), turbidity (*F*(`r turb_aov_values[[1,2]]`, `r turb_aov_values[[2,2]]`) = `r round(turb_aov_values[[1,5]],2)`, *p* < 0.001), TPM (*F*(`r TPM_aov_values[[1,2]]`, `r TPM_aov_values[[2,2]]`) = `r round(TPM_aov_values[[1,5]],2)`, *p* = < 0.001), and OC (*F*(`r OC_aov_values[[1,2]]`, `r OC_aov_values[[2,2]]`) = `r round(OC_aov_values[[1,5]],2)`, *p* = `r round(OC_aov_values[[1,6]],2)`) (Figure \ref{Site_WQ_boxplot}).
Temperature was not different between sites (*F*(`r temp_aov_values[[1,2]]`, `r temp_aov_values[[2,2]]`) = `r round(temp_aov_values[[1,5]],2)`, *p* > 0.05) (Figure \ref{Site_WQ_boxplot}).

```{r ChlRmd_Site_boxplot, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align= "center", fig.asp=0.618, out.width="70%", message= F, fig.cap="Box plots of percent chlorophyll $\\alpha$ removal (Chl\\textsubscript{up} - Chl\\textsubscript{down} / Chl\\textsubscript{up} * 100) during filtration trials, control trials are listed in Table 1. Each data point is an the mean of a single filtration trial and diamonds are site means. Filtration trials were conducted between February 2018 to June 2019 at San Rafael, CA (restored reefs); Morro Bay, CA (Morro Bay Oyster Company aquaculture); and Newport Bay, CA (Shellmaker and Deanza, restored beds). \\label{ChlRmd_Site_boxplot}"}

### Chl removed summary - filtration trials only
Chlrmd_Site <- Filter_only_outRmd_data %>% 
  group_by(Site) %>% 
  summarize(avg_Chlrmd = mean(pcnt_Chl_rmvd),
            SD = sd(pcnt_Chl_rmvd),
            n_samples = length(pcnt_Chl_rmvd))

Chlrmd_site_aov <- aov(pcnt_Chl_rmvd ~ Site, data = Filter_only_outRmd_data)
#summary(HCR_site_aov)
Chlrmd_aov_values <- broom::tidy(Chlrmd_site_aov)

# Post-Hoc Tukey test
tukey_Chlrmd <- TukeyHSD(Chlrmd_site_aov)
#tukey_Chlrmd
#plot(tukey_Chlrmd)
#Honestly Significant Difference test
hds_Chlrmd <- HSD.test(Chlrmd_site_aov, trt = "Site")
#hds_Chlrmd

########### Power analysis - sensitivity power analysis 
# one-way ANOVA effect size (n^2). n^2 = treatmentSumSquares / TotalSumSquares (TreatSS + ResidualSS) 
d_Chlrmd_site <- {Chlrmd_aov_values[[1,3]] / (Chlrmd_aov_values[[1,3]] + Chlrmd_aov_values[[2,3]]) }

# power analysis for "balanced one-way analysis of variance tests"
# For now Ted says to use the mean of the different sample sizes
Chlrmd_site_power <- pwr.anova.test(f = d_Chlrmd_site, 
                                 k = 4,
                                 n = mean(Chlrmd_Site$n_samples), 
                                 sig.level = 0.05,
                                 power = NULL) # solve for this

Chl_Rmd_box <- ggplot(Filter_only_outRmd_data, aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) + 
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
   geom_point(data = Chlrmd_Site, aes(Site, avg_Chlrmd),
             size = 2, shape = 18) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = Prt_Chl_Label)

plot(Chl_Rmd_box)

####### Don't include - doesn't match analysis data
ChlRmd_pos_box <- ggplot((Filtration_pos_data), aes(Site, pcnt_Chl_rmvd)) +
  geom_boxplot(color = Site_colors) +
    geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.5, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Prt_Chl_Label)
#plot(ChlRmd_pos_box)

```

## Percent Chlorophyll $\alpha$ Removal

The mean percent Chl $\alpha$ removal at the San Rafael site was `r round(mean(SR_filter_sum$pcnt_Chl_rmvd),1)`\% (*N* = `r nrow(SR_filter_sum)`, *SD* = `r round(sd(SR_filter_sum$pcnt_Chl_rmvd),2)`) (Figure \ref{ChlRmd_Site_boxplot}) and was `r round(SR_NC_sum$pcnt_Chl_rmvd,1)`\% in the single control trial (Table 1). 
Filtration trials at Morro Bay had a mean Chl $\alpha$ removal of `r round(mean(MB_filter_sum$pcnt_Chl_rmvd),1)`\% (*N* = `r nrow(MB_filter_sum)`, *SD* = `r round(sd(MB_filter_sum$pcnt_Chl_rmvd),1)`) and `r round(MB_NC_sum$pcnt_Chl_rmvd,1)`\% during the control trial. 
At Deanza, mean Chl $\alpha$ removal was `r round(mean(NPD_filter_sum$pcnt_Chl_rmvd),1)`\% (*N* = `r nrow(NPD_filter_sum)`, *SD* =  `r round(sd(NPD_filter_sum$pcnt_Chl_rmvd),1)`) and `r round(mean(NPD_NC_sum$pcnt_Chl_rmvd))`\% Chl $\alpha$ removal during the control trial.
Mean Shellmaker Chl $\alpha$ removal was `r round(mean(NPSM_filter_sum$pcnt_Chl_rmvd),1)` \% (*N* = `r nrow(NPSM_filter_sum)`, *SD* = `r round(sd(NPSM_filter_sum$pcnt_Chl_rmvd),1)`) (Figure \ref{ChlRmd_Site_boxplot}), and its control trial was `r round(mean(NPSM_NC_sum$pcnt_Chl_rmvd),1)` \% (Table 1).
Chl $\alpha$ removal in filtration trials did not differ significantly between sites (one-way ANOVA, *F*(`r Chlrmd_aov_values[[1,2]]`, `r Chlrmd_aov_values[[2,2]]`) = `r round(Chlrmd_aov_values[[1,5]],2)`, *p* = `r round(Chlrmd_aov_values[[1,6]],2)`).
A power analysis of this one-way ANOVA determined that effect size between site and Chl $\alpha$ removal is very small (*ES* = `r format(round(Chlrmd_site_power$f, 2), nsmall = 2)`), per the criteria in @Sawilowsky2009a, with little statistical power (`r round(Chlrmd_site_power$power,2)`).


```{r Random_Forest_DrNichols, include=FALSE}
##################### Estimate missing values (Imputation) ##########################
#In our data we are missing 4 out of 400ish values.  (cells)
#Because we have limited observations but a high number of variables simply
#removing incomplete observations is too costly

#For imputation we are doing a non parametric random forest imputation.  See missForest documentation for details/references.  
#Stekhoven, D.J. and Buehlmann, P. (2012), "missForest - nonparametric missing value imputation for mixed-type data', Bioinformatics, 28(1) 2012, 112-118, doi: 10.1093/bioinformatics/btr597


# Import data
Analysis_data <- Master_analysis_table %>% 
    mutate(Date = mdy(Date),
         L_hr_m2 = round(L_hr_m2),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1),
         Temp_C_Up = round(Temp_C_Up, digits = 2),
         Sal_ppt_Up = round(Sal_ppt_Up, digits = 1),
         Turbidity_NTU_Up = round(Turbidity_NTU_Up, digits = 1),
         Avg_TPM_mg_L = round(Avg_TPM_mg_L, digits = 4),
         Avg_OC_Ratio = round(Avg_OC_Ratio, digits = 2),
         Chl_ug_L_Up = round(Chl_ug_L_Up, digits = 1),
         Chl_ug_L_Down = round(Chl_ug_L_Down, digits = 1),
         avg_depth_m = round((avg_depth_cm/100), digits = 2),
         d_bw_sondes_m = round(d_bw_sondes_m, digits = 1),
         avg_m_sec = round(avg_m_hr/3600, 2)) %>%
  dplyr::select(Site, Date, Experiment, Temp_C_Up, Sal_ppt_Up, Turbidity_NTU_Up, Avg_TPM_mg_L, 
          Avg_OC_Ratio, Chl_ug_L_Up, Chl_ug_L_Down, avg_depth_m, d_bw_sondes_m, avg_m_sec, 
          pcnt_Chl_rmvd, L_hr_m2) %>% 
 dplyr::arrange(Site, Date)
  
# packages needed for imputation and randomforest regression
library(missForest)
library(rpart)
library(randomForest)
library(adabag)

# Imputation for 4 missing values (TPM & OC)
temp1 = Analysis_data[,c(1,2,3)] # temporarily remove data labels for imputation
temp2 = missForest(Analysis_data[,-c(1,2,3)])$ximp # Imputation of missing values
test = cbind(temp1,temp2) # bing back data labels 
# dimensions of data with labels removed (data only) 28 x 12 = 336 data cells
dim(Analysis_data[,-c(1,2,3)]) 
num_NA_values <- sum(is.na(Analysis_data)) # 4 missing values

colnames(test) <- c( "Site", "Date", "Experiment", "Temp","Salinity", "Turbidity",
                            "TPM", "OC", "Chl.up", "Chl.dn", 
                           "Depth","Distance", "Water velocity", "Chl.removal", 
                           "Clearance")

#Shellmaker 06-09 Neg Control, Shellmaker 05-22 Filtration and Deanze 4-17 Filtration just have astronomical outlier values for clearance.
#Lets ignore them for now as they complete dominate any model useful for comparison.
## Thea Notes ###
## Shellmaker 06-09 Neg Control - floating algae mats caused me to reposition instruments after ~10 mins into Neg Control trial. Looks like sediments never settled afterward. Huge spikes in Chl afterwards that even cutting out is suspect. Avg depth and distance b/w sondes are wrong If I just use the first part of the neg control. Going to change values in Insitu_Filter_Veolcity_All_Data.csv - will reduce clearance rate b/c reduced water volume. 

###############################################
#############  Mud vs Oyster - Filtraiton vs Control (unadjusted) #########################

### Make a Choice - Two ways to treat extreme values

### 1) remove extreme values (NPSM 2020_6_9, NPSM 2020_5_22, NPD 2020_4_17)
### Committee did not like this approach. Stick to domain knowlege for removal, don't mix 
# Confidence intervals and domain knowlege. Could compare outputs later.
#test1 = test[abs(test$Chl.removal) < 50,] 
#check_filter_dist <- test1 %>% 
#  filter(Experiment %in% c("Filtration"))
#hist(check_filter_dist$Clearance) # Looks more normal than just removing NPD_2020_4_17)
#summary(check_filter_dist$Clearance)

### 2) Domain knowlege - remove one single trial (NPD_2020_4_17) avg Chlup at sensor detection limit (+- 0.1 ug/L)
test1 = test %>% 
  dplyr::filter(round(Chl.up,2) > 0.1 | round(Chl.up,2) < -0.1)
# check distribution of Control trials
check_control_dist <- test1 %>% 
  filter(Experiment %in% c("Neg Control 1"))
hist(check_control_dist$Clearance, breaks = 50)
summary(check_control_dist$Clearance) # mean and median not close... prob not normally distributed
# check distribution of Filtration trials
check_filter_dist <- test1 %>% 
  filter(Experiment %in% c("Filtration"))
hist(check_filter_dist$Clearance, breaks = 50)
summary(check_filter_dist$Clearance) # also not close... doesn't look normal with extreme values

########### T-test Compare Control vs Filtration trials
exp = test1[test1$Experiment=="Filtration",] # separate Filtraiton trials
control = test1[test1$Experiment!="Filtration",] # separate negative control trials
# Two-sample / independent t-test , single / one-sided 
t_test <- t.test(exp$Clearance,control$Clearance,alternative="greater")
# extract t.test results from tibble format
filter_control_ttest <- broom::tidy(t_test)
filter_control_ttest
# Degrees of freedom two-sample t-test
t_test_df <- (nrow(exp) + nrow(control)) - 2 

########### Power analysis - sensitivity power analysis 
library(pwr)
# estimate s per Cohen --> d (effect size) = mean(x1) - mean(x2) / s
# formulas from Cohen (1988) on Wikipedia
d_test1 <- {
  (mean(exp$Clearance) - mean(control$Clearance)) / 
  (sqrt(
    ((nrow(exp) - 1)*sd(exp$Clearance)^2 + (nrow(control) - 1)*sd(control$Clearance)^2) / 
         (nrow(exp) + nrow(control) - 2))
   ) }

# power analysis for "t-test (two samples with unequal n)"
test1_power <- pwr.t2n.test(d = d_test1, 
                            n1 = nrow(exp), 
                            n2 = nrow(control),
                            sig.level = 0.05,
                            power = NULL, # solve for this
                            alternative = "greater")

########## RANDOM FOREST MODEL- control for WQ & Site
model.rf = randomForest(Clearance~Temp+Salinity+Turbidity+TPM+OC+Site,
                        data=test1, # use data with extreme values removed 
                        ntree=100,
                        mtry=3,
                        control=rpart.control(minsplit=2,cp=.05))
model.rf
plot(model.rf)
y.hat = predict(model.rf,newdata=test1) # model predicted values
res = test1$Clearance - y.hat # residuals - difference between measured values and model predicted values 
r.sq = (var(test1$Clearance) - var(res))/var(test1$Clearance)
r.sq # r squared value for random forest model

### Random Forest variable importance
Var_import1 <- importance(model.rf)
Var_import1
Var_import1 <- Var_import1[order(Var_import1[,1], decreasing=TRUE),] # sort matrix highest to lowest - output names numeric
Var_import_df1 <- data.frame(as.list(Var_import1)) # convert named numeric to data.frame
Var_import_df1 %<>% 
  pivot_longer(cols = c(Turbidity, Temp, TPM, Salinity, OC, Site), names_to = "Variable", values_to = "Importance") %>% 
  arrange(desc(Importance))
Var_import_df1 # dataframe with sorted importance values - highest to lowest
## Calculate the percent relative importance for each variable
sum_import1 <- sum(Var_import_df1$Importance)
Temp_rel_import <- (Var_import_df1[[1,2]] / sum_import1) * 100
OC_rel_import <- (Var_import_df1[[2,2]] / sum_import1) * 100
Turb_rel_import <- (Var_import_df1[[3,2]] / sum_import1) *100
TPM_rel_import <- (Var_import_df1[[4,2]] / sum_import1) * 100
Sal_rel_import <- (Var_import_df1[[5,2]] / sum_import1) *100
Site_rel_import <- (Var_import_df1[[6,2]] / sum_import1) *100

######## Adjust values - Random Forest model - compare Mud flat to Oyster habitat. ###############
# take residuals (diff between data and model - what the model doesn't account for (oysters)) and add to the mean response (same for data and model?). This gives me response with the effects of all variables accounted for. 
y.adj = res + mean(test1$Clearance) 
y.adj.experiment = y.adj[test1$Experiment=="Filtration"]
y.adj.control = y.adj[test1$Experiment!="Filtration"]
t.test(y.adj.experiment,y.adj.control,alternative="greater")
t_test_adj <- broom::tidy(t.test(y.adj.experiment,y.adj.control,alternative="greater"))
t_test_adj
# Degrees of freedom two-sample t-test
t_test_adj_df <- (length(y.adj.experiment) + length(y.adj.control)) - 2 

########### Power analysis - sensitivity power analysis 
# estimate s per Cohen --> d (effect size) = mean(x1) - mean(x2) / s
# formulas from Cohen (1988) on Wikipedia
d_adj_test1 <- {
  (mean(y.adj.experiment) - mean(y.adj.control)) / 
  (sqrt(
    ((length(y.adj.experiment) - 1)*sd(y.adj.experiment)^2 + 
       (length(y.adj.control) - 1)*sd(y.adj.control)^2) / 
         (length(y.adj.experiment) + length(y.adj.control) - 2))
   ) }

# power analysis for "t-test (two samples with unequal n)"
adj_test1_power <- pwr.t2n.test(d = d_adj_test1, 
                            n1 = length(y.adj.experiment), 
                            n2 = length(y.adj.control),
                            sig.level = 0.05,
                            power = NULL, # solve for this
                            alternative = "greater")



### Example tree ######
#model.tree = rpart(Clearance~Temp+Salinity+Turbidity+TPM+OC+Site,method="anova",control=rpart.control(minsplit=2,cp=0.05),data=test1)
#plot(model.tree)
#text(model.tree,cex=.65)

############# WQ values affect on Filtration only #############

test2 <- test1[test1$Experiment=="Filtration",] # Filtraton trials only
model.rf.filter = randomForest(Clearance~Temp+Salinity+Turbidity+TPM+OC+Site,
                        data=test2, # use data with extreme values removed 
                        ntree=100,
                        mtry=3,
                        control=rpart.control(minsplit=2,cp=.05))
model.rf.filter
plot(model.rf.filter)
y.hat.filter = predict(model.rf.filter,newdata=test2) # model predicted values
res.filter = test2$Clearance - y.hat.filter # residuals - difference between measured values and model predicted values 
r.sq.filter = (var(test2$Clearance) - var(res.filter))/var(test2$Clearance)
r.sq.filter # r squared value for random forest model
### R^2: 0.646

### Random Forest variable importance
Var_import <- importance(model.rf.filter)
Var_import <- Var_import[order(Var_import[,1], decreasing=TRUE),] # sort matrix highest to lowest - output names numeric
Var_import_df <- data.frame(as.list(Var_import)) # convert named numeric to data.frame
Var_import_df %<>% 
  pivot_longer(cols = c(Turbidity, Temp, TPM, Salinity, OC, Site), names_to = "Variable", values_to = "Importance") %>% 
  arrange(desc(Importance))
Var_import_df # dataframe with sorted importance values - highest to lowest
sum_import <- sum(Var_import_df$Importance)
Temp_rel_import_HCR <- (Var_import_df[[1,2]] / sum_import) * 100
Turb_rel_import_HCR <- (Var_import_df[[2,2]] / sum_import) * 100
TPM_rel_import_HCR <- (Var_import_df[[3,2]] / sum_import) * 100
OC_rel_import_HCR <- (Var_import_df[[4,2]] / sum_import) * 100
Site_rel_import_HCR <- (Var_import_df[[5,2]] / sum_import) * 100
Sal_rel_import_HCR <- (Var_import_df[[6,2]] / sum_import) * 100

###################### Initial analysis ################
m1 = lm(Chl.up~Chl.dn,data=test)
summary(m1)
plot(test$Chl.up,test$Chl.dn)
abline(m1,col=2,lty=2)
# Seemed like a dumb idea because we have very different sites.  What we're trying to accomplish
# is a comparison of chloroform upstream vs. downstream after controlling for other covariates (depth, temp, site, ect)
# To do this we will model choloroform up and cholorform down as a function of those covarates and then compare 
# residuals of those models.  
# The model we're choosing right now is just a linear model, we can substitude something more glamourous later if need be.

test1 = test[test$Experiment=="Filtration",]
par(mfrow=c(2,1))
plot(test$Chl.up,test$Chl.dn)
plot(test1$Chl.up,test1$Chl.dn)


upstream = test1[,-10] 
downstream = test1[,-9] 
upstream$stream = "upstream"
downstream$stream  = "downstream"
colnames(upstream)[9] = "clr"
colnames(downstream)[9] = "clr"
test2 = rbind(upstream,downstream)
colnames(test2)[12] = "Velocity"
control.model = lm(clr~Site+Temp+Salinity+Turbidity+TPM+OC+Depth+Distance+Velocity+Chl.removal+Clearance,data=test2)
test2$adjusted.clr = control.model$residuals + mean(test2$clr)

up.adj = test2$adjusted.clr[test2$stream=="upstream"]
dn.adj = test2$adjusted.clr[test2$stream=="downstream"]
up.adj = up.adj[-c(10,14)]
dn.adj = dn.adj[-c(10,14)]
#Assuming we have a good reason for dropping data point 10.

m2 = lm(up.adj~dn.adj+0)
summary(m2)
dev.off()
plot(up.adj,dn.adj)
abline(0,1,col=4,lwd=2,lty=2)
x.seq = seq(min(dn.adj),max(dn.adj),by = (max(dn.adj)-min(dn.adj))/1000)
conf.seq = predict.lm(m2,newdata=data.frame(dn.adj=x.seq),interval="confidence")
lines(x.seq,conf.seq[,1],col=2,lty=2,lwd=2)
lines(x.seq,conf.seq[,2],col=2,lty=2,lwd=1)
lines(x.seq,conf.seq[,3],col=2,lty=2,lwd=1)
text(up.adj+.08,dn.adj,(1:length(up.adj)))
slope = summary(m2)[[4]][1]
se = summary(m2)[[4]][2]
df = summary(m2)[[7]][2]

t = (slope-1)/se
p.val = 1-pt(t,df)
p.val

mlr = lm(clr~Site+Temp+Salinity+Turbidity+TPM+OC,data=test2)
summary(mlr)
```

## Oyster Habitat vs. Control 

Habitat clearance rates (HCR) in filtration trials (*N* = `r nrow(exp)`) were not significantly different than in control trials (*N* = `r nrow(control)`) (two-sample, one-tail *t*(`r t_test_df`) = `r round(filter_control_ttest$statistic, digits = 2)`, *p* = `r round(filter_control_ttest$p.value, digits = 2)`). 
A statistical power analysis determined that the effect size between filtration and control trial HCR was very large (*ES* = `r round(test1_power$d, 2)`) [@Sawilowsky2009a], and there was little power (`r round(test1_power$power,2)`) to detect a statistical signal.
A random forest model including all filtration and control trials HCR (*R*^2^ = `r round(r.sq,2)`) indicated that temperature had the highest relative importance to the model (`r round(Temp_rel_import, 1)`\%), followed by OC (`r round(OC_rel_import, 1)`\%), turbidity (`r format(round(Turb_rel_import, 1), nsmall = 1)`\%), TPM (`r format(round(TPM_rel_import, 1), nsmall =1)`\%), salinity (`r format(round(Sal_rel_import, 1), nsmall = 1)`\%), and site (`r format(round(Site_rel_import, 1), nsmall =1)`\%).
The residuals of this random forest regression adjusted HCR values to account for water quality variables and site. 
Adjusted HCR between filtration and control trials were not significantly different (two-sample, one-tail *t*(`r t_test_adj_df`) = `r round(t_test_adj$statistic, digits = 2)`, *p* = `r round(t_test_adj$p.value, digits = 3)`).
A statistical power analysis determined that the effect size of adjusted HCRs between filtration and control trials was still very large (*ES* = `r round(adj_test1_power$d,2 )`) and with more power (`r round(adj_test1_power$power, 2)`) than the unadjusted HCR t-test.
Despite non-significant results between control and filtration trials, statistical power analysis indicate that my limited sample size is inhibiting statistical inference of a very large effect size between oyster habitat HCRs relative to mudflat control HCRs.

```{r FR_Site_boxplot, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align= "center", fig.asp=0.618, out.width="70%", fig.width=6,  message= F, fig.cap="Box plots of habitat clearance rates (HCR) during filtration trials, control trials are listed in Table 1. Each data point is an the mean of a single filtration trial and diamonds are site means. HCR was not statistically different between sites (one-way ANOVA). Filtration trials were conducted between February 2018 to June 2019 at San Rafael, CA (restored \\textit{O. lurida} reefs); Morro Bay, CA (Morro Bay Oyster Company \\textit{C. gigas} aquaculture); and Newport Bay, CA (Shellmaker and Deanza, restored beds). \\label{FR_Site_boxplot}"}

## HCR averages by Site
FR_Site <- Filter_only_outRmd_data %>% 
  group_by(Site) %>% 
  summarize(avg_HCR = mean(L_hr_m2),
            SD = sd(L_hr_m2),
            n_samples = length(L_hr_m2),
            median = median(L_hr_m2),
            varience = var(L_hr_m2))

#### one-way ANOVA -- HCR by Site
HCR_site_aov <- aov(L_hr_m2 ~ Site, data = Filter_only_outRmd_data)
#summary(HCR_site_aov)
HCR_aov_values <- broom::tidy(HCR_site_aov)

# Post-Hoc Tukey test
tukey_HCR <- TukeyHSD(HCR_site_aov)
#tukey_HCR
#plot(tukey_HCR)
#Honestly Significant Difference test
hds_HCR <- HSD.test(HCR_site_aov, trt = "Site")
#hds_HCR

########### Power analysis - sensitivity power analysis 
# one-way ANOVA effect size (n^2). n^2 = treatmentSumSquares / TotalSumSquares (TreatSS + ResidualSS) 
d_HCR_site <- { HCR_aov_values[[1,3]] / (HCR_aov_values[[1,3]] + HCR_aov_values[[2,3]]) }

# power analysis for "balanced one-way analysis of variance tests"
# For now Ted says to use the mean of the different sample sizes
HCR_site_power <- pwr.anova.test(f = d_HCR_site, 
                                 k = 4,
                                 n = mean(FR_Site$n_samples), 
                                 sig.level = 0.05,
                                 power = NULL) # solve for this

# test if shellmaker extreme value was removed. SD is approxamtely equal among sites
x <- Filter_only_outRmd_data %>% 
  filter(L_hr_m2 > -1000) %>% 
  group_by(Site) %>% 
  summarize(avg_L_hr_m2 = mean(L_hr_m2),
            SD = sd(L_hr_m2),
            n_samples = length(L_hr_m2))

### Filtration by site (Filtration Trials only)
FR_box <- ggplot((Filter_only_outRmd_data), aes(Site, L_hr_m2)) +
  geom_boxplot(color = Site_colors) +
  geom_dotplot(binaxis = "y", stackdir = "center", aes(fill = Site),
               alpha = 0.5, dotsize = 0.65, show.legend = FALSE) +
   geom_point(data = FR_Site, aes(Site, avg_HCR),
             size = 2, shape = 18) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  #stat_summary(fun.data = n_mean_stats, geom = "text") +
  labs(x = 'Site',
       y = Hab_FR_Label)

plot(FR_box) 

#### HCR by Site with .5 quantile ###########
# select within each stie
SR_50quant <- Filter_only_outRmd_data %>%
  filter(Site == "San Rafael",
         L_hr_m2 > FR_Site[[1,5]])

MB_50quant <- Filter_only_outRmd_data %>%
  filter(Site == "Morro Bay",
         L_hr_m2 > FR_Site[[2,5]])

NPSM_50quant <- Filter_only_outRmd_data %>%
  filter(Site == "Shellmaker",
         L_hr_m2 > FR_Site[[3,5]])

NPD_50quant <- Filter_only_outRmd_data %>%
  filter(Site == "Deanza",
         L_hr_m2 > FR_Site[[4,5]])
# combine each site's .5 quantile data together
Site_HCR_50quant <- rbind(SR_50quant, MB_50quant, NPSM_50quant, NPD_50quant)

HCR50_sum <- Site_HCR_50quant %>% 
  group_by(Site) %>% 
  summarize(avg_L_hr_m2 = mean(L_hr_m2),
            SD = sd(L_hr_m2),
            n_samples = length(L_hr_m2),
            med = median(L_hr_m2))

HCR_50quant_box <- ggplot((Site_HCR_50quant), aes(Site, L_hr_m2)) +
  geom_point(aes(fill = Site), shape = 21, show.legend = FALSE) +
  scale_fill_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Site',
       y = Hab_FR_Label)

#plot(HCR_50quant_box)

####### one-way ANOVA -- HCR by Site
HCR50_site_aov <- aov(L_hr_m2 ~ Site, data = Site_HCR_50quant)
#summary(HCR_site_aov)
HCR50_aov_values <- broom::tidy(HCR50_site_aov)

########### Power analysis - sensitivity power analysis 
# one-way ANOVA effect size (n^2). n^2 = treatmentSumSquares / TotalSumSquares (TreatSS + ResidualSS) 
d_HCR50_site <- { HCR50_aov_values[[1,3]] / (HCR50_aov_values[[1,3]] + HCR50_aov_values[[2,3]]) }

# power analysis for "balanced one-way analysis of variance tests"
# For now Ted says to use the mean of the different sample sizes
HCR50_site_power <- pwr.anova.test(f = d_HCR50_site, 
                                 k = 4,
                                 n = mean(HCR50_sum$n_samples), 
                                 sig.level = 0.05,
                                 power = NULL) # solve for this

```

```{r HCR_Quantile_Regression, fig.width=7, fig.asp=1.2, warning=F, message = F, fig.cap="The relationship between water quality variables and habitat clearance rate (HCR). For all oyster habitat filtration trials, quantile regression with $\\tau$ = 0.5 and $\\tau$ = 0.9 was used to test wheather HCR changed with A) temperature, B) salinity, C) turbidity, D) total particulate matter, or E) organic content; slopes that are not significantly different from zero are indicated by red dashed lines. Dotted gray lines are the mean value of HCR. \\label{Quantile_Reg}"}
#create model variables
attach(Filter_only_outRmd_data)
qr_x <- cbind(Temp_C_Up, Sal_ppt_Up, Turbidity_NTU_Up, Avg_TPM_mg_L, Avg_OC_Ratio, Site)
#summary(qr_x)
qr_y <- cbind(L_hr_m2)
#summary(qr_y)

## OLS Model
HCR_lm <- lm(qr_y ~ qr_x)
#summary(HCR_lm)
#hist(Filter_only_outRmd_data$L_hr_m2)
# Look at linear model assumptions
# Doesn't look good with this data
#par(mfrow=c(2,2))
#plot(HCR_lm)

##########################################
############## Quantile Regression ###############
## Bivariate comparisons only, not doing multivariate in this study (Talked with Ted Grosholz)
library(quantreg) # Quantile Rregression package

#### Look at change over most Quantiles
qr_temp <- rq(L_hr_m2 ~ Temp_C_Up,
             tau = seq(0.05,0.95, by = 0.05),
             na.action = na.omit,
             data = Filter_only_outRmd_data)
#summary(qr_temp)
#plot(qr_temp)

#### Temperature
## Looking at .5 and .9 quantiles of Habitat Clearance Rates - Filtration most likely on
qr_5_9_temp <- rq(L_hr_m2 ~ Temp_C_Up,
                tau = c(0.5,0.9),
                data = Filter_only_outRmd_data)

# Check results
sumQRtemp <- summary(qr_5_9_temp, se = "boot", R = 1000)
#sumQRtemp

## Graph
# if statements choose linetype - solid (significant) or dashed (not significant)
qrplot_temp <- ggplot(Filter_only_outRmd_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_point(aes(color = Site)) +
  # gray line indicating mean of HCR
  geom_hline(yintercept = mean(Filter_only_outRmd_data$L_hr_m2),
             linetype = "dotted", 
             color = "gray50") +
  theme_classic() +
  guides(color=FALSE) +
  labs(x = expression(paste("Temperature (", degree, "C)")),
       y = "",
       title = "A)") +
  scale_color_manual(values = Site_colors) +
  {if(sumQRtemp[[1]]$coefficients[2,4] >= 0.05 | is.na(sumQRtemp[[1]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "dashed")} +
  {if(sumQRtemp[[1]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "solid")} +
  {if(sumQRtemp[[2]]$coefficients[2,4] >= 0.05 | is.na(sumQRtemp[[2]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "dashed")} +
  {if(sumQRtemp[[2]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "solid")}

### Salinity 
qr_5_9_sal <- rq(L_hr_m2 ~ Sal_ppt_Up,
                tau = c(0.5,0.9),
                data = Filter_only_outRmd_data)

# Check results
sumQRsal <- summary(qr_5_9_sal, se = "boot", R = 1000)
#sumQRsal

# Graph
qrplot_sal <- ggplot(Filter_only_outRmd_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_point(aes(color = Site)) +
  geom_hline(yintercept = mean(Filter_only_outRmd_data$L_hr_m2),
             linetype = "dotted", 
             color = "gray50") +
  theme_classic() +
  guides(color=FALSE) +
    labs(x = expression(paste("Salinity (ppt)")),
       y = "",
       title = "B)") +
  scale_color_manual(values = Site_colors) +
  {if(sumQRsal[[1]]$coefficients[2,4] >= 0.05 | is.na(sumQRsal[[1]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "dashed")} +
  {if(sumQRsal[[1]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "solid")} +
  {if(sumQRsal[[2]]$coefficients[2,4] >= 0.05 | is.na(sumQRsal[[2]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "dashed")} +
  {if(sumQRsal[[2]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "solid")}

### Turbidity
qr_5_9_turb <- rq(L_hr_m2 ~ Turbidity_NTU_Up,
                tau = c(0.5,0.9),
                data = Filter_only_outRmd_data)

# Check results
sumQRturb <- summary(qr_5_9_turb, se = "boot", R = 1000)
#sumQRturb

# Graph
qrplot_turb <- ggplot(Filter_only_outRmd_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_point(aes(color = Site)) +
  geom_hline(yintercept = mean(Filter_only_outRmd_data$L_hr_m2),
             linetype = "dotted", 
             color = "gray50") +
  theme_classic() +
  guides(color=FALSE) +
  labs(x = expression(paste("Turbidity (NTU)")),
       y = "",
       title = "C)") +
  scale_color_manual(values = Site_colors) +
  {if(sumQRturb[[1]]$coefficients[2,4] >= 0.05 | is.na(sumQRturb[[1]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "dashed")} +
  {if(sumQRturb[[1]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "solid")} +
  {if(sumQRturb[[2]]$coefficients[2,4] >= 0.05 | is.na(sumQRturb[[2]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "dashed")} +
  {if(sumQRturb[[2]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "solid")}

### TPM
qr_5_9_tpm <- rq(L_hr_m2 ~ Avg_TPM_mg_L,
                tau = c(0.5,0.9),
                data = Filter_only_outRmd_data)

# Check results
sumQRtpm <- summary(qr_5_9_tpm , se = "boot", R = 1000)
#sumQRtpm

# Graph
qrplot_tpm <- ggplot(Filter_only_outRmd_data, aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_point(aes(color = Site)) +
  geom_hline(yintercept = mean(Filter_only_outRmd_data$L_hr_m2),
             linetype = "dotted", 
             color = "gray50") +
  theme_classic() +
  guides(color=FALSE) +
  labs(x = expression(paste("Total Particulate Matter (", mu,"g/L)")),
       y = "",
       title = "D)") +
  scale_color_manual(values = Site_colors) +
  {if(sumQRtpm[[1]]$coefficients[2,4] >= 0.05 | is.na(sumQRtpm[[1]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "dashed")} +
  {if(sumQRtpm[[1]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "solid")} +
  {if(sumQRtpm[[2]]$coefficients[2,4] >= 0.05 | is.na(sumQRtpm[[2]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "dashed")} +
  {if(sumQRtpm[[2]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "solid")}

### OC 
qr_5_9_oc <- rq(L_hr_m2 ~ Avg_OC_Ratio,
                tau = c(0.5,0.9),
                data = Filter_only_outRmd_data)

# Check results
sumQRoc <- summary(qr_5_9_oc , se = "boot", R = 1000)
#sumQRoc

# Graph
qrplot_oc <- ggplot(Filter_only_outRmd_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point(aes(color = Site)) +
  geom_hline(yintercept = mean(Filter_only_outRmd_data$L_hr_m2),
             linetype = "dotted", 
             color = "gray50") +
  theme_classic() +
  guides(color=FALSE) +
  labs(x = expression(paste("Organic Content (ratio)")),
       y = "",
       title = "E)") +
  scale_color_manual(values = Site_colors) +
  {if(sumQRoc[[1]]$coefficients[2,4] >= 0.05 | is.na(sumQRoc[[1]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "dashed")} +
  {if(sumQRoc[[1]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.5, color = 'red', linetype = "solid")} +
  {if(sumQRoc[[2]]$coefficients[2,4] >= 0.05 | is.na(sumQRoc[[2]]$coefficients[2,4]))
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "dashed")} +
  {if(sumQRoc[[2]]$coefficients[2,4]< 0.05)
              geom_quantile(quantiles = 0.9, color = 'red', linetype = "solid")}

## Combine graphs into single multiframe figure
## Function to pull out legend
extract_legend<-function(myggplot){
    tmp <- ggplot_gtable(ggplot_build(myggplot))
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
    legend <- tmp$grobs[[leg]]
    return(legend)
    }

# Dumbie graph
legend_plot <- ggplot(Filter_only_outRmd_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() 
# extract legend
QR_legend <- extract_legend(legend_plot)

# make multipframe figure
grid.arrange(arrangeGrob(qrplot_temp, qrplot_sal, qrplot_turb, qrplot_tpm, qrplot_oc, QR_legend, 
             nrow = 3,
             left = grid::textGrob(Hab_FR_Label, rot = 90, vjust = 1, 
                                          gp = gpar(fontsize = 12))))
```

## Habitat Clearance Rates 

Mean HCR at San Rafael was `r round(mean(SR_filter_sum$L_hr_m2),1)` L hr^-1^ m^-2^ (*N* = `r nrow(SR_filter_sum)`, *SD* = `r round(sd(SR_filter_sum$L_hr_m2),1)`), `r round(mean(MB_filter_sum$L_hr_m2),1)` L hr^-1^ m^-2^ (*N* = to `r nrow(MB_filter_sum)`, *SD* = `r round(sd(MB_filter_sum$L_hr_m2),1)`) at Morro Bay, 
`r round(mean(NPSM_filter_sum$L_hr_m2),1)` L hr^-1^ m^-2^ (*N* = `r nrow(NPSM_filter_sum)`, *SD* = `r round(sd(NPSM_filter_sum$L_hr_m2),1)`) at Shellmaker, 
and `r round(mean(NPD_filter_sum$L_hr_m2),1)` L hr^-1^ m^-2^ (*N* = `r nrow(NPD_filter_sum)`, *SD* = `r round(sd(NPD_filter_sum$L_hr_m2),1)`) at Deanza (Figure \ref{FR_Site_boxplot}).
Control trials measured `r round(SR_NC_sum$L_hr_m2,1)`, `r round(MB_NC_sum$L_hr_m2,1)`, `r round(NPSM_NC_sum$L_hr_m2,1)`, and `r round(NPD_NC_sum$L_hr_m2,1)` L hr^-1^ m^2^ at San Rafael, Morro Bay, Shellmaker, and Deanza respectfully.
HCR for filtration trials did not differ significantly between sites (one-way ANOVA, *F*(`r HCR_aov_values[[1,2]]`, `r HCR_aov_values[[2,2]]`) = `r round(HCR_aov_values[[1,5]],2)`, *p* = `r round(HCR_aov_values[[1,6]],2)`).
A statistical power analysis determined that the effect size between site and HCR in a one-way ANOVA was very small (*ES* = `r round(HCR_site_power$f, 2)`) [@Sawilowsky2009a] with little power (`r round(HCR_site_power$power, 2)`) to detect statistically significant differences.
The upper 0.5 quantile of HCR at each site, representing the top filtration performance within each site, did not differ between sites (one-way ANOVA, *F*(`r HCR50_aov_values[[1,2]]`, `r HCR50_aov_values[[2,2]]`) = `r round(HCR50_aov_values[[1,5]],2)`, *p* = `r round(HCR50_aov_values[[1,6]],2)`).
This comparison between site and HCR had low power (`r round(HCR50_site_power$power,2)`) and very small effect size (`r round(HCR50_site_power$f,2)`) [@Sawilowsky2009a].
Individual water quality variables did not significantly relate with HCR at 0.5 and 0.9 quantiles: temperature ($\tau$ = 0.5, $\beta$±*SE* = `r round(sumQRtemp[[1]]$coefficients[2,2],2)`, *p* = `r round(sumQRtemp[[1]]$coefficients[2,4],2)`; $\tau$ = 0.9, $\beta$±*SE* = `r round(sumQRtemp[[2]]$coefficients[2,2],2)`, *p* = `r round(sumQRtemp[[2]]$coefficients[2,4],2)`), salinity ($\tau$ = 0.5, $\beta$±*SE* = `r round(sumQRsal[[1]]$coefficients[2,2],2)`, *p* = `r round(sumQRsal[[1]]$coefficients[2,4],2)`; $\tau$ = 0.9, $\beta$±*SE* = `r round(sumQRsal[[2]]$coefficients[2,2],2)`, *p* = `r round(sumQRsal[[2]]$coefficients[2,4],2)`),
turbidity ($\tau$ = 0.5, $\beta$±*SE* = `r round(sumQRturb[[1]]$coefficients[2,2],2)`, *p* = `r round(sumQRturb[[1]]$coefficients[2,4],2)`; $\tau$ = 0.9, $\beta$±*SE* = `r round(sumQRturb[[2]]$coefficients[2,2],2)`, *p* = `r round(sumQRturb[[2]]$coefficients[2,4],2)`),
TPM ($\tau$ = 0.5, $\beta$±*SE* = `r round(sumQRtpm[[1]]$coefficients[2,2],2)`, *p* = `r round(sumQRtpm[[1]]$coefficients[2,4],2)`; $\tau$ = 0.9, $\beta$±*SE* = `r round(sumQRtpm[[2]]$coefficients[2,2],2)`, *p* = `r round(sumQRtpm[[2]]$coefficients[2,4],2)`),
OC ($\tau$ = 0.5, $\beta$±*SE* = `r round(sumQRoc[[1]]$coefficients[2,2],2)`, *p* = `r round(sumQRoc[[1]]$coefficients[2,4],2)`; $\tau$ = 0.9, $\beta$±*SE* = `r round(sumQRoc[[2]]$coefficients[2,2],2)`, *p* = `r round(sumQRoc[[2]]$coefficients[2,4],2)`) (Figure \ref{Quantile_Reg}).

```{r Final_Summary_table, eval=FALSE, include=FALSE, results='asis'}

## Having hard time compiling this table in Rmd. LaTeX output in Console runs perfectly in Overleaf. ## Need to build table in Word per request of CSUF Thesis Reader :(
## Export to pdf from Overleaf, Open pdf in Word

#library(xtable)

# Organize & clean summary table data
Final_table <- Master_analysis_table %>%
  mutate(Date = mdy(Date),
         Site = ifelse(Site == "San Rafael", "SR",
                       ifelse(Site == "Morro Bay", "MB",
                              ifelse(Site == "Shellmaker", "NPSM",
                                     ifelse(Site == "Deanza", "NPD",  "Pattern Not Found")))),
         Experiment = ifelse(grepl("Neg Control*", Master_analysis_table$Experiment), 
                             gsub("Neg Control*", "Ctrl", Master_analysis_table$Experiment), 
                             "Fltr"),
         L_hr_m2 = round(L_hr_m2),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1),
         Temp_C_Up = round(Temp_C_Up, digits = 2),
         Sal_ppt_Up = round(Sal_ppt_Up, digits = 1),
         Turbidity_NTU_Up = round(Turbidity_NTU_Up, digits = 1),
         Avg_TPM_mg_L = round(Avg_TPM_mg_L, digits = 4),
         Avg_OC_Ratio = round(Avg_OC_Ratio, digits = 2),
         Chl_ug_L_Up = round(Chl_ug_L_Up, digits = 1),
         Chl_ug_L_Down = round(Chl_ug_L_Down, digits = 1),
         avg_depth_m = round((avg_depth_cm/100), digits = 2),
         d_bw_sondes_m = round(d_bw_sondes_m, digits = 1),
         avg_m_sec = round(avg_m_hr/3600, 2)) %>%
  dplyr::select(Site, Date, Experiment, Tide, pcnt_Chl_rmvd, L_hr_m2, Temp_C_Up, Sal_ppt_Up, 
                Turbidity_NTU_Up, Avg_TPM_mg_L, Avg_OC_Ratio, Chl_ug_L_Up, avg_depth_m, 
                d_bw_sondes_m, avg_m_sec) %>% 
 dplyr::arrange(Site, Date)


# arrange by site latitude
Final_table <- arrange(transform(Final_table, Site = factor(Site,levels = site_by_lat_abv)), Site)

data_removed <- Final_table[19,] # name excluded data
data_analysis <- Final_table[-19,] # remove excluded analysis data points

Latex_table_data <- rbind(data_analysis, data_removed) # add excluded data back in at bottom 

### Add to column names for LaTeX to read a multicolumn names
#\\multicolumn{1}{p{1cm}}{\\centering x \\\ y}
# Make date formated as character to display properly
Latex_table_data$Date <- as.character(Latex_table_data$Date)
colnames(Latex_table_data) <- c( "\\multicolumn{1}{p{1cm}}{\\centering Site}", 
                            "\\multicolumn{1}{p{1cm}}{\\centering Date}", 
                            "\\multicolumn{1}{p{1cm}}{\\centering Trial}",
                            "\\multicolumn{1}{p{1cm}}{\\centering Tide}",
                           "\\multicolumn{1}{p{1cm}}{\\centering Chl\\textsubscript{rmd} \\\ (\\%)}",
                           "\\multicolumn{1}{p{1cm}}{\\centering HCR \\\ (L/hr/$m^{2}$)}",
                            "\\multicolumn{1}{p{1cm}}{\\centering Temp \\\ (\\si{\\degree}C)}",
                            "\\multicolumn{1}{p{1cm}}{\\centering Sal \\\ (ppt)} ", 
                            "\\multicolumn{1}{p{1cm}}{\\centering Turb \\\ (NTU)}",
                            "\\multicolumn{1}{p{1cm}}{\\centering TPM \\\ (mg/L)}", 
                            "\\multicolumn{1}{p{1cm}}{\\centering OC \\\ (ratio)}", 
                            "\\multicolumn{1}{p{1cm}}{\\centering Chl\\textsubscript{up} \\\ ($\\upmu$g/L)}", 
                           "\\multicolumn{1}{p{1cm}}{\\centering Depth \\\ (m)}",
                           "\\multicolumn{1}{p{1cm}}{\\centering Dist \\\ (m)}",
                           "\\multicolumn{1}{p{1cm}}{\\centering Vel \\\ (m/s)}")

# create xtable
sumtable_latex <- xtable(Latex_table_data, 
                         caption = "Details of Whole-habitat In Situ Filtration and Control Trials Across Four California Sites. All Values are Means from the Entire Trial. The Trial Separated at the Bottom is within the Chlorophyll  Sensor’s Error and was Removed from the Analysis. Dashes Denote Missing Values.",
                         label = "tb:summary",
                         align = "lllllrrrrrrrrrrr",
                         type = "latex")

#foot_note <-list(pos = list(0), command = NULL)
#foot_note$pos[[1]] <- c(nrow(sumtable_latex))
#foot_note$command <- c("\\hline\\footnotesize{SR: San Rafael, MB: Morro Bay, NPSM: Newport Shellmaker, NPD: Newport Deanza, Fltr: Filtration, Ctrl: Control, Chl\\textsubscript{rmd}: Percent Chlorophyll $\alpha$ Removed, HCR: habitat clearance rate, Temp: temperature, Sal: salinity, Turb: turbidity, TPM: total particulate matter, OC: organic content, Dist: Distance between instruments, Vel: water velocity.}\n")

print.xtable(sumtable_latex, 
      booktabs=TRUE, 
      caption.placement="top", 
      NA.string = NA, 
      sanitize.colnames.function=function(x){x},
      floating.environment = "sidewaystable",
      #add.to.row = foot_note,
      hline.after = c(-1,0,25,26),
      comment = F,
      include.rownames = FALSE,
      timestamp = NULL,
      size = "\\fontsize{10pt}{10pt}\\selectfont") # font size / line spacing 


### Table abbreviations description

#Field sites are San Rafael (SR), Morro Bay (MB), Newport Shellmaker (NPSM), and Newport Deanza (NPD). Trials are either filtration over oyster habitat (Fltr), or control over mudflat (Ctrl). Chl$\textsubscript{rmd}$ is the percent chlorophyll $\alpha$ removed as water traveled across the habitat. HCR is the habitat clearance rate originally described in Milbrandt et al. (2015). Temp is temperature, Turb. is Turbidity, TPM is sesson total particulate matter, OC is relative organic content of TPM. Chl$\textsubscript{up}$ is chlorophyll $\alpha$ concentration at the upstream instrument. Depth is the average water column depth, Dist. is the distance between instruments, and Vel. is the average water velocity.
```

\includepdf[pagecommand={},noautoscale = true]{Summary_Table_2020_11_5.pdf}

\captionsetup[table]{labelformat=empty}

A random forest regression containing only filtration trials (*R*^2^ = `r round(r.sq.filter, 2)`) indicated that temperature (`r round(Temp_rel_import_HCR,1)`\%) had the highest relative importance to the model, followed by turbidity (`r round(Turb_rel_import_HCR,1)`\%), TPM (`r round(TPM_rel_import_HCR,1)`\%), OC (`r round(OC_rel_import_HCR,1)`\%), site (`r round(Site_rel_import_HCR,1)`\%), and salinity (`r round(Sal_rel_import_HCR,1)`\%).

```{r TPM_OC_Values, include=FALSE}
TPM_OC_Values <- Master_analysis_table %>% 
  dplyr::select(Site, Avg_TPM_mg_L, Avg_OC_Ratio) %>% 
  na.omit()

SR_TPM_OC <- TPM_OC_Values %>% 
  filter(Site == "San Rafael")

MB_TPM_OC <- TPM_OC_Values %>% 
  filter(Site == "Morro Bay")

NPSM_TPM_OC <- TPM_OC_Values %>% 
  filter(Site == "Shellmaker")

NPD_TPM_OC <- TPM_OC_Values %>% 
  filter(Site == "Deanza")

NP_combo_TPM_OC <- TPM_OC_Values %>% 
  filter(Site == "Deanza" | Site == "Shellmaker")
```

## Seston Quantity and Quality

```{r TPM_OC_Models, include=FALSE}
### Linear Model 
OC_TPM_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ Avg_TPM_mg_L)
#summary(OC_TPM_LM)
#par(mfrow=c(2,2))
#plot(OC_TPM_LM)

### linear - log model
OC_logTPM_LM <- lm(data = Avg_TPM_summary_table, Avg_OC_Ratio ~ log(Avg_TPM_mg_L))
#summary(OC_logTPM_LM)
#par(mfrow=c(2,2))
#plot(OC_logTPM_LM)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(OC_logTPM_all_LM)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(OC_logTPM_all_LM))

### log - log model
logOC_logTPM_LM <- lm(data = Avg_TPM_summary_table, log(Avg_OC_Ratio) ~ log(Avg_TPM_mg_L))
logOC_logTPM_LM_sum <- summary(logOC_logTPM_LM)
str(logOC_logTPM_LM_sum)
```

```{r TPM_OC_graphs, echo=FALSE, fig.align="center", fig.asp=0.618, fig.cap="The relationship between seston total particulate matter (TPM) and seston organic content (OC) across sites and all trials. Two trials are not included because of missing TPM data. \\label{TPM_OC_model}", fig.keep='all', fig.width=6, message=FALSE, warning=FALSE, dev='pdf', out.width="70%"}

## Linear Model
OC_TPM_graph <- ggplot(data = Avg_TPM_summary_table, aes(Avg_TPM_mg_L, Avg_OC_Ratio, group = Site)) +
  geom_smooth(method = lm, se = F, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  ylim(0,0.5) +
  labs(x = TPM_Label,
       y = "Organic Content (ratio)") +
  guides(color = FALSE) +
  annotate("text", x = 60, y = 0.3, label = "y ~ x") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

## ANCOVA - https://towardsdatascience.com/doing-and-reporting-your-first-anova-and-ancova-in-r-1d820940f2ef
library(car)
ancova_2 <- aov(Avg_OC_Ratio ~ Site + Avg_TPM_mg_L, data = Avg_TPM_summary_table)
#Anova(ancova_2, type = "III") # summary() uses type I error, no good
# can also use summary.lm()
#summary.lm(ancova_2)
# Post-hoc Tukey Honestly Significant Difference test
hsd_ancova <- HSD.test(ancova_2, trt = "Site")



############ Y ~ log(x)
# create range of values to predict with model
TPM_newrange <- data.frame(Avg_TPM_mg_L = seq(from = 0, to = 80, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_OC = predict(OC_logTPM_LM, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

# Testing function to extract lm model
# equatiomatic::extract_eq(FR_logTPM_lm, use_coefs = T)

OC_logTPM_graph <- ggplot((Avg_TPM_summary_table), aes(Avg_TPM_mg_L, Avg_OC_Ratio)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM_mg_L, y = pred_OC)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  #annotate("text", x = 60, y = 0.3, label = "y ~ log(x)") +
  guides(color = FALSE) +
  ylim(0,0.5) +
  labs(x = TPM_Label,
       y = "Organic Content (ratio)") +
  guides(fill = FALSE) +
    ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = y_logx_fomula,
               eq.x.rhs = (" ln(x)"),
               parse = TRUE,
               label.x = "right",
               label.y = "top")

########## Log-log model logOC_logTPM_LM 


loglog_Pred_OC <- data.frame(pred_OC = exp(predict(logOC_logTPM_LM, newdata = TPM_newrange)))
pred_loglogTPM_df <- data.frame(TPM_newrange, loglog_Pred_OC)

logOC_logTPM_graph <- ggplot((Avg_TPM_summary_table), aes(Avg_TPM_mg_L, Avg_OC_Ratio)) +
  geom_line(data = pred_loglogTPM_df, aes(x = Avg_TPM_mg_L, y = pred_OC)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  #guides(color = FALSE) +
  ylim(0,0.5) +
  #annotate("text", x = 60, y = 0.3, label = "log(y) ~ log(x)") +
  labs(x = TPM_Label,
       y = "Organic Content (ratio)") +
  guides(fill = FALSE) +
    ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..rr.label.., ")", sep ="")),
               formula = logy_logx_formula,
               eq.x.rhs = (" ln(x)"), 
               eq.with.lhs = ("ln(y) =="),
               parse = TRUE,
               label.x = "right",
               label.y = "top")

logOC_logTPM_graph


# compare transformation models
#summary(OC_TPM_LM) # R2: 0.3309
#summary(OC_logTPM_LM) # R2: 0.2701
#summary(logOC_logTPM_LM) # R2: 0.3594

```

Total Particulate Matter (TPM) is a significantly related to seston OC when sites are combined  (Figure \ref{TPM_OC_model}). 
This model includes all field days (filtration and controls) because water samples used to determine TPM and OC were collected the same way regardless of the trial. 
Northern San Francisco Bay (San Rafael) TPM averaged `r round(mean(SR_TPM_OC$Avg_TPM_mg_L),2)` mg/L (*N* = `r nrow(SR_TPM_OC)`, *SD* = `r round(sd(SR_TPM_OC$Avg_TPM_mg_L),2)`), and Morro Bay TPM averaged `r round(mean(MB_TPM_OC$Avg_TPM_mg_L),2)` mg/L (*N* = `r nrow(MB_TPM_OC)`, *SD* = `r round(sd(MB_TPM_OC$Avg_TPM_mg_L),2)`) (Figure \ref{TPM_OC_model}).
Newport Bay (Deanza and Shellmaker) TPM averaged `r round(mean(NP_combo_TPM_OC$Avg_TPM_mg_L),2)` mg/L (*N* = `r nrow(NP_combo_TPM_OC)`, *SD* = `r round(sd(NP_combo_TPM_OC$Avg_TPM_mg_L),2)`).
Northern San Francisco Bay (San Rafael) OC averaged `r round(mean(SR_TPM_OC$Avg_OC_Ratio),2)` (*N* = `r nrow(SR_TPM_OC)`, *SD* = `r round(sd(SR_TPM_OC$Avg_OC_Ratio),2)`), and Morro Bay OC averaged `r round(mean(MB_TPM_OC$Avg_OC_Ratio),2)` (*N* = `r nrow(MB_TPM_OC)`, *SD* = `r round(sd(MB_TPM_OC$Avg_OC_Ratio,2))`).
Newport Bay (Deanza and Shellmaker) OC averaged `r round(mean(NP_combo_TPM_OC$Avg_OC_Ratio),3)` (*N* = `r nrow(NP_combo_TPM_OC)`, *SD* = `r round(sd(NP_combo_TPM_OC$Avg_OC_Ratio),2)`) (Figure \ref{TPM_OC_model}).

```{r TPM_OC_Sites_graphs, echo=FALSE, include=F, fig.keep = 'all', dev = 'pdf', fig.align="default", fig.asp=0.618, fig.width=8, message= F, fig.cap="The relationship between seston total particulate matter (TPM) and seston organic content (OC) across all sites and all trials. \\label{TPM_OC_Sites_graphs}"}

TPM_OC_Deanza <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Deanza")),
                        aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Newport Deanza") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_NPSM <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Shellmaker")), 
                     aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Newport Shellmaker") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_SR <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "San Rafael")),
                   aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "San Rafael") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_MB <- ggplot(data = (Avg_TPM_summary_table %>% filter(Site == "Morro Bay")), 
                   aes(x = Avg_TPM_mg_L, y = Avg_OC_Ratio, label = Date)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) + 
  ylim(0,1) +
  scale_color_manual(values = Site_colors, guide=FALSE) + 
  labs(x = TPM_Label, 
       y = "Average Organic Content Ratio", 
       title = "Morro Bay") + 
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

TPM_OC_bysite_graph <- grid.arrange(TPM_OC_SR, TPM_OC_MB, TPM_OC_NPSM, TPM_OC_Deanza, nrow = 2)
# using plot() renders plot twice. Grid.arrange must render on its own
# plot(TPM_OC_bysite_graph)
```

## Filter Feeding Community

```{r Oly_DTW_Shell_length_setup, include=FALSE}
############ Olympia DTW and Shell Length #####################
# Determine what quadrat samples have missing data (NAs)
NPD_biv_bio_summary <- NPD_bivalves %>% 
  group_by(excavation_sample) %>% 
  summarize(avg_DTW = mean(tissue_dry_weight_g))

# what are the unique species in dataset
#unique(NPD_bivalves$species)

# Still contains missing data --> which quadrats to use for analyses
NPD_bivalve_data_clean <- NPD_bivalves %>% 
  filter(!excavation_sample %in% c("Q10", "Q4", "Q8")) %>% 
  mutate(species = ifelse(grepl("adula", ignore.case = T, species), "Adula diegensis",
                          ifelse(grepl("muscul.", ignore.case = T, species), "Musculista senhousia",
                                 ifelse(grepl("myt", ignore.case = T, species), "Mytilus galloprovincialis",
                                        ifelse(grepl(".lurida", ignore.case = T, species), "Ostrea lurida",
                                               ifelse(grepl("mussel", ignore.case = T, species), "Unknown mussel",
                                                      ifelse(grepl(".spinosum", ignore.case = T, species), "Crucibulum spinosum",
                                                       "Pattern Not Found"))))))) %>% 
  # Filter out unclassified/ empty species & samples less than 0g (processing error, doesn't make sense)
  filter(!species %in% c("Pattern Not Found", "Crucibulum spinosum"))

# Remove outlier and negative DTW value
NPD_bivalve_outrmd <- NPD_bivalve_data_clean %>%
  mutate(DTW_outlier = find_outlier(NPD_bivalve_data_clean$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0)

#Olympia DTW predicted by Shell Length - Newport, CA
# All excavation quadrat samples processed to date aggregated (summer 2020)
NPD_oly <- NPD_bivalve_data_clean %>% 
  filter(species == "Ostrea lurida") %>% 
  drop_na() %>% 
  as_tibble() 

Oly_shell_DTW <- ggplot(NPD_oly, aes(length_mm, tissue_dry_weight_g)) +
  geom_smooth(method = lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW predicted by Shell Length - Newport, CA',
       subtitle = 'With outlier (bad data)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top") +
  stat_quadrant_counts(quadrants = 0L, label.x = "left", 
                       aes(label = sprintf("%i observations", stat(count))))

#plot(Oly_shell_DTW)
```

```{r Bivalve_Den_Setup, include=FALSE}
################### Bivalve Density by Site #########################
# read in bivalve density data from cleaned data file
Bivalve_Den_data <- fread(file.path(Bivalve_output_directory, "Bivalve_Density_summary.csv"))

# replace NAs with 0s
Bivalve_Den_data[is.na(Bivalve_Den_data)] <- 0

Bivalve_Den_data <- Bivalve_Den_data %>% 
  # move species from individual columns to a single column with new density column to contain data
  pivot_longer(c(Adula_diegensis_m2, Musculista_senhousia_m2, Mytilus_galloprovincialis_m2,
                 Ostrea_lurida_m2, Crassostrea_gigas_m2, Argopecten_ventricosa_m2, 
                 Geukensia_demissa_m2, Crassostrea_gigas_m2), 
               names_to = "Species", 
               values_to =  "individuals_m2") %>% 
  # remove "_m2" from species names in Species column
  mutate(Species = str_replace(Species, "_m2", ""),
         Species = str_replace(Species, "_", " "))

#Reorder levels of Site factor - display North to South
order_by_site <- c("San Rafael", "Morro Bay", "Shellmaker", "Deanza") 
Bivalve_Den_data <- arrange(transform(Bivalve_Den_data, Site = factor(Site,levels = order_by_site)), Site)
# Density values for in text
SR_Den <- Bivalve_Den_data %>% 
  filter(Site == "San Rafael",
         individuals_m2 > 0) %>% 
  summarise(total_den = sum(individuals_m2))

MB_Den <- Bivalve_Den_data %>% 
  filter(Site == "Morro Bay",
         individuals_m2 > 0) %>% 
  summarise(total_den = sum(individuals_m2))

NPSM_Den <- Bivalve_Den_data %>% 
  filter(Site == "Shellmaker",
         individuals_m2 > 0) %>% 
  summarise(total_den = sum(individuals_m2))
  
NPD_Den <- Bivalve_Den_data %>% 
  filter(Site == "Deanza",
         individuals_m2 > 0) %>% 
  summarise(total_den = sum(individuals_m2))
## Species list
NPSM_species <- Bivalve_Den_data %>% 
  filter(Site == "Shellmaker",
         individuals_m2 > 0) %>% 
  group_by(Species) %>% 
  summarise(species_den = individuals_m2)
 
NPD_species <- Bivalve_Den_data %>% 
  filter(Site == "Deanza",
         individuals_m2 > 0) %>% 
  group_by(Species) %>% 
  summarise(species_den = individuals_m2)
  
```

In November 2017 the estimated bivalve density at San Rafael was `r SR_Den` individuals/m^2^, all of which were *Ostrea lurida* (Figure \ref{Bivalve_Den}).
Other bivalves were noted, but were rare, and were not detected in sample bags (C. Zabin, unpublished data). 
Morro Bay has an estimated `r MB_Den` *Crassostrea gigas* individuals/m^2^ in the summer of 2018 (Morro Bay Oyster Company); personal field observations confirm the lack of bivalve fouling on the aquaculture lines.
In May 2018, Shellmaker had an estimated `r NPSM_Den` individuals/m^2^, composed of *Adula diegensis* (`r NPSM_species[NPSM_species$Species=="Adula diegensis",2]` individuals/m^2^), *Musculista senhousia* (`r NPSM_species[NPSM_species$Species=="Musculista senhousia",2]` individuals/m^2^), *O. lurida* (`r NPSM_species[NPSM_species$Species=="Ostrea lurida",2]` individuals/m^2^), *Mytilus galloprovincialis* (`r NPSM_species[NPSM_species$Species=="Mytilus galloprovincialis",2]` individuals/m^2^), *Geukensia demissa* (`r NPSM_species[NPSM_species$Species=="Geukensia demissa",2]` individuals/m^2^), and *Argopecten ventricosa* (`r NPSM_species[NPSM_species$Species=="Argopecten ventricosa",2]` individuals/m^2^) (Figure \ref{Bivalve_Den}.
Deanza had an estimated `r NPD_Den` individuals/m^2^ in May 2018, and was composed of *M. senhousia* (`r NPD_species[NPD_species$Species=="Musculista senhousia",2]` individuals/m^2^), *A. diegensis* (`r NPD_species[NPD_species$Species=="Adula diegensis",2]` individuals/m^2^), *O. lurida* (`r NPD_species[NPD_species$Species=="Ostrea lurida",2]` individuals/m^2^), *M. galloprovincialis* (`r NPD_species[NPD_species$Species=="Mytilus galloprovincialis",2]` individuals/m^2^) (Figure \ref{Bivalve_Den}).

```{r Bivalve_Den_bargraph, echo=FALSE, fig.align="center", fig.asp=0.618, fig.width=6, warning= F, message= F, fig.keep='all', dev='pdf', out.width="70%", fig.cap="Bivalve community density and composition for each study site. San Rafael data were collected November 2017 by the Zabin lab at SERC, Morro Bay was estimated by Morro Bay Oyster Company in 2018, and Shellmaker and Deanza were surveyed in May 2018 by the Zacherl lab at CSUF.  \\label{Bivalve_Den}"}

#unique(Bivalve_Den_data$Species) # list each individual bivalve species
# Assign species to specific color
Species_colors <- c("Adula diegensis" = "#8D8680",
                    "Argopecten ventricosa" = "#CCC3C5",
                    "Crassostrea gigas" = "#6D6340",
                    "Geukensia demissa" = "#524D4F",
                    "Musculista senhousia" = "#B0915B",
                    "Mytilus galloprovincialis" = "#7E4B41",
                    "Ostrea lurida" = "#9986A5",
                    "Unknown mussel" = "black")

# Stacked bar graph
Bivalve_Den_graph <- ggplot(Bivalve_Den_data, aes(Site)) + 
  geom_col(aes(x = Site, y = individuals_m2, fill = Species)) +
 # geom_text(aes(label = round(Bivalve_den_m2,0), y = Bivalve_den_m2), 
          #  vjust = -0.5) +
  theme_classic() +
  theme(legend.text = element_text(face = "italic")) +
  scale_fill_manual(values = Species_colors) +
  scale_y_continuous(breaks = seq(0, max(Bivalve_Den_data$Bivalve_den_m2), by = 500)) +
  labs(y = expression("Individuals m"^-2))
Bivalve_Den_graph
```

```{r Gray_OlyDTW_SL, include=FALSE}
########### Gray DTW 
Gray_Oly_Data <- fread(file.path('./Data/bivalve_density_community', "MattGray_2011_2013_Olurida_allometric_data.csv"))
colnames(Gray_Oly_Data) <- c("ID", "Date", "species", "length_mm", "shell_tissue_g", "vial_weight", "Vial_wet_oyster", "Tissue_weight_g", "vial_dry_oyster", "tissue_dry_weight_g")
Gray_Oly_Data %<>% 
  mutate(species = ifelse(species %in% "O. lurida", "Ostrea lurida", "Pattern Not FOund"),
         Site = "Yaquina")

Gray_Oly_SL_DTW <- Gray_Oly_Data %>% 
  dplyr::select(Date, Site, species, length_mm, tissue_dry_weight_g)

```

```{r NPD_Oly_DTW_SL_combine_Gray_data, include=FALSE}
# Remove outlier and negative DTW value
NPD_oly_outRmd <- NPD_oly %>%
  mutate(DTW_outlier = find_outlier(NPD_oly$tissue_dry_weight_g)) %>% 
  filter(DTW_outlier == FALSE & tissue_dry_weight_g >= 0) 

NPD_Oly_SL_DTW <- NPD_oly_outRmd %>% 
  mutate(Date = excavation_date) %>% 
  dplyr::select(Date, Site, species, length_mm, tissue_dry_weight_g)

Oly_combo_DTW_SL <- full_join(NPD_Oly_SL_DTW,Gray_Oly_SL_DTW) %>% 
  mutate(legend = case_when(Site == "Deanza" & species == "Ostrea lurida" ~ "Deanza",
                            Site == "Yaquina" & species == "Ostrea lurida" ~ "Yaquina"))

Oly_combo_DTW_SL$legend <- fct_relevel(Oly_combo_DTW_SL$legend, "Yaquina", "Deanza")

### Data file for Dr. Nichols
#Data_For_Kevin <- Oly_combo_DTW_SL %>% 
 # dplyr::select(Site, length_mm, tissue_dry_weight_g)
#fwrite(Data_For_Kevin, file = "Marks_Data_DTW_SL_Newport_Yaquina.csv")
```

```{r Compare_NPD_DTW_SL_transformations, include=FALSE}
####### Linear 
Oly_DTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ length_mm)
summary(Oly_DTW_lm)
# R^2: 0.4914

######### linear - log
Oly_LogxDTW_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ log(length_mm))
summary(Oly_LogxDTW_lm)
# R^2: 0.4289

###### Log - linear
Oly_LogDTW_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ length_mm)
Oly_logDTW_lm_sum <- summary(Oly_LogDTW_lm)
coef(Oly_logDTW_lm_sum)
# R^2: 0.6772
str(Oly_logDTW_lm_sum) ## displays all values in summary

####### Polynomial
Oly_DTW2_lm <- lm(data = NPD_oly_outRmd, tissue_dry_weight_g ~ poly(length_mm, degree = 2, raw = T))
summary(Oly_DTW2_lm)
# R^2: 0.5042

###### Log - Log
## This model has a better fit than log(y) ~ x
Oly_LogDTW_logSH_lm <- lm(data = NPD_oly_outRmd, log(tissue_dry_weight_g) ~ log(length_mm))
OlyDTW_loglog_sum <- summary(Oly_LogDTW_logSH_lm)
# R^2: 0.7299
# Residuals should be close to 0
#https://boostedml.com/2019/06/linear-regression-in-r-interpreting-summarylm.html
# Q1 and Q3 should have similar magnitude
#### Boxplot of residuals
boxplot(Oly_LogDTW_logSH_lm[['residuals']],main='Boxplot: Residuals',ylab='residual value')

summary(Oly_LogDTW_logSH_lm) # residuals median should be close to 0? 
coef(Oly_LogDTW_logSH_lm) # The intercept tells us that when all the features are at 0
confint(Oly_LogDTW_logSH_lm) # confidence interval
residuals(Oly_LogDTW_logSH_lm) # residuals of each data point entered into model


par(mfrow=c(2,2))
plot(Oly_LogDTW_logSH_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(Oly_LogDTW_logSH_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(Oly_LogDTW_logSH_lm))

# show the available object attributes
str(Oly_LogDTW_logSH_lm)
```


```{r Bivalve_biomass_setup, include=FALSE}
######### Biomass by Site ############################
# excavation quadrat area m^2 (0.25 x 0.25m)
NP_excavation_quad_area = 0.0625
# calculate DTW / m^2 / species 
NPD_biv_DTW_m2 <- NPD_bivalve_outrmd %>% 
  group_by(excavation_sample, species) %>% 
  summarize(mean_DTW = mean(tissue_dry_weight_g)) %>% # show the average DTW for each species within each excav sample
  ungroup() %>% # undo previous grouping by excavation_sample and species
  group_by(species) %>% # new grouping by species to determine the average DTW by species across all quads
  summarize(mean_DTW_m2 = mean(mean_DTW/NP_excavation_quad_area)) %>% 
  mutate(Site = "Deanza") %>%  # add new column with site info for bar graph
  rename(Species = species) # rename column with capital case

################### Biomass by species San Rafael ####################
# double dot in file path steps down from current folder "Thesis_Manuscript" back to project level folder
SR_Density_directory = "./Data/bivalve_density_community"
SR_Oly_Shelllength_data = fread(file.path(SR_Density_directory, "Insitu_Filter_SR_oyster_length.csv"))

######## Predict SR DTW with shell length #########
## Predict with log-log model (best fit)
predict_DTW_loglog <- function(data){
  exp(predict(Oly_LogDTW_logSH_lm, newdata = data.frame(length_mm = data$length_mm))) 
  # exp() converts log value, predict needs data.frame input
  # does predict() include error term inherently in lm()
}

SR_Oly_DTW_data <- SR_Oly_Shelllength_data %>% 
  mutate(DTW_g = predict_DTW_loglog(SR_Oly_Shelllength_data)) %>%  # predict Oly Dry tissue weight with length_mm
  group_by(Site, bag_number) %>% 
  summarize(DTW_bag = mean(DTW_g)) # average DTW per sample bag

Oly_italic <- expression(italic("Ostrea lurida"))

SR_Oly_DTW_data2 <- SR_Oly_DTW_data %>% 
  ungroup() %>% 
  group_by(Site) %>% # regroup by site
  summarize(DTW_bag_avg = mean(DTW_bag)) %>% # average DTW across sample bags
  mutate(mean_DTW_m2 = DTW_bag_avg * 18,
         Species = "Ostrea lurida") # sample bag is 1/3 the size of regular shell bag. There are 6 full size bags on the 
# top of the reef unit at San Rafael. The units are 1 x 1 x 1m, so the top area of the reef is 1m^2. (3 * 6 = the amount in 1m^2)

SR_Oly_DTW_data3 <- SR_Oly_DTW_data2 %>% 
  dplyr::select(-(DTW_bag_avg)) # remove DTW_bag_avg 
SR_Oly_DTW_data4 <- data.frame(SR_Oly_DTW_data3) # convert wierd mess of types into a data.frame

SR_NPD_biv_DTWm2 <- rbind(SR_Oly_DTW_data4, NPD_biv_DTW_m2)
# SR total and species total DTW values 
SR_total_DTW <- SR_NPD_biv_DTWm2 %>% 
  filter(Site == "San Rafael") %>% 
  summarise(total = sum(mean_DTW_m2))

SR_species_DTW <- SR_NPD_biv_DTWm2 %>% 
  filter(Site == "San Rafael") %>%
  group_by(Species) %>% 
  summarise(total = sum(mean_DTW_m2))
# Deanza total and species totoal DTW values
NPD_total_DTW <- SR_NPD_biv_DTWm2 %>% 
  filter(Site == "Deanza") %>% 
  summarise(total = sum(mean_DTW_m2))

NPD_species_DTW <- SR_NPD_biv_DTWm2 %>% 
  filter(Site == "Deanza") %>%
  group_by(Species) %>% 
  summarise(total = sum(mean_DTW_m2))

```


Direct biomass data were only available for Deanza, which estimated `r round(NPD_total_DTW, 2)` g/m^2^ of bivalve dry tissue weight (DTW) (Figure \ref{Bivalve_DTW_Biomass}). 
*O. lurida* had the highest DTW with `r round(NPD_species_DTW[NPD_species_DTW$Species=="Ostrea lurida",2],2)` g/m^2^, followed by *M. galloprovincialis* (`r round(NPD_species_DTW[NPD_species_DTW$Species=="Mytilus galloprovincialis",2],)` g/m^2^), an unknown *Modiolus* sp. (`r round(NPD_species_DTW[NPD_species_DTW$Species=="Unknown mussel",2],2)` g/m^2^), *A. diegensis* (`r round(NPD_species_DTW[NPD_species_DTW$Species=="Adula diegensis",2],2)` g/m^2^), and *M. senhousia* (`r round(NPD_species_DTW[NPD_species_DTW$Species=="Musculista senhousia",2],2)` g/m^2^) (Figure \ref{Bivalve_DTW_Biomass}).
San Rafael surveys did not directly measure biomass, but did include *O. lurida* shell length measurements which I used to estimate DTW (Figure \ref{Bivalve_Den_Biomass}) with a model describing the relationship between *O. lurida* shell length and DTW at Deanza (ln(y) = `r round(coef(OlyDTW_loglog_sum)[1,1],digits=2)` `r round(coef(OlyDTW_loglog_sum)[2,1],digits=3)`ln(x), R^2^ = `r round(OlyDTW_loglog_sum$r.squared,digits=2)`, *p* < 0.0001) (Figure \ref{NPD_Oly_DTW_SH_Trans}). 
I estimated San Rafael had `r round(SR_species_DTW$total,2)` g/m^2^ of *O. lurida* (Figure \ref{Bivalve_DTW_Biomass}).
A direct comparison between site biomass to HCR was not possible with my limited biomass and shell length data. 

```{r Bivalve_biomass_bargraph, echo=FALSE, fig.align="center", fig.asp=0.618, fig.width=6, warning= F, message= F, fig.keep='all', dev='pdf', out.width="70%", fig.cap="Estimated biomass of \\textit{O. lurida} habitat at Deanza and San Rafael sites. Data for Deanza was collected by the Zacherl lab (CSUF) in May 2018, the relationship between \\textit{O. lurida} shell length and dry tissue weight (DTW) from the survey was used to estimate DTW at San Rafael with shell length data collected by the Zabin lab (SERC) in November 2017. \\label{Bivalve_DTW_Biomass}"}

####### Bar graph NPD Biomass / DTW by species
Bivalve_Biomass_graph <- ggplot(SR_NPD_biv_DTWm2, aes(Site)) + 
  geom_col(aes(x = Site, y = mean_DTW_m2, fill = Species)) +
  theme_classic() +
  scale_fill_manual(values = Species_colors) +
  theme(legend.text = element_text(face = "italic")) +
  #scale_y_continuous(breaks = seq(0, max(NPD_Posbiomass_outlier$tissue_dry_weight_g), by = 500)) +
  labs(y = expression("Dry Tissue Weight (g m" ^-2* ")"))
## Add total Biomass on top of bars
Bivalve_Biomass_graph
#bar_graphs <- plot_grid(Bivalve_Den_graph + theme(legend.position="none"),
 #                       Bivalve_Biomass_graph + theme(legend.position="none"),
  #                      align = 'vh',
   #                     labels = c("A", "B"),
    #                    hjust = -1,
     #                   nrow = 1)
#legend_b <- get_legend(Bivalve_Den_graph + theme(legend.box.margin = margin(0, 0, 0, 12)))
#bar_graph_1legend <- plot_grid(bar_graphs, legend_b, rel_widths = c(3, .4))
# How do I move legend inside of plot area? This method uses cowplot
#bar_graph_1legend

### Might be better to have separate graphs so size scaling & fonts stays good when knitting. Legend could takeup more room next to DTW graph, forcing columns to compact. Figure out how to display legend with more data then is present in the data.frame.
```

```{r Oly_DTW_SH_outrmd_Graphs, echo=FALSE, fig.keep = 'all', dev = 'pdf', fig.align="center", warning=F, message=F, fig.asp=0.618, fig.width=6, out.width="70%", fig.cap="The relationship between \\textit{O. lurida} shell length and dry tissue weight (DTW) at the Deanza restoration site in Newport Bay, California. \\label{NPD_Oly_DTW_SH_Trans}"}

### y ~ log(x) model ####
# range of Shell length values
SH_newrange <- data.frame(length_mm = seq(from = 0, to = 53, by = 1))
# create new dataframe with model predicted values from new data range above
pred_logxDTW_SH <- data.frame(DTW_pred = predict(Oly_LogxDTW_lm, newdata = SH_newrange), length_mm = SH_newrange)

# graph with model predicted values to draw line
Oly_SH_logxDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_logxDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "y ~ log(x)") +
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

### log(y) ~ x model ####

pred_logDTW_SH <- data.frame(DTW_pred = exp(predict(Oly_LogDTW_lm, newdata = SH_newrange)), length_mm = SH_newrange)

Oly_shell_DTW_logline <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_logDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  #annotate("text", x = 10, y = 0.2, label = "log(y) ~ x")+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') +
    ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..rr.label.., ")", sep ="")),
               formula = logy_x_formula,
              # eq.x.rhs = (" ln(x)"), 
               eq.with.lhs = ("ln(y) =="),
               parse = TRUE,
               label.x = "left",
               label.y = "top")



### log(y) ~ log(x) model ###

# predict values for model based on model and new range of data. exp() converts log() values to regular values
pred_loglogDTW_SH <- data.frame(DTW_pred = exp(predict(Oly_LogDTW_logSH_lm, newdata = SH_newrange)), 
                                length_mm = SH_newrange)

Oly_shell_logDTW <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_loglogDTW_SH, aes(x = length_mm, y = DTW_pred)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  #annotate("text", x = 10, y = 0.2, label = "log(y) ~ log(x)")+
  labs(x = 'Shell Length (mm)',
       y = ' Dry Tissue Weight (g)') +
    ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..rr.label.., ")", sep ="")),
               formula = logy_logx_formula,
               eq.x.rhs = (" ln(x)"), 
               eq.with.lhs = ("ln(y) =="),
               parse = TRUE,
               label.x = "left",
               label.y = "top")
    
Oly_shell_logDTW

### Y ~ x + x^2

SH_newrange <- data.frame(length_mm = seq(from = 2, to = 52, by = 1))
pred_DTW2_SH_df <- data.frame(tissue_dry_weight_g = predict(Oly_DTW2_lm, newdata = SH_newrange), SH_newrange)

Oly_SH_DTW2_graph <- ggplot(NPD_oly_outRmd, aes(length_mm, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW2_SH_df, aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  ylim(0,0.3) +
  scale_color_manual(values = Species_colors, guide = F) +
  theme_classic() +
  scale_x_continuous(breaks = c(0,10,20,30,40,50))+
  annotate("text", x = 10, y = 0.2, label = "Y ~ x + x^2")+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

#OlySH_DTW_Trans_graphs <- grid.arrange(Oly_SH_logxDTW, Oly_shell_DTW_logline, 
                                       # Oly_shell_logDTW, Oly_SH_DTW2_graph, nrow = 2)

#plot(OlySH_DTW_Trans_graphs)

```




```{r EXTRA ANALYSIS CODE, eval=FALSE, include=FALSE}
\/ \/ \/ THIS IS ALL EXTRA EXPLORATORY ANALYSIS NOT USED BELOW THIS POINT \/ \/ \/
```


```{r Oly_DTW_SH_outlier_rmd, include=F, fig.keep = 'all', dev = 'pdf', warning=F, message=F, fig.align="center", out.width = "70%", fig.asp=0.618, fig.width=6, fig.cap="The relationship between \\textit{O. lurida} shell length and its dry tissue weight (DTW) at two locations, Newport Bay, California (Zacherl unpublished data) and Yaquina Bay, Oregon (Gray unpublished data). The Newport Bay data was collected at the Deanza restoration site and outlier data (outside mean +- 2.2 SD) and negative values are excluded. \\label{Oly_DTW_SH_outlier_rmd}"}

Site_Shapes <- c("Deanza" = 16,
                 "Yaquina" = 3)

######## Graph with Deanza and Yaquina DTW x Shell length
# Combine legend --> https://gist.github.com/mps9506/39b70aec30ab1322f7ecd6b21f04120e#file-testplot-r-L96
Oly_shell_DTW_NPD_Yaquina <- ggplot(Oly_combo_DTW_SL, aes(length_mm, tissue_dry_weight_g)) +
  geom_point(aes(color = legend, shape = legend)) +
  #geom_smooth(se = F, color = 'grey50') + # method=lm, formula = x_y_formula, level = 0.95, color = 'grey50') +
  scale_color_manual(labels = c("Yaquina Bay, OR", 
                                "Deanza, Newport Bay, CA"),
                     values = c("Yaquina" = "#9986A5",
                                "Deanza" = "#9986A5"),
                     na.translate = TRUE, drop = FALSE) + 
  scale_shape_manual(labels = c("Yaquina Bay, OR", 
                                "Deanza, Newport Bay, CA"),
                     values = c("Yaquina" = 3,
                                "Deanza" = 16),
                     na.translate = TRUE, drop = FALSE) + 
  theme_classic() +
  theme(legend.box.background = element_rect(colour = "black"),
        legend.justification = c(0, 1), 
        legend.position = c(0.1, 0.95),
        legend.title = element_blank()) +
  ylim(0,1)+
  labs(x = 'Shell Length (mm)',
       y = 'Dry Tissue Weight (g)') 
 # ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
  #             formula = x_y_formula,
   #            parse = TRUE,
    #           label.x = "right",
     #          label.y = "bottom") 
  #stat_quadrant_counts(quadrants = 0L, label.x = "left", 
   #                    aes(label = sprintf("%i observations", stat(count))))

plot(Oly_shell_DTW_NPD_Yaquina)
```
```{r Oly_TWW_DTW_outRmd, eval=FALSE, fig.align="default", fig.asp=0.618, fig.cap="The relationship between \\*O. lurida* total wet weight (TWW) and its dry tissue weight (DTW) in Newport Bay, fig.keep='all', fig.width=8, message=FALSE, warning=FALSE, California at the Deanza restoration site. Blue dashed lines represent the relationship found by Gray and Langdon (2018) in Yaquina Bay, Oregon Olympia oysters (DTW=0.0044*TWW - 0.043). \\label{Oly_TWW_DTW_outRmd}", dev='pdf', include=FALSE}

######### NPD Oly TWW DTW Graphs - Not using 

# Make sure only using positive TWW values, negative values indicate processing error
NPD_oly_TWW <- NPD_oly_outRmd %>% 
  filter(total_wet_weight_g > 0)
# Gray & Langdon 2017 TWW ~ DTW Olympia model to add to graph
Gray18_DTW_TWW_lm <- function(x) 0.0044*x - 0.043 
# Gray disertation 2016 - exponential 
Gray18_DTW_TWW_lm_loglog <- function(TWW) ((0.0044^(-0.043))*(TWW^(-0.043)))


# use DTW outlier data to plot graph
Oly_TWW_DTW_rm_out <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  xlim(0, 7) +
  scale_color_manual(values = Species_colors, guide=FALSE) +
  geom_function(fun = Gray18_DTW_TWW_lm, 
                colour = "blue", linetype = "dashed") + # plots function without data
  geom_function(fun = Gray18_DTW_TWW_lm_loglog, 
                colour = "red", linetype = "dashed") + # plots function without data
  theme_classic() +
  labs(x = 'Total wet weight (g)',
       y = 'Dry Tissue Weight (g)') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

### log(y) ~ x
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ total_wet_weight_g)
TWW_newrange <- data.frame(total_wet_weight_g = seq(from = 0, to = 7, by = 0.01))
pred_DTW_TWW_log_df <- data.frame(tissue_dry_weight_g = exp(predict(Oly_TWW_DTW_log_LM, newdata = TWW_newrange)),
                              TWW_newrange)

Oly_logTWW_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW_TWW_log_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
 # stat_function(fun = Gray18_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  ylim(0,0.3) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "log(y) ~ x") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')

### log(y) ~ log(x)
Oly_TWW_DTW_loglog_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
pred_DTW_TWW_loglog_df <- data.frame(tissue_dry_weight_g = exp(predict(Oly_TWW_DTW_loglog_LM, newdata = TWW_newrange)),
                              TWW_newrange)

Oly_loglogTWW_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW_TWW_loglog_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  #stat_function(fun = Gray18_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  ylim(0,0.3) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "log(y) ~ log(x)") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')

### y ~ x + x^2
Oly_TWW2_DTW_LM <- lm(data = NPD_oly_TWW, 
                        tissue_dry_weight_g ~ poly(total_wet_weight_g, degree = 2, raw = T))
pred_DTW2_TWW_log_df <- data.frame(tissue_dry_weight_g = predict(Oly_TWW2_DTW_LM, newdata = TWW_newrange),
                              TWW_newrange)

Oly_TWW2_DTW_graph <- ggplot(NPD_oly_TWW, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_line(data = pred_DTW2_TWW_log_df, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
 # stat_function(fun = Gray18_DTW_TWW_lm, colour = "blue", linetype="dashed") +
  xlim(0, 7) +
  ylim(0,0.3) +
  theme_classic() +
  annotate("text", x = 1, y = .25, label = "y ~ x + x^2") +
  labs(x ="Total wet weight (g)",
       y = 'Dry Tissue Weight (g)')
       
Oly_TWW_DTW_outRmd_graph <- grid.arrange(Oly_TWW_DTW_rm_out, Oly_logTWW_DTW_graph,
                                          Oly_loglogTWW_DTW_graph, Oly_TWW2_DTW_graph, nrow = 2)

#plot(Oly_TWW_DTW_outRmd_graph)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_lm_rm_out <- lm(data = NPD_oly_outRmd,
                         tissue_dry_weight_g ~ total_wet_weight_g)

ols_regress(Oly_TWW_DTW_lm_rm_out)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(Oly_TWW_DTW_lm_rm_out)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(Oly_TWW_DTW_lm_rm_out)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(Oly_TWW_DTW_lm_rm_out))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_log_LM <- lm(data = NPD_oly_TWW, log(tissue_dry_weight_g) ~ total_wet_weight_g)
ols_regress(Oly_TWW_DTW_log_LM )
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW_DTW_loglog_LM <- lm(data = NPD_oly_TWW, 
                         log(tissue_dry_weight_g) ~ log(total_wet_weight_g))
ols_regress(Oly_TWW_DTW_loglog_LM)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
Oly_TWW2_DTW_LM <- lm(data = NPD_oly_TWW, 
                        tissue_dry_weight_g ~ poly(total_wet_weight_g, degree = 2, raw = T))
ols_regress(Oly_TWW2_DTW_LM)
```

```{r NPD_Bivalve_SH_DTW_outrmd, fig.align="center", fig.asp=0.618, fig.cap="The biomass of bivalves excavated from Deanza in Newport Bay \\label{NPD_Bivalve_SH_DTW_outrmd}", fig.keep='all', fig.width=8.6, dev='pdf', include=FALSE, out.width="100%"}

#NPD_bivalve_outrmd_graph <- NPD_bivalve_outrmd %>% 
 # ggplot(aes(x = length_mm, y = tissue_dry_weight_g, group = species, color = species)) +
  #geom_point() +
#  scale_color_manual(values = Species_colors, guide = FALSE) +
 # facet_wrap(~species) +
  #labs(x = "Shell length (mm)",
#       y = "Dry Tissue Weight (g)",
 #      title = "NPD Bivalve Biomass - Pos DTW Outlier Rmd") +
#  theme_classic() +
 # theme(strip.text = element_text(face = "italic"))

# NPD_bi_Biomass_graphs <- grid.arrange(NPD_bivalve_biomass_graph, NPD_bivalve_outrmd_graph, nrow = 1)
#plot(NPD_bivalve_outrmd_graph)
```

```{r Correction_to_Signal_95CI_graph, eval=FALSE, fig.align='default', fig.asp=1, fig.cap="The relationship between side-by-side trial chlorophyll $\\alpha$ difference (correction) and filtration trial chlorophyll $\\alpha$ difference (signal). The solid black line is a 1-1 relationship", fig.keep='all', fig.show="hold", fig.width=4, message=FALSE, warning=FALSE, dev='pdf', include=FALSE, out.width="50%"}

##### Althea's Chl correction x Filtration diff Graph ###########
## Correction data & OG Chl values
#Sbs_correction_data 
sbs_corr_NoAbs <- Sbs_correction_data %>% 
  dplyr::select(File_Name, Sonde_Up, Sonde_Down, G_Avg_Chl, H_Avg_Chl, Correction_Factor) %>% 
  mutate(correction_noabs = ifelse(Sonde_Up == "G", G_Avg_Chl - H_Avg_Chl, H_Avg_Chl - G_Avg_Chl),
         sbs_chl_up = ifelse(Sonde_Up == "G", G_Avg_Chl, H_Avg_Chl),
         sbs_chl_down = ifelse(Sonde_Down == "G", G_Avg_Chl, H_Avg_Chl)) %>% 
  dplyr::select(-c(Sonde_Up, Sonde_Down))

sbs_correction_summary <- read_csv("output/6_Sbs_Corrections_Summary/sbs_correction_summary.csv")
filtration_summary <- read_csv("output/4_Filtration_Calculations/Filtration_Summary/filtration_summary.csv")

filter_diff_tpaired <- filtration_summary %>% 
  dplyr::select(File_Name, Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>% 
  rename(filter_chl_up = Chl_ug_L_Up,
         filter_chl_down = Chl_ug_L_Down)

Corr_chl_diff_data <- full_join(filter_diff_tpaired, sbs_corr_NoAbs, by = "File_Name")
# Missing data from MB_2019_6_5 and MB_2019_6_4 - filtration trial not long enough for water to travel from upstream to downstream - not included in other analyses either

Corr_chl_diff_data %<>%
  filter(!Site == "San Diego") %>% 
  mutate(chl_filter_up_uncorr = ifelse(sbs_chl_up > sbs_chl_down, 
                                       filter_chl_up + Correction_Factor, # reverse sbs correction 
                                       filter_chl_up - Correction_Factor),
         chl_filter_down_uncorr = ifelse(sbs_chl_down > sbs_chl_up, 
                                         filter_chl_down + Correction_Factor, 
                                         filter_chl_down - Correction_Factor),
         filter_chl_diff = chl_filter_up_uncorr - chl_filter_down_uncorr,
         graph_labels = ifelse( File_Name == "Insitu_Filter_NPSM_2019_5_22.csv" | 
                                  File_Name == "Insitu_Filter_NPSM_2019_6_9.csv", 
                               paste(Site, "\n", Date, "\n", Experiment), NA))

Corr_chl_diff_data$dummie = 1:27

# Explore if values are outliers (+-2.2 SD) based on correction:signal relationship 
Corr_chl_diff_data$singal_corr = Corr_chl_diff_data$correction_noabs / Corr_chl_diff_data$filter_chl_diff
Corr_chl_diff_data$outlier = find_outlier(Corr_chl_diff_data$singal_corr)

#Corr_chl_diff_data[c(9,19,21),] # Look at problem data points

### Confidence intervals
model.temp = lm(filter_chl_diff~correction_noabs,data=Corr_chl_diff_data)
x.seq = seq(-5,5,by=.005)
y.seq = predict(model.temp,newdata=data.frame(correction_noabs=x.seq),interval="prediction",level=.95)
#low.bound = y.seq[,2]
#high.bound = y.seq[,3]
#plot(Corr_chl_diff_data$correction_noabs,Corr_chl_diff_data$filter_chl_diff)
#lines(x.seq,low.bound,lty=2,col=2)
#lines(x.seq,high.bound,lty=2,col=2)

Corr_Chl_diff_graph <- ggplot(Corr_chl_diff_data, aes(correction_noabs, filter_chl_diff)) +
  geom_point() +
  theme_classic() + 
  xlim(-3,3) + # even axes
  ylim(-3,3) +
  xlab(expression("Side-by-side Chl" ~ alpha ~"Difference")) +
  ylab(expression("Experiment Chl" ~ alpha ~ "Difference")) +
  geom_abline(slope = 1) + # 1-1 reference line
  #annotate("text", x = -2.5, y = 2.75, label = "A") +
  geom_line(data = data.frame(y.seq), aes(x = fit, y = lwr), linetype = "dashed", color = "red") +
  geom_line(data = data.frame(y.seq), aes(x = fit, y = upr), linetype = "dashed", color = "red") +
  #geom_text(aes(x=correction_noabs + .12,label=dummie)) 
  #geom_text(hjust = "center", vjust= "top",aes(x=correction_noabs, label=graph_labels))
  #geom_label(aes(label = graph_labels))
  ggrepel::geom_label_repel(aes(label = graph_labels), point.padding = 0.9, na.rm = T,
                            nudge_y = c(-1.2,-0.75),
                            nudge_x = c(-0.5,0.75))
print(Corr_Chl_diff_graph)
#plot_grid(Corr_Chl_diff_graph, labels = c("A"))

### Remove two problem data points - remove their influence on confidence intervals
Corr_chl_diff_data1 = Corr_chl_diff_data[-c(21,19),]

Corr_chl_diff_data1 %<>%
  mutate(graph_labels = ifelse(File_Name == "Insitu_Filter_NPD_2019_4_17.csv",
                               paste(Site, "\n", Date, "\n", Experiment), NA))


model.temp1 = lm(filter_chl_diff~correction_noabs,data=Corr_chl_diff_data1)
x.seq1 = seq(-5,5,by=.005)
y.seq1 = predict(model.temp1,newdata=data.frame(correction_noabs=x.seq),interval="prediction",level=.98)
#low.bound1 = y.seq1[,2]
#high.bound1 = y.seq1[,3]
#plot(Corr_chl_diff_data1$correction_noabs,Corr_chl_diff_data1$filter_chl_diff)
#lines(x.seq1,low.bound1,lty=2,col=2)
#lines(x.seq1,high.bound1,lty=2,col=2)

Corr_Chl_diff_graph1 <- ggplot(Corr_chl_diff_data1, aes(correction_noabs, filter_chl_diff)) +
  geom_point() +
  theme_classic() + 
  xlim(-3,3) + # even axes
  ylim(-3,3) +
  xlab(expression("Side-by-side Chl" ~ alpha ~"Difference")) +
  ylab(expression("Experiment Chl" ~ alpha ~ "Difference (Velocity Paired)")) +
  geom_abline(slope = 1) + # 1-1 reference line
  geom_line(data = data.frame(y.seq1), aes(x = fit, y = lwr), linetype = "dashed", color = "red") +
  geom_line(data = data.frame(y.seq1), aes(x = fit, y = upr), linetype = "dashed", color = "red") +
  #geom_text(aes(x=correction_noabs + .12,label=dummie)) 
  #geom_text(hjust = "center", vjust= "top",aes(x=correction_noabs, label=graph_labels))
  #geom_label(aes(label = graph_labels))
  ggrepel::geom_label_repel(aes(label = graph_labels), point.padding = 0.9, na.rm = T,
                            nudge_y = c(-1),
                            nudge_x = c(0.4))
print(Corr_Chl_diff_graph1)
# plot_grid(Corr_Chl_diff_graph1, labels = c("B"))
```


```{r Bar_Graphs_up_vs_down,  include=FALSE}
Bar_up_down_data <- Master_analysis_table %>%
 # select(Experiment, Date, Site, Chl_ug_L_Up, Chl_ug_L_Down) %>%
  rename(Upstream = Chl_ug_L_Up, Downstream = Chl_ug_L_Down) %>%  
  gather(Upstream, Downstream, key = Position, value = Chl_ug_L) %>% 
  mutate(Position = fct_relevel(Position, 'Upstream', 'Downstream')) %>% 
  mutate(Site = fct_relevel(Site, 'Deanza', 'Shellmaker', 'San Rafael', 'Morro Bay')) %>% 
  mutate(Site_exp_date = paste(Site, Experiment, Date, sep = ' ')) %>% 
  mutate(Exp_Date = paste(Experiment, Date, sep = ' ')) %>% 
  arrange(Site, mdy(Date))

#Bar_up_down_data$Position <- as.factor(Bar_up_down_data$Position)

Paired_bar_chl_graph <- ggplot(data = Bar_up_down_data, aes(x = Site_exp_date, y = Chl_ug_L, fill = Position)) +
    geom_bar(stat="identity", position = "dodge") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    facet_grid(~ Site, scales = "free", space = "free") + #'free' allows axis b/w sites uneaven
    geom_bar(data = (Bar_up_down_data %>%
                       filter(!Experiment %in% c('Filtration'))),
             color = "grey22",
             stat="identity",
             position = "dodge") +
    labs(x = 'Experiment', y = 'Chlorophyll (ug/L)')

plot(Paired_bar_chl_graph)
```

```{r Bar_Graphs_up_vs_down_grid.arrange, fig.align="default", fig.asp=0.75, fig.keep='all', fig.width=8.6, dev='pdf', include=FALSE, out.width="100%"}
############## Try 2 ####### make separate graphs, combine using grid.arrange()

##### Can't figure out how to properly label x axis. Works with Exp_Date, but can't shorten without messing up data:label pairs. Can't spend more time on this right now. come back if time -AM 2020_3_3

NPD_bar_data <- Bar_up_down_data %>% 
  filter(Site == "Deanza") %>% 
  mutate(graph_Label = ifelse(grepl("^Filtration", Exp_Date), str_replace(Exp_Date, "Filtration ", ""),
                             str_replace(Exp_Date, "^Neg Control .", "")))

NPD_bar_graph <- ggplot(data = NPD_bar_data, aes(x = Exp_Date, y = Chl_ug_L, 
                                                 fill = Position)) +
    geom_col(position = position_dodge(width = 0.9, preserve = "single")) +
    geom_col(data = (NPD_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.x = element_blank(),
          legend.position = c(0.9, 0.8),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(y = 'Chlorophyll a (ug/L)', title = "Newport Deanza") +
  # This labels the x-axis
    #scale_x_discrete(labels = Exp_Date) +
    ylim(0, 8)

NPSM_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Shellmaker')

NPSM_bar_graph <- ggplot(data = NPSM_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (NPSM_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Newport Shellmaker") +
    # scale_x_discrete(labels = NPSM_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE) 

MB_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'Morro Bay')

MB_bar_graph <- ggplot(data = MB_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (MB_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "Morro Bay") +
   # scale_x_discrete(labels = MB_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

SR_bar_data <- Bar_up_down_data %>% 
  filter(Site == 'San Rafael')

SR_bar_graph <- ggplot(data = SR_bar_data,
                          aes(x = Exp_Date, y = Chl_ug_L, fill = Position)) +
    geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
    geom_col(data = (SR_bar_data %>% # add boarder around Neg Control experiments
                       filter(!Experiment %in% c('Filtration'))),
             color = "black",
             position = "dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          plot.title = element_text(hjust = 0.5)) + # center title
    labs(title = "San Rafael") +
    #scale_x_discrete(labels = SR_bar_data$Date) +
    ylim(0, 8) +
    guides(fill = FALSE)

Chl_graphs <- list(NPD_bar_graph, NPSM_bar_graph, SR_bar_graph, MB_bar_graph) 
all_chl_graphs <- grid.arrange(grobs = Chl_graphs,
             widths = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1),
             layout_matrix = rbind(c(NA,1,1,1,1,1,1,1,1,1,1,1,1, NA),
                                   c(2,2,2,2,2,3,3,3,3,3,4,4,4,4)))
#plot(all_chl_graphs)
#ggsave("Insitu_Filter_up_vs_down_all_sites.png", all_chl_graphs)
```


```{r FR_TPM_point, echo=FALSE, include=F, fig.keep = 'all', dev = 'pdf', fig.show="hold", fig.show = "hold", fig.align="center", fig.asp=0.618, fig.width=6, out.width="70%", warning = F, fig.cap="The habitat clearance rates and filtration trials in response to seston total particulate matter (TPM). Extreme values not included in the analysis are not shown. \\label{FR_ChlRmd_TPM_point}"}
### Doesn't make sense to include - doesn't align with Random Forest justificaiton - TPM x OC more interesting
############ All Filtration trials w/ outliers removed ##################

# Need to add relationship to graph
FR_TPM_graph <- ggplot(data = Filter_only_outRmd_data, aes(Avg_TPM_mg_L, L_hr_m2 )) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE)
  # line equation on graph
 # ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
  #             formula = x_y_formula,
   #            parse = TRUE,
     #          label.x = "right",
      #         label.y = "bottom")

plot(FR_TPM_graph)

########### Not Used - Positive Filtration trials only ########################
FRPos_TPM_graph <- ggplot(data = Filtration_pos_data, aes(Avg_TPM_mg_L, L_hr_m2 )) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE)
  # line equation on graph
 # ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
  #             formula = x_y_formula,
   #            parse = TRUE,
     #          label.x = "right",
      #         label.y = "bottom")

#plot(FRPos_TPM_graph)

############### Not USed- Chl Removed All Filtration Trials - outliers removed ########################
Chl_Rmd_TPM_graph <- ggplot(Filter_only_outRmd_data, aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  theme(legend.position = c(.85,.75),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) + 
  labs(x = TPM_Label,
       y = Prt_Chl_Label) 

### Not included Chl Removed graph - DZ meeting (2020/9/15)
# plot(Chl_Rmd_TPM_graph)

################ Not Used - Chl Removed Positive values only ################
Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  #geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  theme(legend.position = c(.85,.75),
        legend.title = element_blank(),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black")) + 
  labs(x = TPM_Label,
       y = Prt_Chl_Label) 

#plot(Chl_RmdPos_TPM_graph)

#grid.arrange(FRPos_TPM_graph, Chl_RmdPos_TPM_graph, nrow = 1)
```

```{r FR_TPM_models, eval=FALSE, include=FALSE}

######## Don't include - Doesn't make sense to include this relationship with HCR with Random Forest analysis justification
##### TPM x OC makes more sense

FR_TPM_LM <- lm(data = Filter_only_outRmd_data, L_hr_m2 ~ Avg_TPM_mg_L)
# Extract LaTeX formula
equatiomatic::extract_eq(FR_TPM_LM, use_coefs = T)


FR_TPM_graph_lm <- ggplot(Filter_only_outRmd_data, aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_smooth(method = lm, se = F, color = "gray50") +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'Y ~ X') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# log-log model predicitons
logFR_logTPM_lm <- lm(data = Filter_only_outRmd_data, log(L_hr_m2) ~ log(Avg_TPM_mg_L))
# create range of values to predict with model
TPM_newrange <- data.frame(Avg_TPM_mg_L = seq(from = 0, to = 80, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogTPM_Pred <- data.frame(pred_FR = exp(predict(logFR_logTPM_lm, newdata = TPM_newrange)))
pred_loglog_TPM_df <- data.frame(TPM_newrange, loglogTPM_Pred)
  

logFR_logTPM_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_loglog_TPM_df, aes(x = Avg_TPM_mg_L, y = pred_FR)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'log(Y) ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons
FR_logTPM_lm <- lm(data = Filter_only_outRmd_data, L_hr_m2 ~ log(Avg_TPM_mg_L))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_FR = predict(FR_logTPM_lm, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

# Testing function to extract lm model
# equatiomatic::extract_eq(FR_logTPM_lm, use_coefs = T)

FR_logTPM_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM_mg_L, y = pred_FR)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'Y ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons --> producing complex numbers OR NaNs - Won't graph
logFR_TPM_lm <- lm(data = Filter_only_outRmd_data, log(L_hr_m2) ~ Avg_TPM_mg_L)
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logFR_Pred <- data.frame(pred_FR = exp(predict(logFR_TPM_lm, newdata = TPM_newrange)))
pred_logFR_df <- data.frame(TPM_newrange, logFR_Pred)

logFR_TPM_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_logFR_df, aes(x = Avg_TPM_mg_L, y = logFR_Pred)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'log(Y) ~ X') +
  guides(fill = FALSE)


# Y~x + x^2 model predicitons
FR_TPM2_lm <- lm(data = Filter_only_outRmd_data, L_hr_m2 ~ poly(Avg_TPM_mg_L, degree = 2, raw = T))
TPM2_Pred <- data.frame(FR_pred = predict(FR_TPM2_lm, newdata = TPM_newrange))
pred_TPM2_df <- data.frame(TPM_newrange, TPM2_Pred)

FR_TPM2_graph <- ggplot((Filter_only_outRmd_data), aes(Avg_TPM_mg_L, L_hr_m2)) +
  geom_line(data = pred_TPM2_df, aes(x = Avg_TPM_mg_L, y = FR_pred)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label,
       title = '',
       subtitle = 'Y ~ x + x^2') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x2_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(FR_TPM_graph_lm , logFR_logTPM_graph, FR_logTPM_graph, FR_TPM2_graph, nrow = 2)

summary(FR_TPM_LM)
summary(logFR_logTPM_lm)
summary(FR_logTPM_lm)
summary(FR_TPM2_lm)


```

```{r ChlRmdpos_TPM_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_TPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_TPM_mg_L)
#summary(ChlRmdPos_TPM_lm)
ols_regress(ChlRmdPos_TPM_lm)
# Not significant
```

```{r ChlRmdpos_TPM_LM_diagnostics, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_TPM_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_TPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_TPM_lm)
```

```{r ChlRmd_TPM_Transform, eval=FALSE, fig.width=12, include=FALSE}
Chl_RmdPos_TPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# log-log model predicitons
logChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_TPM_mg_L))
# create range of Salinity values to predict with model
TPM_newrange <- data.frame(Avg_TPM_mg_L = seq(from = 0, to = 0.04, by = 0.001))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogTPM_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logTPM_lm, newdata = TPM_newrange)))
pred_loglog_TPM_df <- data.frame(TPM_newrange, loglogTPM_Pred)
  

logChlRmdPos_logTPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglog_TPM_df, aes(x = Avg_TPM_mg_L, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'log(Y) ~ log(X)') +
  guides(fill = FALSE)

# Y-log model predicitons
ChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_TPM_mg_L))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
logTPM_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logTPM_lm, newdata = TPM_newrange))
pred_logTPM_df <- data.frame(TPM_newrange, logTPM_Pred)

ChlRmdPos_logTPM_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logTPM_df, aes(x = Avg_TPM_mg_L, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'Y ~ log(X)') +
  guides(fill = FALSE)

# Y~x + x^2 model predicitons
ChlRmdPos_TPM2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Avg_TPM_mg_L, degree = 2, raw = T))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
TPM2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_TPM2_lm, newdata = TPM_newrange))
pred_TPM2_df <- data.frame(TPM_newrange, TPM2_Pred)

ChlRmdPos_TPM2_graph <- ggplot((Filtration_pos_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_line(data = pred_TPM2_df, aes(x = Avg_TPM_mg_L, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'Y ~ x + x^2') +
  guides(fill = FALSE) +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x2_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(Chl_RmdPos_TPM_graph, logChlRmdPos_logTPM_graph, 
             ChlRmdPos_logTPM_graph, ChlRmdPos_TPM2_graph, nrow = 2)
```

```{r logChlRmdPos_logTPM_lm, eval=FALSE,  include=FALSE}
logChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_TPM_mg_L))
#summary(ChlRmdPos_TPM_lm)
ols_regress(logChlRmdPos_logTPM_lm)
```

```{r logChlRmdPos_logTPM_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(logChlRmdPos_logTPM_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logTPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logTPM_lm)
```

```{r ChlRmdPos_logTPM_lm, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logTPM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_TPM_mg_L))
#summary(ChlRmdPos_logTPM_lm)
ols_regress(ChlRmdPos_logTPM_lm)
```

```{r ChlRmdPos_TPM2_lm, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_TPM2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Avg_TPM_mg_L, degree = 2, raw = T))
#summary(ChlRmdPos_TPM_lm)
ols_regress(ChlRmdPos_TPM2_lm)
```

```{r ChlRmdPos_TPM2_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_TPM2_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logTPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logTPM_lm)
```

```{r NPD_FRPos_TPM_graph, echo=FALSE, eval=F}
NPD_FRPos_TPM_graph <- ggplot((Deanza_PosFilter_data), aes(Avg_TPM_mg_L, L_hr_m2 )) +
  geom_smooth(method = lm, se = F, color = 'grey50') + #se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Hab_FR_Label) +
  guides(color = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(NPD_FRPos_TPM_graph)

NPD_ChlRmdPos_TPM_graph <- ggplot((Deanza_PosFilter_data), aes(Avg_TPM_mg_L, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = F, color = 'grey50') + # se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  # geom_abline(aes(intercept=0, slope=1)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label) +
  guides(color = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(NPD_ChlRmdPos_TPM_graph)
#grid.arrange(NPD_FRPos_TPM_graph, NPD_ChlRmdPos_TPM_graph, nrow = 1)
```

```{r NPD_FRpos_TPM_LM, eval=FALSE, cache=T, include=FALSE}
NPD_PosFR_TPM_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_TPM_mg_L)
ols_regress(NPD_PosFR_TPM_lm)
```

```{r NPD_ChlRmdPos_TPM_LM, eval=FALSE, cache=T, include=FALSE}
NPD_PosChlRmd_TPM_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_TPM_mg_L)
ols_regress(NPD_PosChlRmd_TPM_lm)
```

```{r NPD_PosChlRmd_TPM_lm_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_PosChlRmd_TPM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_PosChlRmd_TPM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_PosChlRmd_TPM_lm)
```

```{r FRPos_Chlpos_PIM, eval=FALSE, include=FALSE}
FRPos_PIM_graph <- ggplot(Filtration_pos_data, aes(Avg_PIM, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = PIM_Label,
       y = Hab_FR_Label,
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FRPos_PIM_graph)

Chl_RmdPos_PIM_graph <- ggplot(Filtration_pos_data, aes(Avg_PIM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = PIM_Label,
       y = Prt_Chl_Label,
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(FRPos_PIM_graph)
#grid.arrange(FRPos_PIM_graph, Chl_RmdPos_PIM_graph, nrow = 1)
```

```{r FRPos_PIM_LM, eval=FALSE,  include=FALSE}
FRPos_PIM_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_PIM)
ols_regress(FRPos_PIM_lm)
```

```{r ChlRmdPos_PIM_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_PIM_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_PIM)
ols_regress(ChlRmdPos_PIM_lm)
```

```{r ChlRmdPos_PIM_LM_Diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_PIM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_PIM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_PIM_lm)
```

```{r Deanza_Filter_Pos_PIM, eval=FALSE,  include=FALSE}
NPD_FRPos_PIM_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_PIM, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = PIM_Label,
       y = Hab_FR_Label,
       title = 'Deanza Positive Filtration') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_PIM_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_PIM, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = PIM_Label,
       y = Prt_Chl_Label,
       title = 'Deanza Positive Filtration') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(NPD_FRPos_PIM_graph, NPD_ChlRmdPos_PIM_graph, nrow = 1)
```

```{r NPD_FRpos_PIM_LM, eval=FALSE,  include=FALSE}
NPD_FRpos_PIM_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_PIM)
ols_regress(NPD_FRpos_PIM_lm)
```

```{r NPD_ChlRmdpos_PIM_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdpos_PIM_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_PIM)
ols_regress(NPD_ChlRmdpos_PIM_lm)
```

```{r NPD_ChlRmdpos_PIM_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_ChlRmdpos_PIM_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_ChlRmdpos_PIM_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_ChlRmdpos_PIM_lm)
```

```{r FRPos_OC, eval=FALSE,   include=FALSE}
FRPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_RmdPos_OC_graph <- ggplot(Filtration_pos_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'All Filtration Trials') +
  guides(fill = FALSE) +
  # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
grid.arrange(FRPos_OC_graph, Chl_RmdPos_OC_graph, nrow = 1)
```

```{r FRPos_OC_LM, eval=FALSE,  include=FALSE}
FRPos_OC_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Avg_OC_Ratio)
ols_regress(FRPos_OC_lm)
```

```{r ChlrRmdPos_OC_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
ols_regress(ChlRmdPos_OC_lm)
```

```{r ChlRmdPos_OC_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_OC_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_OC_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_OC_lm)
```

```{r ChlRmdPos_OC_LM_Trans, eval=FALSE,  include=FALSE}
logChl_RmdPos_logOC_graph <- ggplot(Filtration_pos_data, 
                                    aes(log(Avg_OC_Ratio), log(pcnt_Chl_rmvd))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = expression(paste(log[n],' Organic Content of Seston (fraction)')),
       y = expression(paste(log[n], " Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Filtration Trials') +
  guides(fill = FALSE)

# log-log model predicitons
logChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
OC_newrange <- data.frame(Avg_OC_Ratio = seq(from = 0.6, to = 1, by = 0.025))
loglogOC_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logOC_lm, newdata = OC_newrange)))
pred_loglogOC_df <- data.frame(OC_newrange, loglogOC_Pred)

ChlRmdPos_loglogOC_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogOC_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'log(y) ~ log(x)') +
  guides(fill = FALSE)

# Y-log model predicitons
ChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
logOC_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logOC_lm, newdata = OC_newrange))
pred_logOC_df <- data.frame(OC_newrange, logOC_Pred)

ChlRmdPos_logOC_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logOC_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'y ~ log(x)') +
  guides(fill = FALSE)

# Y-x + x^2 model predicitons
ChlRmdPos_OC2_lm <- lm(data = Filtration_pos_data, 
                         pcnt_Chl_rmvd ~ poly(Avg_OC_Ratio, degree = 2, raw = T))
OC2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_OC2_lm, newdata = OC_newrange))
pred_OC2_df <- data.frame(OC_newrange, OC2_Pred)

ChlRmdPos_OC2_graph <- ggplot((Filtration_pos_data), aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_line(data = pred_OC2_df, aes(x = Avg_OC_Ratio, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +
  theme_classic() +
  labs(x = TPM_Label,
       y = Prt_Chl_Label,
       title = 'Pos Filtration Trials',
       subtitle = 'y ~ x + x^2') +
  guides(fill = FALSE)

grid.arrange(logChl_RmdPos_logOC_graph, ChlRmdPos_loglogOC_graph,
             ChlRmdPos_logOC_graph, ChlRmdPos_OC2_graph, nrow = 2)

```

```{r ChlRmdPos_Loglog_LM, eval=FALSE,  include=FALSE}
logChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
ols_regress(logChlRmdPos_logOC_lm)
```

```{r ChlRmdPos_OC_logLM, eval=FALSE,  include=FALSE}
ChlRmdPos_logOC_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
ols_regress(ChlRmdPos_logOC_lm)
```

```{r ChlrRmdPos_OC_PolyLM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC2_lm <- lm(data = Filtration_pos_data, 
                       pcnt_Chl_rmvd ~ poly(Avg_OC_Ratio, degree = 2, raw = T))
ols_regress(ChlRmdPos_OC2_lm)
```

```{r Deanza_Filter_Pos_OC_graph, eval=FALSE,  include=FALSE}
FRPos_OC_NPD_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_OC_Ratio, L_hr_m2)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Hab_FR_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plor(FRPos_OC_NPD_graph)

Chl_RmdPos_OC_NPD_graph <- ggplot(Deanza_PosFilter_data, aes(Avg_OC_Ratio, pcnt_Chl_rmvd)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point() +
  #scale_color_manual(values = Site_colors, guide=FALSE) +  
  theme_classic() +
  labs(x = 'Organic Content of Seston (fraction)',
       y = Prt_Chl_Label,
       title = 'Newport Deanza Positive Filtration Trials (Linear Model)') +
  guides(fill = FALSE) +
    # line equation on graph
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")
plot(Chl_RmdPos_OC_NPD_graph)
#grid.arrange(FRPos_OC_NPD_graph, Chl_RmdPos_OC_NPD_graph, nrow = 1)
```

```{r NPD_FRpos_OC_LM, eval=FALSE,  include=FALSE}
FRPos_OC_NPD_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Avg_OC_Ratio)
ols_regress(FRPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_LM, eval=FALSE,  include=FALSE}
ChlRmdPos_OC_NPD_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Avg_OC_Ratio)
ols_regress(ChlRmdPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_LM_diag, eval=FALSE,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_OC_NPD_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_OC_NPD_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_OC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_logLM, eval=FALSE,  include=FALSE}
ChlRmdPos_logOC_NPD_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Avg_OC_Ratio))
ols_regress(ChlRmdPos_logOC_NPD_lm)
```

```{r ANOVA_ChlRmdPos_OC_NPD_LM, eval=FALSE, include=FALSE}
anova(ChlRmdPos_OC_NPD_lm, ChlRmdPos_logOC_NPD_lm)
```

```{r NPD_ChlRmdpos_OC_loglogLM, eval=FALSE,  include=FALSE}
logChlRmdPos_logOC_NPD_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Avg_OC_Ratio))
ols_regress(logChlRmdPos_logOC_NPD_lm)
```


```{r SR_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_SR <- Avg_TPM_summary_table %>% filter(Site == "San Rafael")

OC_TPM_SR_LM <- lm(data = TPM_SR, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_SR_LM)
```

```{r MB_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_MB <- Avg_TPM_summary_table %>% filter(Site == "Morro Bay")

OC_TPM_MB_LM <- lm(data = TPM_MB, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_MB_LM)
```

```{r NPSM_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPSM <- Avg_TPM_summary_table %>% filter(Site == "Shellmaker")

OC_TPM_NPSM_LM <- lm(data = TPM_NPSM, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_NPSM_LM)
```

```{r NPD_TPM_OC_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_TPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ Avg_TPM_mg_L)
ols_regress(OC_TPM_NPD_LM)
```

```{r NPD_TPM_OC_LMlog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

OC_logTPM_NPD_LM <- lm(data = TPM_NPD, Avg_OC_Ratio ~ log(Avg_TPM_mg_L))
ols_regress(OC_logTPM_NPD_LM)
```

```{r NPD_TPM_OC_LMloglog, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
TPM_NPD <- Avg_TPM_summary_table %>% filter(Site == "Deanza")

logOC_logTPM_NPD_LM <- lm(data = TPM_NPD, log(Avg_OC_Ratio) ~ log(Avg_TPM_mg_L))
ols_regress(logOC_logTPM_NPD_LM)
```

```{r Filter_Temp, eval=FALSE, fig.height=5, fig.width=14,  include=FALSE}

FR_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Temp <- ggplot(Filtration_pos_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Positive ChlRmd') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_pos_Temp, Chl_Rmd_pos_Temp, nrow = 1)
```

```{r FRpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(FRPos_temp_lm)
```

```{r ChlRmdpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_temp_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(ChlRmdPos_temp_lm)
```

```{r ChlRmdpos_Temp_diag, eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_temp_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_temp_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_temp_lm))
```

```{r NPD_Filter_Temp, eval=FALSE, fig.height=10, fig.width=12,  include=FALSE}

NPD_Chl_RmdPos_Temp <- ggplot(Deanza_PosFilter_data, aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'Deanza Positive Filter Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Predict Y ~ log(x) model
NPD_ChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Temp_C_Up))
Temp_newrange <- data.frame(Temp_C_Up = seq(from = 18, to = 21, by = 0.25))
Templog_Pred <- data.frame(pred_ChlRmd = predict(NPD_ChlRmdPos_logtemp_lm, newdata = Temp_newrange))
pred_Templog_df <- data.frame(Temp_newrange, Templog_Pred)

NPD_ChlRmdPos_logTemp_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Templog_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'y ~ log(x)') +
  guides(fill = FALSE)

# Predict log(Y) ~ log(x) model
NPD_logChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Temp_C_Up))
Temploglog_Pred <- data.frame(pred_ChlRmd = exp(predict(NPD_logChlRmdPos_logtemp_lm, newdata = Temp_newrange)))
pred_Temploglog_df <- data.frame(Temp_newrange, Temploglog_Pred)

NPD_ChlRmdPos_loglogTemp_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Temploglog_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'log(y) ~ log(x)') +
  guides(fill = FALSE)

# Predict Y ~ x + x^2 model
NPD_ChlRmdPos_temp2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Temp_C_Up, degree = 2, raw = T))
Temp2_Pred <- data.frame(pred_ChlRmd = predict(NPD_ChlRmdPos_temp2_lm, newdata = Temp_newrange))
pred_Temp2_df <- data.frame(Temp_newrange, Temp2_Pred)

NPD_ChlRmdPos_Temp2_graph <- ggplot((Deanza_PosFilter_data), aes(Temp_C_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Temp2_df, aes(x = Temp_C_Up, y = pred_ChlRmd)) +
  geom_point() +
  theme_classic() +
  labs(x = 'Temperature Upstream (C)',
       y = Prt_Chl_Label,
       title = 'NPD Pos Filtration Trials',
       subtitle = 'y ~ x + x^2') +
  guides(fill = FALSE)

grid.arrange(NPD_Chl_RmdPos_Temp, NPD_ChlRmdPos_logTemp_graph,
             NPD_ChlRmdPos_loglogTemp_graph, NPD_ChlRmdPos_Temp2_graph, nrow = 2)
```

```{r NPD_ChlRmdpos_Temp_LM, eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_temp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Temp_C_Up)
ols_regress(NPD_ChlRmdPos_temp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Temp_C_Up))
ols_regress(NPD_ChlRmdPos_logtemp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_logChlRmdPos_logtemp_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Temp_C_Up))
ols_regress(NPD_logChlRmdPos_logtemp_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_temp2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Temp_C_Up, degree = 2, raw = T))
ols_regress(NPD_ChlRmdPos_temp2_lm)
```

```{r Filter_Salinity, eval=FALSE, fig.height=5, fig.width=14,  include=FALSE}

FR_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'Positive FR only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Sal <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(FR_pos_Sal, Chl_Rmd_pos_Sal, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Sal_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Sal_ppt_Up)
ols_regress(FRPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
ols_regress(ChlRmdPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_Sal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_Sal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_Sal_lm))
```

```{r LogChlRmdPos_LogSalinity_graph, eval=FALSE, fig.height=12, fig.width=12,  include=FALSE}
### Graph with log-log axes
logChlRmd_pos_logSal_graph <- ggplot(Filtration_pos_data, aes(log(Sal_ppt_Up), log(pcnt_Chl_rmvd))) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = expression('log'[n]*' Salinity Upstream (ppt)'),
       y = expression(paste(log[n], " Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only') +
  stat_poly_eq(formula = x_y_formula, parse = TRUE)

# log-log model
logChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Sal_ppt_Up))
# create range of Salinity values to predict with model
Sal_newrange <- data.frame(Sal_ppt_Up = seq(from = 29, to = 38, by = 0.5))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogSal_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logSal_lm, newdata = Sal_newrange)))
pred_loglog_Sal_df <- data.frame(Sal_newrange, loglogSal_Pred)

# model coefficents 
#coef(logChlRmdPos_logSal_lm)

## Graph with regualar x & y axes, log-log model
logChlRmd_pos_logSal_graph2 <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglog_Sal_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "Log(y) ~ Log(x) pretty sure correct line")

# log X transformed model
ChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Sal_ppt_Up))
pred_ChlRmdPos_logSal_df <- data.frame(Sal_newrange,
                                       pred_ChlRmd = predict(ChlRmdPos_logSal_lm, 
                                                             newdata = Sal_newrange))

ChlRmd_pos_logSal_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_logSal_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~ log(x)")

# Polynomial ^2 transformation
ChlRmdPos_Sal2_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 2, raw = T))
# predict values with model and new Sal range values
Sal2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Sal2_lm, newdata = Sal_newrange))
pred_ChlRmdPos_Sal2_df2 <- data.frame(Sal_newrange, Sal2_Pred)

ChlRmd_pos_Sal2_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_Sal2_df2, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~  x + x^2")

# Polynomial ^3 transformation
ChlRmdPos_Sal3_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 3, raw = T))
pred_ChlRmdPos_Sal3_df <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Sal3_lm, newdata = Sal_newrange),
                                       Sal_newrange)

ChlRmd_pos_Sal3_graph <- ggplot(Filtration_pos_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_ChlRmdPos_Sal3_df, aes(x = Sal_ppt_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = expression(paste(" Percent Chlorophyll ", alpha, " Removed")),
       title = 'Positive Chl Removed Only',
       subtitle = "y ~  x + x^3")

grid.arrange(logChlRmd_pos_logSal_graph, logChlRmd_pos_logSal_graph2, 
             ChlRmd_pos_logSal_graph, ChlRmd_pos_Sal2_graph, ChlRmd_pos_Sal3_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Sal_ppt_Up))
ols_regress(logChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(logChlRmdPos_logSal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(logChlRmdPos_logSal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(logChlRmdPos_logSal_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logSal_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Sal_ppt_Up))
ols_regress(ChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_logSal_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_logSal_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_logSal_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
anova(ChlRmdPos_Sal_lm, ChlRmdPos_logSal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal2_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Sal2_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Sal3_lm <- lm(data = Filtration_pos_data, 
                        pcnt_Chl_rmvd ~ poly(Sal_ppt_Up, degree = 3, raw = T))
ols_regress(ChlRmdPos_Sal2_lm)
```

```{r NPD_Filter_Salinity, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}
NPD_FRPos_Salinity <- ggplot(Deanza_PosFilter_data, aes(Sal_ppt_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Hab_FR_Label,
       title = 'NPD Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Salinity <- ggplot(Deanza_PosFilter_data, aes(Sal_ppt_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Salinity Upstream (ppt)',
       y = Prt_Chl_Label,
       title = 'NPD Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(NPD_FRPos_Salinity, NPD_ChlRmdPos_Salinity, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Sal_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Sal_ppt_Up)
ols_regress(NPD_FRPos_Sal_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Sal_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Sal_ppt_Up)
ols_regress(NPD_ChlRmdPos_Sal_lm)
```

```{r Filter_Chl, eval=FALSE, fig.height=15, fig.width=14,  include=FALSE}

FR_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Chl <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Y-log model
ChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
# create range of Salinity values to predict with model
Chl_newrange <- data.frame(Chl_ug_L_Up = seq(from = 0, to = 8, by = 0.5))
logChl_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logChl_lm, newdata = Chl_newrange))
pred_logChl_df <- data.frame(Chl_newrange, logChl_Pred)

ChlRmdpos_Chllog_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logChl_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ log(x)')

# log-log model
ChlRmdPos_loglogChl_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
# predict alone gives log(y) values, exponentiate y to get regular values with exp()
loglogChl_Pred <- data.frame(pred_ChlRmd = exp(predict(ChlRmdPos_loglogChl_lm, newdata = Chl_newrange)))
pred_loglogChl_df <- data.frame(Chl_newrange, loglogChl_Pred)

ChlRmdpos_Chlloglog_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogChl_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'log(y) ~ log(x)')

# Y-x + x^2 model
ChlRmdPos_Chl2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
Chl2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Chl2_lm, newdata = Chl_newrange))
pred_Chl2_df <- data.frame(Chl_newrange, Chl2_Pred)

ChlRmdpos_Chl2_graph <- ggplot(Filtration_pos_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Chl2_df, aes(x = Chl_ug_L_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) +  
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ x + x^2')

grid.arrange(FR_pos_Chl, Chl_Rmd_pos_Chl, 
             ChlRmdpos_Chllog_graph, ChlRmdpos_Chlloglog_graph, 
             ChlRmdpos_Chl2_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Chl_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Chl_ug_L_Up)
ols_regress(FRPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Chl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
ols_regress(ChlRmdPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(ChlRmdPos_Chl_lm)

# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(ChlRmdPos_Chl_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(ChlRmdPos_Chl_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
ols_regress(ChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logChl_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
ols_regress(logChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Chl2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Chl2_lm)
```

```{r NPD_Filter_Chl, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}

NPD_FRPos_Chl <- ggplot(Deanza_PosFilter_data, aes(Chl_ug_L_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Hab_FR_Label,
       title = "NPD Positive Filtration") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Chl <- ggplot(Deanza_Filter_data, aes(Chl_ug_L_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Chlorophyll Upstream (ug/L)',
       y = Prt_Chl_Label,
       title = "NPD Positive Filtration") +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

grid.arrange(NPD_FRPos_Chl, NPD_ChlRmdPos_Chl, nrow = 1)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Chl_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Chl_ug_L_Up)
ols_regress(NPD_FRPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Chl_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Chl_ug_L_Up)
ols_regress(NPD_ChlRmdPos_Chl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=8,  include=FALSE}
par(mfrow=c(2,2))
plot(NPD_ChlRmdPos_Chl_lm)
# Leverage Statistics - plots index of parameter elements against their leverage on the model
# plot(hatvalues(NPD_ChlRmdPos_Chl_lm)) 
# identifies the index of the largest element of a vector
# which.max(hatvalues(NPD_ChlRmdPos_Chl_lm))
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_logChl_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ log(Chl_ug_L_Up))
ols_regress(NPD_ChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logChl_lm <- lm(data = Deanza_PosFilter_data, log(pcnt_Chl_rmvd) ~ log(Chl_ug_L_Up))
ols_regress(logChlRmdPos_logChl_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Chl2_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ poly(Chl_ug_L_Up, degree = 2, raw = T))
ols_regress(NPD_ChlRmdPos_Chl2_lm)
```

```{r Filter_Turbidity, eval=FALSE, fig.height=15, fig.width=14,  include=FALSE}

FR_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Positive FR Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

Chl_Rmd_pos_Turb <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

# Y-log model
ChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Turbidity_NTU_Up))
Turb_newrange <- data.frame(Turbidity_NTU_Up = seq(from = 2, to = 31, by = 1))
logTurb_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_logTurb_lm, newdata = Turb_newrange))
pred_logTurb_df <- data.frame(Turb_newrange, logTurb_Pred)

ChlRmdpos_Turblog_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_logTurb_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'y ~ log(x)')

#log-log model
logChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Turbidity_NTU_Up))
loglogTurb_Pred <- data.frame(pred_ChlRmd = exp(predict(logChlRmdPos_logTurb_lm, newdata = Turb_newrange)))
pred_loglogTurb_df <- data.frame(Turb_newrange, loglogTurb_Pred)

ChlRmdpos_Turbloglog_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_loglogTurb_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'log(y) ~ log(x)')

# Y ~ x + x^2 model
ChlRmdPos_Turb2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Turbidity_NTU_Up, degree = 2, raw = T))
Turb2_Pred <- data.frame(pred_ChlRmd = predict(ChlRmdPos_Turb2_lm, newdata = Turb_newrange))
pred_Turb2_df <- data.frame(Turb_newrange, Turb2_Pred )

ChlRmdpos_Turb2_graph <- ggplot(Filtration_pos_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_line(data = pred_Turb2_df, aes(x = Turbidity_NTU_Up, y = pred_ChlRmd)) +
  geom_point(aes(color = Site)) +
  scale_color_manual(values = Site_colors) + 
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Positive Chl Removed Only',
       subtitle = 'Y ~ x + x^2') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

grid.arrange(FR_pos_Turb, Chl_Rmd_pos_Turb,
             ChlRmdpos_Turblog_graph, ChlRmdpos_Turbloglog_graph,
             ChlRmdpos_Turb2_graph, nrow = 3)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
FRPos_Turb_lm <- lm(data = Filtration_pos_data, L_hr_m2 ~ Turbidity_NTU_Up)
ols_regress(FRPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Turb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
ols_regress(ChlRmdPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ log(Turbidity_NTU_Up))
ols_regress(ChlRmdPos_logTurb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
logChlRmdPos_logTurb_lm <- lm(data = Filtration_pos_data, log(pcnt_Chl_rmvd) ~ log(Turbidity_NTU_Up))
ols_regress(logChlRmdPos_logTurb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
ChlRmdPos_Turb2_lm <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ poly(Turbidity_NTU_Up, degree = 2, raw = T))
ols_regress(ChlRmdPos_Turb2_lm)
```

```{r NPD_Filter_Turbidity, eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}

NPD_FRPos_Turb <- ggplot(Deanza_PosFilter_data, aes(Turbidity_NTU_Up, L_hr_m2)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Hab_FR_Label,
       title = 'Deanza - Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")

NPD_ChlRmdPos_Turb <- ggplot(Deanza_PosFilter_data, aes(Turbidity_NTU_Up, pcnt_Chl_rmvd)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point() +
  theme_classic() +
  labs(x = 'Turbidity Upstream (NTU)',
       y = Prt_Chl_Label,
       title = 'Deanza - Positive Filtration Trials') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "bottom")



grid.arrange(NPD_FRPos_Turb, NPD_ChlRmdPos_Turb, nrow = 1)

```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_FRPos_Turb_lm <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~ Turbidity_NTU_Up)
ols_regress(NPD_FRPos_Turb_lm)
```

```{r eval=FALSE, fig.height=6, fig.width=6,  include=FALSE}
NPD_ChlRmdPos_Turb_lm <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~ Turbidity_NTU_Up)
ols_regress(NPD_ChlRmdPos_Turb_lm)
```

```{r NPD_Bivalve_SH_DTW, eval=FALSE, include=FALSE}
## Graph Newport Deanza biomass by shell length
NPD_bivalve_biomass_graph <-  NPD_bivalve_data_clean %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g, color = species)) +
  geom_point() +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  facet_wrap(~species) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = "NPD Bivalve Biomass - Raw data") +
  theme_classic() +
  theme(strip.text = element_text(face = "italic"))

plot(NPD_bivalve_biomass_graph)
```

```{r Oly_TWW_DTW, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}
Oly_TWW_DTW<- ggplot(NPD_oly, aes(total_wet_weight_g, tissue_dry_weight_g)) +
  geom_smooth(method=lm, se=TRUE, level=0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide=FALSE) + 
  theme_classic() +
  labs(x = 'Total Wet Weight (g)',
       y = 'Dry Tissue Weight (g)',
       title = 'Olympia Oyster DTW x TWW - Newport, CA') +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "right",
               label.y = "top")

plot(Oly_TWW_DTW)
```



```{r fig.height=5, fig.width=12,  include=FALSE}
NPD_Adula <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Adula diegensis"))

NPD_Adula_Posbiomass_graph <- NPD_Adula %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Adula diegensis")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

# Predict new values with 

NPD_Adula_Posbiomass_loggraph <- NPD_Adula %>% 
  ggplot(aes(x = log(length_mm), y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Ln Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Adula diegensis")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Adula_Posbiomass_graph, NPD_Adula_Posbiomass_loggraph, nrow = 1)
```

```{r fig.height=5, fig.width=12,  include=FALSE}
NPD_Musculista <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Musculista senhousia"))

NPD_Musculista_Posbiomass_graph <- NPD_Musculista %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Musculista senhousia")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Musculista_Posbiomass_loggraph <- NPD_Musculista %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Musculista senhousia")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Musculista_Posbiomass_graph, NPD_Musculista_Posbiomass_loggraph, nrow=1)
```

```{r fig.height=5, fig.width=12,  include=FALSE}

NPD_Mytilus <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Mytilus galloprovincialis"))

NPD_Mytilus_Posbiomass_graph <- NPD_Mytilus %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Mytilus galloprovincialis")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Mytilus_Posbiomass_loggraph <- NPD_Mytilus %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Mytilus galloprovincialis")," - Positive Ln DTW only"))) +
  theme_classic() +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Mytilus_Posbiomass_graph, NPD_Mytilus_Posbiomass_loggraph, nrow = 1)
```

```{r eval=FALSE, fig.height=5, fig.width=12,  include=FALSE}
NPD_Unknown <- NPD_bivalve_outrmd %>% 
  filter(species %in% c("Unknown mussel"))

NPD_Unknown_Posbiomass_graph <- NPD_Unknown %>% 
  ggplot(aes(x = length_mm, y = tissue_dry_weight_g)) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Unknown mussel")," - Positive DTW only"))) +
  theme_classic() +
  ggpmisc::stat_poly_eq(aes(label = paste("atop(",..eq.label.., ",",..adj.rr.label.., ")", sep ="")),
               formula = x_y_formula,
               parse = TRUE,
               label.x = "left",
               label.y = "top")

NPD_Unknown_Posbiomass_loggraph <- NPD_Unknown %>% 
  ggplot(aes(x = length_mm, y = log(tissue_dry_weight_g))) +
  geom_smooth(method = lm, se = T, level = 0.95, color = 'grey50') +
  geom_point(aes(color = species)) +
  scale_color_manual(values = Species_colors, guide = FALSE) +
  labs(x = "Shell length (mm)",
       y = "Ln Dry Tissue Weight (g)",
       title = expression(paste("NPD ", italic("Unknown mussel")," - Positive Ln DTW only"))) +
  theme_classic()  +
  stat_poly_eq(aes(label = stat(adj.rr.label)), formula = x_y_formula, 
               parse = TRUE)

grid.arrange(NPD_Unknown_Posbiomass_graph, NPD_Unknown_Posbiomass_loggraph, nrow =1)

```

```{r LM_PrctChl_pos_add, eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}
# Multiple Linear Regression - Chl Rmd Filtration Stepwise Selection
# Positive Percent Chl removed trials only
MLR_PrctChl_fwd <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~
                         # Field notes Qualitative variables
                         #Wind + G_upstream + Algae + #Daylight +  Sonde_fell + Boat_wake +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + #Turbidity_NTU_Up + 
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)

summary(MLR_PrctChl_fwd)

# stepwise selection that enters and removes variables. 
step(MLR_PrctChl_fwd, direction = 'both')

```

```{r LM_PrctChl_pos_Oly, eval=FALSE, include=FALSE}
Pos_Newport_data <- Filtration_pos_data %>% 
  filter(!Site %in% c("Morro Bay", "San Rafael"))

LM_PrctChl_NP <- lm(data = Pos_Newport_data, pcnt_Chl_rmvd ~ 
                   Temp_C_Up + 
                   Sal_ppt_Up + 
                   Turbidity_NTU_Up + 
                   #avg_depth_cm + 
                   #d_bw_sondes_m + 
                   #avg_m_hr + 
                   Avg_OC_Ratio +
                   Avg_TPM_mg_L)

# stepwise selection that enters and removes variables. 
step(LM_PrctChl_NP, direction = 'both')
```

```{r eval=FALSE, fig.height=5, fig.width=6,  include=FALSE}

#Positive Filtration ~ ChlRmd Multiple Regression with selected variables
LM2_PrctChl_pos_add <- lm(data = Filtration_pos_data, pcnt_Chl_rmvd ~ 
                          NPSM + Avg_OC_Ratio)

summary(LM2_PrctChl_pos_add)
# diagnosis of colinearity
#ols_coll_diag(LM_PrctChl_pos_add)
```

```{r eval=FALSE, fig.height=10, fig.width=6,  include=FALSE}
#Positive Filtration ~ ChlRmd Multiple Regression with selected variables
# detailed multiple regression summary - ANOVA results
ols_regress(LM2_PrctChl_pos_add)
```

```{r LM_FR_pos, eval=FALSE,  include=FALSE}
#FR - Positive Filtration Stepwise Multiple Regression
# Positive Percent Chl removed trials only
LM_FR_pos <- lm(data = Filtration_pos_data, L_hr_m2 ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + # Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)

ols_step_both_p(LM_FR_pos)
```

```{r LM_ChlRmd_NPD_PosFilter, eval=FALSE,  include=FALSE}
#Chl Rmd - Deanza - Positive Filtration
LM_ChlRmd_NPD_PosFilter <- lm(data = Deanza_PosFilter_data, pcnt_Chl_rmvd ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + # Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)
# not enough degrees of freedom for full model
ols_step_both_p(LM_ChlRmd_NPD_PosFilter)
```

```{r LM_FR_NPD_Posfilter, eval=FALSE,  include=FALSE}
#FR - Deanza - Positive Filtration
LM_FR_NPD_Posfilter <- lm(data = Deanza_PosFilter_data, L_hr_m2 ~
                         # site logic variables - SR not included - break model to include all sites
                         NPD + NPSM + MB + 
                         # Field notes logic variables
                         Wind + G_upstream +  Daylight +  Sonde_fell + Boat_wake + Algae +
                         # Quantatative variables
                         Temp_C_Up + Sal_ppt_Up + Turbidity_NTU_Up + #Chl_ug_L_Up +
                         avg_depth_cm + d_bw_sondes_m + avg_m_hr + Avg_OC_Ratio)
# not enough degrees of freedom for full model
ols_step_both_p(LM_FR_NPD_Posfilter)
```

```{r T_test_table, eval=FALSE, fig.height=5, fig.width=6, include=FALSE}
#### T-test is not an appropriate analysis for my data (per Dr. Kevin Nichols CSUF) The groups are not independent, violating the assumptions. 
T_test_Table <- Master_analysis_table %>%
  mutate(Date = mdy(Date),
         pcnt_Chl_rmvd = round(pcnt_Chl_rmvd, digits = 1), # Do I need Percent Chl removed here? Presented in other table
         Mean_Chl_diff = round(Mean_Chl_diff, digits = 2),
         StDev_Chl_diff = round(StDev_Chl_diff, digits = 2),
         StEr_Chl_diff = round(StEr_Chl_diff, digits = 2),
         statistic = round(statistic, digits = 2), # t-statistic 
         p.value = round(p.value, digits = 2),
         parameter = round(parameter, digits = 2),
         conf.low = round(conf.low, digits = 2)) %>% 
  dplyr::select(Site, Date, Experiment, pcnt_Chl_rmvd, Mean_Chl_diff, StDev_Chl_diff, StEr_Chl_diff,
                statistic, p.value, parameter, conf.low) %>% 
  group_by(Site) %>% 
  arrange(Date, .by_group = T)
# Make date formated as character to display properly
T_test_Table$Date <- as.character(T_test_Table$Date)
# Make xtable to render LaTex table in pdf
Ttest_table_LaTeX <- xtable(T_test_Table, caption = "T-test results", label="tb:iris")


############ Chl diff single tailed t-test Values ################
SR_T_Table <- T_test_Table %>% 
  filter(Site %in% c("San Rafael"))

MB_T_Table <- T_test_Table %>% 
  filter(Site %in% c("Morro Bay"))

NPSM_T_Table <- T_test_Table %>% 
  filter(Site %in% c("Shellmaker"))

NPD_T_Table <- T_test_Table %>% 
  filter(Site %in% c("Deanza"))


```